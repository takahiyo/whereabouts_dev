# 🚀 デプロイチェックリスト（お知らせ機能）

## ⚠️ 重要な注意事項

**現在の問題:** GASコードは正しく更新されているが、デプロイが古いバージョンのまま

**原因:** GASのキャッシュまたはデプロイの更新が反映されていない

**解決策:** 新規デプロイを作成して、完全にリフレッシュする

---

## ✅ デプロイ前の確認

### GASコードの確認
- [ ] `GAS_コード.gs` を開いた
- [ ] 総行数が **622行** である
- [ ] 523-524行目に `if(action === 'getNotices'){` がある
- [ ] 548行目に `if(action === 'setNotices'){` がある
- [ ] 158-206行目に正規化関数がある
- [ ] Ctrl+S (Cmd+S) で保存した

---

## 📝 デプロイ手順（簡易版）

### 1. 新規デプロイの作成
```
GAS エディタ → デプロイ → 新しいデプロイ
↓
種類の選択 → ウェブアプリ
↓
説明: お知らせ機能追加 v2.0
実行: 自分
アクセス: 全員
↓
デプロイ → URL をコピー
```

- [ ] 新規デプロイを作成した
- [ ] 新しいウェブアプリURLをコピーした

**コピーしたURL:**
```
https://script.google.com/macros/s/___________________/exec
```

### 2. Cloudflare Worker環境変数の更新
```
Cloudflare Dashboard → Workers & Pages → プロジェクト選択
↓
Settings → Environment Variables → Edit variables
↓
GAS_ENDPOINT を新しいURLに更新
↓
Save and deploy
```

- [ ] Cloudflare Dashboardを開いた
- [ ] 環境変数 `GAS_ENDPOINT` を更新した
- [ ] Save and deploy をクリックした
- [ ] デプロイ完了まで待った（30秒〜1分）

### 3. キャッシュクリア
```
ブラウザ: Ctrl+Shift+Delete → キャッシュ削除
↓
HQシステムページ: Ctrl+Shift+R で強制リロード（2回）
```

- [ ] ブラウザキャッシュをクリアした
- [ ] HQシステムページを強制リロードした（2回）

---

## 🧪 動作確認

### 基本動作
- [ ] ログインできる
- [ ] ヘッダーに「お知らせ」ボタンが表示される（お知らせがある場合）
- [ ] お知らせエリアが展開状態で表示される

### お知らせの追加
- [ ] 管理パネルを開いた
- [ ] お知らせを追加した
  - タイトル: `テスト通知`
  - 内容: `これはテストです。`
- [ ] 「追加」ボタンをクリックした
- [ ] 成功メッセージが表示された

### 表示確認
- [ ] 追加したお知らせが表示された
- [ ] タイトルと内容が正しく表示されている

### 折りたたみ機能
- [ ] 「お知らせ」ボタンをクリックした
- [ ] お知らせが折りたたまれた
- [ ] 「（タイトル） (他●件)」形式で表示された
- [ ] もう一度クリックして展開した

### コンソール確認
- [ ] F12 で開発者ツールを開いた
- [ ] Console タブを選択した
- [ ] エラーがないことを確認した
- [ ] `{error: 'unknown_action'}` が出ていないことを確認した

---

## ❌ トラブルシューティング

### まだ `unknown_action` エラーが出る場合

**確認項目:**
1. Cloudflare Workerの環境変数が正しく更新されているか？
2. 新しいGAS URLが正しくコピーされているか？
3. Cloudflareのデプロイが完了しているか？

**対処法:**
```bash
# Cloudflare Workerを手動で再デプロイ
Deployments タブ → 最新デプロイの「...」メニュー → Retry deployment
```

### お知らせボタンが表示されない場合

**原因:** お知らせがまだ存在しない

**対処法:**
1. 管理パネルからお知らせを1件追加
2. ページをリロード

### 保存ができない場合

**確認項目:**
1. GASコードの548行目に `if(action === 'setNotices'){` があるか？
2. ログインユーザーが管理者権限を持っているか？

---

## 📊 成功の判定基準

以下のログが表示されればOK:

```javascript
// Console ログ（成功例）
saveNotices: sending params: {action: 'setNotices', office: 'nagoya', noticesLength: 1}
setNotices response: {ok: true, notices: [{title: '...', content: '...'}]}
fetchNotices params: {action: 'getNotices', token: '...', nocache: '1', office: 'nagoya'}
fetchNotices response: {updated: 1731398400000, notices: [{title: '...', content: '...'}]}
```

**❌ NG:** `{error: 'unknown_action'}` が表示される  
**✅ OK:** `{ok: true, notices: [...]}` が表示される

---

## 📁 関連ファイル

詳細な手順は以下を参照:
- `GAS_新規デプロイ手順.md` - 詳細な手順書（トラブルシューティング含む）

---

## ✅ 完了

すべてのチェック項目が完了したら、このファイルを保存してください。

**完了日時:** _________________

**実施者:** _________________

**備考:**
```
（問題があった場合や特記事項を記入）
```
