<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ</title>

  <!-- 蠑ｷ繧√・繧ｭ繝｣繝・す繝･謚第ｭ｢・・TML縺ｫ蜉ｹ縺擾ｼ・-->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- CSP・啗orker 縺ｸ縺ｮ POST 繧定ｨｱ蜿ｯ -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self';
               script-src 'self' https://www.gstatic.com;
               connect-src 'self' https://presence-proxy-test.taka-hiyo.workers.dev https://*.googleapis.com https://*.firebaseapp.com https://*.firebaseio.com https://www.gstatic.com;
               style-src 'self' 'unsafe-inline';
               img-src 'self' data:;
               font-src 'self';
               object-src 'none';
               base-uri 'self';
               form-action 'self'">
  

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
  :root {
    /* === v1.42 縺ｮ蟷・ヱ繝ｩ繝｡繝ｼ繧ｿ繧定ｸ剰･ｲ === */
    --base-name: 110px;
    --base-ext: 70px;
    --base-work: 170px;
    --base-status: 150px;
    --base-time: 65px;
    --base-note: 210px;

    --scale-name: 0.50;
    --scale-ext: 0.33;
    --scale-work: 0.55;
    --scale-status: 0.75;
    --scale-time: 0.45;

    --min-name: 85px;
    --min-ext: 35px;
    --min-work: 80px;
    --min-status: 85px;
    --min-time: 65px;
    --min-note: 70px;

    --w-name: max(calc(var(--base-name) * var(--scale-name)), var(--min-name));
    --w-ext: max(calc(var(--base-ext) * var(--scale-ext)), var(--min-ext));
    --w-work: max(calc(var(--base-work) * var(--scale-work)), var(--min-work));
    --w-status: max(calc(var(--base-status) * var(--scale-status)), var(--min-status));
    --w-time: max(calc(var(--base-time) * var(--scale-time)), var(--min-time));
    --w-note: max(var(--base-note), var(--min-note));

    --status-effective: var(--status-fixed, var(--w-status));

    --gap: 20px;
    --header-height: 56px;

    /* === Color System (Single Source of Truth) === */
    /* Base Colors */
    --white: #fff;
    --black: #000;
    --bg-main: #fafafa;
    --bg-header: #fff;
    --bg-head: #f1ece6;
    --line: #d9d9d9;

    /* Text Colors */
    --text-primary: #1f2937;
    --text-secondary: #374151;
    --text-muted: #6b7280;
    --text-danger: #ef4444;

    /* Status Colors (Bg / Accent) */
    --st-out-bg: #fff7ed;
    --st-out-acc: #f59e0b;
    --st-meet-bg: #eff6ff;
    --st-meet-acc: #3b82f6;
    --st-remote-bg: #f5f3ff;
    --st-remote-acc: #8b5cf6;
    --st-trip-bg: #ecfdf5;
    --st-trip-acc: #10b981;
    --st-train-bg: #fefce8;
    --st-train-acc: #eab308;
    --st-health-bg: #f0f9ff;
    --st-health-acc: #06b6d4;
    --st-coadoc-bg: #fdf2f8;
    --st-coadoc-acc: #db2777;
    --st-home-bg: #f3f4f6;
    --st-home-acc: #6b7280;
    --st-off-bg: #fef2f2;
    --st-off-acc: #ef4444;

    /* Button Colors */
    --btn-title-bg: #dff1ff;
    --btn-title-bd: #bfe4ff;
    --btn-notice-bg: #fffbeb;
    --btn-notice-bd: #fbbf24;
    --btn-admin-bg: #e7f8e7;
    --btn-admin-bd: #b7e6b7;
    --btn-event-bg: #fdf2f8;
    --btn-event-bd: #fbcfe8;
    --btn-logout-bg: #fee2e2;
    --btn-logout-bd: #fecaca;
    --btn-tools-bg: #e0f2fe;
    --btn-tools-bd: #bae6fd;
    --btn-manual-bg: #eef2ff;
    --btn-manual-bd: #c7d2fe;

    /* Interactive */
    --focus-ring: #4a90e2;
    --link-blue: #2563eb;
    --hover-bg: #f3f4f6;

    /* Toast */
    --toast-bg: #0f172a;
    --toast-text: #e2e8f0;
    --toast-error-bg: #7f1d1d;
    --toast-error-text: #fee2e2;
  }

  body {
    font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: #fff;
    margin: 16px
  }

  /* 繝倥ャ繝 */
  header {
    position: relative;
    position: sticky;
    top: 0;
    z-index: 1500;
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    background: var(--bg-header);
    padding: 6px 0;
    box-shadow: 0 1px 0 rgba(0, 0, 0, .06);
  }

  .title-wrap {
    position: relative;
  }

  header .title-btn,
  header .notices-btn,
  header .admin-btn,
  header .event-btn,
  header .logout-btn,
  header .manual-btn,
  header .tools-btn {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    padding: .35rem .9rem;
    border-radius: 999px;
    line-height: 1.2;
    border: 1px solid transparent;
    cursor: pointer;
  }

  header .title-btn {
    background: var(--btn-title-bg);
    border-color: var(--btn-title-bd);
  }

  header .notices-btn {
    background: var(--btn-notice-bg);
    border-color: var(--btn-notice-bd);
    display: none;
  }

  header .admin-btn {
    background: var(--btn-admin-bg);
    border-color: var(--btn-admin-bd);
    display: none;
  }

  header .event-btn {
    background: var(--btn-event-bg);
    border-color: var(--btn-event-bd);
    display: none;
  }

  header .logout-btn {
    background: var(--btn-logout-bg);
    border-color: var(--btn-logout-bd);
    display: none;
  }

  header .tools-btn {
    background: var(--btn-tools-bg);
    border-color: var(--btn-tools-bd);
    display: none;
  }

  header .manual-btn {
    background: var(--btn-manual-bg);
    border-color: var(--btn-manual-bd);
    display: none;
  }

  /* 繝輔ぅ繝ｫ繧ｿUI・医Ο繧ｰ繧､繝ｳ蠕後・縺ｿ陦ｨ遉ｺ・・*/
  .name-filter,
  .status-filter {
    display: none;
    padding: .35rem .6rem;
    border: 1px solid var(--line);
    border-radius: 999px;
    font-size: 14px;
  }

  .name-filter {
    min-width: 220px;
    max-width: 50vw;
  }

  .status-filter {
    min-width: 170px;
  }

  /* 繝倥ャ繝蜀・・讀懃ｴ｢繝懊ャ繧ｯ繧ｹ縺ｮ蝗ｺ螳壼ｹ・*/
  header #nameFilter,
  header .name-filter {
    display: inline-block;
    width: clamp(220px, 32vw, 360px) !important;
    min-width: 220px;
    max-width: 50vw;
    flex: 0 0 auto;
  }

  header #statusFilter,
  header .status-filter {
    display: inline-block;
    width: clamp(170px, 22vw, 240px) !important;
    min-width: 170px;
    flex: 0 0 auto;
  }

  /* 逶､髱｢ */
  .wrap {
    width: 100%;
    margin: 0 auto;
  }

  .board {
    display: grid;
    gap: var(--gap);
    grid-template-columns: repeat(var(--cols, auto-fit), minmax(min(100%, 760px), 1fr));
  }

  .board[data-cols="1"] {
    grid-template-columns: 1fr;
  }

  #board.force-cards {
    grid-template-columns: 1fr;
  }

  .panel {
    border: 1px solid var(--line);
    border-radius: 6px;
    background: var(--bg);
    padding: 8px;
    overflow: auto;
    scroll-margin-top: calc(var(--header-height) + 12px);
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: fixed
  }

  thead th {
    position: sticky;
    top: 0;
    background: var(--bg-head);
    font-weight: 700
  }

  th,
  td {
    border: 1px solid var(--line);
    padding: 6px;
    font-size: 14px
  }

  th {
    text-align: left
  }

  col.col-name {
    width: var(--w-name)
  }

  col.col-ext {
    width: var(--w-ext)
  }

  col.col-work {
    width: var(--w-work)
  }

  col.col-status {
    width: var(--status-effective)
  }

  col.col-time {
    width: var(--w-time)
  }

  col.col-note {
    width: var(--w-note)
  }

  select,
  input[type="text"],
  input[type="search"] {
    width: 100%;
    box-sizing: border-box;
    padding: .3rem .35rem;
    border: 1px solid var(--line);
    border-radius: 4px;
    background: var(--white);
    font-size: 14px;
    appearance: auto;
    -webkit-appearance: auto
  }

  td.status select {
    padding-right: 2.6em
  }

  td.time select {
    text-align-last: center;
    font-variant-numeric: tabular-nums
  }

  td.work input {
    font-variant-numeric: tabular-nums;
    letter-spacing: .02em;
    text-align: center;
  }

  .candidate-input {
    position: relative;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .candidate-input input {
    flex: 1 1 auto;
    min-width: 0;
  }

  .candidate-btn {
    flex: 0 0 auto;
    width: 20px;
    height: 100%;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 10px;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, transform 0.15s;
  }

  .candidate-btn:hover {
    color: #374151;
  }

  .candidate-btn[aria-expanded="true"] {
    transform: rotate(180deg);
  }

  .candidate-btn:focus-visible {
    outline: 2px solid #4a90e2;
    outline-offset: 1px;
  }

  .candidate-panel {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 10;
    min-width: 180px;
    max-height: 220px;
    overflow: auto;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    padding: 6px;
    display: none;
  }

  .candidate-panel.show {
    display: block;
  }

  .candidate-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .candidate-list li+li {
    margin-top: 4px;
  }

  .candidate-option {
    width: 100%;
    text-align: left;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f8f8;
    cursor: pointer;
  }

  .candidate-option:hover,
  .candidate-option:focus-visible {
    background: #e8f1ff;
    outline: none;
    border-color: #4a90e2;
  }

  .contact-overlay {
    position: fixed;
    inset: 0;
    z-index: 1900;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    background: rgba(0, 0, 0, .45);
  }

  .contact-dialog {
    position: relative;
    width: min(420px, 94vw);
    max-width: 560px;
    border-radius: 14px;
    background: #fff;
    padding: 18px 16px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
    border: 1px solid #e5e7eb;
  }

  .contact-title {
    margin: 0 0 10px;
    font-size: 16px;
    font-weight: 700;
    color: #0f172a;
  }

  .contact-body {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .contact-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--e5e7eb);
    /* Note: Creating var for this as it is used often or use var(--line) */
    border-radius: 12px;
    background: var(--bg-main);
  }

  .contact-label {
    font-weight: 700;
    color: var(--text-secondary);
    min-width: 56px;
  }

  .contact-link {
    flex: 1;
    text-align: right;
    color: var(--link-blue);
    font-weight: 700;
    word-break: break-word;
    line-break: anywhere;
    overflow-wrap: anywhere;
    text-decoration: none;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 6px 10px;
    border-radius: 10px;
    background: var(--btn-tools-bg);
  }

  .contact-link:hover,
  .contact-link:focus-visible {
    text-decoration: underline;
    outline: 2px solid var(--link-blue);
    outline-offset: 2px;
  }

  .contact-empty {
    flex: 1;
    text-align: right;
    color: #6b7280;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 6px 10px;
  }

  .contact-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 38px;
    height: 38px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: var(--white);
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .contact-close:hover {
    background: var(--hover-bg);
  }

  .contact-close:focus-visible {
    outline: 2px solid var(--link-blue);
    outline-offset: 2px;
  }

  /* 繧ｹ繝・・繧ｿ繧ｹ蛻･縺ｮ陦瑚牡・亥惠蟶ｭ縺ｯ繝・ヵ繧ｩ繝ｫ繝茨ｼ・*/
  #board tbody tr {
    transition: background-color .15s ease;
  }

  #board tbody tr.st-here {
    background: transparent;
  }

  #board tbody tr.st-out {
    background: var(--st-out-bg);
    box-shadow: inset 4px 0 0 var(--st-out-acc);
  }

  #board tbody tr.st-meeting {
    background: var(--st-meet-bg);
    box-shadow: inset 4px 0 0 var(--st-meet-acc);
  }

  #board tbody tr.st-remote {
    background: var(--st-remote-bg);
    box-shadow: inset 4px 0 0 var(--st-remote-acc);
  }

  #board tbody tr.st-trip {
    background: var(--st-trip-bg);
    box-shadow: inset 4px 0 0 var(--st-trip-acc);
  }

  #board tbody tr.st-training {
    background: var(--st-train-bg);
    box-shadow: inset 4px 0 0 var(--st-train-acc);
  }

  #board tbody tr.st-health {
    background: var(--st-health-bg);
    box-shadow: inset 4px 0 0 var(--st-health-acc);
  }

  #board tbody tr.st-coadoc {
    background: var(--st-coadoc-bg);
    box-shadow: inset 4px 0 0 var(--st-coadoc-acc);
  }

  #board tbody tr.st-home {
    background: var(--st-home-bg);
    box-shadow: inset 4px 0 0 var(--st-home-acc);
  }

  #board tbody tr.st-off {
    background: var(--st-off-bg);
    box-shadow: inset 4px 0 0 var(--st-off-acc);
    color: var(--text-secondary);
  }

  #board tbody tr.st-off input,
  #board tbody tr.st-off select {
    color: var(--text-secondary);
  }

  /* 謌ｻ繧頑凾髢灘・蜉帙・菫・＠・亥､門・/莨夊ｭｰ・・*/
  td.time {
    position: relative;
  }

  td.time.time-disabled select {
    pointer-events: none;
    opacity: 0.45;
  }

  td.time.need-time select {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, .25);
    animation: pulseRing 1.2s ease-in-out infinite;
  }

  .time-hint {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #b91c1c;
    /* Keep as specific dark red or map to danger/muted */
    pointer-events: none;
    user-select: none;
  }

  @keyframes pulseRing {
    0% {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, .25);
    }

    70% {
      box-shadow: 0 0 0 6px rgba(239, 68, 68, .06);
    }

    100% {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, .25);
    }
  }

  .login {
    position: fixed;
    inset: 0;
    background: var(--bg-header);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2200
  }

  .login .card {
    background: var(--bg-header);
    border-radius: 8px;
    padding: 20px;
    min-width: 300px;
    max-width: 90vw;
    text-align: center
  }

  .toast {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    padding: 0 16px calc(20px + env(safe-area-inset-bottom, 0px));
    opacity: 0;
    transform: translateY(12px);
    transition: opacity .2s ease, transform .2s ease;
    z-index: 2500;
    pointer-events: none;
  }

  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  .toast-panel {
    width: min(960px, calc(100% - 32px));
    max-width: 960px;
    background: var(--toast-bg);
    color: var(--toast-text);
    border-radius: 10px;
    padding: 16px 18px;
    font-size: 16px;
    line-height: 1.6;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
    pointer-events: auto;
    text-align: center;
    word-break: break-word;
    overflow-wrap: anywhere;
    text-wrap: balance;
    border: 1px solid rgba(226, 232, 240, 0.28);
  }

  .toast.toast--error .toast-panel {
    background: var(--toast-error-bg);
    color: var(--toast-error-text);
    border-color: rgba(254, 226, 226, 0.35);
  }

  .toast.toast--success .toast-panel {
    background: var(--toast-bg);
    color: var(--toast-text);
  }

  @media (max-width: 720px) {

    colgroup,
    thead {
      display: none;
    }

    table {
      table-layout: auto;
    }

    tbody {
      display: block;
    }

    tbody tr {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
    }

    tbody td {
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1 1 48%;
      min-width: 140px;
      background: transparent;
    }

    #board tbody td::before {
      content: attr(data-label) !important;
      font-weight: 600;
      color: #6B7280;
      min-width: 5.5em;
      flex: 0 0 auto;
    }

    tbody td.name {
      order: 0;
      flex: 1 1 100%;
      font-weight: 800;
      font-size: 15px;
      line-height: 1.2;
      padding-bottom: 2px;
      user-select: none;
      -webkit-touch-callout: none;
    }

    tbody td.name::before {
      content: "";
      display: none;
    }

    tbody td.work {
      order: 1;
      flex: 1 1 100%;
    }

    tbody td.ext {
      order: 2;
    }

    tbody td.time {
      order: 3;
    }

    tbody td.status {
      order: 4;
      flex: 1 1 100%;
    }

    tbody td.note {
      order: 5;
      flex: 1 1 100%;
    }
  }

  #board.force-cards colgroup,
  #board[data-cols="1"] colgroup,
  #board.force-cards thead,
  #board[data-cols="1"] thead {
    display: none;
  }

  #board.force-cards tbody,
  #board[data-cols="1"] tbody {
    display: block;
  }

  #board.force-cards tbody tr,
  #board[data-cols="1"] tbody tr {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 12px;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
  }

  #board.force-cards tbody td,
  #board[data-cols="1"] tbody td {
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1 1 48%;
    min-width: 140px;
    background: transparent;
  }

  #board.force-cards tbody td::before,
  #board[data-cols="1"] tbody td::before {
    font-weight: 600;
    color: #6B7280;
    min-width: 5.5em;
    flex: 0 0 auto;
  }

  #board.force-cards tbody td.name,
  #board[data-cols="1"] tbody td.name {
    order: 0;
    flex: 1 1 100%;
    font-weight: 800;
    font-size: 15px;
    line-height: 1.2;
    padding-bottom: 2px;
    user-select: none;
    -webkit-touch-callout: none;
  }

  #board.force-cards tbody td.work,
  #board[data-cols="1"] tbody td.work {
    order: 1;
    flex: 1 1 100%;
  }

  #board.force-cards tbody td.ext,
  #board[data-cols="1"] tbody td.ext {
    order: 2;
  }

  #board.force-cards tbody td.time,
  #board[data-cols="1"] tbody td.time {
    order: 3;
  }

  #board.force-cards tbody td.status,
  #board[data-cols="1"] tbody td.status {
    order: 4;
    flex: 1 1 100%;
  }

  #board.force-cards tbody td.note,
  #board[data-cols="1"] tbody td.note {
    order: 5;
    flex: 1 1 100%;
  }

  #board.force-cards tbody td.name::before,
  #board[data-cols="1"] tbody td.name::before {
    content: "";
    display: none;
  }

  /* 1蛻励↓縺ｪ縺｣縺溘ｉ蠑ｷ蛻ｶ繧ｫ繝ｼ繝牙喧 */

  .board.force-cards table {
    display: block;
    width: 100%;
    table-layout: auto;
    border-collapse: separate;
  }

  /* 險ｺ譁ｭ逕ｨ繝舌リ繝ｼ・亥ｿ・ｦ∵凾縺ｮ縺ｿ・・*/
  .diag {
    position: fixed;
    left: 8px;
    bottom: 8px;
    background: #fffbdd;
    border: 1px solid #e6cf00;
    color: #614a00;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 2500;
    display: none;
  }

  .diag.show {
    display: block;
  }

  /* v1.431: duplicate-label fix */
  .sr-only {
    position: absolute !important;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (min-width: 721px) {
    #board:not(.force-cards) tbody td::before {
      content: "" !important;
    }
  }

  #board.force-cards td>label.sr-only {
    display: none !important;
  }

  #board.force-cards tbody td::before {
    content: attr(data-label) !important;
    white-space: nowrap;
  }

  .admin-modal {
    position: fixed;
    inset: 0;
    z-index: 1850;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .5);
    padding: 20px;
  }

  .admin-modal.show {
    display: flex;
  }

  .admin-card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 12px;
    max-height: 90vh;
    width: min(1280px, 100%);
    max-width: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .admin-card-header {
    flex: 0 0 auto;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #fff;
  }

  .admin-card-body {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .notice-modal-card {
    width: min(720px, 95vw);
    max-width: 95vw;
  }

  .notice-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
  }

  .notice-modal-body {
    max-height: 60vh;
    overflow: auto;
    line-height: 1.6;
    color: #0f172a;
    font-size: 14px;
  }

  .notice-modal-content {
    white-space: pre-wrap;
  }

  .tools-modal-card {
    width: min(840px, 95vw);
    max-width: 95vw;
    padding: 16px;
  }

  .tools-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }

  .tools-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 70vh;
    overflow: auto;
  }

  .tools-item {
    padding: 10px 0;
  }

  .tools-item+.tools-item {
    border-top: 1px solid #e5e7eb;
  }

  .tools-item-title {
    font-weight: 700;
    font-size: 15px;
    color: #0f172a;
  }

  .tools-item-title a {
    color: inherit;
    text-decoration: none;
  }

  .tools-item-title a:hover {
    text-decoration: underline;
  }

  .tools-item-note {
    margin-top: 6px;
    color: #374151;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
  }

  .tools-empty {
    padding: 12px;
    border: 1px dashed #cbd5e1;
    border-radius: 8px;
    color: #475569;
    background: #f8fafc;
  }

  .admin-tabs {}

  .tab-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: .35rem .9rem;
    border: 1px solid var(--line);
    border-radius: 6px;
    background: #f3f4f6;
    cursor: pointer;
  }

  .tab-btn.active {
    background: #e7f8e7;
    border-color: #b7e6b7;
  }

  .tab-panel {
    display: none;
    padding-bottom: 100px;
  }

  .tab-panel.active {
    display: block;
  }

  .admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
    align-items: start;
  }

  .admin-box-stacked {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .admin-subsection {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
  }

  .admin-subsection h5 {
    margin: 0;
    font-size: 14px;
    color: #374151;
  }

  .admin-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 4px 0;
  }

  .admin-box {
    margin: 0;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
  }

  .admin-box-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }

  .admin-box-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    padding-left: 8px;
  }

  .admin-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 8px;
  }

  .admin-note {
    font-size: 12px;
    color: #6B7280;
    margin-top: 4px;
  }

  .members-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: 0;
  }

  .member-save-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    padding: 15px;
    padding-right: 40px;
    /* 逕ｻ髱｢蜿ｳ遶ｯ縺九ｉ蟆代＠髮｢縺・*/
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid #ccc;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
  }

  .member-table-wrap {
    overflow: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    max-height: 60vh;
    background: #fff;
  }

  .member-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    min-width: 1580px;
    table-layout: fixed;
  }

  .member-table th,
  .member-table td {
    border-bottom: 1px solid #e5e7eb;
    padding: 4px 8px;
    text-align: left;
    vertical-align: middle;
    word-break: break-word;
    height: auto;
  }

  .member-table th {
    background: #f9fafb;
    color: #374151;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .member-table tr:last-child td {
    border-bottom: none;
  }

  .member-row-actions {
    display: flex;
    gap: 6px;
    justify-content: center;
    align-items: center;
  }

  /* .member-drag-handle{...} // 蟒・ｭ｢ */

  /* --- 鬆・分蛻励・繧ｹ繧ｿ繧､繝ｫ --- */
  .member-order-cell {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    /* 蟾ｦ蟇・○ */
    gap: 8px;
    white-space: nowrap;
    font-family: monospace;
    /* 謨ｰ蟄励・蟷・ｒ謠・∴繧・*/
  }

  .member-order-num {
    font-weight: bold;
    color: #555;
  }

  .member-move-actions {
    display: flex;
    gap: 2px;
  }

  /* 辟｡蜉ｹ蛹悶＆繧後◆遘ｻ蜍輔・繧ｿ繝ｳ縺ｮ繧ｹ繧ｿ繧､繝ｫ */
  .btn-move-up:disabled,
  .btn-move-down:disabled {
    opacity: 0.3;
    cursor: default;
    pointer-events: none;
  }

  #groupOrderList.group-order-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
  }

  #groupOrderList .group-order-item {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    padding: 6px 10px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
  }

  #groupOrderList .group-order-label {
    flex: 1;
    min-width: 0;
  }

  #groupOrderList .group-order-actions {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }

  .member-filter-row {
    display: flex;
    gap: 12px;
    align-items: center;
    margin: 6px 0 4px;
    flex-wrap: wrap;
  }

  .member-filter-label {
    font-weight: 700;
    color: #374151;
    min-width: 92px;
    display: flex;
    align-items: center;
  }

  .member-filter-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .member-filter-controls input {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    min-width: 220px;
    max-width: 340px;
    flex: 1;
  }

  .member-inline-form {
    margin: 10px 0;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
  }

  .member-edit-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .member-edit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 10px;
  }

  .member-edit-grid label {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-weight: 600;
    color: #374151;
  }

  .member-edit-grid input {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }

  .member-edit-actions {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .member-edit-actions-left {
    color: #4b5563;
    font-size: 13px;
  }

  .member-edit-actions-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .member-edit-mode {
    font-weight: 700;
  }

  .member-table .numeric-cell {
    white-space: nowrap;
  }

  /* --- 莉･荳九∝・蟷・・菫ｮ豁｣ --- */

  /* 1蛻礼岼: 鬆・分 (150px 蝗ｺ螳・ */
  .member-table th:nth-child(1),
  .member-table td:nth-child(1) {
    width: 150px;
    white-space: nowrap;
    text-align: center;
  }

  /* 2蛻礼岼: 繧ｰ繝ｫ繝ｼ繝・(譛菴・400px - 蜿ｯ螟・ */
  .member-table th:nth-child(2),
  .member-table td:nth-child(2) {
    width: 400px;
  }

  /* 3蛻礼岼: 豌丞錐 (譛菴・240px - 蜿ｯ螟・ */
  .member-table th:nth-child(3),
  .member-table td:nth-child(3) {
    width: 240px;
  }

  /* 4蛻礼岼: 蜀・ｷ・(80px 蝗ｺ螳・ */
  .member-table th:nth-child(4),
  .member-table td:nth-child(4) {
    width: 80px;
  }

  /* 5蛻礼岼: 謳ｺ蟶ｯ (180px 蝗ｺ螳・ */
  .member-table th:nth-child(5),
  .member-table td:nth-child(5) {
    width: 180px;
  }

  /* 6蛻礼岼: Email (譛菴・350px - 蜿ｯ螟・ */
  .member-table th:nth-child(6),
  .member-table td:nth-child(6) {
    width: 350px;
  }

  /* 7蛻礼岼: 謫堺ｽ・(180px 蝗ｺ螳・ */
  .member-table th:nth-child(7),
  .member-table td:nth-child(7) {
    width: 180px;
    text-align: center;
  }












  .member-email {
    display: flex;
    flex-direction: column;
    gap: 2px;
    white-space: normal;
    word-break: break-word;
    line-height: 1.35;
  }

  .member-email .email-domain {
    color: #4b5563;
    font-size: 12px;
    word-break: break-all;
  }

  .required {
    color: #b91c1c;
    font-weight: 700;
  }

  .vacation-grid {
    display: grid;
    grid-template-columns: minmax(420px, 1.1fr) minmax(340px, 0.9fr);
    gap: 16px;
    align-items: start;
  }

  @media (max-width: 1023px) {
    .vacation-grid {
      grid-template-columns: 1fr;
    }
  }

  .vacation-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .vacation-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .vacation-row-two-cols {
    flex-direction: row;
    gap: 12px;
    flex-wrap: wrap;
  }

  .vacation-row-two-cols label {
    flex: 1;
    min-width: 180px;
  }

  .vacation-row label {
    font-weight: 600;
    color: #374151;
    gap: 4px;
    display: flex;
    flex-direction: column;
  }

  .vacation-row input,
  .vacation-row textarea,
  .vacation-row select {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
  }

  .vacation-row textarea {
    resize: vertical;
  }

  .vacation-row-inline {
    flex-direction: row;
    align-items: flex-end;
    gap: 12px;
    flex-wrap: wrap;
  }

  .vacation-row-inline label {
    flex: 1;
    min-width: 260px;
  }

  .vacation-inline-actions {
    display: flex;
    align-items: flex-end;
    gap: 8px;
  }

  .vacation-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    margin: 4px 0 8px;
  }

  .vacation-table-wrap {
    overflow: auto;
    max-height: 340px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .vacation-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .vacation-table th,
  .vacation-table td {
    border-bottom: 1px solid #e5e7eb;
    padding: 8px;
    text-align: left;
    vertical-align: top;
  }

  .vacation-table th {
    background: #f9fafb;
    color: #374151;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .vacation-table tr:last-child td {
    border-bottom: none;
  }

  .vacation-drag-cell {
    width: 44px;
    text-align: center;
  }

  .vacation-drag-handle {
    cursor: grab;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 4px 6px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    color: #6b7280;
    font-size: 14px;
  }

  .vacation-drag-handle:active {
    cursor: grabbing;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12);
  }

  .vacation-dragging {
    opacity: 0.72;
  }

  .vacation-gantt-sticky-header {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 30;
    padding-bottom: 4px;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 4px;
  }

  .vacation-gantt {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    background: #f8fafc;
    overflow: auto;
    max-height: 60vh;
  }

  .vacation-gantt table {
    border-collapse: collapse;
    min-width: 480px;
    width: 100%;
    font-size: 12px;
  }

  .vacation-gantt .vac-save-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
    font-size: 12px;
    color: #334155;
  }

  .vacation-gantt .vac-save-status[data-state="error"] {
    color: #b91c1c;
  }

  .vacation-gantt .vac-save-status[data-state="saved"] {
    color: #16a34a;
  }

  .vacation-gantt .vac-save-status button {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    background: #fff;
    cursor: pointer;
  }

  .vacation-gantt .vac-save-status button:hover {
    background: #f8fafc;
  }

  .vac-save-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid #93c5fd;
    border-top-color: #0ea5e9;
    border-radius: 50%;
    animation: vac-save-spin 0.8s linear infinite;
    display: inline-block;
  }

  @keyframes vac-save-spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  .vacation-gantt thead th {
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    z-index: 5;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    vertical-align: middle;
    user-select: none;
  }

  .vacation-gantt thead tr.vac-month-row th {
    --vac-month-row-height: 34px;
    --vac-head-offset: 0px;
    top: 0;
    padding: 6px 4px;
  }

  .vacation-gantt thead tr.vac-day-row th {
    --vac-head-offset: var(--vac-month-row-height, 30px);
    top: var(--vac-head-offset);
    padding: 4px 3px;
  }

  .vacation-gantt th,
  .vacation-gantt td {
    border: 1px solid #e5e7eb;
    padding: 4px;
    white-space: nowrap;
    text-align: center;
  }

  .vacation-gantt th {
    user-select: none;
  }

  .vacation-gantt th.group-name {
    background: #f3f4f6;
    position: sticky;
    left: 0;
    z-index: 10;
    min-width: 32px;
    width: 32px;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    padding: 8px 4px;
    font-size: 11px;
    letter-spacing: 0.05em;
    border-right: 2px solid #d1d5db;
  }

  .vacation-gantt th.member-name {
    background: #fff;
    position: sticky;
    left: 32px;
    z-index: 10;
    text-align: left;
    font-weight: 600;
    width: var(--w-name);
    min-width: 85px;
    max-width: 110px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-right: 2px solid #9ca3af;
    user-select: none;
  }

  .vacation-gantt th.member-name.member-has-bit {
    background: #dbeafe;
    font-weight: 700;
    color: #1e40af;
  }

  .vacation-gantt thead th.group-name {
    z-index: 20;
    background: #f3f4f6;
  }

  .vacation-gantt thead th.member-name {
    z-index: 20;
    background: #fff;
  }

  .vacation-gantt .vac-cell {
    cursor: pointer;
    min-width: 34px;
    transition: background 0.1s ease, color 0.1s ease, box-shadow 0.1s ease;
    user-select: none;
  }

  .vacation-gantt table.dragging .vac-cell {
    touch-action: none;
  }

  .vacation-gantt .vac-cell.weekend-sat {
    background: #e0f2fe;
  }

  .vacation-gantt .vac-cell.weekend-sun {
    background: #fee2e2;
  }

  .vacation-gantt .vac-cell.holiday {
    background: #ffe4e6;
    color: #b91c1c;
  }

  .vacation-gantt .vac-day-header {
    background: #fff;
  }

  .vacation-gantt .vac-day-header.weekend-sat {
    background: #e0f2fe;
  }

  .vacation-gantt .vac-day-header.weekend-sun {
    background: #fee2e2;
  }

  .vacation-gantt .vac-day-header.holiday {
    background: #ffe4e6;
    color: #b91c1c;
  }

  .vacation-gantt .vac-day-header.vac-color-none,
  .vacation-gantt .vac-cell.vac-color-none,
  .vac-color-option.vac-color-none {
    background: #fff;
  }

  .vacation-gantt .vac-day-header.vac-color-sat,
  .vacation-gantt .vac-cell.vac-color-sat,
  .vac-color-option.vac-color-sat {
    background: #e0f2fe;
  }

  .vacation-gantt .vac-day-header.vac-color-sun,
  .vacation-gantt .vac-cell.vac-color-sun,
  .vac-color-option.vac-color-sun {
    background: #fee2e2;
  }

  .vacation-gantt .vac-day-header.vac-color-holiday,
  .vacation-gantt .vac-cell.vac-color-holiday,
  .vac-color-option.vac-color-holiday {
    background: #ffe4e6;
    color: #b91c1c;
  }

  .vacation-gantt .vac-day-header.vac-color-amber,
  .vacation-gantt .vac-cell.vac-color-amber,
  .vac-color-option.vac-color-amber {
    background: #fef3c7;
  }

  .vacation-gantt .vac-day-header.vac-color-mint,
  .vacation-gantt .vac-cell.vac-color-mint,
  .vac-color-option.vac-color-mint {
    background: #dcfce7;
  }

  .vacation-gantt .vac-day-header.vac-color-lavender,
  .vacation-gantt .vac-cell.vac-color-lavender,
  .vac-color-option.vac-color-lavender {
    background: #ede9fe;
  }

  .vacation-gantt .vac-day-header.vac-color-slate,
  .vacation-gantt .vac-cell.vac-color-slate,
  .vac-color-option.vac-color-slate {
    background: #e5e7eb;
  }

  .vacation-gantt .vac-cell.on {
    background: #0ea5e9;
    color: #fff;
    font-weight: 700;
  }

  .vacation-gantt .vac-cell.on.weekend-sat {
    background: #0284c7;
    color: #fff;
  }

  .vacation-gantt .vac-cell.on.weekend-sun,
  .vacation-gantt .vac-cell.on.holiday {
    background: #e11d48;
    color: #fff;
  }

  .vac-color-palette {
    position: absolute;
    z-index: 1860;
    background: #fff;
    border: 1px solid #cbd5e1;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
    padding: 10px;
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 12px;
    color: #0f172a;
  }

  .vac-color-palette__title {
    font-weight: 700;
    font-size: 12px;
    line-height: 1.2;
    color: #111827;
  }

  .vac-color-palette__grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 6px;
  }

  .vac-color-option {
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 6px 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    min-width: 0;
  }

  .vac-color-option:hover {
    box-shadow: 0 6px 15px rgba(15, 23, 42, 0.12);
    border-color: #93c5fd;
    transform: translateY(-1px);
  }

  .vac-color-option__dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
  }

  .vac-color-option__label {
    font-weight: 700;
    font-size: 11px;
    color: #111827;
    text-transform: capitalize;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media print {
    .vac-color-palette {
      display: none !important;
    }

    .vacation-gantt .vac-day-header.vac-color-none,
    .vacation-gantt .vac-cell.vac-color-none,
    .vac-color-option.vac-color-none {
      background: #fff !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-sat,
    .vacation-gantt .vac-cell.vac-color-sat,
    .vac-color-option.vac-color-sat {
      background: #e0f2fe !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-sun,
    .vacation-gantt .vac-cell.vac-color-sun,
    .vac-color-option.vac-color-sun {
      background: #fee2e2 !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-holiday,
    .vacation-gantt .vac-cell.vac-color-holiday,
    .vac-color-option.vac-color-holiday {
      background: #ffe4e6 !important;
      color: #b91c1c !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-amber,
    .vacation-gantt .vac-cell.vac-color-amber,
    .vac-color-option.vac-color-amber {
      background: #fef3c7 !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-mint,
    .vacation-gantt .vac-cell.vac-color-mint,
    .vac-color-option.vac-color-mint {
      background: #dcfce7 !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-lavender,
    .vacation-gantt .vac-cell.vac-color-lavender,
    .vac-color-option.vac-color-lavender {
      background: #ede9fe !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-day-header.vac-color-slate,
    .vacation-gantt .vac-cell.vac-color-slate,
    .vac-color-option.vac-color-slate {
      background: #e5e7eb !important;
      color: #0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }

  .vacation-gantt tbody tr.group-last-row {
    border-bottom: 3px solid #6b7280;
  }

  .vacation-gantt tbody tr.group-last-row th.group-name {
    border-bottom: 3px solid #6b7280;
  }

  .vacation-gantt tbody tr.group-last-row th.member-name {
    border-bottom: 3px solid #6b7280;
  }

  .vacation-gantt tbody tr.group-last-row td {
    border-bottom: 3px solid #6b7280;
  }

  .vacation-gantt tbody tr:hover {
    background: #f0f9ff;
  }

  .vacation-gantt tbody tr:hover th.member-name {
    background: #dbeafe;
    color: #1e40af;
    font-weight: 700;
  }

  .vacation-gantt tbody tr:hover td {
    background: #e0f2fe;
  }

  .vacation-gantt thead th.hover-highlight,
  .vacation-gantt td.hover-highlight {
    box-shadow: inset 0 0 0 2px #93c5fd;
  }

  .vacation-gantt td.hover-highlight:not(.vac-cell.on) {
    background: #dbeafe !important;
    color: #1e40af;
  }

  .vacation-gantt .vac-cell.on.hover-highlight {
    color: #fff;
    box-shadow: inset 0 0 0 2px #bfdbfe, inset 0 0 0 4px rgba(191, 219, 254, 0.55);
  }

  .vacation-gantt tbody tr .hover-highlight {
    font-weight: 700;
  }

  .vacation-gantt .vac-day-label {
    display: flex;
    flex-direction: column;
    gap: 1px;
    align-items: center;
    font-weight: 600;
    white-space: nowrap;
    justify-content: center;
    line-height: 1.1;
  }

  .vacation-gantt .vac-day-label .vac-date {
    font-size: 12px;
    font-weight: 700;
  }

  .vacation-gantt .vac-day-label .vac-day {
    font-size: 10px;
    color: #6b7280;
  }

  .vacation-gantt .vac-month-header {
    background: #f3f4f6;
    font-weight: 700;
    font-size: 12px;
    border-bottom: 2px solid #d1d5db;
  }

  .vacation-gantt .vac-month-header .vac-month-text {
    display: block;
    line-height: 1.2;
  }

  .vacation-gantt .vacation-gantt-help {
    margin: 4px 0;
    color: #6b7280;
    font-size: 12px;
  }

  .vacation-gantt .vacation-gantt-title {
    font-weight: 700;
    color: #0f172a;
    display: none;
  }

  .vacation-gantt-head {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-bottom: 2px;
  }

  .vacation-gantt-touch-hint {
    font-size: 11px;
    color: #6b7280;
  }

  .event-color-manual-hint {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #1d4ed8;
    font-size: 11px;
    font-weight: 600;
  }

  .event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .event-modal-title {
    margin: 0;
  }

  .event-modal .admin-card {
    max-height: 92vh;
    width: min(1400px, 100%);
  }

  .event-modal .admin-card-body {
    padding: 24px;
  }

  .event-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }

  .event-toolbar__hint {
    color: #6b7280;
    font-size: 12px;
    flex: 1;
    min-width: 200px;
  }

  .vacation-helper {
    color: #6b7280;
    font-size: 12px;
    line-height: 1.5;
  }

  .vacation-view {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .vacation-group-jumps {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    margin: 2px 0 4px;
  }

  .vacation-group-jumps .jump-label {
    font-weight: 700;
    color: #0f172a;
    font-size: 12px;
  }

  .vacation-group-jumps .jump-btn {
    padding: 4px 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
    color: #0f172a;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }

  .vacation-group-jumps .jump-btn:hover {
    background: #e0f2fe;
    border-color: #93c5fd;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
  }

  .vacation-group-jumps .jump-btn:focus-visible {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
  }

  .vacation-group-jumps .jump-select {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .vacation-group-jumps .jump-select select {
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    background: #fff;
    min-width: 180px;
  }

  .vacation-group-jumps .jump-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .event-modal .vacation-table-wrap {
    max-height: unset;
  }

  .vacation-select-wrap {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    background: #fafafa;
  }

  .event-select-toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
    padding: 12px;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    flex-wrap: wrap;
  }

  .event-select-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #0f172a;
    white-space: nowrap;
  }

  .event-select-dropdown {
    padding: 6px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 14px;
    min-width: 200px;
    max-width: 400px;
    flex: 1;
    background: #fff;
  }

  .btn-show-event-notice {
    padding: 6px 12px;
    font-size: 13px;
    white-space: nowrap;
  }

  .vacation-radio-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 340px;
    overflow-y: auto;
  }

  .vacation-radio-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 12px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .vacation-radio-item:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .vacation-radio-item:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  .vacation-radio-item.selected {
    background: #eff6ff;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, .55);
  }

  .vacation-radio-item.applied {
    background: #ecfdf3;
    border-color: #16a34a;
    box-shadow: 0 0 0 2px rgba(22, 163, 74, .5);
  }

  .vacation-radio-item.selected::before,
  .vacation-radio-item.applied::after {
    position: absolute;
    top: 8px;
    right: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: .01em;
    box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
    opacity: 0;
    transform: translateY(-6px);
    transition: opacity .18s ease, transform .18s ease;
    pointer-events: none;
  }

  .vacation-radio-item.selected::before {
    content: "笨・驕ｸ謚樔ｸｭ";
    background: #dbeafe;
    border: 1px solid #bfdbfe;
    color: #1d4ed8;
    opacity: 1;
    transform: translateY(0);
  }

  .vacation-radio-item.applied::after {
    content: "早 陦ｨ遉ｺ荳ｭ";
    background: #dcfce7;
    border: 1px solid #86efac;
    color: #166534;
    opacity: 1;
    transform: translateY(0);
  }

  .vacation-radio-item.selected.applied::before {
    right: 108px;
  }

  .vacation-radio-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .vacation-radio-header {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: space-between;
  }

  .vacation-radio-title {
    font-weight: 600;
    color: #0f172a;
    font-size: 14px;
    text-decoration: none;
    flex: 1;
  }

  .vacation-radio-title:hover {
    text-decoration: underline;
  }

  .vacation-radio-period {
    color: #6b7280;
    font-size: 12px;
  }

  .vacation-radio-state {
    color: #475569;
    font-size: 11px;
    white-space: nowrap;
    font-weight: 600;
  }

  .vacation-radio-item.selected .vacation-radio-state {
    color: #1d4ed8;
  }

  .vacation-radio-item.applied .vacation-radio-state {
    color: #15803d;
    font-weight: 700;
  }

  .vacation-radio-actions {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin-top: 4px;
    min-height: 32px;
  }

  .vacation-radio-actions .btn-open-notice {
    padding: 6px 12px;
    font-size: 12px;
    line-height: 1.4;
    font-weight: 600;
  }

  .vacation-radio-actions .btn-open-notice:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .event-banner {
    display: none !important;
    max-width: 1200px;
    margin: 12px auto;
    padding: 12px 14px;
    border: 1px solid #fcd34d;
    background: #fffbeb;
    color: #92400e;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .event-banner__title {
    font-weight: 700;
    margin-bottom: 4px;
  }

  .event-banner__detail {
    font-size: 13px;
  }

  .event-banner__members {
    font-size: 13px;
    color: #b45309;
  }

  .event-highlight {
    background: #f8fafc !important;
    box-shadow: inset 4px 0 0 #94a3b8;
  }

  .event-color-amber {
    background: #fef9c3 !important;
    box-shadow: inset 4px 0 0 #f59e0b;
  }

  .event-color-blue {
    background: #e0f2fe !important;
    box-shadow: inset 4px 0 0 #3b82f6;
  }

  .event-color-green {
    background: #dcfce7 !important;
    box-shadow: inset 4px 0 0 #22c55e;
  }

  .event-color-pink {
    background: #fdf2f8 !important;
    box-shadow: inset 4px 0 0 #ec4899;
  }

  .event-color-purple {
    background: #f3e8ff !important;
    box-shadow: inset 4px 0 0 #a855f7;
  }

  .event-color-teal {
    background: #e0f7f5 !important;
    box-shadow: inset 4px 0 0 #14b8a6;
  }

  .event-color-gray {
    background: #f1f5f9 !important;
    box-shadow: inset 4px 0 0 #64748b;
  }

  .event-color-sunday {
    background: #fee2e2 !important;
    box-shadow: inset 4px 0 0 #ef4444;
  }

  .event-color-holiday {
    background: #ffe4e6 !important;
    box-shadow: inset 4px 0 0 #e11d48;
  }

  .event-color-slate {
    background: #e5e7eb !important;
    box-shadow: inset 4px 0 0 #475569;
  }

  .event-color-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #cbd5e1;
    border: 1px solid #cbd5e1;
  }

  .event-legend {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    min-height: 28px;
    margin: 8px 0;
  }

  .event-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    font-size: 12px;
  }

  .event-legend-text {
    color: #0f172a;
    font-weight: 600;
  }

  .event-legend-type {
    color: #475569;
    font-size: 11px;
  }

  .event-legend-empty {
    color: #94a3b8;
    font-size: 12px;
  }

  .event-legend-compact {
    margin: 4px 0;
  }

  .vacation-status-label {
    display: none;
    font-weight: 700;
    color: #92400e;
    padding: 4px 8px;
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 4px;
    text-align: center;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media (max-width:768px) {
    .admin-card {
      padding: 12px;
      width: min(1200px, 98vw);
      max-width: 98vw;
    }

    .vacation-view {
      gap: 8px;
    }
  }

  @media (max-width:705px) {
    .admin-card {
      padding: 10px;
      width: 100vw;
      max-width: 100vw;
      border-radius: 0;
      max-height: 100vh;
    }

    .vacation-gantt {
      max-height: 55vh;
    }

    .vacation-view {
      gap: 6px;
    }
  }

  @media (max-width:640px) {
    .vacation-gantt table {
      font-size: 10px;
    }

    .vacation-gantt .vac-cell {
      min-width: 26px;
      max-width: 26px;
      padding: 2px 1px;
      font-size: 9px;
    }

    .vacation-gantt {
      padding: 4px;
      max-height: 50vh;
    }

    .vacation-gantt thead tr.vac-month-row th {
      --vac-month-row-height: 30px;
      padding: 5px 3px;
    }

    .vacation-gantt thead tr.vac-day-row th {
      padding: 3px 2px;
    }

    .vacation-gantt th.group-name {
      min-width: 22px;
      width: 22px;
      font-size: 9px;
      padding: 4px 2px;
      letter-spacing: 0;
    }

    .vacation-gantt th.member-name {
      min-width: 55px;
      max-width: 70px;
      font-size: 10px;
      padding: 2px;
      left: 22px;
    }

    .vacation-gantt .vac-day-label {
      gap: 1px;
      flex-direction: column;
      font-size: 8px;
      line-height: 1.1;
    }

    .vacation-gantt .vac-day-label span {
      font-size: 8px;
      display: block;
      line-height: 1.1;
    }

    .vacation-gantt .vac-day-label .vac-day {
      font-size: 7px;
      display: block;
    }

    .vacation-gantt thead th {
      padding: 2px 1px;
      vertical-align: middle;
      height: auto;
      min-width: 26px;
      max-width: 26px;
    }

    .vacation-gantt-sticky-header {
      padding-bottom: 2px;
    }

    .vacation-gantt-help {
      font-size: 10px;
    }

    .vacation-gantt-touch-hint {
      font-size: 9px;
    }

    .vacation-actions {
      margin-bottom: 2px !important;
    }

    .vacation-actions button {
      font-size: 11px;
      padding: 4px 8px;
    }
  }

  @media (max-width:480px) {
    .vacation-gantt table {
      font-size: 9px;
    }

    .vacation-gantt .vac-cell {
      min-width: 24px;
      max-width: 24px;
      padding: 1px;
      font-size: 8px;
    }

    .vacation-gantt {
      padding: 3px;
      max-height: 45vh;
    }

    .vacation-gantt thead tr.vac-month-row th {
      --vac-month-row-height: 28px;
      padding: 4px 2px;
    }

    .vacation-gantt thead tr.vac-day-row th {
      padding: 2px 1px;
    }

    .vacation-gantt th.group-name {
      min-width: 18px;
      width: 18px;
      font-size: 8px;
      padding: 3px 1px;
    }

    .vacation-gantt th.member-name {
      min-width: 45px;
      max-width: 60px;
      font-size: 9px;
      padding: 1px;
      left: 18px;
    }

    .vacation-gantt .vac-day-label {
      font-size: 7px;
      gap: 1px;
      flex-direction: column;
      line-height: 1;
    }

    .vacation-gantt .vac-day-label .vac-date {
      font-size: 7px;
      display: block;
      line-height: 1;
    }

    .vacation-gantt .vac-day-label .vac-day {
      font-size: 6px;
      display: block;
      line-height: 1;
    }

    .vacation-gantt .vac-month-header .vac-month-text {
      font-size: 10px;
    }

    .vacation-gantt thead th {
      padding: 1px;
      vertical-align: middle;
      height: auto;
      min-width: 24px;
      max-width: 24px;
    }

    .vacation-gantt-help {
      font-size: 9px;
      gap: 4px !important;
    }

    .vacation-gantt-touch-hint {
      font-size: 8px;
    }

    .vacation-actions button {
      font-size: 10px;
      padding: 3px 6px;
    }

    .vacation-view {
      gap: 4px;
    }

    .vacation-helper {
      font-size: 10px;
    }
  }

  /* 繝槭ル繝･繧｢繝ｫ繝｢繝ｼ繝繝ｫ */
  .manual-modal {
    position: fixed;
    inset: 0;
    z-index: 1850;
    display: none;
  }

  .manual-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .5);
  }

  .manual-card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 12px;
    width: min(960px, 94vw);
    max-height: 80vh;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .manual-card>div:first-child {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
    padding: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
  }

  .manual-card>section {
    overflow: auto;
    padding: 0 16px 16px 16px;
    flex: 1;
  }

  .manual-section {
    margin-bottom: 16px;
  }

  .manual-section h4 {
    margin: 8px 0;
  }

  .manual-section table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .manual-section table th,
  .manual-section table td {
    border: 1px solid #ddd;
    padding: 6px;
  }

  /* 繝槭ル繝･繧｢繝ｫ繧ｿ繝・*/
  .manual-tabs {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .manual-tab-btn {
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    border-radius: 6px 6px 0 0;
    background: #f9fafb;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    transition: all .2s;
  }

  .manual-tab-btn:hover {
    background: #f3f4f6;
  }

  .manual-tab-btn.active {
    background: #fff;
    border-bottom-color: #fff;
    color: #0073bb;
    position: relative;
    margin-bottom: -1px;
  }

  .manual-tab-content {
    display: none;
  }

  .manual-tab-content.active {
    display: block;
  }

  /* 繧ｰ繝ｫ繝ｼ繝励Γ繝九Η繝ｼ */
  .grp-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 100%;
    width: max-content;
    max-width: calc(100vw - 32px);
    background: #dff1ff;
    border: 1px solid #bfe4ff;
    border-radius: 8px;
    padding: 4px 0;
    max-height: calc(100vh - var(--header-height) - 20px);
    overflow: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
    z-index: 1600;
    transition: opacity .15s ease;
    opacity: 0;
    pointer-events: none;
  }

  .grp-menu.show {
    opacity: 1;
    pointer-events: auto;
  }

  .grp-menu h4 {
    margin: 0 0 4px;
    padding: 0 12px;
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
  }

  .grp-menu ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .grp-menu li {
    margin: 0;
  }

  .grp-menu button.grp-item {
    display: block;
    width: 100%;
    background: transparent;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    text-align: left;
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    cursor: pointer;
    white-space: nowrap;
  }

  .grp-menu button.grp-item:hover {
    background: #bfe4ff;
  }

  /* 縺顔衍繧峨○繧ｨ繝ｪ繧｢ */
  .notices-area {
    max-width: 100%;
    margin: 0 auto 16px;
    padding: 0 16px;
    transition: all 0.3s ease;
  }

  .notices-container {
    background: #fffbeb;
    border: 1px solid #fbbf24;
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
  }

  .notices-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    cursor: pointer;
    user-select: none;
    transition: background .2s;
    padding: 4px 8px;
    margin: -4px -8px 8px -8px;
    border-radius: 4px;
  }

  .notices-header:hover {
    background: rgba(251, 191, 36, 0.1);
  }

  .notices-title {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #92400e;
  }

  .notices-hint {
    font-size: 11px;
    color: #b45309;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 6px;
  }

  .notices-summary {
    font-size: 14px;
    color: #92400e;
    font-weight: 400;
  }

  .notices-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* 縺顔衍繧峨○繧ｨ繝ｪ繧｢縺碁哩縺倥※縺・ｋ迥ｶ諷・*/
  .notices-area.collapsed .notices-list {
    display: none;
  }

  .notices-area.collapsed .notices-summary {
    display: inline !important;
  }

  .notice-item {
    background: #fff;
    border: 1px solid #fbbf24;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all .2s;
  }

  .notice-item:hover {
    background: #fef3c7;
    border-color: #f59e0b;
  }

  .notice-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #92400e;
    user-select: none;
  }

  .notice-toggle {
    font-size: 14px;
    transition: transform .2s;
  }

  .notice-item.expanded .notice-toggle {
    transform: rotate(90deg);
  }

  .notice-title {
    flex: 1;
    font-size: 14px;
  }

  .notice-content {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #fbbf24;
    font-size: 14px;
    color: #78350f;
    line-height: 1.6;
    white-space: pre-wrap;
    display: none;
  }

  .notice-item.expanded .notice-content {
    display: block;
  }

  .notice-content a {
    color: #0073bb;
    text-decoration: underline;
    word-break: break-all;
  }

  .notice-content a:hover {
    color: #005a8f;
  }

  /* 繧ｿ繧､繝医Ν縺ｮ縺ｿ縺ｮ縺顔衍繧峨○縺ｯ髢矩哩荳崎ｦ・*/
  .notice-item.title-only {
    cursor: default;
  }

  .notice-item.title-only .notice-toggle {
    display: none;
  }

  .notice-item.title-only:hover {
    background: #fff;
  }

  /* 縺顔衍繧峨○邂｡逅・I */
  .notices-editor,
  .tools-editor {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 12px;
  }

  .notice-edit-item,
  .tool-edit-item {
    background: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 12px;
  }

  .notice-edit-row,
  .tool-edit-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .notice-edit-item input[type="text"],
  .tool-edit-item input[type="text"],
  .tool-edit-item input[type="url"] {
    flex: 1;
    margin-left: 24px;
    min-width: 160px;
  }

  .notice-edit-item textarea,
  .tool-edit-item textarea {
    width: 100%;
    min-height: 80px;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
  }

  .btn-remove-notice,
  .btn-remove-tool {
    background: #ef4444;
    color: #fff;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-remove-notice:hover,
  .btn-remove-tool:hover {
    background: #dc2626;
  }

  /* 縺顔衍繧峨○邂｡逅・/ 繝・・繝ｫ邂｡逅・ｼ医ち繝門・・・*/
  .notices-manager,
  .tools-manager {
    display: flex;
    flex-direction: column;
  }

  .notices-manager-toolbar,
  .tools-manager-toolbar {
    flex: 0 0 auto;
    background: #fff;
    padding: 8px 0 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    border-bottom: 1px solid #e5e7eb;
  }

  .notices-manager-scroll,
  .tools-manager-scroll {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
    padding: 12px 0 8px;
    max-height: calc(80vh - 280px);
  }

  .notices-manager-info,
  .tools-manager-info {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    color: #1e40af;
  }

  .notices-manager-info p,
  .tools-manager-info p {
    margin: 0;
    line-height: 1.6;
  }

  .notices-manager-actions,
  .tools-manager-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .btn-primary {
    background: #0073bb;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background .2s;
  }

  .btn-primary:hover {
    background: #005a94;
  }

  .btn-secondary {
    background: #6b7280;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background .2s;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  .btn-danger {
    background: #ef4444;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background .2s;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-success {
    background: #10b981;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background .2s;
  }

  .btn-success:hover {
    background: #059669;
  }

  /* 繝峨Λ繝・げ&繝峨Ο繝・・蟇ｾ蠢懊・縺顔衍繧峨○/繝・・繝ｫ繧ｨ繝・ぅ繧ｿ繧｢繧､繝・Β */
  .notice-edit-item,
  .tool-edit-item {
    position: relative;
    background: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 12px;
    transition: all .2s;
    cursor: move;
  }

  .notice-edit-item:hover,
  .tool-edit-item:hover {
    border-color: #9ca3af;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
  }

  .notice-edit-item.dragging,
  .tool-edit-item.dragging {
    opacity: 0.5;
    border-color: #0073bb;
    background: #e0f2fe;
  }

  .notice-edit-item.drag-over,
  .tool-edit-item.drag-over {
    border-top: 3px solid #0073bb;
  }

  .notice-edit-handle,
  .tool-edit-handle {
    position: absolute;
    left: 12px;
    top: 12px;
    font-size: 18px;
    color: #9ca3af;
    cursor: move;
    user-select: none;
  }

  .notice-edit-controls,
  .tool-edit-controls {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .notice-visibility-toggle,
  .tool-visibility-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 4px 8px;
  }

  .notice-visibility-toggle input[type="checkbox"],
  .tool-visibility-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
  }

  .notice-edit-item.hidden-notice,
  .tool-edit-item.hidden-tool {
    border-style: dashed;
    opacity: 0.7;
    background: #fef3c7;
  }

  .btn-move-up,
  .btn-move-down {
    background: #6b7280;
    color: #fff;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background .2s;
  }

  .btn-move-up:hover {
    background: #4b5563;
  }

  .btn-move-down:hover {
    background: #4b5563;
  }

  .btn-move-up:disabled,
  .btn-move-down:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    opacity: 0.5;
  }

  /* 蜊ｰ蛻ｷ逕ｨCSS */
  @media print {

    /* 蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ縺ｪ縺ｩ繧､繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ莉･螟悶ｒ髱櫁｡ｨ遉ｺ */
    header,
    .wrap,
    #board,
    #noticesArea,
    #adminModal,
    #manualModal,
    #noticeModal {
      display: none !important;
    }

    /* 繧､繝吶Φ繝医Δ繝ｼ繝繝ｫ繧貞ｼｷ蛻ｶ陦ｨ遉ｺ */
    #eventModal {
      display: block !important;
      position: static !important;
      background: white !important;
      padding: 0 !important;
      margin: 0 !important;
      width: 100% !important;
      height: auto !important;
    }

    /* 繧､繝吶Φ繝医Δ繝ｼ繝繝ｫ蜀・・荳崎ｦ√↑隕∫ｴ繧帝撼陦ｨ遉ｺ */
    #eventModal .event-modal-header,
    #eventModal .event-select-toolbar,
    #eventModal .event-toolbar,
    #eventModal .vacation-actions,
    #eventModal .vacation-group-jumps,
    #eventModal .event-legend,
    #eventModal button {
      display: none !important;
    }

    /* 繝壹・繧ｸ險ｭ螳・*/
    @page {
      size: A4 landscape;
      margin: 15mm;
    }

    body {
      margin: 0 !important;
      padding: 0 !important;
      background: white !important;
      overflow: visible !important;
    }

    /* 縺吶∋縺ｦ縺ｮ隕ｪ隕∫ｴ繧定｡ｨ遉ｺ */
    html,
    body {
      display: block !important;
      visibility: visible !important;
    }

    /* admin-card繧貞・逕ｻ髱｢陦ｨ遉ｺ */
    #eventModal .admin-card {
      display: block !important;
      max-height: none !important;
      max-width: none !important;
      width: 100%;
      border: none;
      box-shadow: none;
      overflow: visible;
      position: static !important;
    }

    #eventModal .admin-card-body {
      overflow: visible !important;
      padding: 0 !important;
      max-height: none !important;
    }

    #eventModal .tab-panel {
      display: block !important;
    }

    #eventModal .vacation-view {
      display: block !important;
    }

    /* 蜊ｰ蛻ｷ逕ｨ蝗ｺ螳壹・繝・ム繝ｼ・亥・繝壹・繧ｸ荳企Κ縺ｫ陦ｨ遉ｺ・・*/
    #eventPrintInfo {
      display: block !important;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      padding: 10px 15px;
      border-bottom: 2px solid #333;
      background: white !important;
      color: #000;
      z-index: 9999;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    #eventGanttWrap {
      display: block !important;
      margin: 0 !important;
      padding: 0 !important;
      /* 蝗ｺ螳壹・繝・ム繝ｼ蛻・・荳翫・繝ｼ繧ｸ繝ｳ繧堤｢ｺ菫・*/
      margin-top: 50px !important;
    }

    #eventGantt {
      display: block !important;
      margin: 0 !important;
    }

    /* 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医ｒ蜊ｰ蛻ｷ逕ｨ縺ｫ譛驕ｩ蛹・*/
    .vacation-gantt {
      max-height: none !important;
      overflow: visible !important;
      border: 1px solid #000;
      page-break-inside: auto;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* 繝・・繝悶Ν蜈ｨ菴薙ｒ遒ｺ螳溘↓陦ｨ遉ｺ */
    .vacation-gantt table {
      display: table !important;
      width: 100%;
      border-collapse: collapse;
    }

    .vacation-gantt table {
      font-size: 10px;
      border-collapse: collapse;
    }

    .vacation-gantt th,
    .vacation-gantt td {
      border: 1px solid #333;
      padding: 3px 2px;
    }

    .vacation-gantt thead {
      display: table-header-group;
    }

    .vacation-gantt thead th {
      position: static !important;
      background: #f0f0f0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt tbody {
      display: table-row-group;
    }

    /* 繝・・繝悶Ν繝倥ャ繝繝ｼ縺ｨ繧､繝吶Φ繝医・繝・ム繝ｼ縺碁㍾縺ｪ繧峨↑縺・ｈ縺・↓ */
    .vacation-gantt table {
      margin-top: 0 !important;
    }

    .vacation-gantt th.member-name {
      position: static;
      left: auto;
      background: #fff !important;
    }

    .vacation-gantt th.group-name {
      position: static;
      left: auto;
      background: #f5f5f5 !important;
    }

    /* 繝薙ャ繝郁ｨｭ螳壽ｸ医∩繧ｻ繝ｫ縺ｮ陦ｨ遉ｺ */
    .vacation-gantt .vac-cell.on {
      background: #0ea5e9 !important;
      color: #fff !important;
      font-weight: 700;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-sat {
      background: #e0f2fe !important;
      color: #0f172a !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-sun {
      background: #fee2e2 !important;
      color: #7f1d1d !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-holiday {
      background: #ffe4e6 !important;
      color: #9f1239 !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-amber {
      background: #fef3c7 !important;
      color: #92400e !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-mint {
      background: #dcfce7 !important;
      color: #166534 !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-lavender {
      background: #ede9fe !important;
      color: #4c1d95 !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .vac-cell.on.vac-color-slate {
      background: #e5e7eb !important;
      color: #111827 !important;
      background-image: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.25)) !important;
      box-shadow: inset 0 0 0 2px #0284c7 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* 騾ｱ譛ｫ繝ｻ逾晄律縺ｮ陦ｨ遉ｺ */
    .vacation-gantt .weekend-sat {
      background: #e8f4f8 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .vacation-gantt .weekend-sun,
    .vacation-gantt .holiday {
      background: #ffe8e8 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* 繝上う繝ｩ繧､繝医Γ繝ｳ繝舌・ */
    .vacation-gantt th.member-name.member-has-bit {
      background: #ddd !important;
      font-weight: 700;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医・繝壹・繧ｸ蛻・牡 */
    .vacation-gantt {
      page-break-before: avoid;
    }

    /* 繝・・繝悶Ν陦後・繝壹・繧ｸ蛻・牡繧帝亟豁｢ */
    .vacation-gantt tr {
      page-break-inside: avoid;
    }



    /* 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医ユ繝ｼ繝悶Ν縺ｮ繝倥ャ繝繝ｼ繧貞推繝壹・繧ｸ縺ｧ郢ｰ繧願ｿ斐☆ */
    .vacation-gantt thead {
      display: table-header-group;
    }

    .vacation-gantt tbody {
      display: table-row-group;
    }
  }

  /* === Migrated Utilities & Components (v1.5) === */

  /* Utilities */
  .u-flex-between-center {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .u-mb-8 {
    margin-bottom: 8px !important;
  }

  .u-mt-6 {
    margin-top: 6px;
  }

  .u-mt-12 {
    margin-top: 12px;
  }

  .u-mt-16 {
    margin-top: 16px;
  }

  .u-mr-4 {
    margin-right: 4px;
  }

  .u-mb-0 {
    margin-bottom: 0 !important;
  }

  .u-text-center {
    text-align: center;
  }

  .u-text-gray {
    color: #6b7280;
  }

  .u-text-red {
    color: #d00;
  }

  .u-font-sm {
    font-size: 11px;
  }

  .u-font-13 {
    font-size: 13px;
  }

  .u-font-09em {
    font-size: 0.9em;
  }

  .u-font-095em {
    font-size: 0.95em;
  }

  .u-w-44 {
    width: 44px;
  }

  .u-w-64 {
    width: 64px;
  }

  .u-w-160 {
    width: 160px;
  }

  .u-hidden {
    display: none;
  }

  .u-bold {
    font-weight: bold;
  }

  .u-link-blue {
    color: #0073bb;
    text-decoration: underline;
  }

  .u-cursor-pointer {
    cursor: pointer;
  }

  .u-lh-16 {
    line-height: 1.6;
  }

  .u-lh-18 {
    line-height: 1.8;
  }

  .u-inline-block {
    display: inline-block;
  }

  /* Components: Manual & Admin */
  .manual-alert {
    padding: 12px;
    margin: 12px 0;
    border-left-width: 4px;
    border-left-style: solid;
    border-radius: 4px;
  }

  .manual-alert-info {
    background: #f0f8ff;
    border-left-color: #0073bb;
  }

  .manual-alert-success {
    background: #e7f8e7;
    border-left-color: #4ade80;
  }

  .manual-alert-teal {
    background: #d1ecf1;
    border-left-color: #0c5460;
  }

  .manual-alert-warning {
    background: #fff3cd;
    border-left-color: #ffc107;
  }

  .manual-alert-danger {
    background: #f8d7da;
    border-left-color: #dc3545;
  }

  .manual-hint {
    background: #fff3cd;
    padding: 10px;
    margin: 10px 0;
    border-left: 3px solid #ffc107;
    border-radius: 3px;
  }

  .status-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 12px;
    font-size: 0.9em;
  }

  .status-table th,
  .status-table td {
    padding: 6px;
    border: 1px solid #ddd;
  }

  .status-table tr:first-child {
    background: #f5f5f5;
  }

  .manual-details {
    margin: 8px 0;
  }

  .manual-details summary {
    cursor: pointer;
    font-weight: bold;
    padding: 4px 0;
  }

  .manual-details p {
    margin: 8px 0 8px 20px;
  }

  .admin-modal-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .login-msg {
    color: #0073bb;
    margin-top: 8px;
  }

  .u-flex-end-gap {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .u-m-0 {
    margin: 0 !important;
  }

  .u-mt-0 {
    margin-top: 0 !important;
  }

  .u-mt-4 {
    margin-top: 4px;
  }

  .u-mt-8 {
    margin-top: 8px;
  }

  .u-mb-12 {
    margin-bottom: 12px;
  }

  .u-mb-16 {
    margin-bottom: 16px;
  }

  .u-my-8 {
    margin: 8px 0;
  }

  .u-pl-20 {
    padding-left: 20px;
  }

  .u-visually-hidden {
    position: fixed;
    left: -9999px;
    opacity: 0;
  }

  .manual-subtext {
    margin: 8px 0 16px 0;
    color: #666;
    font-size: 0.9em;
  }
</style>
</head>

<body>
  <header>
    <div class="title-wrap">
      <button id="titleBtn" class="title-btn" aria-haspopup="true" aria-expanded="false"
        aria-controls="groupMenu">蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ</button>
      <div id="groupMenu" class="grp-menu" role="menu" aria-labelledby="titleBtn">
        <h4 id="groupMenuTitle">繧ｰ繝ｫ繝ｼ繝励↓繧ｸ繝｣繝ｳ繝・/h4>
        <ul id="groupMenuList"></ul>
      </div>
    </div>
    <button id="adminBtn" class="admin-btn" title="邂｡逅・>邂｡逅・/button>
    <input id="nameFilter" class="name-filter" type="search" placeholder="豌丞錐讀懃ｴ｢・亥・蜉帙→蜷梧凾縺ｫ邨槭ｊ霎ｼ縺ｿ・・ aria-label="豌丞錐讀懃ｴ｢"
      autocomplete="off" name="member_search_query" />
    <select id="statusFilter" class="status-filter" aria-label="繧ｹ繝・・繧ｿ繧ｹ縺ｧ邨槭ｊ霎ｼ縺ｿ"></select>
    <button id="noticesBtn" class="notices-btn" title="縺顔衍繧峨○">縺顔衍繧峨○</button>
    <button id="eventBtn" class="event-btn" title="繧､繝吶Φ繝・>套 繧､繝吶Φ繝・/button>
    <button id="toolsBtn" class="tools-btn" title="繝・・繝ｫ">屏・・繝・・繝ｫ</button>
    <button id="logoutBtn" class="logout-btn" title="繝ｭ繧ｰ繧ｪ繝・>繝ｭ繧ｰ繧ｪ繝・/button>
    <button id="manualBtn" class="manual-btn" title="繝槭ル繝･繧｢繝ｫ">繝槭ル繝･繧｢繝ｫ</button>
  </header>

  <!-- 邂｡逅・Δ繝ｼ繝繝ｫ -->
  <div id="adminModal" class="admin-modal" aria-modal="true" role="dialog">
    <div class="admin-card">
      <div class="admin-card-header">
        <div class="admin-modal-header-row">
          <h3>邂｡逅・ヱ繝阪Ν</h3><button id="adminClose">髢峨§繧・/button>
        </div>

        <!-- 繧ｿ繝悶リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ -->
        <div class="admin-tabs">
          <div class="tab-buttons">
            <button class="tab-btn active" data-tab="basic">笞呻ｸ・蝓ｺ譛ｬ險ｭ螳・/button>
            <button class="tab-btn" data-tab="members">則 繝｡繝ｳ繝舌・邂｡逅・/button>
            <button class="tab-btn" data-tab="notices">討 縺顔衍繧峨○邂｡逅・/button>
            <button class="tab-btn" data-tab="events">套 繧､繝吶Φ繝育ｮ｡逅・/button>
            <button class="tab-btn" data-tab="tools">屏・・繝・・繝ｫ邂｡逅・/button>
          </div>
        </div>
      </div>

      <div class="admin-card-body">

        <!-- 繧ｿ繝悶ヱ繝阪Ν1: 蝓ｺ譛ｬ險ｭ螳・-->
        <div id="tabBasic" class="tab-panel active" data-tab="basic">
          <div class="admin-grid">
            <div class="admin-box admin-box-stacked">
              <h4>刀 CSV邂｡逅・/h4>
              <div class="admin-subsection">
                <h5>踏 蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ繝ｪ繧ｹ繝・繧ｨ繧ｯ繧ｹ繝昴・繝・/h5>
                <div class="admin-row"><button id="btnExport">繝繧ｦ繝ｳ繝ｭ繝ｼ繝・/button></div>
                <div class="admin-note">蠖｢蠑擾ｼ壹げ繝ｫ繝ｼ繝礼分蜿ｷ,繧ｰ繝ｫ繝ｼ繝怜錐,陦ｨ遉ｺ鬆・id,豌丞錐,蜀・ｷ・謳ｺ蟶ｯ逡ｪ蜿ｷ,Email,讌ｭ蜍呎凾髢・繧ｹ繝・・繧ｿ繧ｹ,謌ｻ繧頑凾髢・蛯呵・/div>
                <div class="admin-note u-font-sm u-text-gray">窶ｻ蠕捺擂繝輔か繝ｼ繝槭ャ繝茨ｼ域声蟶ｯ逡ｪ蜿ｷ繝ｻEmail蛻励↑縺暦ｼ峨ｂ蠑輔″邯壹″蟇ｾ蠢・/div>
              </div>
              <div class="admin-subsection">
                <h5>豆 蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ繝ｪ繧ｹ繝・繧､繝ｳ繝昴・繝・/h5>
                <div class="admin-row"><input type="file" id="csvFile" accept=".csv,text/csv" /><button
                    id="btnImport">蜿悶ｊ霎ｼ縺ｿ</button></div>
              </div>
            </div>

            <div class="admin-box admin-box-stacked">
              <h4>召 諡轤ｹ險ｭ螳・/h4>
              <div class="admin-subsection">
                <h5>諡轤ｹ蜷阪・螟画峩</h5>
                <div class="admin-row"><input id="renameOfficeName" placeholder="譁ｰ縺励＞諡轤ｹ蜷・ /><button
                    id="btnRenameOffice">螟画峩</button></div>
              </div>
              <div class="admin-subsection">
                <h5>諡轤ｹ繝代せ繝ｯ繝ｼ繝峨・螟画峩</h5>
                <div class="admin-row">
                  <input id="setPw" placeholder="譁ｰ繝代せ繝ｯ繝ｼ繝会ｼ井ｻｻ諢擾ｼ・ />
                  <input id="setAdminPw" placeholder="譁ｰ邂｡逅・・W・井ｻｻ諢擾ｼ・ />
                  <button id="btnSetPw">譖ｴ譁ｰ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 繧ｿ繝悶ヱ繝阪Ν: 繝｡繝ｳ繝舌・邂｡逅・-->
        <div id="tabMembers" class="tab-panel" data-tab="members">
          <div class="member-save-bar">
            <button id="btnMemberSave" class="btn-primary">沈 菫晏ｭ・/button>
          </div>
          <div class="members-panel">
            <div class="admin-box" id="memberEditTop">
              <div class="admin-box-header">
                <h4>則 繝｡繝ｳ繝舌・荳隕ｧ繝ｻ邱ｨ髮・/h4>
              </div>
              <div class="admin-note">繝峨Λ繝・げ縺ｾ縺溘・竊鯛・繝懊ち繝ｳ縺ｧ荳ｦ縺ｳ譖ｿ縺医∫ｷｨ髮・・繧ｿ繝ｳ縺ｧ隧ｳ邏ｰ繧呈峩譁ｰ縺ｧ縺阪∪縺吶・/div>
              <form id="memberEditForm" class="member-edit-form member-inline-form">
                <input type="hidden" id="memberEditId" />
                <div class="member-edit-grid">
                  <label>豌丞錐・亥ｿ・茨ｼ・
                    <input id="memberEditName" type="text" required placeholder="萓具ｼ壼ｱｱ逕ｰ 螟ｪ驛・ />
                  </label>
                  <label>謇螻槭げ繝ｫ繝ｼ繝暦ｼ亥ｿ・茨ｼ・
                    <input id="memberEditGroup" type="text" list="memberGroupOptions" placeholder="譌｢蟄倥げ繝ｫ繝ｼ繝励ｒ驕ｸ謚・or 蜈･蜉・ />
                    <datalist id="memberGroupOptions"></datalist>
                  </label>
                  <label>蜀・ｷ・
                    <input id="memberEditExt" type="tel" inputmode="numeric" placeholder="謨ｰ蟄励・縺ｿ" />
                  </label>
                  <label>謳ｺ蟶ｯ
                    <input id="memberEditMobile" type="tel" inputmode="tel" placeholder="萓具ｼ・90-1234-5678" />
                  </label>
                  <label>Email
                    <input id="memberEditEmail" type="email" placeholder="example@example.com" />
                  </label>
                </div>
                <div class="member-edit-actions">
                  <div class="member-edit-actions-left">
                    <span id="memberEditModeLabel" class="member-edit-mode">譁ｰ隕剰ｿｽ蜉・冗ｷｨ髮・ヵ繧ｩ繝ｼ繝</span>
                  </div>
                  <div class="member-edit-actions-right">
                    <button type="button" id="memberEditReset" class="btn-secondary">繝輔か繝ｼ繝繧偵け繝ｪ繧｢</button>
                    <button type="submit" class="btn-primary">沈 霑ｽ蜉・乗峩譁ｰ</button>
                  </div>
                </div>
              </form>
              <div class="admin-subsection">
                <h5>逃 繧ｰ繝ｫ繝ｼ繝嶺ｸｦ縺ｳ譖ｿ縺・/h5>
                <div class="admin-note">竊鯛・繝懊ち繝ｳ縺ｧ繧ｰ繝ｫ繝ｼ繝励・荳ｦ縺ｳ鬆・ｒ螟画峩縺ｧ縺阪∪縺吶ゆｿ晏ｭ俶凾縺ｯ繝｡繝ｳ繝舌・鬆・ｒ邯ｭ謖√＠縺溘∪縺ｾ繧ｰ繝ｫ繝ｼ繝鈴・・縺ｿ蜿肴丐縺輔ｌ縺ｾ縺吶・/div>
                <div id="groupOrderList" class="group-order-list"></div>
                <div id="groupOrderEmpty" class="admin-note u-mt-6">繧ｰ繝ｫ繝ｼ繝励′縺ゅｊ縺ｾ縺帙ｓ縲・/div>
              </div>
              <div class="member-filter-row">
                <label for="memberFilterInput" class="member-filter-label">豌丞錐繝輔ぅ繝ｫ繧ｿ繝ｼ</label>
                <div class="member-filter-controls">
                  <input id="memberFilterInput" type="search" placeholder="蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ縺ｮ豌丞錐縺ｧ邨槭ｊ霎ｼ縺ｿ" aria-label="豌丞錐繝輔ぅ繝ｫ繧ｿ繝ｼ" />
                  <button id="btnMemberFilterClear" class="btn-secondary" type="button">繧ｯ繝ｪ繧｢</button>
                </div>
              </div>
              <div class="member-table-wrap">
                <table class="member-table">
                  <thead>
                    <tr>
                      <th>鬆・分</th>
                      <th>繧ｰ繝ｫ繝ｼ繝・/th>
                      <th>豌丞錐</th>
                      <th>蜀・ｷ・/th>
                      <th>謳ｺ蟶ｯ</th>
                      <th>Email</th>
                      <th>謫堺ｽ・/th>
                    </tr>
                  </thead>
                  <tbody id="memberTableBody">
                    <tr>
                      <td colspan="7" class="u-text-center u-text-gray">隱ｭ縺ｿ霎ｼ縺ｿ蠕・■</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 繧ｿ繝悶ヱ繝阪Ν2: 縺顔衍繧峨○邂｡逅・-->
        <div id="tabNotices" class="tab-panel" data-tab="notices">
          <div class="notices-manager">
            <div class="notices-manager-toolbar">
              <div class="notices-manager-info">
                <p>縺顔衍繧峨○縺ｮ鬆・分縺ｯ繝峨Λ繝・げ&繝峨Ο繝・・縺ｾ縺溘・竊鯛・繝懊ち繝ｳ縺ｧ蜈･繧梧崛縺医ｉ繧後∪縺吶ゆｸ翫↓縺ゅｋ繧ゅ・縺九ｉ鬆・↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺吶・/p>
                <p>縲瑚｡ｨ遉ｺ縺吶ｋ縲阪メ繧ｧ繝・け縺ｧ蜈ｬ髢・髱槫・髢九ｒ蛻・ｊ譖ｿ縺医ｉ繧後∪縺吶ょ炎髯､繝懊ち繝ｳ繧呈款縺吶→遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺吶・/p>
              </div>
              <div class="notices-manager-actions">
                <button id="btnAddNotice" class="btn-primary">筐・縺顔衍繧峨○繧定ｿｽ蜉</button>
                <button id="btnLoadNotices" class="btn-secondary">売 隱ｭ縺ｿ霎ｼ縺ｿ</button>
                <button id="btnSaveNotices" class="btn-success">沈 菫晏ｭ・/button>
              </div>
            </div>

            <div class="notices-manager-scroll">
              <div id="noticesEditor" class="notices-editor"></div>
            </div>
          </div>
        </div>

        <!-- 繧ｿ繝悶ヱ繝阪Ν3: 繧､繝吶Φ繝育ｮ｡逅・-->
        <div id="tabEvents" class="tab-panel" data-tab="events">
          <div class="vacation-grid">
            <div class="admin-box">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <h4 style="margin:0;">逋ｻ骭ｲ貂医∩縺ｮ繧､繝吶Φ繝・/h4>
                <button id="btnExportEvent" class="btn-secondary u-font-13">塘 繧､繝吶Φ繝医ｒ繧ｨ繧ｯ繧ｹ繝昴・繝・/button>
              </div>
              <div class="vacation-table-wrap">
                <table class="vacation-table">
                  <thead>
                    <tr>
                      <th class="u-w-44">荳ｦ縺ｳ</th>
                      <th>繧ｿ繧､繝医Ν</th>
                      <th>譛滄俣</th>
                      <th>蟇ｾ雎｡諡轤ｹ</th>
                      <th>莨第嚊蝗ｺ螳夲ｼ育ｨｮ蛻･・・/th>
                      <th>濶ｲ</th>
                      <th>蛯呵・/th>
                      <th>陦ｨ遉ｺ</th>
                      <th>謫堺ｽ・/th>
                    </tr>
                  </thead>
                  <tbody id="vacationListBody">
                    <tr>
                      <td colspan="9" class="u-text-center u-text-gray">隱ｭ縺ｿ霎ｼ縺ｿ蠕・■</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="admin-box">
              <h4>繧､繝吶Φ繝医・菴懈・ / 譖ｴ譁ｰ</h4>
              <div class="vacation-form">
                <div class="vacation-row">
                  <label>蟇ｾ雎｡諡轤ｹ
                    <select id="vacationOffice" aria-label="蟇ｾ雎｡諡轤ｹ"></select>
                  </label>
                </div>
                <div class="vacation-row">
                  <label>繧ｿ繧､繝医Ν
                    <input id="vacationTitle" type="text" placeholder="萓・ GW譛滄俣莨第嚊" />
                  </label>
                </div>
                <div class="vacation-row vacation-row-two-cols">
                  <label>髢句ｧ区律
                    <input id="vacationStart" type="date" />
                  </label>
                  <label>邨ゆｺ・律
                    <input id="vacationEnd" type="date" />
                  </label>
                </div>
                <div class="vacation-row vacation-row-inline">
                  <label>縺顔衍繧峨○繧帝∈謚・
                    <select id="vacationNotice" aria-label="繧､繝吶Φ繝医↓邏舌▼縺代ｋ縺顔衍繧峨○"></select>
                  </label>
                  <div class="vacation-inline-actions">
                    <button id="btnCreateNoticeFromEvent" class="btn-secondary">筐・縺顔衍繧峨○譁ｰ隕丈ｽ懈・</button>
                  </div>
                </div>
                <div class="vacation-row vacation-row-two-cols">
                  <label>
                    遞ｮ蛻･
                    <input id="vacationTypeText" type="text" value="莨第嚊蝗ｺ螳夲ｼ井ｸ隕ｧ縺ｧ蛻・崛・・ readonly />
                    <span class="vacation-helper">窶ｻ 遞ｮ蛻･縺ｯ荳隕ｧ縺ｮ縲御ｼ第嚊蝗ｺ螳壹榊・縺ｧ螟画峩縺ｧ縺阪∪縺吶・/span>
                  </label>
                  <label>濶ｲ/繧ｫ繝・ざ繝ｪ繝ｼ
                    <select id="vacationColor" aria-label="濶ｲ/繧ｫ繝・ざ繝ｪ繝ｼ">
                      <option value="amber">繧ｵ繝九・</option>
                      <option value="blue">繝悶Ν繝ｼ</option>
                      <option value="green">繧ｰ繝ｪ繝ｼ繝ｳ</option>
                      <option value="pink">繝斐Φ繧ｯ</option>
                      <option value="purple">繝代・繝励Ν</option>
                      <option value="teal">繝・ぅ繝ｼ繝ｫ</option>
                      <option value="gray">繧ｰ繝ｬ繝ｼ</option>
                    </select>
                  </label>
                </div>
                <div class="vacation-row u-hidden">
                  <label>繝｡繝ｳ繝舌・縺ｮ莨第嚊謖・ｮ夲ｼ医ぎ繝ｳ繝医〒閾ｪ蜍募・蜉幢ｼ・
                    <input id="vacationMembersBits" type="text" placeholder="繧ｬ繝ｳ繝亥・蜉帙〒閾ｪ蜍募渚譏縺輔ｌ縺ｾ縺・ readonly />
                    <span class="vacation-helper">窶ｻ 謇句・蜉帙・荳崎ｦ√〒縺吶ゆｸ九・繧ｬ繝ｳ繝郁｡ｨ縺ｧ莨第嚊縺ｫ縺励◆縺・Γ繝ｳ繝舌・縺ｨ譌･莉倥ｒON縺ｫ縺励※縺上□縺輔＞縲・/span>
                  </label>
                </div>
                <div class="vacation-actions">
                  <button id="btnVacationSave" class="btn-primary">沈 菴懈・/譖ｴ譁ｰ</button>
                  <button id="btnVacationDelete" class="btn-danger">卵・・蜑企勁</button>
                  <button id="btnVacationClear" class="btn-secondary">ｧｹ 蜈･蜉帙け繝ｪ繧｢</button>
                  <button id="btnVacationReload" class="btn-secondary">売 荳隕ｧ譖ｴ譁ｰ</button>
                </div>
                <div class="vacation-row u-hidden">
                  <div class="vacation-gantt-head">
                    <div class="vacation-gantt-title">繧ｬ繝ｳ繝亥・蜉・/div>
                    <div class="vacation-gantt-help">髢句ｧ区律/邨ゆｺ・律縺ｫ蜷医ｏ縺帙※譌･莉倥せ繝ｭ繝・ヨ繧堤函謌舌＠縲√そ繝ｫ繧偵け繝ｪ繝・け/繝峨Λ繝・げ・医せ繝槭・縺ｯ繧ｿ繝・・・峨☆繧九→繝薙ャ繝医′蛻・ｊ譖ｿ繧上ｊ縺ｾ縺吶・/div>
                  </div>
                  <div id="vacationGantt" class="vacation-gantt" aria-live="polite"></div>
                </div>
                <div class="vacation-row u-hidden">
                  <label>ID・郁・蜍戊ｨｭ螳夲ｼ・
                    <input id="vacationId" type="text" readonly placeholder="譁ｰ隕丈ｽ懈・譎ゅ・遨ｺ谺・・縺ｾ縺ｾ" />
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 繧ｿ繝悶ヱ繝阪Ν4: 繝・・繝ｫ邂｡逅・-->
        <div id="tabTools" class="tab-panel" data-tab="tools">
          <div class="tools-manager">
            <div class="tools-manager-toolbar">
              <div class="tools-manager-info">
                <p>繝・・繝ｫ縺ｮ鬆・分縺ｯ繝峨Λ繝・げ&繝峨Ο繝・・縺ｾ縺溘・竊鯛・繝懊ち繝ｳ縺ｧ蜈･繧梧崛縺医ｉ繧後∪縺吶ゆｸ翫↓縺ゅｋ繧ゅ・縺九ｉ鬆・↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺吶・/p>
                <p>繧ｿ繧､繝医Ν縺ｨURL縲∝ｙ閠・ｒ蜈･蜉帙〒縺阪∪縺吶り｡ｨ遉ｺ繧丹FF縺ｫ縺励◆繝・・繝ｫ縺ｯ蛻ｩ逕ｨ閠・判髱｢縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ縲・/p>
              </div>
              <div class="tools-manager-actions">
                <button id="btnAddTool" class="btn-primary">筐・繝・・繝ｫ繧定ｿｽ蜉</button>
                <button id="btnLoadTools" class="btn-secondary">売 隱ｭ縺ｿ霎ｼ縺ｿ</button>
                <button id="btnSaveTools" class="btn-success">沈 菫晏ｭ・/button>
              </div>
            </div>

            <div class="tools-manager-scroll">
              <div id="toolsEditor" class="tools-editor"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- 繧､繝吶Φ繝医Δ繝ｼ繝繝ｫ -->
  <div id="eventModal" class="admin-modal event-modal" aria-modal="true" role="dialog" aria-label="繧､繝吶Φ繝郁｡ｨ遉ｺ險ｭ螳・>
    <div class="admin-card">
      <div class="event-modal-header">
        <h3 class="event-modal-title">繧､繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ</h3>
        <button id="eventClose">髢峨§繧・/button>
      </div>

      <!-- 繧ｿ繝悶ヱ繝阪Ν: 繧､繝吶Φ繝磯∈謚・-->
      <div id="tabEvent" class="tab-panel active">
        <div class="vacation-view">
          <div class="event-select-toolbar">
            <label class="event-select-label">
              <span>繧､繝吶Φ繝医ｒ驕ｸ謚・</span>
              <select id="eventSelectDropdown" class="event-select-dropdown"></select>
            </label>
            <button id="btnShowEventNotice" class="btn-secondary btn-show-event-notice u-hidden">塘
              繧､繝吶Φ繝医・蜀・ｮｹ繧定｡ｨ遉ｺ</button>
          </div>
          <div id="vacationRadioList" class="vacation-radio-list u-hidden"></div>
          <div id="eventGanttWrap" class="vacation-gantt-head">
            <div class="vacation-gantt-sticky-header">
              <div class="event-toolbar">
                <div class="event-toolbar__hint">
                  <span class="vacation-gantt-touch-hint">繧ｻ繝ｫ繧偵け繝ｪ繝・け/繝峨Λ繝・げ・医せ繝槭・縺ｯ繧ｿ繝・・・峨☆繧九→ON/OFF繧貞・繧頑崛縺医ｉ繧後∪縺吶・/span>
                  <span id="eventColorManualHint" class="event-color-manual-hint u-hidden" role="status"
                    aria-live="polite"></span>
                </div>
                <div class="vacation-actions u-mb-0 u-flex-end-gap">
                  <button id="btnEventPrint" class="btn-secondary">蜜・・蜊ｰ蛻ｷ</button>
                </div>
              </div>
              <div id="eventGroupJumps" class="vacation-group-jumps u-hidden" aria-label="繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝・>
                <span class="jump-label">繧ｰ繝ｫ繝ｼ繝礼ｧｻ蜍・/span>
                <div class="jump-buttons" aria-label="繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝励・繧ｿ繝ｳ"></div>
                <label class="jump-select u-hidden" aria-label="繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝鈴∈謚・>
                  <span class="sr-only">繧ｰ繝ｫ繝ｼ繝励ｒ驕ｸ謚・/span>
                  <select id="eventGroupJumpSelect"></select>
                </label>
              </div>
              <div id="eventLegendModal" class="event-legend event-legend-compact" aria-live="polite"></div>
            </div>
            <div id="eventPrintInfo" class="u-hidden"></div>
            <div id="eventGantt" class="vacation-gantt" aria-live="polite"></div>
            <input id="eventStart" type="hidden" />
            <input id="eventEnd" type="hidden" />
            <input id="eventBits" type="hidden" />
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 縺顔衍繧峨○繝励Ξ繝薙Η繝ｼ繝｢繝ｼ繝繝ｫ・医う繝吶Φ繝育ｵ檎罰蟆ら畑・・-->
  <div id="noticeModal" class="admin-modal notice-modal" aria-modal="true" role="dialog"
    aria-labelledby="noticeModalTitle" aria-hidden="true">
    <div class="admin-card notice-modal-card">
      <div class="notice-modal-header">
        <h3 id="noticeModalTitle">髢｢騾｣縺顔衍繧峨○</h3>
        <button id="noticeModalClose" aria-label="髢峨§繧・>髢峨§繧・/button>
      </div>
      <div id="noticeModalBody" class="notice-modal-body"></div>
    </div>
  </div>

  <!-- 繝・・繝ｫ繝｢繝ｼ繝繝ｫ -->
  <div id="toolsModal" class="admin-modal tools-modal" aria-modal="true" role="dialog"
    aria-labelledby="toolsModalTitle">
    <div class="admin-card tools-modal-card">
      <div class="tools-modal-header">
        <h3 id="toolsModalTitle">屏・・繝・・繝ｫ荳隕ｧ</h3>
        <button id="toolsModalClose" aria-label="髢峨§繧・>髢峨§繧・/button>
      </div>
      <div id="toolsList" class="tools-list">
        <div class="tools-empty">繝・・繝ｫ諠・ｱ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺吮ｦ</div>
      </div>
    </div>
  </div>

  <!-- 繝槭ル繝･繧｢繝ｫ繝｢繝ｼ繝繝ｫ -->
  <div id="manualModal" class="manual-modal" aria-modal="true" role="dialog" aria-labelledby="manualTitle">
    <div class="manual-card" role="document">
      <div>
        <div class="admin-modal-header-row u-mb-12">
          <h3 id="manualTitle" class="u-m-0">繝槭ル繝･繧｢繝ｫ</h3>
          <button id="manualClose" aria-label="髢峨§繧・>髢峨§繧・/button>
        </div>
        <div class="manual-tabs">
          <button class="manual-tab-btn active" data-tab="user">当 繝ｦ繝ｼ繧ｶ繝ｼ蜷代￠</button>
          <button class="manual-tab-btn" data-tab="admin">笞呻ｸ・邂｡逅・・髄縺・/button>
        </div>
      </div>

      <section id="manualUser" class="manual-section manual-tab-content active">
        <h4>当 繝ｦ繝ｼ繧ｶ繝ｼ繝槭ル繝･繧｢繝ｫ - 蛻昴ａ縺ｦ縺ｮ譁ｹ縺ｸ</h4>

        <div class="manual-alert manual-alert-info">
          <strong>庁 縺薙・繧ｷ繧ｹ繝・Β縺ｫ縺､縺・※</strong><br>
          蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ縺ｯ縲√メ繝ｼ繝繝｡繝ｳ繝舌・縺ｮ蝨ｨ蟶ｭ迥ｶ豕√ｒ繝ｪ繧｢繝ｫ繧ｿ繧､繝縺ｧ蜈ｱ譛峨☆繧九す繧ｹ繝・Β縺ｧ縺吶・br>
          蜈･蜉帙＠縺溷・螳ｹ縺ｯ閾ｪ蜍慕噪縺ｫ菫晏ｭ倥＆繧後∽ｻ悶・莠ｺ縺ｮPC繧・せ繝槭・繝医ヵ繧ｩ繝ｳ縺ｫ繧ょ叉蠎ｧ縺ｫ蜿肴丐縺輔ｌ縺ｾ縺吶・
        </div>

        <h5>柏 1. 蛻晏屓繝ｭ繧ｰ繧､繝ｳ・育ｮ｡逅・・°繧峨ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ蜿励￠蜿悶▲縺ｦ縺上□縺輔＞・・/h5>
        <ol class="u-lh-18">
          <li><strong>諡轤ｹ繧帝∈謚・/strong>・壹ラ繝ｭ繝・・繝繧ｦ繝ｳ縺九ｉ謇螻槭☆繧区侠轤ｹ・亥霧讌ｭ謇・峨ｒ驕ｸ縺ｳ縺ｾ縺・/li>
          <li><strong>繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉・/strong>・夂ｮ｡逅・・°繧画蕗縺医※繧ゅｉ縺｣縺溘ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｾ縺・/li>
          <li><strong>縲後Ο繧ｰ繧､繝ｳ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</strong></li>
          <li>笨・繝ｭ繧ｰ繧､繝ｳ謌仙粥縺吶ｋ縺ｨ縲∝惠蟶ｭ遒ｺ隱崎｡ｨ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ol>
        <p class="manual-subtext">
          窶ｻ繝ｭ繧ｰ繧､繝ｳ迥ｶ諷九・1譎る俣菫晄戟縺輔ｌ縲∬・蜍慕噪縺ｫ蟒ｶ髟ｷ縺輔ｌ縺ｾ縺吶ゅヶ繝ｩ繧ｦ繧ｶ繧帝哩縺倥◆蝣ｴ蜷医・蜀阪Ο繧ｰ繧､繝ｳ縺悟ｿ・ｦ√〒縺吶・
        </p>

        <h5>早・・2. 逕ｻ髱｢縺ｮ隕区婿</h5>
        <ul class="u-lh-18">
          <li><strong>逕ｻ髱｢荳企Κ・医・繝・ム繝ｼ・・/strong>・・
            <ul class="u-mt-4">
              <li>桃 <strong>繧ｿ繧､繝医Ν</strong>・壽侠轤ｹ蜷阪′陦ｨ遉ｺ縺輔ｌ縺ｾ縺呻ｼ医け繝ｪ繝・け縺吶ｋ縺ｨ繧ｰ繝ｫ繝ｼ繝嶺ｸ隕ｧ繝｡繝九Η繝ｼ縺碁幕縺阪∪縺呻ｼ・/li>
              <li>剥 <strong>豌丞錐讀懃ｴ｢</strong>・夂音螳壹・莠ｺ繧呈爾縺吶→縺阪↓菴ｿ縺・∪縺・/li>
              <li>識 <strong>繧ｹ繝・・繧ｿ繧ｹ邨槭ｊ霎ｼ縺ｿ</strong>・壹悟､門・荳ｭ縺ｮ莠ｺ縺縺代阪↑縺ｩ縲∵擅莉ｶ縺ｧ邨槭ｊ霎ｼ繧√∪縺・/li>
              <li>討 <strong>縺顔衍繧峨○</strong>・壹♀遏･繧峨○縺後≠繧句ｴ蜷医↓陦ｨ遉ｺ縲ゅけ繝ｪ繝・け縺ｧ謚倥ｊ縺溘◆縺ｿ/螻暮幕繧貞・繧頑崛縺医∪縺・/li>
              <li>笞呻ｸ・<strong>邂｡逅・/strong>・夂ｮ｡逅・・・縺ｿ陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
              <li>坎 <strong>繝ｭ繧ｰ繧ｪ繝・/strong>・壹Ο繧ｰ繧｢繧ｦ繝医＠縺ｾ縺・/li>
              <li>当 <strong>繝槭ル繝･繧｢繝ｫ</strong>・壹％縺ｮ繝槭ル繝･繧｢繝ｫ繧定｡ｨ遉ｺ縺励∪縺・/li>
            </ul>
          </li>
          <li><strong>繝｡繧､繝ｳ逕ｻ髱｢</strong>・・
            <ul class="u-mt-4">
              <li>繝√・繝・医げ繝ｫ繝ｼ繝暦ｼ峨＃縺ｨ縺ｫ陦ｨ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
              <li>蜷・｡後′繝｡繝ｳ繝舌・1莠ｺ縺ｮ諠・ｱ縺ｧ縺・/li>
              <li>繧ｹ繝槭・繝医ヵ繧ｩ繝ｳ縺ｧ縺ｯ閾ｪ蜍慕噪縺ｫ繧ｫ繝ｼ繝芽｡ｨ遉ｺ縺ｫ蛻・ｊ譖ｿ繧上ｊ縺ｾ縺・/li>
            </ul>
          </li>
        </ul>

        <h5>笨搾ｸ・3. 蝓ｺ譛ｬ謫堺ｽ・- 閾ｪ蛻・・迥ｶ諷九ｒ譖ｴ譁ｰ縺吶ｋ</h5>

        <p class="u-my-8"><strong>統 讌ｭ蜍呎凾髢薙・蜈･蜉・/strong></p>
        <ol class="u-lh-18">
          <li>閾ｪ蛻・・陦後・縲梧･ｭ蜍呎凾髢薙肴ｬ・ｒ繧ｯ繝ｪ繝・け</li>
          <li>逶ｴ謗･蜈･蜉帙☆繧九°縲∬｡ｨ遉ｺ縺輔ｌ繧句呵｣懊Μ繧ｹ繝医°繧蛾∈謚橸ｼ井ｾ具ｼ・code>09:00-17:30</code>・・/li>
          <li>笨・蜈･蜉帙′螳御ｺ・☆繧九→縲∫ｴ・遘貞ｾ後↓閾ｪ蜍穂ｿ晏ｭ倥＆繧後∪縺呻ｼ井ｿ晏ｭ倥・繧ｿ繝ｳ縺ｯ荳崎ｦ√〒縺呻ｼ・/li>
        </ol>

        <p class="u-mt-16 u-mb-8"><strong>耳 繧ｹ繝・・繧ｿ繧ｹ縺ｮ驕ｸ謚橸ｼ郁牡蛻・￠縺輔ｌ縺ｾ縺呻ｼ・/strong></p>
        <table class="status-table">
          <tr>
            <th>繧ｹ繝・・繧ｿ繧ｹ</th>
            <th>濶ｲ</th>
            <th>謌ｻ繧頑凾髢・/th>
            <th>菴ｿ逕ｨ萓・/th>
          </tr>
          <tr>
            <td>蝨ｨ蟶ｭ</td>
            <td>辟｡濶ｲ・育區・・/td>
            <td>荳崎ｦ・/td>
            <td>繝・せ繧ｯ縺ｫ縺・ｋ縺ｨ縺・/td>
          </tr>
          <tr>
            <td>螟門・</td>
            <td>泛 繧ｪ繝ｬ繝ｳ繧ｸ</td>
            <td><strong>蠢・・/strong></td>
            <td>驫陦後・Ψ萓ｿ螻縺ｪ縺ｩ</td>
          </tr>
          <tr>
            <td>蝨ｨ螳・共蜍・/td>
            <td>泪 邏ｫ</td>
            <td>荳崎ｦ・/td>
            <td>繝・Ξ繝ｯ繝ｼ繧ｯ荳ｭ</td>
          </tr>
          <tr>
            <td>蜃ｺ蠑ｵ</td>
            <td>鳩 豌ｴ濶ｲ</td>
            <td><strong>蠢・・/strong></td>
            <td>莉匁侠轤ｹ繧・ｮ｢蜈医∈</td>
          </tr>
          <tr>
            <td>遐比ｿｮ</td>
            <td>泙 邱・/td>
            <td><strong>蠢・・/strong></td>
            <td>遐比ｿｮ繝ｻ繧ｻ繝溘リ繝ｼ蜿ょ刈</td>
          </tr>
          <tr>
            <td>蛛･蠎ｷ險ｺ譁ｭ</td>
            <td>ｩｷ 繝斐Φ繧ｯ</td>
            <td><strong>蠢・・/strong></td>
            <td>蛛･蠎ｷ險ｺ譁ｭ蜿苓ｨｺ荳ｭ</td>
          </tr>
          <tr>
            <td>繧ｳ繧｢繝峨ャ繧ｯ</td>
            <td>凋 阮・ｴｫ</td>
            <td><strong>蠢・・/strong></td>
            <td>繧ｳ繧｢繝峨ャ繧ｯ蜿苓ｨｺ荳ｭ</td>
          </tr>
          <tr>
            <td>蟶ｰ螳・/td>
            <td>笞ｪ 轣ｰ濶ｲ</td>
            <td>荳崎ｦ・/td>
            <td>騾遉ｾ貂医∩</td>
          </tr>
          <tr>
            <td>莨代∩</td>
            <td>閥 襍､</td>
            <td>荳崎ｦ・/td>
            <td>莨第嚊繝ｻ谺蜍､</td>
          </tr>
        </table>

        <p style="margin:16px 0 8px 0;"><strong>竢ｰ 謌ｻ繧頑凾髢薙・蜈･蜉幢ｼ亥､門・縲∝・蠑ｵ縲∫比ｿｮ縺ｪ縺ｩ縺ｮ蝣ｴ蜷茨ｼ・/strong></p>
        <ol style="line-height:1.8;">
          <li>繧ｹ繝・・繧ｿ繧ｹ縺ｧ縲悟､門・縲阪悟・蠑ｵ縲阪檎比ｿｮ縲阪悟▼蠎ｷ險ｺ譁ｭ縲阪後さ繧｢繝峨ャ繧ｯ縲阪ｒ驕ｸ縺ｶ縺ｨ縲∵綾繧頑凾髢薙′<strong class="u-text-red">蠢・・/strong>縺ｫ縺ｪ繧翫∪縺・/li>
          <li>縲梧綾繧頑凾髢薙阪・繝峨Ο繝・・繝繧ｦ繝ｳ繧偵け繝ｪ繝・け縺励※驕ｸ謚橸ｼ・7:00縲・2:00縲・0蛻・綾縺ｿ・・/li>
          <li>笞・・譛ｪ蜈･蜉帙・蝣ｴ蜷医・襍､譫縺ｧ陦ｨ遉ｺ縺輔ｌ縺ｾ縺呻ｼ亥ｿ・★蜈･蜉帙＠縺ｦ縺上□縺輔＞・・/li>
        </ol>
        <p style="margin:8px 0;color:#666;font-size:0.9em;">
          庁 繝偵Φ繝茨ｼ壹悟惠蟶ｭ縲阪悟惠螳・共蜍吶阪悟ｸｰ螳・阪御ｼ代∩縲阪ｒ驕ｸ縺ｶ縺ｨ縲∵綾繧頑凾髢薙→蛯呵・′閾ｪ蜍慕噪縺ｫ繧ｯ繝ｪ繧｢縺輔ｌ縺ｾ縺・
        </p>

        <p style="margin:16px 0 8px 0;"><strong>東 蛯呵・・蜈･蜉幢ｼ井ｻｻ諢擾ｼ・/strong></p>
        <ul style="line-height:1.8;">
          <li>縲悟ｙ閠・肴ｬ・ｒ繧ｯ繝ｪ繝・け縺励※縲∬・逕ｱ縺ｫ蜈･蜉帙〒縺阪∪縺・/li>
          <li>蛟呵｣懊°繧蛾∈縺ｶ縺薙→繧ゅ〒縺阪∪縺呻ｼ・strong>逶ｴ蜃ｺ</strong>縲・strong>逶ｴ蟶ｰ</strong>縲・strong>逶ｴ蜃ｺ繝ｻ逶ｴ蟶ｰ</strong></li>
          <li>遨ｺ逋ｽ縺ｫ縺励◆縺・ｴ蜷医・縲鯉ｼ育ｩｺ逋ｽ・峨阪ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</li>
        </ul>

        <h5>套 4. 繧､繝吶Φ繝医・陦ｨ遉ｺ</h5>
        <p><strong>繧､繝吶Φ繝域ｩ溯・縺ｨ縺ｯ</strong></p>
        <ul style="line-height:1.8;">
          <li>GW縲∝ｹｴ譛ｫ蟷ｴ蟋九∝､丞ｭ｣莨第嚊縺ｪ縺ｩ縲∬､・焚譌･縺ｫ繧上◆繧倶ｼ第嚊繧堤ｰ｡蜊倥↓邂｡逅・〒縺阪∪縺・/li>
          <li>邂｡逅・・′莨第嚊譛滄俣縺ｨ繝｡繝ｳ繝舌・繧剃ｺ句燕縺ｫ險ｭ螳壹＠縺ｦ縺翫￥縺薙→縺ｧ縲∽ｼ第嚊荳ｭ縺ｮ繝｡繝ｳ繝舌・縺後ｏ縺九ｊ繧・☆縺上↑繧翫∪縺・/li>
          <li>繧､繝吶Φ繝医′逋ｻ骭ｲ縺輔ｌ縺ｦ縺・ｋ蝣ｴ蜷医・縺ｿ縲√・繝・ム繝ｼ縺ｫ縲後う繝吶Φ繝医阪・繧ｿ繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ul>

        <p style="margin-top:12px;"><strong>繧､繝吶Φ繝医・陦ｨ遉ｺ譁ｹ豕・/strong></p>
        <ol style="line-height:1.8;">
          <li>繝倥ャ繝繝ｼ縺ｮ<strong>縲後う繝吶Φ繝医・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け</li>
          <li>逋ｻ骭ｲ縺輔ｌ縺ｦ縺・ｋ繧､繝吶Φ繝医・荳隕ｧ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺呻ｼ井ｾ具ｼ壹隈W譛滄俣莨第嚊縲阪悟ｹｴ譛ｫ蟷ｴ蟋倶ｼ第嚊縲搾ｼ・/li>
          <li>陦ｨ遉ｺ縺励◆縺・う繝吶Φ繝医ｒ繧ｯ繝ｪ繝・け縺励※驕ｸ謚・/li>
          <li>繧ｬ繝ｳ繝医メ繝｣繝ｼ繝茨ｼ医き繝ｬ繝ｳ繝繝ｼ蠖｢蠑上・陦ｨ・峨′陦ｨ遉ｺ縺輔ｌ縲√←縺ｮ繝｡繝ｳ繝舌・縺後＞縺､莨第嚊縺ｪ縺ｮ縺九ｒ遒ｺ隱阪〒縺阪∪縺・/li>
          <li><strong>縲瑚｡ｨ遉ｺ縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け 竊・繝｡繧､繝ｳ逕ｻ髱｢縺ｧ隧ｲ蠖薙Γ繝ｳ繝舌・縺ｮ陦後′<strong>繝上う繝ｩ繧､繝郁｡ｨ遉ｺ</strong>縺輔ｌ縺ｾ縺・/li>
        </ol>

        <p style="margin-top:12px;"><strong>陦ｨ遉ｺ縺輔ｌ繧句・螳ｹ</strong></p>
        <ul style="line-height:1.8;">
          <li>莨第嚊荳ｭ縺ｮ繝｡繝ｳ繝舌・縺ｮ陦後′濶ｲ莉倥″縺ｧ繝上う繝ｩ繧､繝医＆繧後∪縺・/li>
          <li>繧ｹ繝・・繧ｿ繧ｹ谺・↓繧､繝吶Φ繝医・繧ｿ繧､繝医Ν・井ｾ具ｼ壹隈W譛滄俣莨第嚊縲搾ｼ峨′陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>逕ｻ髱｢荳企Κ縺ｫ縲後う繝吶Φ繝郁｡ｨ遉ｺ荳ｭ縲阪・繝舌リ繝ｼ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ul>

        <p style="margin-top:12px;"><strong>陦ｨ遉ｺ繧定ｧ｣髯､縺吶ｋ</strong></p>
        <ul style="line-height:1.8;">
          <li>繧､繝吶Φ繝医Δ繝ｼ繝繝ｫ縺ｧ<strong>縲瑚｡ｨ遉ｺ繧ｯ繝ｪ繧｢縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ縲√ワ繧､繝ｩ繧､繝医′隗｣髯､縺輔ｌ縺ｾ縺・/li>
          <li>蛻･縺ｮ繧､繝吶Φ繝医ｒ驕ｸ謚槭☆繧九→縲∬｡ｨ遉ｺ縺悟・繧頑崛繧上ｊ縺ｾ縺・/li>
        </ul>

        <div class="manual-alert manual-alert-warning">
          <strong>庁 繝偵Φ繝・/strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>繧､繝吶Φ繝医・<strong>逋ｻ骭ｲ繝ｻ邱ｨ髮・・蜑企勁</strong>縺ｯ邂｡逅・・・縺ｿ縺瑚｡後∴縺ｾ縺・/li>
            <li>繧､繝吶Φ繝医ｒ險ｭ螳壹＠縺溘＞蝣ｴ蜷医・縲∫ｮ｡逅・・↓蝠上＞蜷医ｏ縺帙※縺上□縺輔＞</li>
            <li>繧､繝吶Φ繝医・繧ｿ繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｪ縺・ｴ蜷医・縲∫樟蝨ｨ逋ｻ骭ｲ縺輔ｌ縺ｦ縺・ｋ繧､繝吶Φ繝医′縺ゅｊ縺ｾ縺帙ｓ</li>
          </ul>
        </div>

        <h5>剥 5. 莉悶・莠ｺ縺ｮ迥ｶ豕√ｒ遒ｺ隱阪☆繧・/h5>
        </h5>

        <p><strong>豌丞錐讀懃ｴ｢縺ｮ菴ｿ縺・婿</strong></p>
        <ol style="line-height:1.8;">
          <li>逕ｻ髱｢荳企Κ縺ｮ讀懃ｴ｢繝懊ャ繧ｯ繧ｹ縺ｫ蜷榊燕繧貞・蜉幢ｼ井ｾ具ｼ壹檎伐荳ｭ縲搾ｼ・/li>
          <li>蜈･蜉帙☆繧九→蜷梧凾縺ｫ縲∬ｩｲ蠖薙☆繧倶ｺｺ縺縺代′陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>讀懃ｴ｢繧定ｧ｣髯､縺吶ｋ縺ｫ縺ｯ縲∝・蜉帛・螳ｹ繧貞炎髯､縺励※縺上□縺輔＞</li>
        </ol>

        <p style="margin-top:12px;"><strong>繧ｹ繝・・繧ｿ繧ｹ縺ｧ邨槭ｊ霎ｼ縺ｿ</strong></p>
        <ol style="line-height:1.8;">
          <li>逕ｻ髱｢荳企Κ縺ｮ縲後せ繝・・繧ｿ繧ｹ邨槭ｊ霎ｼ縺ｿ縲阪ラ繝ｭ繝・・繝繧ｦ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>隕九◆縺・せ繝・・繧ｿ繧ｹ繧帝∈謚橸ｼ井ｾ具ｼ壹悟､門・荳ｭ縺ｮ莠ｺ縺縺題ｦ九ｋ縲坂・縲悟､門・縲阪ｒ驕ｸ謚橸ｼ・/li>
          <li>蜈ｨ蜩｡陦ｨ遉ｺ縺ｫ謌ｻ縺吶↓縺ｯ縲悟・縺ｦ縲阪ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</li>
        </ol>

        <p style="margin-top:12px;"><strong>繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝暦ｼ育判髱｢縺碁聞縺・ｴ蜷茨ｼ・/strong></p>
        <ol style="line-height:1.8;">
          <li>逕ｻ髱｢荳企Κ縺ｮ諡轤ｹ蜷搾ｼ医ち繧､繝医Ν・峨ｒ繧ｯ繝ｪ繝・け</li>
          <li>繧ｰ繝ｫ繝ｼ繝嶺ｸ隕ｧ繝｡繝九Η繝ｼ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>陦後″縺溘＞繧ｰ繝ｫ繝ｼ繝励ｒ繧ｯ繝ｪ繝・け縺吶ｋ縺ｨ縲√◎縺ｮ菴咲ｽｮ縺ｫ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺励∪縺・/li>
        </ol>

        <h5>討 5. 縺顔衍繧峨○讖溯・縺ｮ菴ｿ縺・婿</h5>
        <p><strong>縺顔衍繧峨○繧ｨ繝ｪ繧｢縺ｨ縺ｯ</strong></p>
        <ul style="line-height:1.8;">
          <li>邂｡逅・・′逋ｻ骭ｲ縺励◆驥崎ｦ√↑縺顔衍繧峨○縺後√・繝・ム繝ｼ縺ｨ繝｡繧､繝ｳ逕ｻ髱｢縺ｮ髢薙↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>繧ｷ繧ｹ繝・Β繝｡繝ｳ繝・リ繝ｳ繧ｹ縲∵･ｭ蜍咎｣邨｡縲∵ｳｨ諢丈ｺ矩・↑縺ｩ縺梧軸霈峨＆繧後∪縺・/li>
          <li>縺顔衍繧峨○縺後↑縺・ｴ蜷医・縲√♀遏･繧峨○繧ｨ繝ｪ繧｢縺ｨ繝懊ち繝ｳ縺ｯ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ</li>
        </ul>

        <p style="margin-top:12px;"><strong>謚倥ｊ縺溘◆縺ｿ/螻暮幕縺ｮ蛻・ｊ譖ｿ縺・/strong></p>
        <ol style="line-height:1.8;">
          <li><strong>蛻晄悄迥ｶ諷具ｼ医Ο繧ｰ繧､繝ｳ逶ｴ蠕鯉ｼ・/strong>・壹♀遏･繧峨○縺ｯ<strong>螻暮幕</strong>縺輔ｌ縺溽憾諷九〒陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li><strong>謚倥ｊ縺溘◆縺ｿ</strong>・壹・繝・ム繝ｼ縺ｮ縲後♀遏･繧峨○縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け 竊・譛蛻昴・縺顔衍繧峨○縺ｮ繧ｿ繧､繝医Ν縺ｨ莉ｶ謨ｰ縺ｮ縺ｿ陦ｨ遉ｺ縺輔ｌ縺ｾ縺・br>
            <span style="color:#666;font-size:0.9em;">萓具ｼ壹後す繧ｹ繝・Β繝｡繝ｳ繝・リ繝ｳ繧ｹ縺ｮ縺顔衍繧峨○ (莉・莉ｶ)縲・/span>
          </li>
          <li><strong>螻暮幕</strong>・壹ｂ縺・ｸ蠎ｦ縲後♀遏･繧峨○縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け 竊・縺吶∋縺ｦ縺ｮ縺顔衍繧峨○縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ol>

        <p style="margin-top:12px;"><strong>縺顔衍繧峨○縺ｮ譖ｴ譁ｰ鬆ｻ蠎ｦ</strong></p>
        <ul style="line-height:1.8;">
          <li>邂｡逅・・′霑ｽ蜉繝ｻ邱ｨ髮・・蜑企勁縺励◆縺顔衍繧峨○縺ｯ縲∫ｴ・0遘偵＃縺ｨ縺ｫ閾ｪ蜍慕噪縺ｫ蜿肴丐縺輔ｌ縺ｾ縺・/li>
          <li>縺吶＄縺ｫ遒ｺ隱阪＠縺溘＞蝣ｴ蜷医・縲√・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ・・5繧ｭ繝ｼ・峨＠縺ｦ縺上□縺輔＞</li>
        </ul>

        <h5>売 6. 閾ｪ蜍墓峩譁ｰ縺ｫ縺､縺・※・磯㍾隕・ｼ・/h5>
        <div class="manual-alert manual-alert-warning">
          <strong>笞｡ 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄</strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>笨・縺ゅ↑縺溘′蜈･蜉帙＠縺溷・螳ｹ縺ｯ縲・strong>邏・遘貞ｾ・/strong>縺ｫ閾ｪ蜍慕噪縺ｫ菫晏ｭ倥＆繧後∪縺・/li>
            <li>笨・莉悶・莠ｺ縺悟・蜉帙＠縺溷惠蟶ｭ迥ｶ豕√・縲・strong>邏・0遘偵＃縺ｨ</strong>縺ｫ閾ｪ蜍慕噪縺ｫ縺ゅ↑縺溘・逕ｻ髱｢縺ｫ蜿肴丐縺輔ｌ縺ｾ縺・/li>
            <li>笨・縺顔衍繧峨○繧・ｨｭ螳壹・螟画峩縺ｯ縲・strong>邏・0遘偵＃縺ｨ</strong>縺ｫ閾ｪ蜍慕噪縺ｫ蜿肴丐縺輔ｌ縺ｾ縺・/li>
            <li>笨・菫晏ｭ倥・繧ｿ繝ｳ繧・峩譁ｰ繝懊ち繝ｳ縺ｯ<strong>荳崎ｦ・/strong>縺ｧ縺・/li>
            <li>笞・・蜈･蜉帑ｸｭ繧・､画鋤荳ｭ縺ｯ縲∽ｻ悶・莠ｺ縺ｮ譖ｴ譁ｰ縺御ｸ譎ら噪縺ｫ菫晉蕗縺輔ｌ縺ｾ縺呻ｼ亥・蜉帙・驍ｪ鬲斐↓縺ｪ繧翫∪縺帙ｓ・・/li>
          </ul>
        </div>

        <h5>笶・繧医￥縺ゅｋ雉ｪ蝠・/h5>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 菫晏ｭ倥・繧ｿ繝ｳ縺ｯ縺ｩ縺薙〒縺吶°・・/summary>
          <p style="margin:8px 0 8px 20px;">A. 菫晏ｭ倥・繧ｿ繝ｳ縺ｯ縺ゅｊ縺ｾ縺帙ｓ縲ょ・蜉帙☆繧九→閾ｪ蜍慕噪縺ｫ邏・遘貞ｾ後↓菫晏ｭ倥＆繧後∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 縺顔衍繧峨○繝懊ち繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ</summary>
          <p style="margin:8px 0 8px 20px;">A. 縺顔衍繧峨○縺後↑縺・ｴ蜷医√♀遏･繧峨○繝懊ち繝ｳ縺ｨ縺顔衍繧峨○繧ｨ繝ｪ繧｢縺ｯ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ縲らｮ｡逅・・′縺顔衍繧峨○繧堤匳骭ｲ縺吶ｋ縺ｨ閾ｪ蜍慕噪縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｾ縺呻ｼ育ｴ・0遘剃ｻ･蜀・↓蜿肴丐・峨・
          </p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 縺顔衍繧峨○縺碁が鬲斐〒逕ｻ髱｢縺瑚ｦ九▼繧峨＞</summary>
          <p style="margin:8px 0 8px 20px;">A. 繝倥ャ繝繝ｼ縺ｮ縲後♀遏･繧峨○縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ縲√♀遏･繧峨○繧ｨ繝ｪ繧｢繧呈釜繧翫◆縺溘・縺薙→縺後〒縺阪∪縺吶よ釜繧翫◆縺溘・縺ｨ1陦後・繧ｵ繝槭Μ繝ｼ陦ｨ遉ｺ縺ｫ縺ｪ繧翫∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 謌ｻ繧頑凾髢薙′驕ｸ謚槭〒縺阪∪縺帙ｓ</summary>
          <p style="margin:8px 0 8px 20px;">A. 繧ｹ繝・・繧ｿ繧ｹ縺後悟惠蟶ｭ縲阪悟惠螳・共蜍吶阪悟ｸｰ螳・阪御ｼ代∩縲阪・蝣ｴ蜷医∵綾繧頑凾髢薙・荳崎ｦ√↑縺溘ａ驕ｸ謚槭〒縺阪∪縺帙ｓ縲ゅ悟､門・縲阪悟・蠑ｵ縲阪↑縺ｩ縺ｫ螟画峩縺励※縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧ｹ繝槭・繝医ヵ繧ｩ繝ｳ縺ｧ繧ゆｽｿ縺医∪縺吶°・・/summary>
          <p style="margin:8px 0 8px 20px;">A. 縺ｯ縺・√せ繝槭・繝医ヵ繧ｩ繝ｳ縺ｮ繝悶Λ繧ｦ繧ｶ縺ｧ繧ょ茜逕ｨ縺ｧ縺阪∪縺吶ら判髱｢縺瑚・蜍慕噪縺ｫ繧ｫ繝ｼ繝芽｡ｨ遉ｺ縺ｫ蛻・ｊ譖ｿ繧上ｊ縺ｾ縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髢馴＆縺医※蜈･蜉帙＠縺ｦ縺励∪縺・∪縺励◆</summary>
          <p style="margin:8px 0 8px 20px;">A. 縺吶＄縺ｫ豁｣縺励＞蜀・ｮｹ縺ｫ蜈･蜉帙＠逶ｴ縺励※縺上□縺輔＞縲らｴ・遘貞ｾ後↓閾ｪ蜍穂ｿ晏ｭ倥＆繧後∪縺吶・/p>
        </details>

        <h5>原 7. 髟ｷ譛滉ｼ第嚊・医う繝吶Φ繝茨ｼ画ｩ溯・縺ｮ菴ｿ縺・婿</h5>
        <p><strong>髟ｷ譛滉ｼ第嚊讖溯・縺ｨ縺ｯ</strong></p>
        <ul style="line-height:1.8;">
          <li>邂｡逅・・′逋ｻ骭ｲ縺励◆<strong>髟ｷ譛滉ｼ第嚊譛滄俣・亥､丞ｭ｣莨第嚊縲∝ｹｴ譛ｫ蟷ｴ蟋九；W縺ｪ縺ｩ・・/strong>繧堤｢ｺ隱阪・驕ｸ謚槭〒縺阪∪縺・/li>
          <li>閾ｪ蛻・′縺ｩ縺ｮ譌･縺ｫ莨第嚊繧貞叙繧九°縲・strong>繧ｫ繝ｬ繝ｳ繝繝ｼ荳翫〒驕ｸ謚・/strong>縺ｧ縺阪∪縺・/li>
          <li>驕ｸ謚槭＠縺滓律縺ｯ閾ｪ蜍慕噪縺ｫ繧ｹ繝・・繧ｿ繧ｹ縺後御ｼ代∩縲搾ｼ医∪縺溘・縲御ｼ第嚊縲阪梧怏邨ｦ縲阪↑縺ｩ・峨↓縺ｪ繧翫・strong>蛯呵・ｬ・↓莨第嚊繧ｿ繧､繝医Ν</strong>縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>笨・繝ｭ繧ｰ繧､繝ｳ譎ゅｄ逕ｻ髱｢譖ｴ譁ｰ譎ゅ↓縲・strong>菫晏ｭ倥＠縺滉ｼ第嚊縺瑚・蜍慕噪縺ｫ驕ｩ逕ｨ</strong>縺輔ｌ縺ｾ縺呻ｼ域ｯ主屓險ｭ螳壹☆繧句ｿ・ｦ√・縺ゅｊ縺ｾ縺帙ｓ・・/li>
        </ul>

        <p style="margin-top:12px;"><strong>髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｮ髢九″譁ｹ</strong></p>
        <ol style="line-height:1.8;">
          <li>逕ｻ髱｢荳企Κ縺ｮ<strong>縲碁聞譛滉ｼ第嚊縲阪・繧ｿ繝ｳ</strong>繧偵け繝ｪ繝・け・育ｮ｡逅・・′險ｭ螳壹＠縺滄聞譛滉ｼ第嚊縺後≠繧句ｴ蜷医・縺ｿ陦ｨ遉ｺ・・/li>
          <li>髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺悟・逕ｻ髱｢縺ｧ髢九″縺ｾ縺・/li>
          <li>隍・焚縺ｮ繧､繝吶Φ繝医′縺ゅｋ蝣ｴ蜷医・縲√Μ繧ｹ繝医°繧蛾∈謚槭〒縺阪∪縺・/li>
        </ol>

        <p style="margin-top:12px;"><strong>莨第嚊譌･縺ｮ驕ｸ謚樊婿豕・/strong></p>
        <ol style="line-height:1.8;">
          <li>髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ繧帝幕縺阪∝ｿ・ｦ√↓蠢懊§縺ｦ<strong>繧､繝吶Φ繝医ｒ驕ｸ謚・/strong>縺励∪縺呻ｼ郁､・焚縺ゅｋ蝣ｴ蜷茨ｼ・/li>
          <li>繧ｫ繝ｬ繝ｳ繝繝ｼ荳翫〒<strong>閾ｪ蛻・・陦・/strong>繧呈爾縺励∪縺呻ｼ医げ繝ｫ繝ｼ繝怜錐縺ｨ豌丞錐縺ｧ遒ｺ隱搾ｼ・/li>
          <li>莨第嚊繧貞叙繧区律縺ｮ<strong>繧ｻ繝ｫ繧偵け繝ｪ繝・け</strong>・・C縺ｮ蝣ｴ蜷医・繝峨Λ繝・げ縺ｧ繧る∈謚槫庄閭ｽ・・/li>
          <li>驕ｸ謚槭＠縺滓律縺・strong>髱定牡</strong>縺ｫ縺ｪ繧翫∪縺呻ｼ医ｂ縺・ｸ蠎ｦ繧ｯ繝ｪ繝・け縺吶ｋ縺ｨ隗｣髯､・・/li>
          <li><strong>縲御ｿ晏ｭ倥阪・繧ｿ繝ｳ</strong>繧偵け繝ｪ繝・け</li>
          <li>笨・驕ｸ謚槭＠縺滓律縺ｮ繧ｹ繝・・繧ｿ繧ｹ縺瑚・蜍慕噪縺ｫ縲御ｼ代∩縲搾ｼ医∪縺溘・縲御ｼ第嚊縲阪梧怏邨ｦ縲阪↑縺ｩ・峨↓縺ｪ繧翫∝ｙ閠・ｬ・↓莨第嚊繧ｿ繧､繝医Ν縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ol>

        <div class="manual-hint">
          <strong>庁 謫堺ｽ懊・繧ｳ繝・/strong>
          <ul style="margin:6px 0;line-height:1.6;">
            <li><strong>騾｣邯壹＠縺滓律莉倥ｒ驕ｸ謚・/strong>・啀C縺ｧ縺ｯ繝峨Λ繝・げ謫堺ｽ懊′萓ｿ蛻ｩ縺ｧ縺呻ｼ井ｾ具ｼ・譛・譌･縲・譛・譌･縺ｾ縺ｧ荳蠎ｦ縺ｫ驕ｸ謚橸ｼ・/li>
            <li><strong>繧ｫ繝ｼ繧ｽ繝ｫ繧ｪ繝ｳ</strong>・壹そ繝ｫ縺ｫ繝槭え繧ｹ繧堤ｽｮ縺上→縲∬ｩｲ蠖薙・豌丞錐縺ｨ譌･莉倥′繝上う繝ｩ繧､繝郁｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li><strong>讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ</strong>・壹き繝ｬ繝ｳ繝繝ｼ驛ｨ蛻・ｒ讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺吶ｋ縺ｨ縲∝・縺ｦ縺ｮ譌･莉倥ｒ遒ｺ隱阪〒縺阪∪縺・/li>
            <li><strong>邵ｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ</strong>・夂ｸｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺励※繧ゅ√・繧ｿ繝ｳ縺ｨ譌･莉倩｡後・逕ｻ髱｢荳企Κ縺ｫ蝗ｺ螳夊｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          </ul>
        </div>

        <div class="manual-alert manual-alert-success">
          <strong>庁 髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｮ萓ｿ蛻ｩ縺ｪ讖溯・</strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>笨・<strong>閾ｪ蜍穂ｿ晏ｭ・/strong>・夐∈謚槭＠縺滓律縺ｯ菫晏ｭ倥・繧ｿ繝ｳ繧呈款縺吶→蜊ｳ蠎ｧ縺ｫ蜿肴丐縺輔ｌ縲√ョ繝ｼ繧ｿ繝吶・繧ｹ縺ｫ菫晏ｭ倥＆繧後∪縺・/li>
            <li>笨・<strong>閾ｪ蜍暮←逕ｨ</strong>・壹Ο繧ｰ繧､繝ｳ譎ゅｄ逕ｻ髱｢譖ｴ譁ｰ・・5・画凾縲∽ｿ晏ｭ倥＆繧後◆莨第嚊縺瑚・蜍慕噪縺ｫ蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ縺ｫ驕ｩ逕ｨ縺輔ｌ縺ｾ縺・/li>
            <li>笨・<strong>繧ｫ繝ｼ繧ｽ繝ｫ繧ｪ繝ｳ蠑ｷ隱ｿ</strong>・壹そ繝ｫ縺ｫ繝槭え繧ｹ繧堤ｽｮ縺上→縲∬ｩｲ蠖薙・豌丞錐縺ｨ譌･莉伜・縺後ワ繧､繝ｩ繧､繝郁｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li>笨・<strong>讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ蝗ｺ螳・/strong>・壽ｨｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺励※繧ゅげ繝ｫ繝ｼ繝怜錐繝ｻ豌丞錐縺ｯ蟾ｦ蛛ｴ縺ｫ蝗ｺ螳夊｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li>笨・<strong>邵ｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ蝗ｺ螳・/strong>・夂ｸｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺励※繧ゅ・繧ｿ繝ｳ繧ｨ繝ｪ繧｢縺ｨ譌･莉倩｡後・荳企Κ縺ｫ蝗ｺ螳夊｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li>笨・<strong>繝ｬ繧ｹ繝昴Φ繧ｷ繝門ｯｾ蠢・/strong>・壹せ繝槭・繝医ヵ繧ｩ繝ｳ繧・ち繝悶Ξ繝・ヨ縺ｧ繧ゆｽｿ縺・ｄ縺吶＞陦ｨ遉ｺ縺ｫ閾ｪ蜍戊ｪｿ謨ｴ縺輔ｌ縺ｾ縺・/li>
          </ul>
        </div>

        <p style="margin-top:12px;"><strong>繧ｹ繝槭・繝医ヵ繧ｩ繝ｳ繝ｻ繧ｿ繝悶Ξ繝・ヨ縺ｧ縺ｮ謫堺ｽ・/strong></p>
        <ul style="line-height:1.8;">
          <li>繧ｻ繝ｫ繧・strong>繧ｿ繝・・</strong>縺励※ON/OFF蛻・ｊ譖ｿ縺茨ｼ医ラ繝ｩ繝・げ謫堺ｽ懊・髱槫ｯｾ蠢懶ｼ・/li>
          <li><strong>讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ</strong>縺ｧ蜈ｨ縺ｦ縺ｮ譌･莉倥ｒ遒ｺ隱榊庄閭ｽ・医げ繝ｫ繝ｼ繝怜錐繝ｻ豌丞錐縺ｯ蝗ｺ螳夲ｼ・/li>
          <li><strong>邵ｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ</strong>縺ｧ蜈ｨ縺ｦ縺ｮ繝｡繝ｳ繝舌・繧堤｢ｺ隱榊庄閭ｽ・医・繧ｿ繝ｳ繝ｻ譌･莉倥・荳企Κ蝗ｺ螳夲ｼ・/li>
          <li><strong>譌･莉倩｡ｨ遉ｺ</strong>・夂判髱｢蟷・↓蠢懊§縺ｦ閾ｪ蜍戊ｪｿ謨ｴ縺輔ｌ縺ｾ縺・
            <ul style="margin:4px 0 0 20px;">
              <li>PC/繧ｿ繝悶Ξ繝・ヨ・壹・2譛・9譌･ 譛医搾ｼ域ｨｪ荳ｦ縺ｳ陦ｨ遉ｺ・・/li>
              <li>繧ｹ繝槭・讓ｪ・壹・2譛・/ 9譌･ / 譛医搾ｼ育ｸｦ3陦瑚｡ｨ遉ｺ・・/li>
              <li>繧ｹ繝槭・邵ｦ・壹・2譛・/ 9譌･ / 譛医搾ｼ医ｈ繧雁ｰ上＆縺・ヵ繧ｩ繝ｳ繝医〒繧ｳ繝ｳ繝代け繝郁｡ｨ遉ｺ・・/li>
            </ul>
          </li>
          <li><strong>繧ｿ繝・・鬆伜沺</strong>・夂強縺・判髱｢縺ｧ繧ゅち繝・・縺励ｄ縺吶＞繧医≧繧ｻ繝ｫ繧ｵ繧､繧ｺ縺梧怙驕ｩ蛹悶＆繧後※縺・∪縺・/li>
        </ul>

        <p style="margin-top:12px;"><strong>豕ｨ諢丈ｺ矩・/strong></p>
        <ul style="line-height:1.8;">
          <li>笞・・髟ｷ譛滉ｼ第嚊繝懊ち繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｪ縺・ｴ蜷医・縲∫ｮ｡逅・・′髟ｷ譛滉ｼ第嚊繧偵瑚｡ｨ遉ｺ縺吶ｋ縲崎ｨｭ螳壹↓縺励※縺・∪縺帙ｓ</li>
          <li>笞・・蛯呵・ｬ・↓譌｢縺ｫ蜀・ｮｹ縺後≠繧句ｴ蜷医・聞譛滉ｼ第嚊繧ｿ繧､繝医Ν縺ｧ荳頑嶌縺阪＆繧後∪縺呻ｼ域里蟄倥・蜀・ｮｹ縺ｯ豸医∴縺ｾ縺呻ｼ・/li>
          <li>笞・・髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｧ縺ｮ驕ｸ謚槭ｒ螟画峩縺励◆蝣ｴ蜷医・縲・strong>蠢・★縲御ｿ晏ｭ倥阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</strong>縺励※縺上□縺輔＞</li>
          <li>笞・・菫晏ｭ倥＠縺滉ｼ第嚊譌･縺ｯ縲√う繝吶Φ繝磯∈謚槭ｒ隗｣髯､縺吶ｋ縺ｾ縺ｧ繧ｹ繝・・繧ｿ繧ｹ縺悟崋螳壹＆繧後∪縺呻ｼ域焔蜍募､画峩縺ｧ縺阪∪縺帙ｓ・・/li>
          <li>笞・・隍・焚縺ｮ繧､繝吶Φ繝医′縺ゅｋ蝣ｴ蜷医・strong>1縺､縺ｮ繧､繝吶Φ繝医＠縺矩∈謚槭〒縺阪∪縺帙ｓ</strong>・井ｻ悶・繧､繝吶Φ繝医ｒ驕ｸ謚槭☆繧九→荳頑嶌縺阪＆繧後∪縺呻ｼ・/li>
        </ul>

        <h5>笶・繧医￥縺ゅｋ雉ｪ蝠擾ｼ磯聞譛滉ｼ第嚊讖溯・・・/h5>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊・医う繝吶Φ繝茨ｼ峨・繧ｿ繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ</summary>
          <p style="margin:8px 0 8px 20px;">A. 邂｡逅・・′縲瑚｡ｨ遉ｺ縺吶ｋ縲阪↓繝√ぉ繝・け繧貞・繧後◆髟ｷ譛滉ｼ第嚊縺後≠繧句ｴ蜷医・縺ｿ陦ｨ遉ｺ縺輔ｌ縺ｾ縺吶ゅ・繧ｿ繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｪ縺・ｴ蜷医・縲∫ｮ｡逅・・↓遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊・医う繝吶Φ繝茨ｼ峨ｒ譁ｰ隕丈ｽ懈・縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            髟ｷ譛滉ｼ第嚊縺ｮ逋ｻ骭ｲ繝ｻ邱ｨ髮・・蜑企勁縺ｯ<strong>邂｡逅・・・縺ｿ</strong>縺瑚｡後∴縺ｾ縺吶ょ､丞ｭ｣莨第嚊縲∝ｹｴ譛ｫ蟷ｴ蟋九；W縺ｪ縺ｩ縺ｮ繧､繝吶Φ繝医ｒ險ｭ螳壹＠縺溘＞蝣ｴ蜷医・縲∫ｮ｡逅・・↓蝠上＞蜷医ｏ縺帙※縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊縺ｧ驕ｸ謚槭＠縺滓律繧貞､画峩縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 髟ｷ譛滉ｼ第嚊繝懊ち繝ｳ繧偵け繝ｪ繝・け縺励※繧ｫ繝ｬ繝ｳ繝繝ｼ繧帝幕縺阪・∈謚槭ｒ螟画峩縺励※縲御ｿ晏ｭ倥阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺励※縺上□縺輔＞縲ょ､画峩縺ｯ縺吶＄縺ｫ蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ縺ｫ蜿肴丐縺輔ｌ縺ｾ縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｧ閾ｪ蛻・・蜷榊燕縺瑚ｦ九▽縺九ｉ縺ｪ縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 讓ｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺ｾ縺溘・邵ｦ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ縺ｧ謗｢縺励※縺上□縺輔＞縲ゅげ繝ｫ繝ｼ繝怜錐縺ｨ豌丞錐縺ｯ蝗ｺ螳夊｡ｨ遉ｺ縺輔ｌ縺ｦ縺・ｋ縺溘ａ縲√せ繧ｯ繝ｭ繝ｼ繝ｫ縺励※繧ょｸｸ縺ｫ隕九∴縺ｾ縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊縺ｮ驕ｸ謚槭ｒ隗｣髯､縺励◆縺・ｼ磯壼ｸｸ縺ｮ繧ｹ繝・・繧ｿ繧ｹ縺ｫ謌ｻ縺励◆縺・ｼ・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ繧帝幕縺阪・搨濶ｲ縺ｫ縺ｪ縺｣縺ｦ縺・ｋ繧ｻ繝ｫ繧偵け繝ｪ繝・け縺励※隗｣髯､縺励√御ｿ晏ｭ倥阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺励※縺上□縺輔＞縲ゅ∪縺溘・縲・聞譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ荳企Κ縺ｮ縲瑚｡ｨ遉ｺ繧ｯ繝ｪ繧｢縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ縲∝・縺ｦ縺ｮ驕ｸ謚槭′隗｣髯､縺輔ｌ縺ｾ縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 髟ｷ譛滉ｼ第嚊繧剃ｿ晏ｭ倥＠縺溘・縺ｫ蜿肴丐縺輔ｌ縺ｪ縺・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            繝悶Λ繧ｦ繧ｶ縺ｮ逕ｻ髱｢繧呈峩譁ｰ・・5繧ｭ繝ｼ・峨＠縺ｦ縺上□縺輔＞縲ゆｿ晏ｭ倥＆繧後◆莨第嚊縺ｯ閾ｪ蜍慕噪縺ｫ驕ｩ逕ｨ縺輔ｌ繧九・縺壹〒縺吶′縲∝渚譏縺輔ｌ縺ｪ縺・ｴ蜷医・蜀榊ｺｦ髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ繧帝幕縺・※縲瑚｡ｨ遉ｺ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺励※縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 隍・焚縺ｮ繧､繝吶Φ繝医ｒ蜷梧凾縺ｫ驕ｸ謚槭〒縺阪∪縺吶°・・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            縺・＞縺医・strong>1縺､縺ｮ繧､繝吶Φ繝医＠縺矩∈謚槭〒縺阪∪縺帙ｓ</strong>縲ょ挨縺ｮ繧､繝吶Φ繝医ｒ驕ｸ謚槭☆繧九→縲∝燕縺ｮ繧､繝吶Φ繝医〒驕ｸ謚槭＠縺溷・螳ｹ縺ｯ荳頑嶌縺阪＆繧後∪縺吶り､・焚縺ｮ繧､繝吶Φ繝域悄髢薙↓縺ｾ縺溘′繧倶ｼ第嚊繧貞叙繧句ｴ蜷医・縲√◎繧後◇繧後・繧､繝吶Φ繝医〒蛟句挨縺ｫ驕ｸ謚槭＠縺ｦ縺上□縺輔＞縲・
          </p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 譌･莉倥′邵ｦ縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｦ隱ｭ縺ｿ縺ｫ縺上＞</summary>
          <p style="margin:8px 0 8px 20px;">A. 繧ｹ繝槭・繝医ヵ繧ｩ繝ｳ縺ｪ縺ｩ迢ｭ縺・判髱｢縺ｧ縺ｯ縲∵律莉倥′邵ｦ3陦瑚｡ｨ遉ｺ・医・2譛・/ 9譌･ /
            譛医搾ｼ峨↓縺ｪ繧翫∪縺吶ゅ％繧後・髯舌ｉ繧後◆繧ｹ繝壹・繧ｹ縺ｫ螟壹￥縺ｮ諠・ｱ繧定｡ｨ遉ｺ縺吶ｋ縺溘ａ縺ｮ莉墓ｧ倥〒縺吶１C繧・ち繝悶Ξ繝・ヨ縺ｧ縺ｯ讓ｪ荳ｦ縺ｳ陦ｨ遉ｺ縺ｫ縺ｪ繧翫∪縺吶・/p>
        </details>

        <p style="margin-top:16px;font-size:0.95em;">
          <strong>答 縺輔ｉ縺ｫ隧ｳ縺励￥遏･繧翫◆縺・婿縺ｸ</strong><br>
          繧医ｊ隧ｳ邏ｰ縺ｪ諠・ｱ縺ｯ <a href="USER_MANUAL.md" target="_blank"
            style="color:#0073bb;text-decoration:underline;">隧ｳ邏ｰ繝槭ル繝･繧｢繝ｫ・・SER_MANUAL.md・・/a> 繧偵＃隕ｧ縺上□縺輔＞縲・
        </p>
      </section>

      <section id="manualAdmin" class="manual-section manual-tab-content">
        <h4>笞呻ｸ・邂｡逅・・・繝九Η繧｢繝ｫ</h4>

        <div class="manual-alert manual-alert-warning">
          <strong>柏 邂｡逅・・Ο繧ｰ繧､繝ｳ縺ｫ縺､縺・※</strong><br>
          邂｡逅・ヱ繝阪Ν繧定｡ｨ遉ｺ縺吶ｋ縺ｫ縺ｯ縲・strong>邂｡逅・・ヱ繧ｹ繝ｯ繝ｼ繝・/strong>縺ｧ繝ｭ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞縲・br>
          荳闊ｬ繝ｦ繝ｼ繧ｶ繝ｼ繝代せ繝ｯ繝ｼ繝峨〒縺ｯ繝ｭ繧ｰ繧､繝ｳ縺ｧ縺阪※繧ゅ檎ｮ｡逅・阪・繧ｿ繝ｳ縺ｯ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ縲・
        </div>

        <h5>唐 1. CSV繧ｨ繧ｯ繧ｹ繝昴・繝・- 繝・・繧ｿ縺ｮ繝舌ャ繧ｯ繧｢繝・・</h5>
        <p><strong>逕ｨ騾・/strong>・夂樟蝨ｨ縺ｮ蜷咲ｰｿ縺ｨ蝨ｨ蟶ｭ繝・・繧ｿ繧脱xcel縺ｧ邱ｨ髮・〒縺阪ｋ蠖｢蠑上〒繝繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺ｾ縺・/p>
        <ol style="line-height:1.8;">
          <li>逕ｻ髱｢荳企Κ縺ｮ縲檎ｮ｡逅・阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>邂｡逅・ヱ繝阪Ν縺碁幕縺阪∪縺・/li>
          <li>縲靴SV繧ｨ繧ｯ繧ｹ繝昴・繝医阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ縲後ム繧ｦ繝ｳ繝ｭ繝ｼ繝峨阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・繝輔ぃ繧､繝ｫ <code>presence_<諡轤ｹID>.csv</code> 縺後ム繧ｦ繝ｳ繝ｭ繝ｼ繝峨＆繧後∪縺・/li>
        </ol>
        <p class="u-mt-8 u-text-red u-bold">笞・・驥崎ｦ・ｼ咾SV繧､繝ｳ繝昴・繝亥燕縺ｫ蠢・★繧ｨ繧ｯ繧ｹ繝昴・繝医〒繝舌ャ繧ｯ繧｢繝・・繧貞叙縺｣縺ｦ縺上□縺輔＞・・/p>

        <h5>踏 2. CSV繧､繝ｳ繝昴・繝・- 蜷咲ｰｿ縺ｮ荳諡ｬ逋ｻ骭ｲ繝ｻ譖ｴ譁ｰ</h5>
        <p><strong>逕ｨ騾・/strong>・哘xcel縺ｧ邱ｨ髮・＠縺溷錐邁ｿ繧剃ｸ諡ｬ縺ｧ蜿悶ｊ霎ｼ縺ｿ縺ｾ縺呻ｼ亥錐邁ｿ蜈ｨ菴薙′鄂ｮ縺肴鋤繧上ｊ縺ｾ縺呻ｼ・/p>

        <p style="margin:12px 0 8px 0;"><strong>蟇ｾ蠢懊＠縺ｦ縺・ｋCSV蠖｢蠑・/strong></p>
        <ul style="line-height:1.8;">
          <li>
            <strong>譛譁ｰ蠖｢蠑擾ｼ域耳螂ｨ・・/strong>・・code>1陦檎岼: 蝨ｨ蟶ｭ邂｡逅・SV / 2陦檎岼: 繧ｰ繝ｫ繝ｼ繝礼分蜿ｷ,繧ｰ繝ｫ繝ｼ繝怜錐,陦ｨ遉ｺ鬆・id,豌丞錐,蜀・ｷ・謳ｺ蟶ｯ逡ｪ蜿ｷ,Email,讌ｭ蜍呎凾髢・繧ｹ繝・・繧ｿ繧ｹ,謌ｻ繧頑凾髢・蛯呵・/code>
          </li>
          <li><strong>讓呎ｺ門ｽ｢蠑・/strong>・・code>繧ｰ繝ｫ繝ｼ繝礼分蜿ｷ,繧ｰ繝ｫ繝ｼ繝怜錐,陦ｨ遉ｺ鬆・id,豌丞錐,蜀・ｷ・讌ｭ蜍呎凾髢・繧ｹ繝・・繧ｿ繧ｹ,謌ｻ繧頑凾髢・蛯呵・/code>・域声蟶ｯ逡ｪ蜿ｷ繝ｻEmail蛻励↑縺励√ち繧､繝医Ν陦後↑縺暦ｼ・
          </li>
          <li><strong>譌ｧ蠖｢蠑・/strong>・・code>繧ｰ繝ｫ繝ｼ繝礼分蜿ｷ,繧ｰ繝ｫ繝ｼ繝怜錐,陦ｨ遉ｺ鬆・id,豌丞錐,蜀・ｷ・繧ｹ繝・・繧ｿ繧ｹ,謌ｻ繧頑凾髢・蛯呵・/code>・域･ｭ蜍呎凾髢灘・縺ｪ縺励よ里蟄倥ョ繝ｼ繧ｿ縺九ｉ蠑輔″邯吶℃縺ｾ縺呻ｼ・/li>
        </ul>

        <p style="margin:12px 0 8px 0;"><strong>謫堺ｽ懈焔鬆・/strong></p>
        <ol style="line-height:1.8;">
          <li><strong class="u-text-red">縲宣㍾隕√代∪縺壹お繧ｯ繧ｹ繝昴・繝医〒繝舌ャ繧ｯ繧｢繝・・繧貞叙繧・/strong></li>
          <li>繝繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺櫃SV繝輔ぃ繧､繝ｫ繧脱xcel縺ｧ髢九＞縺ｦ邱ｨ髮・/li>
          <li>邂｡逅・ヱ繝阪Ν縺ｮ縲靴SV繧､繝ｳ繝昴・繝医阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｧ縲後ヵ繧｡繧､繝ｫ繧帝∈謚槭阪ｒ繧ｯ繝ｪ繝・け</li>
          <li>邱ｨ髮・＠縺櫃SV繝輔ぃ繧､繝ｫ繧帝∈謚・/li>
          <li>縲悟叙繧願ｾｼ縺ｿ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・後う繝ｳ繝昴・繝亥ｮ御ｺ・阪→陦ｨ遉ｺ縺輔ｌ縺溘ｉ謌仙粥縺ｧ縺・/li>
        </ol>

        <div class="manual-alert manual-alert-danger">
          <strong>笞・・豕ｨ諢丈ｺ矩・/strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>繧､繝ｳ繝昴・繝医☆繧九→<strong>蜷咲ｰｿ蜈ｨ菴薙′鄂ｮ縺肴鋤繧上ｊ縺ｾ縺・/strong>・磯Κ蛻・峩譁ｰ縺ｯ縺ｧ縺阪∪縺帙ｓ・・/li>
            <li>CSV縺ｫ蜷ｫ縺ｾ繧後↑縺・Γ繝ｳ繝舌・縺ｯ蜑企勁縺輔ｌ縺ｾ縺・/li>
            <li>蜈・↓謌ｻ縺吶↓縺ｯ繝舌ャ繧ｯ繧｢繝・・縺ｮCSV繧貞・繧､繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞</li>
            <li>譛譁ｰ蠖｢蠑上〒縺ｯ1陦檎岼縺後ち繧､繝医Ν陦後・陦檎岼縺後・繝・ム繝ｼ陦後〒縺呻ｼ域ｨ呎ｺ悶・譌ｧ蠖｢蠑上・1陦檎岼縺後・繝・ム繝ｼ陦鯉ｼ・/li>
          </ul>
        </div>

        <h5>召 3. 諡轤ｹ蜷阪・螟画峩</h5>
        <ol style="line-height:1.8;">
          <li>邂｡逅・ヱ繝阪Ν縺ｮ縲梧侠轤ｹ蜷阪・螟画峩縲阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｫ譁ｰ縺励＞諡轤ｹ蜷阪ｒ蜈･蜉・/li>
          <li>縲悟､画峩縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・逕ｻ髱｢繧ｿ繧､繝医Ν縺ｨ繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢縺ｮ諡轤ｹ蜷阪′螟画峩縺輔ｌ縺ｾ縺・/li>
        </ol>

        <h5>泊 4. 繝代せ繝ｯ繝ｼ繝牙､画峩</h5>
        <p>2遞ｮ鬘槭・繝代せ繝ｯ繝ｼ繝峨ｒ蛟句挨縺ｫ螟画峩縺ｧ縺阪∪縺呻ｼ・/p>
        <ul style="line-height:1.8;">
          <li><strong>譁ｰ繝代せ繝ｯ繝ｼ繝・/strong>・壻ｸ闊ｬ繝ｦ繝ｼ繧ｶ繝ｼ縺後Ο繧ｰ繧､繝ｳ縺吶ｋ縺ｨ縺阪・繝代せ繝ｯ繝ｼ繝・/li>
          <li><strong>譁ｰ邂｡逅・・W</strong>・夂ｮ｡逅・・ｨｩ髯舌〒繝ｭ繧ｰ繧､繝ｳ縺吶ｋ縺ｨ縺阪・繝代せ繝ｯ繝ｼ繝・/li>
        </ul>
        <ol style="line-height:1.8;">
          <li>螟画峩縺励◆縺・ヱ繧ｹ繝ｯ繝ｼ繝画ｬ・↓譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉幢ｼ井ｸ｡譁ｹ縺ｧ繧ら援譁ｹ縺ｧ繧０K・・/li>
          <li>縲梧峩譁ｰ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・後ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ譖ｴ譁ｰ縺励∪縺励◆縲阪→陦ｨ遉ｺ縺輔ｌ縺溘ｉ謌仙粥縺ｧ縺・/li>
        </ol>
        <p style="margin:8px 0;color:#666;font-size:0.9em;">
          庁 繝代せ繝ｯ繝ｼ繝峨・蟷ｳ譁・〒菫晏ｭ倥＆繧後∪縺吶・strong>蠑ｷ蝗ｺ縺ｪ繝代せ繝ｯ繝ｼ繝・/strong>繧剃ｽｿ逕ｨ縺励※縺上□縺輔＞縲・
        </p>

        <h5>討 5. 縺顔衍繧峨○邂｡逅・/h5>
        <p><strong>逕ｨ騾・/strong>・壽侠轤ｹ縺ｮ繝｡繝ｳ繝舌・蜈ｨ蜩｡縺ｫ驥崎ｦ√↑諠・ｱ繧呈軸遉ｺ縺励∪縺・/p>

        <div class="manual-alert manual-alert-success">
          <strong>笨ｨ 閾ｪ蜍戊ｪｭ縺ｿ霎ｼ縺ｿ讖溯・</strong><br>
          邂｡逅・ヱ繝阪Ν繧帝幕縺上→縲∫樟蝨ｨ縺ｮ縺顔衍繧峨○縺・strong>閾ｪ蜍慕噪縺ｫ陦ｨ遉ｺ</strong>縺輔ｌ縺ｾ縺吶・br>
          縲檎樟蝨ｨ縺ｮ縺顔衍繧峨○繧定ｪｭ縺ｿ霎ｼ縺ｿ縲阪・繧ｿ繝ｳ繧呈款縺吝ｿ・ｦ√・縺ゅｊ縺ｾ縺帙ｓ縲・
        </div>

        <p style="margin:12px 0 8px 0;"><strong>縺顔衍繧峨○縺ｮ霑ｽ蜉</strong></p>
        <ol style="line-height:1.8;">
          <li>邂｡逅・ヱ繝阪Ν繧帝幕縺擾ｼ育樟蝨ｨ縺ｮ縺顔衍繧峨○縺瑚・蜍戊｡ｨ遉ｺ縺輔ｌ縺ｾ縺呻ｼ・/li>
          <li>縲娯桾 縺顔衍繧峨○繧定ｿｽ蜉縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け 竊・蜈･蜉帶ｬ・′霑ｽ蜉縺輔ｌ縺ｾ縺・/li>
          <li><strong>繧ｿ繧､繝医Ν</strong>・域怙螟ｧ200譁・ｭ暦ｼ峨→<strong>蜀・ｮｹ</strong>・域怙螟ｧ2000譁・ｭ暦ｼ峨ｒ蜈･蜉・/li>
          <li>縲御ｿ晏ｭ倥阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・縺顔衍繧峨○縺悟叉蠎ｧ縺ｫ菫晏ｭ倥＆繧後∫ｴ・0遘剃ｻ･蜀・↓蜈ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ逕ｻ髱｢縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
        </ol>

        <p style="margin:12px 0 8px 0;"><strong>縺顔衍繧峨○縺ｮ邱ｨ髮・/strong></p>
        <ol style="line-height:1.8;">
          <li>邱ｨ髮・＠縺溘＞縺顔衍繧峨○縺ｮ縲檎ｷｨ髮・阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>蜈･蜉帶ｬ・↓蜀・ｮｹ縺瑚｡ｨ遉ｺ縺輔ｌ繧九・縺ｧ縲∽ｿｮ豁｣縺励∪縺・/li>
          <li>縲御ｿ晏ｭ倥阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
        </ol>

        <p style="margin:12px 0 8px 0;"><strong>縺顔衍繧峨○縺ｮ蜑企勁</strong></p>
        <ol style="line-height:1.8;">
          <li>蜑企勁縺励◆縺・♀遏･繧峨○縺ｮ縲悟炎髯､縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け</li>
          <li>遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ縺ｧ縲薫K縲阪ｒ繧ｯ繝ｪ繝・け</li>
        </ol>

        <div class="manual-alert manual-alert-teal">
          <strong>庁 縺顔衍繧峨○讖溯・縺ｮ繝昴う繝ｳ繝・/strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>縺顔衍繧峨○縺ｯ<strong>諡轤ｹ縺斐→</strong>縺ｫ迢ｬ遶九＠縺ｦ邂｡逅・＆繧後∪縺・/li>
            <li>1諡轤ｹ縺ゅ◆繧・strong>譛螟ｧ20莉ｶ</strong>縺ｾ縺ｧ逋ｻ骭ｲ縺ｧ縺阪∪縺・/li>
            <li>縺顔衍繧峨○縺ｯ<strong>霑ｽ蜉縺励◆鬆・/strong>・亥商縺・・ｼ峨↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li>HTML/繧ｹ繧ｯ繝ｪ繝励ヨ縺ｯ閾ｪ蜍慕噪縺ｫ辟｡蜉ｹ蛹悶＆繧後∪縺呻ｼ医そ繧ｭ繝･繝ｪ繝・ぅ蟇ｾ遲厄ｼ・/li>
            <li>蜈ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ逕ｻ髱｢縺ｫ<strong>邏・0遘剃ｻ･蜀・/strong>縺ｫ閾ｪ蜍募渚譏縺輔ｌ縺ｾ縺・/li>
          </ul>
        </div>

        <p style="margin:12px 0 8px 0;"><strong>縺顔衍繧峨○縺ｮ逕ｨ騾比ｾ・/strong></p>
        <ul style="line-height:1.8;">
          <li>肌 繧ｷ繧ｹ繝・Β繝｡繝ｳ繝・リ繝ｳ繧ｹ縺ｮ莠亥ｮ・/li>
          <li>套 蜈ｨ菴謎ｼ夊ｭｰ繧・う繝吶Φ繝医・譯亥・</li>
          <li>笞・・讌ｭ蜍吩ｸ翫・豕ｨ諢丈ｺ矩・/li>
          <li>脂 譁ｰ讖溯・縺ｮ譯亥・</li>
          <li>討 驥崎ｦ√↑騾｣邨｡莠矩・/li>
        </ul>

        <h5>套 5. 繧､繝吶Φ繝育ｮ｡逅・/h5>
        <p><strong>逕ｨ騾・/strong>・哦W縲∝ｹｴ譛ｫ蟷ｴ蟋九∝､丞ｭ｣莨第嚊縺ｪ縺ｩ縲∬､・焚譌･縺ｫ繧上◆繧倶ｼ第嚊繧剃ｺ句燕縺ｫ逋ｻ骭ｲ繝ｻ邂｡逅・＠縺ｾ縺・/p>

        <div class="manual-alert manual-alert-success">
          <strong>笨ｨ 繧､繝吶Φ繝域ｩ溯・縺ｮ迚ｹ髟ｷ</strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>繧ｬ繝ｳ繝医メ繝｣繝ｼ繝亥ｽ｢蠑上〒莨第嚊譛滄俣縺ｨ繝｡繝ｳ繝舌・繧定ｦ冶ｦ夂噪縺ｫ邂｡逅・〒縺阪∪縺・/li>
            <li>蟇ｾ雎｡繝｡繝ｳ繝舌・縺ｮ蝨ｨ蟶ｭ迥ｶ豕√′閾ｪ蜍慕噪縺ｫ繝上う繝ｩ繧､繝郁｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
            <li>繝ｦ繝ｼ繧ｶ繝ｼ縺ｯ逋ｻ骭ｲ縺輔ｌ縺溘う繝吶Φ繝医ｒ驕ｸ謚槭＠縺ｦ陦ｨ遉ｺ縺ｧ縺阪∪縺・/li>
            <li>陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ縺ｮ蛻・ｊ譖ｿ縺医〒縲∝・髢九☆繧九う繝吶Φ繝医ｒ繧ｳ繝ｳ繝医Ο繝ｼ繝ｫ縺ｧ縺阪∪縺・/li>
          </ul>
        </div>

        <p style="margin:12px 0 8px 0;"><strong>繧､繝吶Φ繝医・菴懈・</strong></p>
        <ol style="line-height:1.8;">
          <li>邂｡逅・ヱ繝阪Ν繧帝幕縺阪・strong>縲交沒・繧､繝吶Φ繝育ｮ｡逅・・/strong>繧ｿ繝悶ｒ繧ｯ繝ｪ繝・け</li>
          <li><strong>蟇ｾ雎｡諡轤ｹ</strong>繧帝∈謚橸ｼ医せ繝ｼ繝代・邂｡逅・・・蝣ｴ蜷茨ｼ・/li>
          <li><strong>繧ｿ繧､繝医Ν</strong>繧貞・蜉幢ｼ井ｾ具ｼ壹隈W譛滄俣莨第嚊縲阪悟ｹｴ譛ｫ蟷ｴ蟋倶ｼ第嚊縲搾ｼ・/li>
          <li><strong>髢句ｧ区律</strong>縺ｨ<strong>邨ゆｺ・律</strong>繧貞・蜉幢ｼ医き繝ｬ繝ｳ繝繝ｼ縺九ｉ驕ｸ謚槫庄閭ｽ・・/li>
          <li><strong>蛯呵・/strong>・井ｻｻ諢擾ｼ峨ｒ蜈･蜉幢ｼ育､ｾ蜀・・譛臥畑縺ｮ繝｡繝｢縺ｪ縺ｩ・・/li>
          <li><strong>縲瑚｡ｨ遉ｺ縺吶ｋ縲・/strong>繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ繧丹N縺ｫ縺吶ｋ縺ｨ縲√Θ繝ｼ繧ｶ繝ｼ縺後う繝吶Φ繝医・繧ｿ繝ｳ縺九ｉ驕ｸ謚槭〒縺阪ｋ繧医≧縺ｫ縺ｪ繧翫∪縺・/li>
          <li>繧ｬ繝ｳ繝医メ繝｣繝ｼ繝茨ｼ域律莉佚励Γ繝ｳ繝舌・縺ｮ陦ｨ・峨〒縲∽ｼ第嚊蟇ｾ雎｡縺ｮ繝｡繝ｳ繝舌・縺ｨ譌･莉倥・繧ｻ繝ｫ繧偵け繝ｪ繝・け/繝峨Λ繝・げ縺励※ON縺ｫ縺励∪縺・/li>
          <li><strong>縲交汳ｾ 菴懈・/譖ｴ譁ｰ縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け</li>
          <li>笨・後う繝吶Φ繝医ｒ菫晏ｭ倥＠縺ｾ縺励◆縲阪→陦ｨ遉ｺ縺輔ｌ縺溘ｉ謌仙粥縺ｧ縺・/li>
        </ol>

        <p style="margin:12px 0 8px 0;"><strong>繧､繝吶Φ繝医・邱ｨ髮・/strong></p>
        <ol style="line-height:1.8;">
          <li>邂｡逅・ヱ繝阪Ν縺ｮ縲檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺九ｉ縲∫ｷｨ髮・＠縺溘＞鬆・岼縺ｮ<strong>縲檎ｷｨ髮・・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け</li>
          <li>蜈･蜉帶ｬ・↓迴ｾ蝨ｨ縺ｮ險ｭ螳壹′陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>蠢・ｦ√↑鬆・岼繧剃ｿｮ豁｣縺励∪縺・/li>
          <li><strong>縲交汳ｾ 菴懈・/譖ｴ譁ｰ縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け</li>
        </ol>

        <p style="margin:12px 0 8px 0;"><strong>繧､繝吶Φ繝医・蜑企勁</strong></p>
        <ol style="line-height:1.8;">
          <li>邱ｨ髮・＠縺溘＞繧､繝吶Φ繝医ｒ驕ｸ謚橸ｼ育ｷｨ髮・・繧ｿ繝ｳ繧偵け繝ｪ繝・け・・/li>
          <li><strong>縲交泓托ｸ・蜑企勁縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け</li>
          <li>遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ縺ｧ縲薫K縲阪ｒ繧ｯ繝ｪ繝・け</li>
        </ol>

        <p style="margin:12px 0 8px 0;"><strong>繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医・謫堺ｽ懈婿豕・/strong></p>
        <ul style="line-height:1.8;">
          <li><strong>繧ｻ繝ｫ繧偵け繝ｪ繝・け</strong>・壻ｼ第嚊縺ｮON/OFF繧貞・繧頑崛縺・/li>
          <li><strong>繝峨Λ繝・げ</strong>・夐｣邯壹＠縺滓律莉倥ｄ繝｡繝ｳ繝舌・繧剃ｸ蠎ｦ縺ｫ險ｭ螳・/li>
          <li><strong>繧ｹ繝槭・繝医ヵ繧ｩ繝ｳ</strong>・壹ち繝・・縺ｧ謫堺ｽ懷庄閭ｽ</li>
          <li><strong>繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝・/strong>・壹Γ繝ｳ繝舌・縺悟､壹＞蝣ｴ蜷医√げ繝ｫ繝ｼ繝鈴∈謚槭〒邏譌ｩ縺冗ｧｻ蜍輔〒縺阪∪縺・/li>
          <li><strong>濶ｲ蛻・￠</strong>・壼悄譌･繝ｻ逾晄律縺ｯ閾ｪ蜍慕噪縺ｫ濶ｲ莉倥￠縺輔ｌ縺ｾ縺・/li>
        </ul>

        <p style="margin:12px 0 8px 0;"><strong>繧､繝吶Φ繝医・荳ｦ縺ｳ譖ｿ縺・/strong></p>
        <p>縲檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺ｧ縺ｯ縲∬､・焚縺ｮ繧､繝吶Φ繝医・陦ｨ遉ｺ鬆・ｺ上ｒ螟画峩縺ｧ縺阪∪縺吶・/p>
        <ol style="line-height:1.8;">
          <li>荳隕ｧ縺ｮ縲御ｸｦ縺ｳ縲榊・縺ｫ縺ゅｋ<strong>縲娯・縲阪娯・縲阪・繧ｿ繝ｳ</strong>繧偵け繝ｪ繝・け縺吶ｋ縺ｨ縲√う繝吶Φ繝医・鬆・ｺ上′蜈･繧梧崛繧上ｊ縺ｾ縺・/li>
          <li>荳翫↓縺ゅｋ繧､繝吶Φ繝医⊇縺ｩ蜆ｪ蜈亥ｺｦ縺碁ｫ倥￥縲√Θ繝ｼ繧ｶ繝ｼ縺碁∈謚槭☆繧矩圀縺ｮ繝ｪ繧ｹ繝医・荳贋ｽ阪↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>荳ｦ縺ｳ譖ｿ縺亥ｾ後・strong>閾ｪ蜍慕噪縺ｫ菫晏ｭ・/strong>縺輔ｌ縺ｾ縺呻ｼ井ｿ晏ｭ倥・繧ｿ繝ｳ繧呈款縺吝ｿ・ｦ√・縺ゅｊ縺ｾ縺帙ｓ・・/li>
        </ol>
        <div class="manual-hint">
          <strong>庁 繝偵Φ繝・/strong>・夂樟蝨ｨ騾ｲ陦御ｸｭ縺ｮ繧､繝吶Φ繝茨ｼ井ｾ具ｼ哦W縲∝ｹｴ譛ｫ蟷ｴ蟋具ｼ峨ｒ荳贋ｽ阪↓驟咲ｽｮ縺吶ｋ縺ｨ縲√Θ繝ｼ繧ｶ繝ｼ縺碁∈謚槭＠繧・☆縺上↑繧翫∪縺吶・
        </div>

        <p style="margin:12px 0 8px 0;"><strong>莨第嚊遞ｮ蛻･・井ｼ第嚊蝗ｺ螳夲ｼ峨・險ｭ螳・/strong></p>
        <p>蜷・う繝吶Φ繝医↓蟇ｾ縺励※縲√せ繝・・繧ｿ繧ｹ縺ｨ縺励※陦ｨ遉ｺ縺輔ｌ繧九御ｼ第嚊遞ｮ蛻･縲阪ｒ險ｭ螳壹〒縺阪∪縺吶・/p>
        <ul style="line-height:1.8;">
          <li><strong>險ｭ螳壼ｴ謇</strong>・壹檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺ｮ<strong>縲御ｼ第嚊蝗ｺ螳夲ｼ育ｨｮ蛻･・峨・/strong>蛻・/li>
          <li><strong>謫堺ｽ懈婿豕・/strong>・夊ｩｲ蠖薙・蛻励ｒ繧ｯ繝ｪ繝・け縺吶ｋ縺ｨ縲√ラ繝ｭ繝・・繝繧ｦ繝ｳ縺九ｉ遞ｮ蛻･繧帝∈謚槭〒縺阪∪縺・/li>
          <li><strong>驕ｸ謚櫁い</strong>・壹御ｼ代∩縲阪御ｼ第嚊縲阪檎音莨代阪梧怏邨ｦ縲阪御ｻ｣莨代阪↑縺ｩ縺九ｉ驕ｸ謚槫庄閭ｽ</li>
          <li><strong>閾ｪ蜍穂ｿ晏ｭ・/strong>・夐∈謚槭☆繧九→蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥＆繧後√Θ繝ｼ繧ｶ繝ｼ縺ｮ逕ｻ髱｢縺ｫ蜿肴丐縺輔ｌ縺ｾ縺・/li>
        </ul>
        <div class="manual-alert manual-alert-success">
          <strong>菴ｿ逕ｨ萓・/strong>
          <ul style="margin:4px 0;line-height:1.6;">
            <li>縲隈W譛滄俣莨第嚊縲坂・ 遞ｮ蛻･・・strong>縲御ｼ第嚊縲・/strong>・磯壼ｸｸ縺ｮ髟ｷ譛滉ｼ第嚊・・/li>
            <li>縲悟ｹｴ譛ｫ蟷ｴ蟋倶ｼ第嚊縲坂・ 遞ｮ蛻･・・strong>縲御ｼ代∩縲・/strong>・井ｼ夂､ｾ莨第･ｭ譌･・・/li>
            <li>縲悟､丞ｭ｣莨第嚊縲坂・ 遞ｮ蛻･・・strong>縲梧怏邨ｦ縲・/strong>・域怏邨ｦ莨第嚊謗ｨ螂ｨ譛滄俣・・/li>
            <li>縲悟卸遶玖ｨ伜ｿｵ譌･縲坂・ 遞ｮ蛻･・・strong>縲檎音莨代・/strong>・育音蛻･莨第嚊・・/li>
          </ul>
        </div>

        <p style="margin:12px 0 8px 0;"><strong>濶ｲ/繧ｫ繝・ざ繝ｪ繝ｼ縺ｮ險ｭ螳・/strong></p>
        <p>繧､繝吶Φ繝医↓濶ｲ繧定ｨｭ螳壹☆繧九％縺ｨ縺ｧ縲∬ｦ冶ｦ夂噪縺ｫ蛹ｺ蛻･縺励ｄ縺吶￥縺ｪ繧翫∪縺吶・/p>
        <ul style="line-height:1.8;">
          <li><strong>險ｭ螳壼ｴ謇</strong>・壹う繝吶Φ繝井ｽ懈・/譖ｴ譁ｰ繝輔か繝ｼ繝縺ｮ縲瑚牡/繧ｫ繝・ざ繝ｪ繝ｼ縲阪ラ繝ｭ繝・・繝繧ｦ繝ｳ</li>
          <li><strong>驕ｸ謚櫁い</strong>・・
            <ul style="margin:4px 0 4px 20px;">
              <li>泯 <strong>繧ｵ繝九・・・mber・・/strong>・壽・繧九＞鮟・牡邉ｻ・亥､丞ｭ｣莨第嚊縺ｪ縺ｩ・・/li>
              <li>鳩 <strong>繝悶Ν繝ｼ・・lue・・/strong>・夐搨邉ｻ・磯壼ｸｸ縺ｮ莨第嚊・・/li>
              <li>泙 <strong>繧ｰ繝ｪ繝ｼ繝ｳ・・reen・・/strong>・夂ｷ醍ｳｻ・域怏邨ｦ謗ｨ螂ｨ譛滄俣縺ｪ縺ｩ・・/li>
              <li>ｩｷ <strong>繝斐Φ繧ｯ・・ink・・/strong>・壹ヴ繝ｳ繧ｯ邉ｻ・育音蛻･繧､繝吶Φ繝茨ｼ・/li>
              <li>泪 <strong>繝代・繝励Ν・・urple・・/strong>・夂ｴｫ邉ｻ・郁ｨ伜ｿｵ譌･縺ｪ縺ｩ・・/li>
              <li>洶 <strong>繝・ぅ繝ｼ繝ｫ・・eal・・/strong>・夐搨邱醍ｳｻ・育比ｿｮ譛滄俣縺ｪ縺ｩ・・/li>
              <li>笞ｫ <strong>繧ｰ繝ｬ繝ｼ・・ray・・/strong>・夂・濶ｲ邉ｻ・磯撼繧｢繧ｯ繝・ぅ繝悶↑繧､繝吶Φ繝茨ｼ・/li>
            </ul>
          </li>
          <li><strong>蜉ｹ譫・/strong>・壻ｸ隕ｧ陦ｨ遉ｺ繧・き繝ｬ繝ｳ繝繝ｼ陦ｨ遉ｺ譎ゅ↓縲∬ｨｭ螳壹＠縺溯牡縺ｧ繧､繝吶Φ繝医′隴伜挨縺輔ｌ縺ｾ縺・/li>
        </ul>

        <p style="margin:12px 0 8px 0;"><strong>邂｡逅・・↓繧医ｋ繝ｦ繝ｼ繧ｶ繝ｼ莨第嚊譌･縺ｮ邱ｨ髮・/strong></p>
        <p>邂｡逅・・・縲√う繝吶Φ繝井ｽ懈・譎ゅ・繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医〒蜈ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ莨第嚊譌･繧剃ｸ諡ｬ險ｭ螳壹〒縺阪∪縺吶・/p>
        <ol style="line-height:1.8;">
          <li>繧､繝吶Φ繝井ｽ懈・/譖ｴ譁ｰ繝輔か繝ｼ繝縺ｧ<strong>髢句ｧ区律縺ｨ邨ゆｺ・律</strong>繧貞・蜉帙☆繧九→縲√ぎ繝ｳ繝医メ繝｣繝ｼ繝医′陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/li>
          <li>繧ｬ繝ｳ繝医メ繝｣繝ｼ繝井ｸ翫〒縲・strong>蜷・Γ繝ｳ繝舌・縺ｮ莨第嚊譌･繧偵け繝ｪ繝・け/繝峨Λ繝・げ</strong>縺励※ON・磯搨濶ｲ・峨↓險ｭ螳壹＠縺ｾ縺・/li>
          <li>隍・焚縺ｮ繝｡繝ｳ繝舌・繧剃ｸ蠎ｦ縺ｫ險ｭ螳壹☆繧句ｴ蜷医・縲・strong>繝峨Λ繝・げ謫堺ｽ・/strong>縺御ｾｿ蛻ｩ縺ｧ縺・/li>
          <li>險ｭ螳壼ｾ後・strong>縲交汳ｾ 菴懈・/譖ｴ譁ｰ縲・/strong>繝懊ち繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ菫晏ｭ倥＆繧後∪縺・/li>
          <li>笨・繝ｦ繝ｼ繧ｶ繝ｼ縺後◎縺ｮ繧､繝吶Φ繝医ｒ驕ｸ謚槭☆繧九→縲∬ｨｭ螳壹＠縺滓律縺瑚・蜍慕噪縺ｫ縲御ｼ代∩縲阪せ繝・・繧ｿ繧ｹ縺ｫ縺ｪ繧翫∪縺・/li>
        </ol>
        <div class="manual-alert manual-alert-danger">
          <strong>笞・・驥崎ｦ・/strong>・壹う繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ縺ｧ繝ｦ繝ｼ繧ｶ繝ｼ閾ｪ霄ｫ縺悟､画峩縺励◆莨第嚊譌･縺ｯ縲・strong>繝ｦ繝ｼ繧ｶ繝ｼ蛟倶ｺｺ縺ｮ繝・・繧ｿ</strong>縺ｨ縺励※菫晏ｭ倥＆繧後∪縺吶・br>
          邂｡逅・・′蠕後°繧峨ぎ繝ｳ繝医メ繝｣繝ｼ繝医ｒ邱ｨ髮・＠縺ｦ繧ゅ∵里縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ縺御ｿ晏ｭ倥＠縺溷倶ｺｺ險ｭ螳壹・荳頑嶌縺阪＆繧後∪縺帙ｓ縲・
        </div>

        <p style="margin:12px 0 8px 0;"><strong>陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ縺ｮ蛻・ｊ譖ｿ縺・/strong></p>
        <ul style="line-height:1.8;">
          <li>縲檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺ｮ<strong>縲瑚｡ｨ遉ｺ縲阪メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ</strong>縺ｧ蛻・ｊ譖ｿ縺医ｉ繧後∪縺・/li>
          <li>繝√ぉ繝・けON・壹Θ繝ｼ繧ｶ繝ｼ縺後う繝吶Φ繝医・繧ｿ繝ｳ縺九ｉ驕ｸ謚槭〒縺阪∪縺・/li>
          <li>繝√ぉ繝・けOFF・夂ｮ｡逅・・・縺ｿ髢ｲ隕ｧ蜿ｯ閭ｽ・医Θ繝ｼ繧ｶ繝ｼ縺ｫ縺ｯ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ・・/li>
          <li>隍・焚縺ｮ繧､繝吶Φ繝医ｒ蜷梧凾縺ｫ縲瑚｡ｨ遉ｺ縲阪↓縺ｧ縺阪∪縺吶′縲√Θ繝ｼ繧ｶ繝ｼ縺碁∈謚槭〒縺阪ｋ縺ｮ縺ｯ1縺､縺縺代〒縺・/li>
        </ul>

        <div class="manual-alert manual-alert-teal">
          <strong>庁 繧､繝吶Φ繝域ｩ溯・縺ｮ繝昴う繝ｳ繝・/strong>
          <ul style="margin:8px 0;line-height:1.8;">
            <li>繧､繝吶Φ繝医・<strong>諡轤ｹ縺斐→</strong>縺ｫ迢ｬ遶九＠縺ｦ邂｡逅・＆繧後∪縺・/li>
            <li>繝ｦ繝ｼ繧ｶ繝ｼ縺後う繝吶Φ繝医ｒ驕ｸ謚槭☆繧九→縲∬ｩｲ蠖薙Γ繝ｳ繝舌・縺ｮ陦後′<strong>繝上う繝ｩ繧､繝郁｡ｨ遉ｺ</strong>縺輔ｌ縺ｾ縺・/li>
            <li>繧ｹ繝・・繧ｿ繧ｹ谺・↓繧､繝吶Φ繝医・繧ｿ繧､繝医Ν縺瑚｡ｨ遉ｺ縺輔ｌ縲∝・驛ｨ逧・↓縺ｯ縲御ｼ代∩縲阪→縺励※謇ｱ繧上ｌ縺ｾ縺・/li>
            <li>繧､繝吶Φ繝郁｡ｨ遉ｺ繧定ｧ｣髯､縺吶ｋ縺ｾ縺ｧ縲∬ｩｲ蠖薙Γ繝ｳ繝舌・縺ｮ繧ｹ繝・・繧ｿ繧ｹ縺ｯ邱ｨ髮・〒縺阪∪縺帙ｓ</li>
            <li>莨第嚊譛滄俣縺檎ｵゆｺ・＠縺ｦ繧り・蜍慕噪縺ｫ縺ｯ隗｣髯､縺輔ｌ縺ｾ縺帙ｓ・域焔蜍輔〒髱櫁｡ｨ遉ｺ縺ｫ縺励※縺上□縺輔＞・・/li>
          </ul>
        </div>

        <p style="margin:12px 0 8px 0;"><strong>繧､繝吶Φ繝医・逕ｨ騾比ｾ・/strong></p>
        <ul style="line-height:1.8;">
          <li>詞 <strong>GW・医ざ繝ｼ繝ｫ繝・Φ繧ｦ繧｣繝ｼ繧ｯ・・/strong>・・譛医・騾｣莨第悄髢・/li>
          <li>紙 <strong>螟丞ｭ｣莨第嚊</strong>・・譛医・縺顔寔莨代∩譛滄俣</li>
          <li>私 <strong>蟷ｴ譛ｫ蟷ｴ蟋倶ｼ第嚊</strong>・・2譛域忰縲・譛亥・譌ｬ</li>
          <li>召 <strong>莨夂､ｾ蜈ｨ菴謎ｼ第･ｭ譌･</strong>・壼卸遶玖ｨ伜ｿｵ譌･縺ｪ縺ｩ</li>
          <li>套 <strong>迚ｹ螳壹メ繝ｼ繝縺ｮ荳譁我ｼ第嚊</strong>・夐Κ鄂ｲ蜊倅ｽ阪・莨第嚊險育判</li>
        </ul>

        <h5>搭 驕狗畑荳翫・豕ｨ諢丈ｺ矩・/h5>
        <ul style="line-height:1.8;">
          <li>沈 <strong>繝舌ャ繧ｯ繧｢繝・・縺ｯ蠢・・/strong>・夐㍾隕√↑謫堺ｽ懊・蜑阪↓蠢・★CSV繧ｨ繧ｯ繧ｹ繝昴・繝医〒繝舌ャ繧ｯ繧｢繝・・繧貞叙縺｣縺ｦ縺上□縺輔＞</li>
          <li>則 <strong>隍・焚邂｡逅・・・蜷梧凾謫堺ｽ懊・驕ｿ縺代ｋ</strong>・夂ｫｶ蜷医＠縺ｦ繝・・繧ｿ縺悟､ｱ繧上ｌ繧句庄閭ｽ諤ｧ縺後≠繧翫∪縺・/li>
          <li>売 <strong>螳壽悄繝舌ャ繧ｯ繧｢繝・・</strong>・夐ｱ1蝗樒ｨ句ｺｦ縲∝ｮ壽悄逧・↓CSV繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧九％縺ｨ繧呈耳螂ｨ縺励∪縺・/li>
          <li>白 <strong>繝代せ繝ｯ繝ｼ繝臥ｮ｡逅・/strong>・壹ヱ繧ｹ繝ｯ繝ｼ繝峨・蟷ｳ譁・ｿ晏ｭ倥・縺溘ａ縲∝ｼｷ蝗ｺ縺ｪ繧ゅ・繧剃ｽｿ縺・・未菫り・ｻ･螟悶↓貍上ｉ縺輔↑縺・〒縺上□縺輔＞</li>
        </ul>

        <h5>笶・繧医￥縺ゅｋ雉ｪ蝠擾ｼ育ｮ｡逅・・髄縺托ｼ・/h5>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. CSV繧､繝ｳ繝昴・繝医〒縲靴SV繝倥ャ繝縺御ｸ肴ｭ｣縺ｧ縺吶阪→蜃ｺ繧・/summary>
          <p style="margin:8px 0 8px 20px;">A. 繝倥ャ繝繝ｼ陦鯉ｼ域怙譁ｰ蠖｢蠑上〒縺ｯ2陦檎岼・峨′豁｣縺励＞蠖｢蠑上°遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲ゅお繧ｯ繧ｹ繝昴・繝医＠縺櫃SV縺ｮ繝倥ャ繝繝ｼ陦後ｒ縺昴・縺ｾ縺ｾ菴ｿ縺・・縺檎｢ｺ螳溘〒縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 隱､縺｣縺ｦ繝｡繝ｳ繝舌・繧貞炎髯､縺励※縺励∪縺｣縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 蜑企勁蜑阪・繝舌ャ繧ｯ繧｢繝・・CSV繧貞・繧､繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞縲ゅヰ繝・け繧｢繝・・縺後↑縺・ｴ蜷医・謇句虚縺ｧCSV繧剃ｽ懈・縺吶ｋ蠢・ｦ√′縺ゅｊ縺ｾ縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繝｡繝九Η繝ｼ險ｭ螳壹・JSON縺梧ｭ｣縺励＞縺倶ｸ榊ｮ・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            繧ｪ繝ｳ繝ｩ繧､繝ｳ縺ｮJSON繝舌Μ繝・・繧ｿ繝ｼ・井ｾ具ｼ嗚sonlint.com・峨〒遒ｺ隱阪〒縺阪∪縺吶ゆｿ晏ｭ俶凾縺ｫ繧ｨ繝ｩ繝ｼ縺悟・縺溷ｴ蜷医・縲檎樟蝨ｨ縺ｮ險ｭ螳壹ｒ隱ｭ縺ｿ霎ｼ縺ｿ縲阪〒蜈・↓謌ｻ縺励※縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医・繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医′陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ</summary>
          <p style="margin:8px 0 8px 20px;">A. 髢句ｧ区律縺ｨ邨ゆｺ・律繧貞・蜉帙＠縺ｦ縺九ｉ縲√ぎ繝ｳ繝医メ繝｣繝ｼ繝医′逕滓・縺輔ｌ縺ｾ縺吶よ律莉倥ｒ蜈･蜉帙＠縺ｦ縺・ｋ縺薙→繧堤｢ｺ隱阪＠縺ｦ縺上□縺輔＞縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医ｒ菫晏ｭ倥＠縺溘・縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｪ縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 縲瑚｡ｨ遉ｺ縺吶ｋ縲阪メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ縺薫N縺ｫ縺ｪ縺｣縺ｦ縺・ｋ縺狗｢ｺ隱阪＠縺ｦ縺上□縺輔＞縲ゅメ繧ｧ繝・けOFF縺ｮ蝣ｴ蜷医∫ｮ｡逅・・・縺ｿ髢ｲ隕ｧ蜿ｯ閭ｽ縺ｧ繝ｦ繝ｼ繧ｶ繝ｼ縺ｫ縺ｯ陦ｨ遉ｺ縺輔ｌ縺ｾ縺帙ｓ縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医・陦ｨ遉ｺ繧偵ｄ繧√◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 繧､繝吶Φ繝育ｮ｡逅・〒隧ｲ蠖薙☆繧倶ｼ第嚊縺ｮ縲瑚｡ｨ遉ｺ縲阪メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ繧丹FF縺ｫ縺励※縺上□縺輔＞縲ゅ∪縺溘・縲∽ｼ第嚊繧貞炎髯､縺吶ｋ縺薙→繧ゅ〒縺阪∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医・荳ｦ縺ｳ鬆・ｒ螟画峩縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 縲檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺ｮ縲御ｸｦ縺ｳ縲榊・縺ｫ縺ゅｋ竊鯛・繝懊ち繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ鬆・ｺ上ｒ螟画峩縺ｧ縺阪∪縺吶ょ､画峩縺ｯ閾ｪ蜍穂ｿ晏ｭ倥＆繧後∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 莨第嚊遞ｮ蛻･・井ｼ第嚊蝗ｺ螳夲ｼ峨ｒ螟画峩縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            縲檎匳骭ｲ貂医∩縺ｮ繧､繝吶Φ繝医堺ｸ隕ｧ縺ｮ縲御ｼ第嚊蝗ｺ螳夲ｼ育ｨｮ蛻･・峨榊・繧偵け繝ｪ繝・け縺吶ｋ縺ｨ縲√ラ繝ｭ繝・・繝繧ｦ繝ｳ縺九ｉ遞ｮ蛻･・井ｼ代∩縲∽ｼ第嚊縲∫音莨代∵怏邨ｦ縲∽ｻ｣莨代↑縺ｩ・峨ｒ驕ｸ謚槭〒縺阪∪縺吶る∈謚槭☆繧九→蜊ｳ蠎ｧ縺ｫ菫晏ｭ倥＆繧後∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医・濶ｲ繧貞､画峩縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 繧､繝吶Φ繝育ｷｨ髮・判髱｢縺ｮ縲瑚牡/繧ｫ繝・ざ繝ｪ繝ｼ縲阪ラ繝ｭ繝・・繝繧ｦ繝ｳ縺九ｉ縲√し繝九・縲√ヶ繝ｫ繝ｼ縲√げ繝ｪ繝ｼ繝ｳ縲√ヴ繝ｳ繧ｯ縲√ヱ繝ｼ繝励Ν縲√ユ繧｣繝ｼ繝ｫ縲√げ繝ｬ繝ｼ縺ｮ荳ｭ縺九ｉ驕ｸ謚槭〒縺阪∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 隍・焚縺ｮ繧､繝吶Φ繝医ｒ蜷梧凾縺ｫ陦ｨ遉ｺ縺ｧ縺阪∪縺吶°・・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            邂｡逅・・・隍・焚縺ｮ繧､繝吶Φ繝医ｒ縲瑚｡ｨ遉ｺ縺吶ｋ縲阪↓險ｭ螳壹〒縺阪∪縺吶′縲√Θ繝ｼ繧ｶ繝ｼ縺悟ｮ滄圀縺ｫ驕ｸ謚槭〒縺阪ｋ縺ｮ縺ｯ1縺､縺縺代〒縺吶ゅΘ繝ｼ繧ｶ繝ｼ縺ｯ繧､繝吶Φ繝医・繧ｿ繝ｳ縺九ｉ驕ｸ謚槭＠縺ｦ蛻・ｊ譖ｿ縺医ｋ縺薙→縺後〒縺阪∪縺吶・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繝ｦ繝ｼ繧ｶ繝ｼ縺悟句挨縺ｫ螟画峩縺励◆莨第嚊譌･繧堤ｮ｡逅・・′遒ｺ隱阪〒縺阪∪縺吶°・・/summary>
          <p style="margin:8px 0 8px 20px;">A.
            繝ｦ繝ｼ繧ｶ繝ｼ縺碁聞譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｧ螟画峩縺励◆蜀・ｮｹ縺ｯ縲√◎縺ｮ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ縲後Γ繝ｳ繝舌・縺ｮ莨第嚊謖・ｮ壹ン繝・ヨ・・embersBits・峨阪→縺励※菫晏ｭ倥＆繧後※縺・∪縺吶らｮ｡逅・・・CSV繧ｨ繧ｯ繧ｹ繝昴・繝医〒遒ｺ隱阪〒縺阪∪縺吶′縲∫峩謗･邱ｨ髮・☆繧区ｩ溯・縺ｯ迴ｾ蝨ｨ縺ゅｊ縺ｾ縺帙ｓ縲ょ推繝ｦ繝ｼ繧ｶ繝ｼ縺瑚・蛻・〒髟ｷ譛滉ｼ第嚊繧ｫ繝ｬ繝ｳ繝繝ｼ縺九ｉ螟画峩縺励※縺上□縺輔＞縲・
          </p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医〒險ｭ螳壹＠縺滉ｼ第嚊譌･縺悟渚譏縺輔ｌ縺ｪ縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医〒繧ｻ繝ｫ繧偵け繝ｪ繝・け/繝峨Λ繝・げ縺励◆蠕後∝ｿ・★縲交汳ｾ
            菴懈・/譖ｴ譁ｰ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺励※菫晏ｭ倥＠縺ｦ縺上□縺輔＞縲ゅ∪縺溘√Θ繝ｼ繧ｶ繝ｼ蛛ｴ縺ｧ隧ｲ蠖薙う繝吶Φ繝医ｒ驕ｸ謚槭＠縺ｦ縺・↑縺・ｴ蜷医・縲∽ｼ第嚊譌･縺ｨ縺励※蜿肴丐縺輔ｌ縺ｾ縺帙ｓ縲・/p>
        </details>
        <details style="margin:8px 0;">
          <summary style="cursor:pointer;font-weight:bold;padding:4px 0;">Q. 繧､繝吶Φ繝医・蟇ｾ雎｡諡轤ｹ繧貞､画峩縺励◆縺・/summary>
          <p style="margin:8px 0 8px 20px;">A. 繧､繝吶Φ繝育ｷｨ髮・判髱｢縺ｮ縲悟ｯｾ雎｡諡轤ｹ縲阪ラ繝ｭ繝・・繝繧ｦ繝ｳ縺九ｉ螟画峩縺ｧ縺阪∪縺呻ｼ医せ繝ｼ繝代・邂｡逅・・・縺ｿ・峨ょ､画峩蠕後交汳ｾ 菴懈・/譖ｴ譁ｰ縲阪・繧ｿ繝ｳ縺ｧ菫晏ｭ倥＠縺ｦ縺上□縺輔＞縲・/p>
        </details>

        <p style="margin-top:16px;font-size:0.95em;">
          <strong>答 縺輔ｉ縺ｫ隧ｳ縺励￥遏･繧翫◆縺・婿縺ｸ</strong><br>
          繧医ｊ隧ｳ邏ｰ縺ｪ諠・ｱ縺ｯ <a href="ADMIN_MANUAL.md" target="_blank"
            style="color:#0073bb;text-decoration:underline;">邂｡逅・・髄縺題ｩｳ邏ｰ繝槭ル繝･繧｢繝ｫ・・DMIN_MANUAL.md・・/a> 繧偵＃隕ｧ縺上□縺輔＞縲・
        </p>
      </section>
    </div>
  </div>

  <!-- 繝ｭ繧ｰ繧､繝ｳ -->
  <div id="login" class="login u-hidden">
    <form class="card" onsubmit="event.preventDefault();">
      <h2>蝨ｨ蟶ｭ遒ｺ隱崎｡ｨ</h2>
      <p>諡轤ｹ繧帝∈縺ｳ縲√ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</p>
      <input type="text" name="username" id="dummyUsername" tabindex="-1" aria-hidden="true" class="u-visually-hidden"
        autocomplete="username">
      <select id="officeSel" aria-label="諡轤ｹ"
        onchange="document.getElementById('dummyUsername').value = this.options[this.selectedIndex].text"></select>
      <input type="password" id="pw" placeholder="Password" autocomplete="current-password" />
      <button id="btnLogin" type="button">繝ｭ繧ｰ繧､繝ｳ</button>
      <div id="loginMsg" class="login-msg" aria-live="polite"></div>
    </form>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- 縺顔衍繧峨○繧ｨ繝ｪ繧｢ -->
  <div id="noticesArea" class="notices-area u-hidden">
    <div class="notices-container">
      <div class="notices-header">
        <h3 class="notices-title">討 縺顔衍繧峨○<span class="notices-hint">・医ち繧､繝医Ν陦後ｄ討繝懊ち繝ｳ繧偵け繝ｪ繝・け縺吶ｋ縺ｨ謚倥ｊ縺溘◆繧√∪縺呻ｼ・/span></h3>
        <span id="noticesSummary" class="notices-summary u-hidden"></span>
      </div>
      <div id="noticesList" class="notices-list"></div>
    </div>
  </div>

  <div class="wrap">
    <div id="board" class="board u-hidden"></div>
  </div>
  <div id="diag" class="diag"></div>
  
  縲
  
  
  
  
  
  
  
  
  
  
  
  
  <script src="main.js"></script>

<script>

/* --- app_core.js --- */
/**
 * App Core Structure
 * Implements Single Source of Truth and Namespace separation.
 */
const App = {
  // Application Configuration (Immutable settings)
  Config: {
    REMOTE_ENDPOINT: "https://presence-proxy-test.taka-hiyo.workers.dev",
    REMOTE_POLL_MS: 10000,
    CONFIG_POLL_MS: 30000,
    TOKEN_DEFAULT_TTL: 3600000,
    
    // Firebase Config
    Firebase: {
      apiKey: "AIzaSyDRTr7h0diRJW6U1dQJaJgr303A5wm3aTE",
      authDomain: "whereabouts-438df.firebaseapp.com",
      projectId: "whereabouts-438df",
      storageBucket: "whereabouts-438df.firebasestorage.app",
      messagingSenderId: "955108979418",
      appId: "1:955108979418:web:31a7235eeec873018dabe3",
      measurementId: "G-26G0TS4HDW"
    },

    // Public Office Fallbacks
    PUBLIC_OFFICE_FALLBACKS: []
  },

  // Application State (Mutable runtime data)
  State: {
    GROUPS: [],
    CONFIG_UPDATED: 0,
    MENUS: null,
    STATUSES: [],
    requiresTimeSet: new Set(),
    clearOnSet: new Set(),
    statusClassMap: new Map(),
    
    // Auth & Session
    SESSION_TOKEN: "",
    CURRENT_OFFICE_NAME: "",
    CURRENT_OFFICE_ID: "",
    CURRENT_ROLE: "user",
    
    // Timers
    Timers: {
      tokenRenew: null,
      remotePull: null,
      configWatch: null,
      eventSync: null
    },
    
    // UI State
    resumeRemoteSyncOnVisible: false,
    resumeConfigWatchOnVisible: false,
    resumeEventSyncOnVisible: false,
    
    // Pending updates
    PENDING_ROWS: new Set(),
    
    // Event/Vacation State
    Events: {
      currentIds: [],
      currentOfficeId: '',
      cached: { officeId:'', list:[] },
      appliedIds: [],
      appliedOfficeId: '',
      appliedTitles: [],
      selectedId: '',
      selectedIds: [],
      dateColorState: { 
        officeId:'', 
        map: new Map(), 
        lastSaved: new Map(), 
        autoSaveTimer: null, 
        saveInFlight: false, 
        queued: false, 
        statusEl: null, 
        loaded: false 
      }
    }
  },

  // UI Components & References
  UI: {
    // Will be populated on init
    Elements: {}
  },

  // Data Logic
  Data: {}
};

// Initialize Firebase helper (moved from config.js)
App.initFirebase = function() {
  if (typeof firebase === 'undefined') {
    console.error("Firebase SDK not loaded.");
    return false;
  }
  if (firebase.apps && firebase.apps.length > 0) return true;
  
  firebase.initializeApp(App.Config.Firebase);
  return true;
};

// Helper for waiting firebase load
if (!App.initFirebase()) {
  window.addEventListener('load', () => { App.initFirebase(); }, { once: true });
}


/* --- app_sync_legacy.js --- */
/**
 * App Sync Legacy
 * Synchronizes App.State changes to legacy global variables.
 */
(function () {
    if (!App || !App.State) return;

    // Export Config Constants to Global Scope
    window.REMOTE_ENDPOINT = App.Config.REMOTE_ENDPOINT;
    window.REMOTE_POLL_MS = App.Config.REMOTE_POLL_MS;
    window.CONFIG_POLL_MS = App.Config.CONFIG_POLL_MS;
    window.TOKEN_DEFAULT_TTL = App.Config.TOKEN_DEFAULT_TTL;
    window.PUBLIC_OFFICE_FALLBACKS = App.Config.PUBLIC_OFFICE_FALLBACKS;
    window.firebaseConfig = App.Config.Firebase;
    window.initFirebase = App.initFirebase;

    // Wrap App.State in a Proxy to update globals
    // We assume App.State is an object.

    // We need to keep the original values
    const originalState = App.State;

    App.State = new Proxy(originalState, {
        set: function (obj, prop, value) {
            obj[prop] = value;

            // Sync to globals
            if (prop === 'SESSION_TOKEN') {
                try { window.SESSION_TOKEN = value; } catch (e) { }
            }
            if (prop === 'CURRENT_OFFICE_ID') {
                try { window.CURRENT_OFFICE_ID = value; } catch (e) { }
            }
            if (prop === 'CURRENT_ROLE') {
                try { window.CURRENT_ROLE = value; } catch (e) { }
            }
            if (prop === 'CURRENT_OFFICE_NAME') {
                try { window.CURRENT_OFFICE_NAME = value; } catch (e) { }
            }
            if (prop === 'CURRENT_NOTICES') {
                try { window.CURRENT_NOTICES = value; } catch (e) { }
            }

            return true;
        },
        get: function (obj, prop) {
            return obj[prop];
        }
    });

    console.log("App.State changes will now sync to legacy globals.");
})();


/* --- globals.js --- */
/* ===== 謗･邯夊ｨｭ螳・===== */
/* config.js 縺ｧ REMOTE_ENDPOINT 縺ｪ縺ｩ繧貞ｮ夂ｾｩ */

/* 繧ｻ繝・す繝ｧ繝ｳ繧ｭ繝ｼ */
const SESSION_KEY = "presence-session-token";
const SESSION_ROLE_KEY = "presence-role";
const SESSION_OFFICE_KEY = "presence-office";
const SESSION_OFFICE_NAME_KEY = "presence-office-name";

/* 隕∫ｴ */
const board=document.getElementById('board'), toastEl=document.getElementById('toast'), diag=document.getElementById('diag');
const loginEl=document.getElementById('login'), loginMsg=document.getElementById('loginMsg'), pwInput=document.getElementById('pw'), officeSel=document.getElementById('officeSel'), btnLogin=document.getElementById('btnLogin');
const menuEl=document.getElementById('groupMenu'), menuList=document.getElementById('groupMenuList'), menuTitle=document.getElementById('groupMenuTitle'), titleBtn=document.getElementById('titleBtn');
const noticesBtn=document.getElementById('noticesBtn'), adminBtn=document.getElementById('adminBtn'), logoutBtn=document.getElementById('logoutBtn'), adminModal=document.getElementById('adminModal'), adminClose=document.getElementById('adminClose');
const toolsBtn=document.getElementById('toolsBtn'), toolsModal=document.getElementById('toolsModal'), toolsModalClose=document.getElementById('toolsModalClose');
const eventBtn=document.getElementById('eventBtn'), eventModal=document.getElementById('eventModal'), eventClose=document.getElementById('eventClose');
const vacationRadioList=document.getElementById('vacationRadioList');
const eventGanttWrap=document.getElementById('eventGanttWrap');
const eventGantt=document.getElementById('eventGantt');
const eventGroupJumps=document.getElementById('eventGroupJumps');
const eventColorManualHint=document.getElementById('eventColorManualHint');
const eventStartInput=document.getElementById('eventStart');
const eventEndInput=document.getElementById('eventEnd');
const eventBitsInput=document.getElementById('eventBits');
const btnEventPrint=document.getElementById('btnEventPrint');
const btnExport=document.getElementById('btnExport'), csvFile=document.getElementById('csvFile'), btnImport=document.getElementById('btnImport');
const renameOfficeName=document.getElementById('renameOfficeName'), btnRenameOffice=document.getElementById('btnRenameOffice');
const setPw=document.getElementById('setPw'), setAdminPw=document.getElementById('setAdminPw'), btnSetPw=document.getElementById('btnSetPw');
const memberTableBody=document.getElementById('memberTableBody'), btnMemberSave=document.getElementById('btnMemberSave'), btnMemberReload=document.getElementById('btnMemberReload');
const memberEditForm=document.getElementById('memberEditForm');
const memberEditTop=document.getElementById('memberEditTop');
const memberEditName=document.getElementById('memberEditName'), memberEditExt=document.getElementById('memberEditExt'), memberEditMobile=document.getElementById('memberEditMobile'), memberEditEmail=document.getElementById('memberEditEmail'), memberEditGroup=document.getElementById('memberEditGroup');
const memberGroupOptions=document.getElementById('memberGroupOptions'), memberEditId=document.getElementById('memberEditId'), memberEditModeLabel=document.getElementById('memberEditModeLabel');
const memberEditReset=document.getElementById('memberEditReset'), memberFilterInput=document.getElementById('memberFilterInput'), btnMemberFilterClear=document.getElementById('btnMemberFilterClear');
const adminOfficeRow=document.getElementById('adminOfficeRow'), adminOfficeSel=document.getElementById('adminOfficeSel');
const manualBtn=document.getElementById('manualBtn'), manualModal=document.getElementById('manualModal'), manualClose=document.getElementById('manualClose'), manualUser=document.getElementById('manualUser'), manualAdmin=document.getElementById('manualAdmin');
const nameFilter=document.getElementById('nameFilter'), statusFilter=document.getElementById('statusFilter');
const noticesEditor=document.getElementById('noticesEditor'), btnAddNotice=document.getElementById('btnAddNotice'), btnLoadNotices=document.getElementById('btnLoadNotices'), btnSaveNotices=document.getElementById('btnSaveNotices');
const toolsEditor=document.getElementById('toolsEditor'), btnAddTool=document.getElementById('btnAddTool'), btnLoadTools=document.getElementById('btnLoadTools'), btnSaveTools=document.getElementById('btnSaveTools');
const noticeModal=document.getElementById('noticeModal'), noticeModalTitle=document.getElementById('noticeModalTitle'), noticeModalBody=document.getElementById('noticeModalBody'), noticeModalClose=document.getElementById('noticeModalClose');
const toolsList=document.getElementById('toolsList');
const vacationTitleInput=document.getElementById('vacationTitle'), vacationStartInput=document.getElementById('vacationStart'), vacationEndInput=document.getElementById('vacationEnd');
const vacationNoticeSelect=document.getElementById('vacationNotice'), vacationOfficeSelect=document.getElementById('vacationOffice'), vacationMembersBitsInput=document.getElementById('vacationMembersBits');
const btnCreateNoticeFromEvent=document.getElementById('btnCreateNoticeFromEvent');
const vacationIdInput=document.getElementById('vacationId'), vacationListBody=document.getElementById('vacationListBody');
const vacationTypeText=document.getElementById('vacationTypeText');
const vacationColorSelect=document.getElementById('vacationColor');
const btnVacationSave=document.getElementById('btnVacationSave'), btnVacationDelete=document.getElementById('btnVacationDelete'), btnVacationReload=document.getElementById('btnVacationReload'), btnVacationClear=document.getElementById('btnVacationClear');

/* 迥ｶ諷・*/
let GROUPS=[], CONFIG_UPDATED=0, MENUS=null, STATUSES=[], requiresTimeSet=new Set(), clearOnSet=new Set(), statusClassMap=new Map();
let tokenRenewTimer=null, ro=null, remotePullTimer=null, configWatchTimer=null, eventSyncTimer=null;
let resumeRemoteSyncOnVisible=false, resumeConfigWatchOnVisible=false, resumeEventSyncOnVisible=false;
let storeKeyBase="presence-board-v4";
const PENDING_ROWS = new Set();
let adminSelectedOfficeId='';
let currentEventIds=[];
let currentEventOfficeId='';
let cachedEvents={ officeId:'', list:[] };
let appliedEventIds=[];
let appliedEventOfficeId='';
let appliedEventTitles=[];
let eventGanttController=null;
let eventSelectedId='';
let selectedEventIds=[];
let eventDateColorState={ officeId:'', map:new Map(), lastSaved:new Map(), autoSaveTimer:null, saveInFlight:false, queued:false, statusEl:null, loaded:false };
const EVENT_SYNC_INTERVAL_MS = Math.max(typeof REMOTE_POLL_MS==='number'?REMOTE_POLL_MS:10000, 15000);

/* 隱崎ｨｼ迥ｶ諷・*/
let SESSION_TOKEN=""; let CURRENT_OFFICE_NAME=""; let CURRENT_OFFICE_ID=""; let CURRENT_ROLE="user";

document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    resumeRemoteSyncOnVisible = remotePullTimer != null;
    resumeConfigWatchOnVisible = configWatchTimer != null;
    resumeEventSyncOnVisible = eventSyncTimer != null;
    clearInterval(remotePullTimer);
    clearInterval(configWatchTimer);
    clearInterval(eventSyncTimer);
    remotePullTimer = null;
    configWatchTimer = null;
    eventSyncTimer = null;
  }else{
    if(resumeRemoteSyncOnVisible && SESSION_TOKEN){
      startRemoteSync(true);
    }
    if(resumeConfigWatchOnVisible && SESSION_TOKEN){
      startConfigWatch();
    }
    if(resumeEventSyncOnVisible && SESSION_TOKEN){
      startEventSync(true);
    }
    resumeRemoteSyncOnVisible = false;
    resumeConfigWatchOnVisible = false;
    resumeEventSyncOnVisible = false;
  }
});
function isOfficeAdmin(){ return CURRENT_ROLE==='officeAdmin' || CURRENT_ROLE==='superAdmin'; }

function getRosterOrdering(){
  if(!Array.isArray(GROUPS)) return [];
  return GROUPS.map(g => ({
    title: g.title || '',
    members: Array.isArray(g.members) ? g.members : []
  }));
}

/* 繧､繝吶Φ繝医・陦ｨ遉ｺ */
function summarizeVacationMembers(bitsStr){
  if(!bitsStr || typeof getRosterOrdering !== 'function') return '';
  const members = getRosterOrdering().flatMap(g => g.members || []);
  if(!members.length) return '';
  const onSet = new Set();
  bitsStr.split(';').map(s => s.trim()).filter(Boolean).forEach(part => {
    const bits = part.includes(':') ? (part.split(':')[1] || '') : part;
    for(let i=0;i<bits.length && i<members.length;i++){
      if(bits[i] === '1') onSet.add(i);
    }
  });
  const names = members.map(m => m.name || '').filter((_,idx)=> onSet.has(idx));
  if(names.length === 0) return '';
  if(names.length <= 3) return names.join('縲・);
  return `${names.slice(0,3).join('縲・)} 縺ｻ縺・{names.length-3}蜷港;
}

function coerceVacationVisibleFlag(raw){
  if(raw === true) return true;
  if(raw === false) return false;
  if(typeof raw === 'number') return raw !== 0;
  if(typeof raw === 'string'){
    const s = raw.trim().toLowerCase();
    if(!s) return false;
    return !(s === 'false' || s === '0' || s === 'off' || s === 'no' || s === 'hide');
  }
  return false;
}

function renderVacationRadioMessage(message){
  // 繝励Ν繝繧ｦ繝ｳ蠖｢蠑上・蝣ｴ蜷・
  const dropdown = document.getElementById('eventSelectDropdown');
  if(dropdown){
    dropdown.innerHTML = '';
    const option = document.createElement('option');
    option.value = '';
    option.textContent = message;
    option.disabled = true;
    option.selected = true;
    dropdown.appendChild(option);
    dropdown.disabled = true;
    return;
  }
  
  // 譌ｧ蠖｢蠑擾ｼ医き繝ｼ繝峨Μ繧ｹ繝茨ｼ峨・繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
  if(!vacationRadioList) return;
  vacationRadioList.style.display='block';
  vacationRadioList.textContent='';
  const div=document.createElement('div');
  div.style.textAlign='center';
  div.style.padding='20px';
  div.style.color='#6b7280';
  div.textContent=message;
  vacationRadioList.appendChild(div);
}

const EVENT_COLOR_KEYS=['amber','blue','green','pink','purple','teal','gray','sunday','holiday','slate'];
const EVENT_COLOR_LABELS={
  amber:'繧ｵ繝九・',
  blue:'繝悶Ν繝ｼ',
  green:'繧ｰ繝ｪ繝ｼ繝ｳ',
  pink:'繝斐Φ繧ｯ',
  purple:'繝代・繝励Ν',
  teal:'繝・ぅ繝ｼ繝ｫ',
  gray:'繧ｰ繝ｬ繝ｼ',
  sunday:'譌･譖・,
  holiday:'逾晄律',
  slate:'繧ｹ繝ｬ繝ｼ繝・
};
const EVENT_COLOR_LEGACY_FALLBACKS={
  pink:'sunday',
  gray:'slate',
  grey:'slate'
};
const EVENT_COLOR_TRANSPORT_FALLBACKS={
  sunday:'pink',
  holiday:'pink',
  slate:'gray'
};
const PALETTE_TO_EVENT_COLOR_MAP={
  none:'',
  saturday:'blue',
  sunday:'sunday',
  holiday:'holiday',
  amber:'amber',
  mint:'green',
  lavender:'purple',
  slate:'slate'
};
const EVENT_COLOR_TO_PALETTE_MAP={
  amber:'amber',
  blue:'saturday',
  green:'mint',
  purple:'lavender',
  teal:'mint',
  sunday:'sunday',
  holiday:'holiday',
  slate:'slate',
  pink:'sunday',
  gray:'slate',
  grey:'slate',
  none:'none',
  saturday:'saturday'
};
const PALETTE_KEYS=['none','saturday','sunday','holiday','amber','mint','lavender','slate'];

function getEventColorClass(color){
  const key=(color||'').toString().trim().toLowerCase();
  if(!key) return '';
  return `event-color-${key}`;
}

function getEventColorClasses(){
  return EVENT_COLOR_KEYS.map(key=>getEventColorClass(key)).filter(Boolean);
}

function normalizeEventDateKey(date){
  if(!date) return '';
  const d = new Date(date);
  if(Number.isNaN(d.getTime())) return '';
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function normalizeEventColorKeyClient(raw){
  const key=(raw||'').toString().trim().toLowerCase();
  if(EVENT_COLOR_LEGACY_FALLBACKS[key]) return EVENT_COLOR_LEGACY_FALLBACKS[key];
  return EVENT_COLOR_KEYS.includes(key)?key:'';
}

function toTransportEventColorKey(raw){
  const normalizedEvent=normalizeEventColorKeyClient(raw);
  if(normalizedEvent){
    return EVENT_COLOR_TRANSPORT_FALLBACKS[normalizedEvent] || normalizedEvent;
  }
  const paletteKey=normalizePaletteKey(raw);
  if(paletteKey){
    const eventColor=paletteKeyToEventColor(paletteKey);
    const normalizedFromPalette=normalizeEventColorKeyClient(eventColor);
    if(normalizedFromPalette){
      return EVENT_COLOR_TRANSPORT_FALLBACKS[normalizedFromPalette] || normalizedFromPalette;
    }
    return eventColor || paletteKey;
  }
  return '';
}

function eventSelectionKey(officeId){
  return `${storeKeyBase}:event:${officeId||'__none__'}`;
}

function loadSavedEventIds(officeId){
  if(currentEventOfficeId===officeId && Array.isArray(currentEventIds)) return currentEventIds;
  let saved=[];
  try{
    const raw=localStorage.getItem(eventSelectionKey(officeId))||'[]';
    const parsed=JSON.parse(raw);
    saved=Array.isArray(parsed)?parsed.map(v=>String(v)).filter(Boolean):[];
  }
  catch{ saved=[]; }
  currentEventOfficeId=officeId||'';
  currentEventIds=saved;
  return currentEventIds;
}

function saveEventIds(officeId, ids){
  const uniqIds=Array.from(new Set((ids||[]).map(v=>String(v).trim()).filter(Boolean)));
  currentEventIds=uniqIds;
  currentEventOfficeId=officeId||'';
  try{ localStorage.setItem(eventSelectionKey(officeId), JSON.stringify(uniqIds)); }
  catch{}
}

function getEventTargetOfficeId(){
  return (vacationOfficeSelect?.value)||adminSelectedOfficeId||CURRENT_OFFICE_ID||'';
}

function hasRelatedNotice(item){
  return !!(item?.noticeTitle||item?.noticeId||item?.noticeKey||item?.note||item?.memo);
}

function ensureEventColorStatusEl(){
  if(eventDateColorState.statusEl) return eventDateColorState.statusEl;
  const el=document.createElement('div');
  el.className='vac-save-status';
  eventDateColorState.statusEl=el;
  const container=eventGanttWrap||eventGantt||document.getElementById('eventGanttWrap')||document.getElementById('eventGantt');
  if(container){ container.appendChild(el); }
  return el;
}

function renderEventColorStatus(type, message, actions){
  const el=ensureEventColorStatusEl();
  el.textContent='';
  el.dataset.state=type||'';
  if(!message) return;
  const msgSpan=document.createElement('span');
  msgSpan.className='vac-save-message';
  msgSpan.textContent=message;
  el.appendChild(msgSpan);
  if(type==='saving'){
    const spinner=document.createElement('span');
    spinner.className='vac-save-spinner';
    spinner.setAttribute('aria-hidden','true');
    el.prepend(spinner);
  }
  (actions||[]).forEach(({ label, onClick, className })=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.textContent=label;
    btn.className=className||'vac-save-action';
    btn.addEventListener('click', onClick);
    el.appendChild(btn);
  });
}

function updateEventColorManualHint(hasManualColor){
  const hintEl=eventColorManualHint||document.getElementById('eventColorManualHint');
  if(!hintEl) return;
  const admin=isOfficeAdmin && typeof isOfficeAdmin==='function' ? isOfficeAdmin() : false;
  if(!admin){
    hintEl.style.display='none';
    hintEl.textContent='';
    hintEl.title='';
    return;
  }
  const targetOffice=getEventTargetOfficeId();
  const shouldShow=!!hasManualColor && !!targetOffice && eventDateColorState.officeId===targetOffice;
  if(shouldShow){
    hintEl.style.display='inline-flex';
    hintEl.textContent='耳 謇句虚濶ｲ縺碁←逕ｨ縺輔ｌ縺ｦ縺・∪縺呻ｼ医そ繝ｫ繧貞承繧ｯ繝ｪ繝・け縺ｧ繧ｯ繝ｪ繧｢縺ｧ縺阪∪縺呻ｼ・;
    hintEl.title='繧ｻ繝ｫ繧貞承繧ｯ繝ｪ繝・け縺吶ｋ縺ｨ謇句虚濶ｲ繧貞句挨縺ｫ繧ｯ繝ｪ繧｢縺ｧ縺阪∪縺吶・;
  }else{
    hintEl.style.display='none';
    hintEl.textContent='';
    hintEl.title='';
  }
}

function paletteKeyToEventColor(key){
  const normalized=(key||'').toString().trim().toLowerCase();
  return PALETTE_TO_EVENT_COLOR_MAP[normalized] ?? '';
}

function paletteKeyFromEventColorKey(key){
  const normalized=(key||'').toString().trim().toLowerCase();
  if(EVENT_COLOR_TO_PALETTE_MAP[normalized]) return EVENT_COLOR_TO_PALETTE_MAP[normalized];
  if(PALETTE_KEYS.includes(normalized)) return normalized;
  return '';
}

function normalizePaletteKey(raw){
  const normalized=(raw||'').toString().trim().toLowerCase();
  return PALETTE_KEYS.includes(normalized)?normalized:'';
}

function normalizeEventDateColorValue(raw){
  const normalizedColor=normalizeEventColorKeyClient(raw);
  if(normalizedColor) return normalizedColor;
  return normalizePaletteKey(raw);
}

function applyEventDateColorsToController(colorMap){
  if(!eventGanttController || typeof eventGanttController.applyDateColorMap!=='function') return;
  try{
    eventGanttController.applyDateColorMap(colorMap || new Map());
  }catch(err){
    console.error('applyDateColorMap error', err);
  }
}

function showEventColorSavingStatus(){
  renderEventColorStatus('saving', '譌･莉倥き繝ｩ繝ｼ繧剃ｿ晏ｭ倥＠縺ｦ縺・∪縺吮ｦ');
}

function showEventColorSavedStatus(){
  renderEventColorStatus('saved', '閾ｪ蜍穂ｿ晏ｭ俶ｸ医∩');
  setTimeout(()=>{
    if(eventDateColorState.statusEl && eventDateColorState.statusEl.dataset.state==='saved'){
      eventDateColorState.statusEl.textContent='';
      eventDateColorState.statusEl.dataset.state='';
    }
  }, 2000);
}

function rollbackEventDateColors(){
  const lastSaved=eventDateColorState.lastSaved instanceof Map ? eventDateColorState.lastSaved : new Map();
  eventDateColorState.map=new Map(lastSaved);
  applyManualEventColorsToGantt();
  applyEventDateColorsToController(eventDateColorState.map);
  toast('菫晏ｭ伜燕縺ｮ迥ｶ諷九↓謌ｻ縺励∪縺励◆', false);
}

function showEventColorErrorStatus(){
  const actions=[{
    label:'蜀崎ｩｦ陦・,
    onClick: ()=>scheduleEventDateColorSave('retry'),
    className:'vac-save-retry'
  }];
  if(eventDateColorState.lastSaved){
    actions.push({
      label:'繝ｭ繝ｼ繝ｫ繝舌ャ繧ｯ',
      onClick: rollbackEventDateColors,
      className:'vac-save-rollback'
    });
  }
  renderEventColorStatus('error', '菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲ょ・隧ｦ陦後☆繧九°繝ｭ繝ｼ繝ｫ繝舌ャ繧ｯ縺ｧ縺阪∪縺吶・, actions);
}

function resetEventDateColorState(){
  const statusEl=eventDateColorState.statusEl||null;
  eventDateColorState={ officeId:'', map:new Map(), lastSaved:new Map(), autoSaveTimer:null, saveInFlight:false, queued:false, statusEl, loaded:false };
  if(statusEl){
    statusEl.textContent='';
    statusEl.dataset.state='';
  }
  applyManualEventColorsToGantt();
  applyEventDateColorsToController(new Map());
}

function updateEventDateColorState(date, colorKey, officeId){
  const targetOffice=officeId||getEventTargetOfficeId();
  const normalizedDate=normalizeEventDateKey(date);
  if(!targetOffice || !normalizedDate) return;
  if(colorKey===null){
    const mapToClear=eventDateColorState.map instanceof Map ? eventDateColorState.map : new Map();
    mapToClear.delete(normalizedDate);
    eventDateColorState.map=mapToClear;
    applyManualEventColorsToGantt();
    applyEventDateColorsToController(mapToClear);
    scheduleEventDateColorSave();
    return;
  }
  const normalizedColor=normalizeEventDateColorValue(colorKey);
  const statusEl=eventDateColorState.statusEl||ensureEventColorStatusEl();
  if(eventDateColorState.autoSaveTimer){
    clearTimeout(eventDateColorState.autoSaveTimer);
    eventDateColorState.autoSaveTimer=null;
  }
  if(eventDateColorState.officeId && eventDateColorState.officeId!==targetOffice){
    eventDateColorState={ officeId:targetOffice, map:new Map(), lastSaved:new Map(), autoSaveTimer:null, saveInFlight:false, queued:false, statusEl, loaded:false };
  }else if(!eventDateColorState.officeId){
    eventDateColorState={ ...eventDateColorState, officeId:targetOffice, statusEl };
  }
  const map=eventDateColorState.map instanceof Map ? eventDateColorState.map : new Map();
  if(!normalizedColor){
    return;
  }
  map.set(normalizedDate, normalizedColor);
  eventDateColorState.map=map;
  eventDateColorState.loaded=true;
  applyManualEventColorsToGantt();
  applyEventDateColorsToController(map);
  scheduleEventDateColorSave();
}

function applyManualEventColorsToGantt(){
  const gantt=eventGantt || document.getElementById('eventGantt');
  const targetOffice=getEventTargetOfficeId();
  if(!gantt) return;
  const colorClasses=getEventColorClasses();
  const map=(eventDateColorState.officeId && eventDateColorState.officeId!==targetOffice) ? new Map() : (eventDateColorState.map||new Map());
  gantt.querySelectorAll('td.vac-cell').forEach(cell=>{
    cell.classList.remove(...colorClasses);
    if(cell.title && cell.title.includes('謇句虚')){
      cell.removeAttribute('title');
    }
    delete cell.dataset.manualColor;
    delete cell.dataset.manualColorBound;
  });

  const applyColorToDayHeader=(cell)=>{
    cell.classList.remove(...colorClasses);
    const date=normalizeEventDateKey(cell.dataset.date||'');
    const storedColorKey=map.get(date)||'';
    const paletteColor=paletteKeyFromEventColorKey(storedColorKey);
    const eventColorKey=normalizeEventColorKeyClient(storedColorKey)||paletteKeyToEventColor(paletteColor);
    if(eventColorKey){
      const cls=getEventColorClass(eventColorKey);
      if(cls) cell.classList.add(cls);
      cell.dataset.manualColor=storedColorKey;
      const label=EVENT_COLOR_LABELS[eventColorKey]||'謇句虚濶ｲ';
      cell.title=`${label}・域焔蜍戊ｨｭ螳夲ｼ・ 蜿ｳ繧ｯ繝ｪ繝・け縺ｧ繧ｯ繝ｪ繧｢`;
    }else{
      delete cell.dataset.manualColor;
      if(cell.title && cell.title.includes('謇句虚')){
        cell.removeAttribute('title');
      }
    }
  };
  gantt.querySelectorAll('.vac-day-header').forEach(applyColorToDayHeader);
  updateEventColorManualHint(map.size>0);
}

function buildEventDateColorPayload(){
  const payload={};
  (eventDateColorState.map||new Map()).forEach((color,date)=>{
    const value=toTransportEventColorKey(color);
    if(date && value){ payload[date]=value; }
  });
  return payload;
}

function getManualEventColorForDate(date, officeId){
  const normalized=normalizeEventDateKey(date);
  const targetOffice=officeId||appliedEventOfficeId||getEventTargetOfficeId();
  if(!normalized || !targetOffice) return '';
  if(eventDateColorState.officeId !== targetOffice) return '';
  return eventDateColorState.map.get(normalized)||'';
}

async function loadEventDateColors(officeId, options={}){
  const targetOfficeId=officeId||getEventTargetOfficeId();
  const opts=options||{};
  const silent=opts.silent===true;
  const forceReload=opts.force===true;
  if(!targetOfficeId || !SESSION_TOKEN){
    resetEventDateColorState();
    return new Map();
  }
  const hasLoadedCurrentOffice=eventDateColorState.officeId===targetOfficeId && eventDateColorState.loaded;
  if(hasLoadedCurrentOffice && !forceReload){
    applyManualEventColorsToGantt();
    return eventDateColorState.map||new Map();
  }
  const mapsAreEqual=(a,b)=>{
    if(!(a instanceof Map) || !(b instanceof Map)) return false;
    if(a.size!==b.size) return false;
    for(const [key,val] of a.entries()){
      if(!b.has(key) || b.get(key)!==val) return false;
    }
    return true;
  };
  try{
    const res=await apiPost({ action:'getEventColorMap', token:SESSION_TOKEN, office:targetOfficeId, nocache:'1' });
    if(res?.error==='unauthorized'){
      await logout();
      return new Map();
    }
    const map=new Map();
    const colors=(res&&typeof res.colors==='object')?res.colors:{};
    Object.keys(colors||{}).forEach(date=>{
      const normalizedDate=normalizeEventDateKey(date);
      if(!normalizedDate) return;
      const paletteKey=paletteKeyFromEventColorKey(colors[date]);
      const normalizedColor=paletteKey || normalizeEventDateColorValue(colors[date]);
      if(normalizedColor){ map.set(normalizedDate, normalizedColor); }
    });
    const shouldApply = !hasLoadedCurrentOffice || forceReload || !mapsAreEqual(eventDateColorState.map, map);
    eventDateColorState={
      ...eventDateColorState,
      officeId: targetOfficeId,
      map,
      lastSaved: new Map(map),
      loaded: true
    };
    if(shouldApply){
      applyManualEventColorsToGantt();
      applyEventDateColorsToController(map);
    }
    return map;
  }catch(err){
    console.error('loadEventDateColors error', err);
    resetEventDateColorState();
    if(!silent) toast('譌･莉倥き繝ｩ繝ｼ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆', false);
    return new Map();
  }
}

async function flushEventDateColorSave(){
  if(eventDateColorState.saveInFlight){
    eventDateColorState.queued=true;
    return;
  }
  const officeId=eventDateColorState.officeId||getEventTargetOfficeId();
  if(!officeId || !SESSION_TOKEN || !isOfficeAdmin()) return;
  eventDateColorState.saveInFlight=true;
  eventDateColorState.queued=false;
  showEventColorSavingStatus();
  try{
    const payload=buildEventDateColorPayload();
    const res=await apiPost({ action:'setEventColorMap', token:SESSION_TOKEN, office:officeId, data:JSON.stringify({ colors: payload }) });
    if(res && res.ok!==false){
      eventDateColorState.lastSaved=new Map(eventDateColorState.map||[]);
      showEventColorSavedStatus();
      toast('譌･莉倥き繝ｩ繝ｼ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆');
    }else{
      throw new Error(res&&res.error?String(res.error):'save_failed');
    }
  }catch(err){
    console.error('flushEventDateColorSave error', err);
    toast('譌･莉倥き繝ｩ繝ｼ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
    showEventColorErrorStatus();
  }finally{
    eventDateColorState.saveInFlight=false;
    if(eventDateColorState.queued){
      eventDateColorState.queued=false;
      flushEventDateColorSave();
    }
  }
}

function scheduleEventDateColorSave(){
  if(!SESSION_TOKEN || !isOfficeAdmin()) return;
  if(eventDateColorState.autoSaveTimer){
    clearTimeout(eventDateColorState.autoSaveTimer);
  }
  eventDateColorState.autoSaveTimer=setTimeout(()=>{
    eventDateColorState.autoSaveTimer=null;
    flushEventDateColorSave();
  }, 800);
}

function refreshAppliedEventHighlights(){
  const officeId=appliedEventOfficeId||getEventTargetOfficeId();
  const sourceList=(cachedEvents.officeId===officeId && Array.isArray(cachedEvents.list)) ? cachedEvents.list : [];
  const idSet=new Set((appliedEventIds||[]).map(id=>String(id)));
  const visibleItems=sourceList.filter(item=>{
    const id=String(item?.id||item?.vacationId||'');
    return idSet.has(id) && coerceVacationVisibleFlag(item?.visible);
  });
  applyEventHighlightForItems(visibleItems, undefined);
}

function renderVacationRadioList(list, options){
  const dropdown = document.getElementById('eventSelectDropdown');
  const noticeBtn = document.getElementById('btnShowEventNotice');
  if(!dropdown) return;
  
  dropdown.innerHTML = '';
  const opts=options||{};
  const onSelectChange = typeof opts.onSelectChange==='function' ? opts.onSelectChange : null;
  const onFocus = typeof opts.onFocus==='function' ? opts.onFocus : null;
  const selectedIds = new Set((opts.selectedIds||[]).map(v=>String(v)));
  const syncSelectedIds=()=>{
    selectedIds.clear();
    (selectedEventIds||[]).forEach(v=> selectedIds.add(String(v)) );
  };
  
  if(!Array.isArray(list) || list.length===0){
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '逋ｻ骭ｲ縺輔ｌ縺溘う繝吶Φ繝医・縺ゅｊ縺ｾ縺帙ｓ';
    placeholder.disabled = true;
    dropdown.appendChild(placeholder);
    dropdown.disabled = true;
    if(noticeBtn) noticeBtn.style.display = 'none';
    return;
  }

  const officeId=list[0]?.office||CURRENT_OFFICE_ID||'';
  dropdown.disabled = false;
  
  // 繝励Ξ繝ｼ繧ｹ繝帙Ν繝繝ｼ
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '繧､繝吶Φ繝医ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞';
  dropdown.appendChild(placeholder);

  const itemMap=new Map();

  list.forEach((item, idx)=>{
    const id=String(item.id||item.vacationId||idx);
    const option = document.createElement('option');
    option.value = id;
    const start=item.startDate||item.start||item.from||'';
    const end=item.endDate||item.end||item.to||'';
    const period=start||end?` (${start||''}縲・{end||''})`:' ';
    option.textContent = `${item.title||''}${period}`;
    dropdown.appendChild(option);
    itemMap.set(id, item);
  });
  
  // 驕ｸ謚槭う繝吶Φ繝医ｒ蠕ｩ蜈・
  syncSelectedIds();
  const firstSelected = Array.from(selectedIds)[0];
  if(firstSelected){
    dropdown.value = firstSelected;
  }
  
  // 縺顔衍繧峨○繝懊ち繝ｳ縺ｮ迥ｶ諷九ｒ譖ｴ譁ｰ
  function updateNoticeButton(){
    const currentId = dropdown.value;
    const currentItem = itemMap.get(currentId);
    if(currentItem && noticeBtn){
      const hasNotice = hasRelatedNotice(currentItem);
      noticeBtn.style.display = hasNotice ? 'inline-block' : 'none';
      noticeBtn.disabled = !hasNotice;
    } else if(noticeBtn){
      noticeBtn.style.display = 'none';
    }
  }
  updateNoticeButton();
  
  // 繝励Ν繝繧ｦ繝ｳ螟画峩繧､繝吶Φ繝・
  dropdown.addEventListener('change', ()=>{
    const id = dropdown.value;
    if(!id) return;
    syncSelectedIds();
    selectedIds.clear();
    selectedIds.add(id);
    const arr=Array.from(selectedIds);
    selectedEventIds=arr;
    saveEventIds(officeId, arr);
    const item=itemMap.get(id)||null;
    updateNoticeButton();
    if(onSelectChange) onSelectChange(arr, item, id, true);
    if(onFocus) onFocus(item, id);
  });
  
  // 縺顔衍繧峨○繝懊ち繝ｳ縺ｮ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・
  if(noticeBtn){
    const existingListeners = noticeBtn.cloneNode(true);
    noticeBtn.parentNode.replaceChild(existingListeners, noticeBtn);
    existingListeners.addEventListener('click', ()=>{
      const id = dropdown.value;
      const item = itemMap.get(id);
      if(item){
        openRelatedNotice(item, { fromEventCalendar:true, openMode:'modal' });
      }
    });
  }

  selectedEventIds=Array.from(selectedIds);
  
  // 蛻晄悄繝輔か繝ｼ繧ｫ繧ｹ
  if(firstSelected){
    const firstItem = itemMap.get(firstSelected);
    if(firstItem && onFocus){
      onFocus(firstItem, firstSelected);
    }
  }
}

function updateEventCardStates(){
  // 繝励Ν繝繧ｦ繝ｳ蠖｢蠑上〒縺ｯ荳崎ｦ√□縺後∽ｺ呈鋤諤ｧ縺ｮ縺溘ａ谿九☆
  return;
}

function findNoticeFromCache(item){
  const normalizeKeyFn = typeof normalizeNoticeKey === 'function'
    ? normalizeNoticeKey
    : (value)=>{ if(value==null) return ''; return String(value).replace(/\s+/g,' ').trim().toLowerCase(); };

  const noticeId=item?.noticeId||item?.id||'';
  const noticeKey=item?.noticeKey||'';
  const noticeTitle=item?.noticeTitle||item?.title||'';
  const normalizedId=normalizeKeyFn(noticeId);
  const normalizedKey=normalizeKeyFn(noticeKey);
  const normalizedTitle=normalizeKeyFn(noticeTitle);
  const list=Array.isArray(window.CURRENT_NOTICES)?window.CURRENT_NOTICES:[];

  let target=list.find(n=> normalizedId && normalizeKeyFn(n?.id||n?.noticeId||n?.uid||'')===normalizedId) || null;
  if(!target){
    target=list.find(n=> normalizedKey && normalizeKeyFn(n?.noticeKey||n?.key||'')===normalizedKey) || null;
  }
  if(!target){
    target=list.find(n=> normalizedTitle && normalizeKeyFn(n?.title||'')===normalizedTitle) || null;
  }
  if(!target) return null;

  return {
    ...target,
    id: target?.id||target?.noticeId||target?.uid||'',
    noticeKey: target?.noticeKey||target?.key||'',
    title: target?.title||'',
    content: target?.content||''
  };
}

function hideNoticeModal(){
  if(!noticeModal) return;
  noticeModal.classList.remove('show');
  noticeModal.setAttribute('aria-hidden','true');
}

function showNoticeModal(notice){
  if(!noticeModal || !noticeModalTitle || !noticeModalBody) return false;
  hideNoticeModal();
  noticeModalTitle.textContent=notice?.title||'髢｢騾｣縺顔衍繧峨○';
  noticeModalBody.textContent='';
  const content=document.createElement('div');
  content.className='notice-modal-content';
  const bodyText=notice?.content||'';
  if(bodyText){
    if(typeof linkifyText==='function'){
      content.innerHTML=linkifyText(bodyText).replace(/\n/g,'<br>');
    }else{
      content.textContent=bodyText;
    }
  }else{
    content.textContent='譛ｬ譁・′險ｭ螳壹＆繧後※縺・∪縺帙ｓ';
  }
  noticeModalBody.appendChild(content);
  noticeModal.classList.add('show');
  noticeModal.setAttribute('aria-hidden','false');
  return true;
}

function openNoticeInNewWindow(notice){
  try{
    const win=window.open('', '_blank', 'noopener');
    if(!win) return false;
    const title=notice?.title||'髢｢騾｣縺顔衍繧峨○';
    const contentStr=notice?.content||'';
    win.document.title=title;
    const wrapper=win.document.createElement('div');
    wrapper.style.fontFamily='sans-serif';
    wrapper.style.maxWidth='720px';
    wrapper.style.margin='24px auto';
    wrapper.style.padding='12px';
    wrapper.style.lineHeight='1.6';
    const heading=win.document.createElement('h1');
    heading.textContent=title;
    heading.style.fontSize='20px';
    heading.style.marginBottom='12px';
    const body=win.document.createElement('div');
    body.style.whiteSpace='pre-wrap';
    body.style.fontSize='14px';
    body.textContent=contentStr||'譛ｬ譁・′險ｭ螳壹＆繧後※縺・∪縺帙ｓ';
    wrapper.appendChild(heading);
    wrapper.appendChild(body);
    win.document.body.appendChild(wrapper);
    return true;
  }catch(err){
    console.error('openNoticeInNewWindow error', err);
    return false;
  }
}

function renderRelatedNoticePopup(notice, options={}){
  const opts=options||{};
  const mode=(opts.openMode||'modal').toLowerCase();
  if(mode==='window'){
    const opened=openNoticeInNewWindow(notice);
    if(opened) return true;
  }
  return showNoticeModal(notice);
}

function openRelatedNotice(item, options={}){
  const opts=options||{};
  const hasNotice = hasRelatedNotice(item);
  const fromEvent = opts.fromEventCalendar===true || opts.fromEvent===true;
  if(!hasNotice){
    if(opts.toastOnMissing!==false) toast('髢｢騾｣縺吶ｋ縺顔衍繧峨○縺後≠繧翫∪縺帙ｓ', false);
    return false;
  }

  if(fromEvent){
    const targetNotice=findNoticeFromCache(item);
    if(targetNotice){
      return renderRelatedNoticePopup(targetNotice, opts);
    }
    if(opts.toastOnMissing!==false) toast('隧ｲ蠖薙☆繧九♀遏･繧峨○縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆', false);
    return false;
  }
  const noticesArea=document.getElementById('noticesArea');
  if(noticesArea){
    noticesArea.style.display='block';
    noticesArea.classList.remove('collapsed');
    noticesArea.scrollIntoView({ behavior:'smooth', block:'start' });
  }
  if(noticesArea?.classList.contains('collapsed') && typeof toggleNoticesArea==='function'){
    toggleNoticesArea();
  }

  const normalizeKeyFn = typeof normalizeNoticeKey === 'function'
    ? normalizeNoticeKey
    : (value)=>{
        if(value==null) return '';
        return String(value).replace(/\s+/g,' ').trim().toLowerCase();
      };
  const noticesList=document.getElementById('noticesList');
  const noticeId=item?.noticeId||item?.id||'';
  const noticeKey=item?.noticeKey||'';
  const noticeTitle=item?.noticeTitle||item?.title||'';
  let targetEl=null;

  if(noticesList){
    const items=Array.from(noticesList.querySelectorAll('.notice-item'));
    if(noticeId){
      const normalizedId=normalizeKeyFn(noticeId);
      targetEl=items.find(el=> normalizeKeyFn(el.dataset.noticeId)===normalizedId );
    }
    if(!targetEl && noticeKey){
      const normalizedKey=normalizeKeyFn(noticeKey);
      targetEl=items.find(el=> normalizeKeyFn(el.dataset.noticeKey||el.dataset.noticeId||'')===normalizedKey );
    }
    if(!targetEl && noticeTitle){
      const normalizedTitle=normalizeKeyFn(noticeTitle);
      targetEl=items.find(el=> {
        const titleText=el.querySelector('.notice-title')?.textContent||'';
        return normalizeKeyFn(titleText)===normalizedTitle;
      });
    }
  }

  if(targetEl){
    targetEl.classList.add('expanded');
    targetEl.scrollIntoView({ behavior:'smooth', block:'center' });
    return true;
  }

  if(opts.toastOnMissing!==false) toast('隧ｲ蠖薙☆繧九♀遏･繧峨○縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆', false);
  return false;
}

if(noticeModalClose){
  noticeModalClose.addEventListener('click', hideNoticeModal);
}
if(noticeModal){
  noticeModal.addEventListener('click', (e)=>{
    if(e.target===noticeModal) hideNoticeModal();
  });
}

function getEventGanttController(){
  if(eventGanttController) return eventGanttController;
  if(typeof createVacationGantt !== 'function' || !eventGantt){
    return null;
  }
  const handleDateColorSelect=(selection)=>{
    if(!selection) return selection;
    const resolvedColor=selection.eventColor||paletteKeyToEventColor(selection.paletteKey)||selection.paletteKey;
    const colorKey=normalizeEventDateColorValue(resolvedColor);
    updateEventDateColorState(selection.date||'', colorKey||selection.paletteKey||'', getEventTargetOfficeId());
    return selection;
  };
  eventGanttController = createVacationGantt({
    rootEl: eventGantt,
    startInput: eventStartInput,
    endInput: eventEndInput,
    bitsInput: eventBitsInput,
    autoBind: true,
    autoInit: false,
    groupJumpContainer: eventGroupJumps,
    scrollContainer: eventGantt,
    groupJumpMode: 'select',
    saveMode: 'event-auto',
    onDateColorSelect: handleDateColorSelect
  });
  if(eventGanttController && typeof eventGanttController.init==='function'){
    eventGanttController.init();
  }
  applyManualEventColorsToGantt();
  applyEventDateColorsToController(eventDateColorState.map||new Map());
  loadEventDateColors(getEventTargetOfficeId()).catch(err=> console.error('initial loadEventDateColors failed', err));
  return eventGanttController;
}

function updateEventDetail(item, officeId){
  const ctrl=getEventGanttController();
  if(!item){
    eventSelectedId='';
    if(ctrl){
      ctrl.setRangeAndBits('', '', '');
      ctrl.applyBitsToCells();
    }
    return;
  }
  const start=item.startDate||item.start||item.from||'';
  const end=item.endDate||item.end||item.to||'';
  eventSelectedId=String(item.id||item.vacationId||'');
  if(ctrl){
    ctrl.setRangeAndBits(start, end, item.membersBits||item.bits||'');
    ctrl.applyBitsToCells();
  }
}

function handleEventSelection(itemOrId){
  const officeId=(vacationOfficeSelect?.value)||adminSelectedOfficeId||CURRENT_OFFICE_ID||'';
  const item=typeof itemOrId==='object'&&itemOrId?itemOrId:findCachedEvent(officeId, itemOrId);
  updateEventDetail(item||null, officeId);
}

function updateEventButtonVisibility(officeId, list){
  if(!eventBtn) return;
  const loggedIn=!!SESSION_TOKEN;
  const targetOfficeId=officeId||CURRENT_OFFICE_ID||'';
  let sourceList=null;
  if(Array.isArray(list)){
    sourceList=list;
  }else if(cachedEvents.officeId===targetOfficeId){
    sourceList=cachedEvents.list;
  }
  const hasVisible=loggedIn && Array.isArray(sourceList)
    && sourceList.some(item=> coerceVacationVisibleFlag(item?.visible) && (!targetOfficeId || String(item.office||targetOfficeId)===targetOfficeId));
  eventBtn.style.display=hasVisible?'inline-block':'none';
}

async function refreshEventDataSilent(officeId){
  const targetOfficeId=officeId||getEventTargetOfficeId();
  if(!SESSION_TOKEN || !targetOfficeId) return [];
  try{
    const res=await apiPost({ action:'getVacation', token:SESSION_TOKEN, office:targetOfficeId, nocache:'1' });
    if(res?.error==='unauthorized'){
      await logout();
      return [];
    }
    const list=Array.isArray(res?.vacations)?res.vacations:(Array.isArray(res?.items)?res.items:[]);
    const prevList=(cachedEvents.officeId===targetOfficeId && Array.isArray(cachedEvents.list))?cachedEvents.list:[];
    const normalizedList=list.map(item=>{
      const idStr=String(item?.id||item?.vacationId||'');
      const prev=prevList.find(v=> String(v?.id||v?.vacationId||'') === idStr);
      const hasIsVacation=item && Object.prototype.hasOwnProperty.call(item,'isVacation');
      const fallbackHasFlag=prev && Object.prototype.hasOwnProperty.call(prev,'isVacation');
      const isVacation=hasIsVacation ? item.isVacation : (fallbackHasFlag ? prev.isVacation : undefined);
      return {
        ...item,
        office: item?.office || targetOfficeId,
        visible: coerceVacationVisibleFlag(item?.visible),
        isVacation,
        color: item?.color || 'amber'
      };
    });
    const filteredList=(isOfficeAdmin() ? normalizedList : normalizedList.filter(item=>item.visible===true));
    cachedEvents={ officeId: targetOfficeId, list: filteredList };
    const savedIds=loadSavedEventIds(targetOfficeId);
    if(Array.isArray(savedIds) && savedIds.length){
      selectedEventIds=savedIds;
    }
    const visibleItems=filteredList.filter(item=>item.visible===true);
    if(eventModal && eventModal.classList.contains('show')){
      renderVacationRadioList(filteredList, {
        selectedIds: selectedEventIds,
        onSelectChange: (ids)=>{
          selectedEventIds=ids;
          saveEventIds(targetOfficeId, ids);
        },
        onFocus: handleEventSelection
      });
    }
    updateEventButtonVisibility(targetOfficeId, normalizedList);
    const firstSelected=selectedEventIds?.[0]||'';
    if(firstSelected){
      const selectedItem=findCachedEvent(targetOfficeId, firstSelected);
      if(selectedItem) updateEventDetail(selectedItem, targetOfficeId);
    }
    await applyEventDisplay(selectedEventIds && selectedEventIds.length ? selectedEventIds : visibleItems);
    return filteredList;
  }catch(err){
    console.error('refreshEventDataSilent error', err);
    return [];
  }
}

async function loadEvents(officeId, showToastOnSuccess=false, options={}){
  const opts=options||{};
  const targetOfficeId=officeId||CURRENT_OFFICE_ID||'';
  renderVacationRadioMessage('隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...');
  if(!SESSION_TOKEN || !targetOfficeId){
    cachedEvents={ officeId:'', list:[] };
    resetEventDateColorState();
    renderVacationRadioMessage('諡轤ｹ縺ｫ繝ｭ繧ｰ繧､繝ｳ縺吶ｋ縺ｨ陦ｨ遉ｺ縺ｧ縺阪∪縺・);
    updateEventDetail(null, targetOfficeId);
    updateEventButtonVisibility(targetOfficeId, []);
    selectedEventIds=[];
    updateEventLegend([]);
    return [];
  }
  try{
    const res=await apiPost({ action:'getVacation', token:SESSION_TOKEN, office:targetOfficeId, nocache:'1' });
    if(res?.error==='unauthorized'){
      if(typeof logout==='function'){ await logout(); }
      cachedEvents={ officeId:'', list:[] };
      resetEventDateColorState();
      updateEventDetail(null, targetOfficeId);
      updateEventButtonVisibility(targetOfficeId, []);
      return [];
    }
    const list=Array.isArray(res?.vacations)?res.vacations:(Array.isArray(res?.items)?res.items:[]);
    const prevList=(cachedEvents.officeId===targetOfficeId && Array.isArray(cachedEvents.list))?cachedEvents.list:[];
    const normalizedList=list.map(item=>{
      const idStr=String(item?.id||item?.vacationId||'');
      const prev=prevList.find(v=> String(v?.id||v?.vacationId||'') === idStr);
      const hasIsVacation=item && Object.prototype.hasOwnProperty.call(item,'isVacation');
      const fallbackHasFlag=prev && Object.prototype.hasOwnProperty.call(prev,'isVacation');
      const isVacation=hasIsVacation ? item.isVacation : (fallbackHasFlag ? prev.isVacation : undefined);
      return {
        ...item,
        office: item?.office || targetOfficeId,
        visible: coerceVacationVisibleFlag(item?.visible),
        isVacation,
        color: item?.color || 'amber'
      };
    });
    const filteredList=(isOfficeAdmin() && opts.visibleOnly!==true)
      ? normalizedList
      : normalizedList.filter(item=>item.visible===true);
    await loadEventDateColors(targetOfficeId);
    const emptyMessage = filteredList.length===0 && normalizedList.length>0
      ? '迴ｾ蝨ｨ陦ｨ遉ｺ荳ｭ縺ｮ繧､繝吶Φ繝医・縺ゅｊ縺ｾ縺帙ｓ縲らｮ｡逅・・′縲瑚｡ｨ遉ｺ縲阪↓險ｭ螳壹☆繧九→縺薙％縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｾ縺吶・
      : '逋ｻ骭ｲ縺輔ｌ縺溘う繝吶Φ繝医・縺ゅｊ縺ｾ縺帙ｓ';
    const savedIds=loadSavedEventIds(targetOfficeId);
    selectedEventIds=savedIds;
    cachedEvents={ officeId: targetOfficeId, list: filteredList };
    const visibleItems=filteredList.filter(item=>item.visible===true);
    renderVacationRadioList(filteredList, {
      selectedIds: savedIds,
      emptyMessage,
      onSelectChange: (ids)=>{
        selectedEventIds=ids;
        saveEventIds(targetOfficeId, ids);
      },
      onFocus: handleEventSelection
    });
    const initialSelection=savedIds.map(id=>findCachedEvent(targetOfficeId, id)).find(Boolean)
      || (opts.visibleOnly===true?visibleItems[0]:(visibleItems[0]||filteredList[0]))
      || null;
    if(initialSelection){
      handleEventSelection(initialSelection);
      if(opts.onSelect){ opts.onSelect(initialSelection, String(initialSelection.id||initialSelection.vacationId||'')); }
    }else{
      updateEventDetail(null, targetOfficeId);
      if(opts.onSelect){ opts.onSelect(null, ''); }
    }
    updateEventLegend(visibleItems);
    updateEventButtonVisibility(targetOfficeId, normalizedList);
    await applyEventDisplay(visibleItems);
    if(showToastOnSuccess) toast('繧､繝吶Φ繝医ｒ隱ｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆');
    return filteredList;
  }catch(err){
    console.error('loadEvents error',err);
    cachedEvents={ officeId:'', list:[] };
    resetEventDateColorState();
    renderVacationRadioMessage('隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆');
    updateEventDetail(null, targetOfficeId);
    updateEventButtonVisibility(targetOfficeId, []);
    if(showToastOnSuccess) toast('繧､繝吶Φ繝医・蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆', false);
    return [];
  }
}

function findCachedEvent(officeId, id){
  if(!id) return null;
  const targetOfficeId=officeId||'';
  if(cachedEvents.officeId!==targetOfficeId) return null;
  const list=Array.isArray(cachedEvents.list)?cachedEvents.list:[];
  const idStr=String(id);
  return list.find(item=> String(item?.id||item?.vacationId||'') === idStr ) || null;
}

function updateCachedMembersBits(officeId, id, membersBits){
  if(!officeId || !id || cachedEvents.officeId!==officeId) return null;
  const list=Array.isArray(cachedEvents.list)?cachedEvents.list:[];
  const idStr=String(id);
  const target=list.find(item=> String(item?.id||item?.vacationId||'') === idStr ) || null;
  if(target){
    target.membersBits=membersBits;
    target.bits=membersBits;
  }
  return target;
}

function parseVacationMembersForDate(bitsStr, targetDate, startDate, endDate){
  console.log('parseVacationMembersForDate called:', { targetDate, startDate, endDate, bitsStr });

  const members=getRosterOrdering().flatMap(g => g.members || []);
  if(!members.length) {
    console.warn('No members found');
    return { memberIds: [], memberNames: '' };
  }

  // 譌･莉倥・豁｣隕丞喧
  function normalizeDate(dateStr){
    if(!dateStr) return '';
    const d = new Date(dateStr);
    if(Number.isNaN(d.getTime())) return '';
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  const target = normalizeDate(targetDate);
  const start = normalizeDate(startDate);
  const end = normalizeDate(endDate);

  const parts = (bitsStr||'').split(';').map(s => s.trim()).filter(Boolean);
  console.log('Normalized dates:', { target, start, end }, 'parts:', parts.length);

  const buildResultFromBits = (bits)=>{
    const onSet = new Set();
    for(let i=0;i<bits.length && i<members.length;i++){
      if(bits[i] === '1') onSet.add(i);
    }
    const memberIds = members.map(m => m.id!=null?String(m.id):'').filter((_,idx)=> onSet.has(idx) );
    const memberNames = members.filter((_,idx)=> onSet.has(idx)).map(m => m.name||'').filter(Boolean).join('縲・);
    console.log('Result from bits:', { memberIds, memberNames, onSetSize: onSet.size });
    return { memberIds, memberNames };
  };

  const fallbackByParts = ()=>{
    if(parts.length===0 || !target){
      console.warn('Fallback: no parts or invalid target');
      return { memberIds: [], memberNames: '' };
    }
    const matchedPart = parts.find(p=>{
      if(!p.includes(':')) return false;
      const [pDate] = p.split(':');
      return normalizeDate(pDate) === target;
    }) || (parts.length===1 ? parts[0] : null);
    if(!matchedPart){
      console.warn('Fallback: target not matched in parts');
      return { memberIds: [], memberNames: '' };
    }
    const bits = matchedPart.includes(':') ? (matchedPart.split(':')[1] || '') : matchedPart;
    console.log('Fallback bits used:', bits);
    return buildResultFromBits(bits);
  };

  if(!target){
    console.warn('Invalid target date after normalization');
    return { memberIds: [], memberNames: '' };
  }

  if(!start || !end){
    console.warn('Invalid start/end; using fallback path');
    return fallbackByParts();
  }

  // 蟇ｾ雎｡譌･縺梧悄髢灘・縺九メ繧ｧ繝・け縲らｯ・峇螟悶・蝣ｴ蜷医ｂ繝薙ャ繝亥・逶ｴ謗･隧穂ｾ｡繧定ｩｦ縺ｿ繧・
  if(target < start || target > end) {
    console.warn('Target date outside range, trying fallback:', { target, start, end });
    return fallbackByParts();
  }

  // 譌･莉倥せ繝ｭ繝・ヨ繧堤函謌・
  const dateSlots = [];
  const current = new Date(start);
  const endD = new Date(end);
  while(current <= endD){
    dateSlots.push(normalizeDate(current));
    current.setDate(current.getDate() + 1);
  }

  console.log('Date slots generated:', dateSlots.length, 'slots');

  // 蟇ｾ雎｡譌･縺ｮ繧､繝ｳ繝・ャ繧ｯ繧ｹ繧貞叙蠕・
  const targetIdx = dateSlots.indexOf(target);
  console.log('Target index:', targetIdx);

  if(targetIdx < 0) {
    console.warn('Target date not found in slots; using fallback');
    return fallbackByParts();
  }

  // 繝薙ャ繝域枚蟄怜・繧偵ヱ繝ｼ繧ｹ
  console.log('Bits parts:', parts.length, 'parts');

  if(parts.length === 0 || targetIdx >= parts.length) {
    console.warn('No bits for target index; using fallback', { partsLength: parts.length, targetIdx });
    return fallbackByParts();
  }

  const part = parts[targetIdx];
  const bits = part.includes(':') ? (part.split(':')[1] || '') : part;
  console.log('Bits for target date:', bits);

  return buildResultFromBits(bits);
}

const ROW_STATUS_CLASSES=['st-here','st-out','st-meeting','st-remote','st-trip','st-training','st-health','st-coadoc','st-home','st-off'];

function getEventMembersForDate(item, targetDate){
  const today=new Date(targetDate||Date.now());
  const todayStr=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  const start=item.startDate||item.start||item.from||'';
  const end=item.endDate||item.end||item.to||'';
  const bits=item.membersBits||item.bits||'';
  const { memberIds, memberNames } = parseVacationMembersForDate(bits, todayStr, start, end);
  return { memberIds, memberNames, targetDate: todayStr };
}

function applyVacationStatus(tr, statusTd, statusSelect, titles){
  const labelTitle=titles.join(' / ') || '繧､繝吶Φ繝・;
  tr.dataset.event='1';
  tr.dataset.eventTitle=labelTitle;
  if(!statusTd || !statusSelect) return;
  if(statusSelect.dataset.originalValue === undefined){
    statusSelect.dataset.originalValue = statusSelect.value || '';
  }
  statusSelect.style.display='none';
  statusSelect.disabled=true;
  let vacationLabel=statusTd.querySelector('.vacation-status-label');
  if(!vacationLabel){
    vacationLabel=document.createElement('div');
    vacationLabel.className='vacation-status-label';
    statusTd.appendChild(vacationLabel);
  }
  vacationLabel.textContent=labelTitle;
  vacationLabel.style.display='block';
  statusSelect.value='莨代∩';
  ROW_STATUS_CLASSES.forEach(cls=>tr.classList.remove(cls));
  tr.classList.add('st-off');
  tr.dataset.status='莨代∩';
}

function restoreStatusField(tr, statusTd, statusSelect){
  delete tr.dataset.event;
  delete tr.dataset.eventTitle;
  if(!statusTd || !statusSelect) return;
  statusSelect.style.display='';
  statusSelect.disabled=false;
  const vacationLabel=statusTd.querySelector('.vacation-status-label');
  if(vacationLabel){ vacationLabel.style.display='none'; }
  if(statusSelect.dataset.originalValue !== undefined){
    const originalValue=statusSelect.dataset.originalValue;
    statusSelect.value=originalValue;
    delete statusSelect.dataset.originalValue;
    ROW_STATUS_CLASSES.forEach(cls=>tr.classList.remove(cls));
    const statusClassMap=new Map([
      ['蝨ｨ蟶ｭ','st-here'], ['螟門・','st-out'], ['莨夊ｭｰ','st-meeting'],
      ['蝨ｨ螳・共蜍・,'st-remote'], ['蜃ｺ蠑ｵ','st-trip'], ['遐比ｿｮ','st-training'],
      ['蛛･蠎ｷ險ｺ譁ｭ','st-health'], ['繧ｳ繧｢繝峨ャ繧ｯ','st-coadoc'], ['蟶ｰ螳・,'st-home'], ['莨代∩','st-off']
    ]);
    const cls=statusClassMap.get(originalValue);
    if(cls) tr.classList.add(cls);
    tr.dataset.status=originalValue;
  }
}

function applyEventHighlightForItems(eventItems, targetDate){
  if(!board) {
    console.warn('applyEventHighlight: board element not found');
    return;
  }
  applyManualEventColorsToGantt();
  const normalizedTargetDate=normalizeEventDateKey(targetDate||Date.now());
  const manualColorForTarget=getManualEventColorForDate(normalizedTargetDate, appliedEventOfficeId||getEventTargetOfficeId());
  const hasManualColor=!!manualColorForTarget;
  // eventItems 縺ｮ鬆・ｺ上・繧ｵ繝ｼ繝舌・縺ｧ險ｭ螳壹＆繧後◆荳ｦ縺ｳ繧剃ｿ晄戟縺吶ｋ諠ｳ螳壹・
  // 蜷梧律縺ｫ隍・焚縺ｮ繧､繝吶Φ繝医′驥崎､・☆繧句ｴ蜷医・・蛻怜・鬆ｭ・井ｸ贋ｽ搾ｼ峨ｒ蜆ｪ蜈医＠縺ｦ濶ｲ繧・ｼ第嚊蝗ｺ螳壹・驕ｩ逕ｨ繧定｡後≧縲・
  const colorClasses=getEventColorClasses();
  const effectMap=new Map();
  (eventItems||[]).forEach(item=>{
    const { memberIds } = getEventMembersForDate(item, targetDate);
    if(!memberIds.length){
      console.warn('applyEventHighlight: memberIds empty', {
        id: item.id||item.vacationId||'',
        title: item.title||'',
        targetDate,
        isVacation: item.isVacation!==false,
        start: item.startDate||item.start||item.from||'',
        end: item.endDate||item.end||item.to||''
      });
    }
    memberIds.forEach(id=>{
      const key=String(id);
      const ref=effectMap.get(key)||{ vacations:[], highlights:[] };
      if(item.isVacation!==false){ ref.vacations.push(item); }
      ref.highlights.push(item);
      effectMap.set(key, ref);
    });
  });

  board.querySelectorAll('tbody tr').forEach(tr=>{
    const key=String(tr.dataset.key||'');
    const effect=effectMap.get(key);
    const statusTd=tr.querySelector('td.status');
    const statusSelect=statusTd?.querySelector('select[name="status"]');
    tr.classList.remove('event-highlight', ...colorClasses);
    if(effect){
      const manualColorKey=hasManualColor ? (normalizeEventColorKeyClient(manualColorForTarget)||paletteKeyToEventColor(manualColorForTarget)||manualColorForTarget) : '';
      const colorKey=hasManualColor ? manualColorKey : (effect.vacations[0]?.color || effect.highlights[0]?.color || '');
      const colorClass=getEventColorClass(colorKey);
      tr.classList.add('event-highlight');
      if(colorClass){ tr.classList.add(colorClass); }
      if(effect.vacations.length>0){
        console.debug('applyEventHighlight: applying vacation status', {
          targetDate,
          memberKey: key,
          vacations: effect.vacations.map(v=>v.id||v.vacationId||v.title||'')
        });
        applyVacationStatus(tr, statusTd, statusSelect, effect.vacations.map(v=>v.title||'繧､繝吶Φ繝・));
      }else{
        restoreStatusField(tr, statusTd, statusSelect);
      }
    }else{
      restoreStatusField(tr, statusTd, statusSelect);
    }
  });
}

function updateEventLegend(items){
  const target=document.getElementById('eventLegendModal')||document.getElementById('eventLegend');
  if(!target) return;
  target.textContent='';
  if(!items || items.length===0){
    const span=document.createElement('span');
    span.className='event-legend-empty';
    span.textContent='驕ｸ謚槭＆繧後◆繧､繝吶Φ繝医・縺ゅｊ縺ｾ縺帙ｓ';
    target.appendChild(span);
    return;
  }
  items.forEach(item=>{
    const pill=document.createElement('div');
    pill.className='event-legend-item';
    const dot=document.createElement('span');
    dot.className=`event-color-dot ${getEventColorClass(item.color)}`.trim();
    dot.title=EVENT_COLOR_LABELS[item.color]||'';
    const text=document.createElement('span');
    text.className='event-legend-text';
    text.textContent=item.title||'繧､繝吶Φ繝・;
    const type=document.createElement('span');
    type.className='event-legend-type';
    type.textContent=item.isVacation===false?'莠亥ｮ壹・縺ｿ':'莨第嚊蝗ｺ螳・;
    pill.append(dot, text, type);
    target.appendChild(pill);
  });
}

async function saveEventFromModal(){
  const officeId=(vacationOfficeSelect?.value)||adminSelectedOfficeId||CURRENT_OFFICE_ID||'';
  const selectedId=eventSelectedId || (selectedEventIds?.[0]||'');
  if(!officeId || !selectedId){ toast('陦ｨ遉ｺ縺吶ｋ繧､繝吶Φ繝医ｒ蜿門ｾ励〒縺阪∪縺帙ｓ縺ｧ縺励◆', false); return false; }
  const item=findCachedEvent(officeId, selectedId);
  if(!item){ toast('繧､繝吶Φ繝医・諠・ｱ繧貞叙蠕励〒縺阪∪縺帙ｓ縺ｧ縺励◆', false); return false; }
  const ctrl=getEventGanttController();
  const membersBits=ctrl?ctrl.getBitsString():(eventBitsInput?.value||'');
  const id=item.id||item.vacationId||selectedId;
  const bitsPayload={ id, membersBits };
  const adminPayload={
    office: officeId,
    title: item.title||'',
    start: item.startDate||item.start||item.from||'',
    end: item.endDate||item.end||item.to||'',
    note: item.noticeTitle||item.note||item.memo||'',
    noticeId: item.noticeId||item.noticeKey||'',
    noticeTitle: item.noticeTitle||'',
    membersBits,
    isVacation: item.isVacation!==false,
    color: item.color||''
  };
  if('visible' in item) adminPayload.visible=item.visible;
  if(id) adminPayload.id=id;
  try{
    let res=null;
    if(typeof saveVacationBits==='function'){
      res=await saveVacationBits(officeId, bitsPayload);
      if(res?.error==='forbidden' && typeof adminSetVacation==='function' && isOfficeAdmin()){
        res=await adminSetVacation(officeId, adminPayload);
      }
    }else if(typeof adminSetVacation==='function'){
      res=await adminSetVacation(officeId, adminPayload);
    }
    if(res && res.ok!==false){
      toast('繧､繝吶Φ繝医ｒ閾ｪ蜍穂ｿ晏ｭ倥＠縺ｾ縺励◆');
      updateCachedMembersBits(officeId, id, membersBits);
      if(Array.isArray(res.vacations)){
        cachedEvents={ officeId, list: res.vacations };
        await applyEventDisplay(selectedEventIds.length?selectedEventIds:[id]);
        updateEventButtonVisibility(officeId, res.vacations);
      }else{
        await applyEventDisplay(selectedEventIds.length?selectedEventIds:[id]);
        await loadEvents(officeId, false, { visibleOnly:true, onSelect: handleEventSelection });
      }
      return true;
    }
    throw new Error(res&&res.error?String(res.error):'save_failed');
  }catch(err){
    console.error('saveEventFromModal error', err);
    toast('繧､繝吶Φ繝医・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
    throw err;
  }
}

async function applyEventDisplay(items){
  const officeId=(vacationOfficeSelect?.value)||adminSelectedOfficeId||CURRENT_OFFICE_ID||'';
  const sourceList=Array.isArray(items)
    ? (()=>{
        const itemsAreIds=items.every(v=>typeof v==='string' || typeof v==='number');
        if(itemsAreIds){
          const baseList=cachedEvents.officeId===officeId ? cachedEvents.list : [];
          const idSet=new Set(items.map(v=>String(v)));
          return (Array.isArray(baseList)?baseList:[]).filter(item=> idSet.has(String(item?.id||item?.vacationId||'')) );
        }
        return items;
      })()
    : (cachedEvents.officeId===officeId ? cachedEvents.list : []);
  const visibleItems=(Array.isArray(sourceList)?sourceList:[])
    .filter(item=>coerceVacationVisibleFlag(item?.visible));

  if(!officeId){ return false; }

  const ids=visibleItems.map(v=>String(v.id||v.vacationId||'')).filter(Boolean);
  appliedEventIds=ids;
  appliedEventOfficeId=officeId;
  appliedEventTitles=visibleItems.map(v=>v.title||'繧､繝吶Φ繝・);

  applyEventHighlightForItems(visibleItems);
  updateEventLegend(visibleItems);
  updateEventCardStates();
  return true;
}

async function autoApplySavedEvent(){
  const officeId = CURRENT_OFFICE_ID || '';
  if(!officeId) { return; }
  let retries = 0;
  const maxRetries = 30;
  while(!board && retries < maxRetries){
    await new Promise(resolve => setTimeout(resolve, 100));
    retries++;
  }
  if(!board) { return; }
  try{
    await applyEventDisplay();
  }catch(err){
    console.error('Auto-apply failed:', err);
  }
}

function startEventSync(immediate=false){
  if(eventSyncTimer){ clearInterval(eventSyncTimer); eventSyncTimer=null; }
  if(!SESSION_TOKEN) return;
  const runSync=async()=>{
    const officeId=getEventTargetOfficeId();
    if(!officeId) return;
    await refreshEventDataSilent(officeId);
    const forceReloadColors = !(typeof isOfficeAdmin==='function' && isOfficeAdmin());
    await loadEventDateColors(officeId, { silent:true, force: forceReloadColors });
  };
  if(immediate){ runSync().catch(err=> console.error('eventSync (immediate) failed', err)); }
  eventSyncTimer=setInterval(()=>{
    runSync().catch(err=> console.error('eventSync failed', err));
  }, EVENT_SYNC_INTERVAL_MS);
}

/* 繧､繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ蜊ｰ蛻ｷ */
if(btnEventPrint){
  btnEventPrint.addEventListener('click', ()=>{
    const dropdown = document.getElementById('eventSelectDropdown');
    if(!dropdown || !dropdown.value){
      toast('蜊ｰ蛻ｷ縺吶ｋ繧､繝吶Φ繝医ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞', false);
      return;
    }
    
    const gantt = document.getElementById('eventGantt');
    if(!gantt || !gantt.querySelector('table')){
      toast('繧ｫ繝ｬ繝ｳ繝繝ｼ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｦ縺・∪縺帙ｓ', false);
      return;
    }
    
    // 蜊ｰ蛻ｷ逕ｨ繧､繝吶Φ繝域ュ蝣ｱ繧呈峩譁ｰ
    const selectedOption = dropdown.options[dropdown.selectedIndex];
    const eventTitle = selectedOption ? selectedOption.textContent : '';
    const printInfo = document.getElementById('eventPrintInfo');
    if(printInfo && eventTitle){
      printInfo.textContent = `繧､繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ: ${eventTitle}`;
      printInfo.style.display = 'block';
    }
    
    // 繧､繝吶Φ繝医Δ繝ｼ繝繝ｫ縺ｨ縺昴・隕ｪ隕∫ｴ繧貞ｼｷ蛻ｶ陦ｨ遉ｺ
    const eventModal = document.getElementById('eventModal');
    if(eventModal){
      eventModal.style.display = 'block';
      eventModal.style.visibility = 'visible';
      eventModal.classList.add('print-mode');
    }
    
    // 繧ｬ繝ｳ繝医メ繝｣繝ｼ繝医ｒ蠑ｷ蛻ｶ陦ｨ遉ｺ縺励√ち繧､繝医Ν繧定ｨｭ螳・
    const ganttWrap = document.getElementById('eventGanttWrap');
    if(ganttWrap){
      ganttWrap.style.display = 'block';
      ganttWrap.style.visibility = 'visible';
      ganttWrap.setAttribute('data-event-title', `繧､繝吶Φ繝医き繝ｬ繝ｳ繝繝ｼ: ${eventTitle}`);
    }
    if(gantt){
      gantt.style.display = 'block';
      gantt.style.visibility = 'visible';
    }
    
    // 蜊ｰ蛻ｷ螳溯｡・
    setTimeout(() => {
      window.print();
      // 蜊ｰ蛻ｷ蠕後↓繧ｹ繧ｿ繧､繝ｫ繧偵Μ繧ｻ繝・ヨ
      if(eventModal){
        eventModal.classList.remove('print-mode');
      }
    }, 200);
  });
}

/* 繝ｬ繧､繧｢繧ｦ繝茨ｼ・S + CSS荳｡譁ｹ縺ｧ蜀鈴聞縺ｫ蛻ｶ蠕｡・・*/
const PANEL_MIN_PX=760,GAP_PX=20,MAX_COLS=3;
const CARD_BREAKPOINT_PX=760; // 縺薙ｌ繧医ｊ迢ｭ縺・ｹ・〒縺ｯ繧ｫ繝ｼ繝芽｡ｨ遉ｺ繧貞ｼｷ蛻ｶ


/* --- utils.js --- */
/* 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ */
function toast(msg, ok = true) {
  if (!toastEl) return;
  if (toastEl._toastTimer) { clearTimeout(toastEl._toastTimer); }
  toastEl.textContent = '';
  const panel = document.createElement('div');
  panel.className = 'toast-panel';
  panel.textContent = msg;
  toastEl.appendChild(panel);
  toastEl.classList.remove('toast--error', 'toast--success');
  toastEl.classList.add(ok ? 'toast--success' : 'toast--error', 'show');
  toastEl._toastTimer = setTimeout(() => {
    toastEl.classList.remove('show');
  }, 2400);
}
function diagAdd(line) {
  diag.classList.add('show');
  const div = document.createElement('div');
  div.textContent = line;
  diag.appendChild(div);
}
function stripCtl(s) { return (s == null ? '' : String(s)).replace(/[\u0000-\u001F\u007F]/g, ''); }
function sanitizeText(s) {
  s = stripCtl(s);

  return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
}
const ID_RE = /^[0-9A-Za-z_-]+$/;

function el(tag, attrs = {}, children = []) { const e = document.createElement(tag); for (const [k, v] of Object.entries(attrs || {})) { if (v == null) continue; if (k === 'class') e.className = v; else if (k === 'text') e.textContent = String(v); else e.setAttribute(k, String(v)); } (children || []).forEach(c => e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c)); return e; }
function qsEncode(obj) { const p = new URLSearchParams(); Object.entries(obj || {}).forEach(([k, v]) => { if (v == null) return; p.append(k, String(v)); }); return p.toString(); }
async function apiPost(params, timeout = 20000) {
  const payload = { ...params };
  if (typeof CURRENT_OFFICE_ID !== 'undefined' && CURRENT_OFFICE_ID) {
    payload.tokenOffice = CURRENT_OFFICE_ID;
  }
  if (typeof CURRENT_ROLE !== 'undefined' && CURRENT_ROLE) {
    payload.tokenRole = CURRENT_ROLE;
  }
  const controller = new AbortController(); const t = setTimeout(() => controller.abort(), timeout); try { const res = await fetch(REMOTE_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: qsEncode(payload), signal: controller.signal, credentials: 'omit', cache: 'no-store' }); const ct = (res.headers.get('content-type') || '').toLowerCase(); if (!ct.includes('application/json')) return { ok: false, error: 'invalid_content_type' }; return await res.json(); } catch (err) { console.error(err); return { ok: false, error: err }; } finally { clearTimeout(t); }
}
/* 繧ｻ繝・す繝ｧ繝ｳ繝｡繧ｿ(F5閠先ｧ) */
function saveSessionMeta() { try { sessionStorage.setItem(SESSION_ROLE_KEY, CURRENT_ROLE || 'user'); sessionStorage.setItem(SESSION_OFFICE_KEY, CURRENT_OFFICE_ID || ''); sessionStorage.setItem(SESSION_OFFICE_NAME_KEY, CURRENT_OFFICE_NAME || ''); } catch { } }
function loadSessionMeta() { try { CURRENT_ROLE = sessionStorage.getItem(SESSION_ROLE_KEY) || 'user'; CURRENT_OFFICE_ID = sessionStorage.getItem(SESSION_OFFICE_KEY) || ''; CURRENT_OFFICE_NAME = sessionStorage.getItem(SESSION_OFFICE_NAME_KEY) || ''; } catch { } }


/* --- vacations.js --- */
(function(){
  const HOLIDAY_API_URL = window.HOLIDAY_API_URL || 'https://holidays-jp.github.io/api/v1/date.json';
  const MANUAL_HOLIDAYS = Array.isArray(window.MANUAL_HOLIDAYS) ? window.MANUAL_HOLIDAYS : [];
  const holidayCache = new Map(); // year -> Set<string>
  const COLOR_PALETTE = [
    { key: 'none', className: 'vac-color-none' },
    { key: 'saturday', className: 'vac-color-sat' },
    { key: 'sunday', className: 'vac-color-sun' },
    { key: 'holiday', className: 'vac-color-holiday' },
    { key: 'amber', className: 'vac-color-amber' },
    { key: 'mint', className: 'vac-color-mint' },
    { key: 'lavender', className: 'vac-color-lavender' },
    { key: 'slate', className: 'vac-color-slate' }
  ];
  const PALETTE_EVENT_COLOR_MAP = {
    none: '',
    saturday: 'blue',
    sunday: 'sunday',
    holiday: 'holiday',
    amber: 'amber',
    mint: 'green',
    lavender: 'purple',
    slate: 'slate'
  };
  const EVENT_COLOR_TO_PALETTE_MAP = {
    amber: 'amber',
    none: 'none',
    blue: 'saturday',
    green: 'mint',
    purple: 'lavender',
    sunday: 'sunday',
    saturday: 'saturday',
    holiday: 'holiday',
    teal: 'mint',
    pink: 'sunday',
    gray: 'slate',
    slate: 'slate'
  };

  const FALLBACK_DAYS = 7;

  function normalizeDateStr(str){
    if(!str) return '';
    const d = new Date(str);
    if(Number.isNaN(d.getTime())) return '';
    const y = d.getFullYear();
    const m = `${d.getMonth()+1}`.padStart(2,'0');
    const day = `${d.getDate()}`.padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function createVacationGanttController(config){
    const opts = config || {};
    const startInput = opts.startInput || null;
    const endInput = opts.endInput || null;
    const bitsInput = opts.bitsInput || null;
    let ganttRoot = opts.rootEl || null;
    const jumpContainer = opts.groupJumpContainer || null;
    const groupJumpMode = opts.groupJumpMode || 'buttons';
    const scrollContainer = opts.scrollContainer || null;
    let tableEl = null;
    let orderedMembers = [];
    let dateSlots = [];
    let bitsByDate = new Map(); // date -> Array<boolean>
    let draggingState = null;
    let autoSaveTimer = null;
    let saveInFlight = false;
    let queuedSave = false;
    let latestRequestedState = null;
    let lastSavedState = null;
    const dateColorMap = new Map(); // date -> palette index
    let latestHolidaySet = new Set();
    const paletteClassNames = COLOR_PALETTE.map(c => c.className);
    const holidayPaletteIndex = COLOR_PALETTE.findIndex(c => c.key === 'holiday');

    function getDefaultColorIndex(date){
      const d = new Date(date);
      const dow = d.getDay();
      if(dow === 0){
        const sundayIdx = COLOR_PALETTE.findIndex(c => c.key === 'sunday');
        return sundayIdx >= 0 ? sundayIdx : 0;
      }
      if(dow === 6){
        const saturdayIdx = COLOR_PALETTE.findIndex(c => c.key === 'saturday');
        return saturdayIdx >= 0 ? saturdayIdx : 0;
      }
      return 0;
    }

    function ensureDateColor(date){
      const normalized = normalizeDateStr(date);
      if(!normalized) return 0;
      if(!dateColorMap.has(normalized)){
        dateColorMap.set(normalized, getDefaultColorIndex(normalized));
      }
      return dateColorMap.get(normalized) ?? 0;
    }

    function syncDateColorMapWithSlots(){
      const available = new Set(dateSlots);
      Array.from(dateColorMap.keys()).forEach(date => {
        if(!available.has(date)){
          dateColorMap.delete(date);
        }
      });
      dateSlots.forEach(date => ensureDateColor(date));
    }

    function applyColumnColor(date){
      if(!tableEl) return;
      const idx = ensureDateColor(date) % COLOR_PALETTE.length;
      const className = COLOR_PALETTE[idx]?.className || '';
      const shouldShowHoliday = latestHolidaySet.has(date) && idx === holidayPaletteIndex;
      tableEl.querySelectorAll(`[data-date="${date}"]`).forEach(el => {
        paletteClassNames.forEach(cls => el.classList.remove(cls));
        if(className){
          el.classList.add(className);
        }
        el.dataset.colorIndex = String(idx);
        el.classList.toggle('holiday', shouldShowHoliday);
      });
    }

    function applyAllColumnColors(){
      dateSlots.forEach(date => applyColumnColor(date));
    }

    let palettePopupEl = null;
    let paletteCurrentDate = '';
    let paletteCleanupFns = [];

    function closePalettePopup(){
      if(palettePopupEl && palettePopupEl.parentNode){
        palettePopupEl.parentNode.removeChild(palettePopupEl);
      }
      palettePopupEl = null;
      paletteCurrentDate = '';
      paletteCleanupFns.forEach(fn => {
        try{ fn(); }catch(err){ console.error(err); }
      });
      paletteCleanupFns = [];
    }

    function positionPalettePopup(anchorEl){
      if(!palettePopupEl || !anchorEl) return;
      const rect = anchorEl.getBoundingClientRect();
      const popupRect = palettePopupEl.getBoundingClientRect();
      const top = rect.bottom + window.scrollY + 6;
      let left = rect.left + window.scrollX + (rect.width / 2) - (popupRect.width / 2);
      const minLeft = 8;
      const maxLeft = Math.max(minLeft, window.scrollX + document.documentElement.clientWidth - popupRect.width - 8);
      left = Math.min(Math.max(left, minLeft), maxLeft);
      palettePopupEl.style.top = `${top}px`;
      palettePopupEl.style.left = `${left}px`;
    }

    function paletteKeyFromIndex(idx){
      const normalizedIdx = Math.max(0, idx % COLOR_PALETTE.length);
      return COLOR_PALETTE[normalizedIdx]?.key || '';
    }

    function paletteIndexFromKey(key){
      const normalized = (key || '').toString().trim().toLowerCase();
      return COLOR_PALETTE.findIndex(c => c.key === normalized);
    }

    function toEventColorKeyFromPalette(key){
      const normalized = (key || '').toString().trim().toLowerCase();
      return PALETTE_EVENT_COLOR_MAP[normalized] ?? '';
    }

    function paletteKeyFromEventColor(key){
      const normalized = (key || '').toString().trim().toLowerCase();
      if(EVENT_COLOR_TO_PALETTE_MAP[normalized]) return EVENT_COLOR_TO_PALETTE_MAP[normalized];
      const paletteIdx = paletteIndexFromKey(normalized);
      return paletteIdx >= 0 ? paletteKeyFromIndex(paletteIdx) : '';
    }

    function handlePaletteColorSelect(date, idx){
      if(!date) return null;
      const normalizedDate = normalizeDateStr(date) || date;
      const paletteKey = paletteKeyFromIndex(idx);
      const normalizedIdx = Math.max(0, idx % COLOR_PALETTE.length);
      dateColorMap.set(normalizedDate, normalizedIdx);
      applyColumnColor(normalizedDate);
      const result = {
        date: normalizedDate,
        paletteIndex: normalizedIdx,
        paletteKey,
        eventColor: toEventColorKeyFromPalette(paletteKey)
      };
      if(typeof opts.onDateColorSelect === 'function'){
        try{
          opts.onDateColorSelect({ ...result });
        }catch(err){
          console.error('onDateColorSelect error', err);
        }
      }
      closePalettePopup();
      return result;
    }

    function createPalettePopup(anchorEl, date){
      closePalettePopup();
      paletteCurrentDate = date;
      const popup = document.createElement('div');
      popup.className = 'vac-color-palette';

      const title = document.createElement('div');
      title.className = 'vac-color-palette__title';
      title.textContent = '蛻励き繝ｩ繝ｼ繧帝∈謚・;
      popup.appendChild(title);

      const grid = document.createElement('div');
      grid.className = 'vac-color-palette__grid';
      COLOR_PALETTE.forEach((item, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `vac-color-option ${item.className}`;
        btn.dataset.colorKey = item.key;
        btn.setAttribute('aria-label', `${item.key} 繧帝∈謚杼);
        const mark = document.createElement('span');
        mark.className = 'vac-color-option__dot';
        btn.appendChild(mark);
        const label = document.createElement('span');
        label.className = 'vac-color-option__label';
        label.textContent = item.key;
        btn.appendChild(label);
        btn.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          handlePaletteColorSelect(date, idx);
        });
        grid.appendChild(btn);
      });
      popup.appendChild(grid);

      document.body.appendChild(popup);
      palettePopupEl = popup;

      requestAnimationFrame(() => positionPalettePopup(anchorEl));

      const handleOutside = (ev) => {
        if(!palettePopupEl) return;
        const target = ev.target;
        if(palettePopupEl.contains(target) || anchorEl.contains(target)) return;
        closePalettePopup();
      };

      const closeOnScroll = () => closePalettePopup();

      ['mousedown','touchstart','pointerdown'].forEach(ev => {
        document.addEventListener(ev, handleOutside, true);
        paletteCleanupFns.push(() => document.removeEventListener(ev, handleOutside, true));
      });
      window.addEventListener('scroll', closeOnScroll, true);
      paletteCleanupFns.push(() => window.removeEventListener('scroll', closeOnScroll, true));
      window.addEventListener('resize', closeOnScroll, true);
      paletteCleanupFns.push(() => window.removeEventListener('resize', closeOnScroll, true));
    }

    function applyExternalDateColors(colorMap){
      if(!colorMap){
        syncDateColorMapWithSlots();
        applyAllColumnColors();
        return;
      }
      const entries = colorMap instanceof Map ? Array.from(colorMap.entries()) : Object.entries(colorMap);
      const previous = new Map(dateColorMap);
      dateColorMap.clear();
      syncDateColorMapWithSlots();
      let changed = true;
      entries.forEach(([rawDate, colorValue]) => {
        const date = normalizeDateStr(rawDate);
        if(!date) return;
        const paletteKey = paletteKeyFromEventColor(colorValue);
        if(!paletteKey){
          if(previous.has(date)){
            dateColorMap.set(date, previous.get(date));
            changed = true;
          }
          return;
        }
        const idx = paletteIndexFromKey(paletteKey);
        if(idx < 0){
          if(previous.has(date)){
            dateColorMap.set(date, previous.get(date));
            changed = true;
          }
          return;
        }
        dateColorMap.set(date, idx % COLOR_PALETTE.length);
        changed = true;
      });
      if(changed){
        applyAllColumnColors();
      }
    }

    function handleColorCycle(e){
      const isAdmin = typeof isOfficeAdmin === 'function' ? isOfficeAdmin() : false;
      if(!isAdmin) return;
      const target = e.target.closest('.vac-day-header');
      if(!target) return;
      const date = target.dataset.date;
      if(!date) return;
      e.preventDefault();
      e.stopPropagation();
      if(palettePopupEl && paletteCurrentDate === date){
        closePalettePopup();
        return;
      }
      createPalettePopup(target, date);
    }
    let statusEl = null;
    let saveMode = opts.saveMode || 'vacation';
    let initialized = false;
    let groupAnchors = [];

    function captureCurrentState(){
      const stateBits = getBitsString();
      return {
        start: startInput?.value || '',
        end: endInput?.value || '',
        bits: stateBits
      };
    }

    function ensureStatusElement(){
      if(statusEl) return statusEl;
      const el = document.createElement('div');
      el.className = 'vac-save-status';
      statusEl = el;
      if(ganttRoot){
        ganttRoot.appendChild(el);
      }
      return el;
    }

    function renderStatus(type, message, actions){
      const el = ensureStatusElement();
      el.textContent = '';
      el.dataset.state = type;
      const msgSpan = document.createElement('span');
      msgSpan.className = 'vac-save-message';
      msgSpan.textContent = message;
      el.appendChild(msgSpan);
      if(type === 'saving'){
        const spinner = document.createElement('span');
        spinner.className = 'vac-save-spinner';
        spinner.setAttribute('aria-hidden', 'true');
        el.prepend(spinner);
      }
      (actions || []).forEach(({ label, onClick, className }) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = label;
        btn.className = className || 'vac-save-action';
        btn.addEventListener('click', onClick);
        el.appendChild(btn);
      });
    }

    function showSavingStatus(){
      renderStatus('saving', '螟画峩繧剃ｿ晏ｭ倥＠縺ｦ縺・∪縺吮ｦ');
    }

    function showSavedStatus(){
      renderStatus('saved', '閾ｪ蜍穂ｿ晏ｭ俶ｸ医∩');
      setTimeout(() => {
        if(statusEl && statusEl.dataset.state === 'saved'){
          statusEl.textContent = '';
          statusEl.dataset.state = '';
        }
      }, 2000);
    }

    function rollbackToLastSaved(){
      if(!lastSavedState) return;
      setRangeAndBits(lastSavedState.start, lastSavedState.end, lastSavedState.bits);
      toast('菫晏ｭ伜燕縺ｮ迥ｶ諷九↓謌ｻ縺励∪縺励◆', false);
    }

    function showErrorStatus(){
      const actions = [{
        label: '蜀崎ｩｦ陦・,
        onClick: () => scheduleAutoSave('retry'),
        className: 'vac-save-retry'
      }];
      if(lastSavedState){
        actions.push({
          label: '繝ｭ繝ｼ繝ｫ繝舌ャ繧ｯ',
          onClick: rollbackToLastSaved,
          className: 'vac-save-rollback'
        });
      }
      renderStatus('error', '菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲ょ・隧ｦ陦後☆繧九°繝ｭ繝ｼ繝ｫ繝舌ャ繧ｯ縺ｧ縺阪∪縺吶・, actions);
    }

    function isEventModalSaveMode(){
      return saveMode === 'event-modal' || saveMode === 'event-auto';
    }

    async function invokeSaveHandler(){
      if(isEventModalSaveMode() && typeof window.saveEventFromModal === 'function'){
        return await window.saveEventFromModal();
      }
      if(typeof window.saveLongVacationFromModal === 'function'){
        return await window.saveLongVacationFromModal();
      }
      if(typeof window.handleVacationAutoSave === 'function'){
        return await window.handleVacationAutoSave();
      }
      if(typeof window.handleVacationSave === 'function'){
        return await window.handleVacationSave();
      }
      throw new Error('save_handler_missing');
    }

    async function flushAutoSave(){
      if(saveInFlight){
        queuedSave = true;
        return;
      }
      if(!latestRequestedState) return;
      saveInFlight = true;
      queuedSave = false;
      showSavingStatus();
      try{
        await invokeSaveHandler();
        lastSavedState = captureCurrentState();
        showSavedStatus();
      }catch(err){
        console.error('閾ｪ蜍穂ｿ晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', err);
        showErrorStatus();
      }finally{
        saveInFlight = false;
        if(queuedSave){
          queuedSave = false;
          flushAutoSave();
        }
      }
    }

    function scheduleAutoSave(reason){
      latestRequestedState = captureCurrentState();
      if(autoSaveTimer){
        clearTimeout(autoSaveTimer);
      }
      autoSaveTimer = setTimeout(() => {
        autoSaveTimer = null;
        flushAutoSave();
      }, 800);
    }

    function getGroupTitle(group, idx){
      if(typeof fallbackGroupTitle === 'function'){
        return fallbackGroupTitle(group, idx);
      }
      const raw = (group && typeof group.title === 'string') ? group.title.trim() : '';
      return raw || `繧ｰ繝ｫ繝ｼ繝・{idx + 1}`;
    }

    function getDateRange(){
      const startRaw = startInput?.value || '';
      const endRaw   = endInput?.value   || '';
      const start = normalizeDateStr(startRaw) || normalizeDateStr(new Date());
      let end = normalizeDateStr(endRaw);
      if(!end){
        const base = start ? new Date(start) : new Date();
        const tmp = new Date(base);
        tmp.setDate(base.getDate() + (FALLBACK_DAYS - 1));
        end = normalizeDateStr(tmp);
      }
      const startDate = new Date(start);
      const endDate = new Date(end);
      if(endDate < startDate){
        return { start: normalizeDateStr(endDate), end: normalizeDateStr(startDate) };
      }
      return { start, end };
    }

    function buildDateSlots(){
      const { start, end } = getDateRange();
      const out = [];
      if(!start || !end) return out;
      const current = new Date(start);
      const endDate = new Date(end);
      while(current <= endDate){
        out.push(normalizeDateStr(current));
        current.setDate(current.getDate() + 1);
      }
      return out;
    }

    function getMembersOrdered(){
      if(typeof getRosterOrdering === 'function'){
        return getRosterOrdering().flatMap((g, gi) => (g.members || []).map(m => ({
          ...m,
          groupTitle: getGroupTitle(g, gi)
        })));
      }
      return [];
    }

    function ensureBits(date){
      if(!bitsByDate.has(date)){
        bitsByDate.set(date, new Array(orderedMembers.length).fill(false));
      }
      const arr = bitsByDate.get(date) || [];
      if(arr.length < orderedMembers.length){
        const diff = orderedMembers.length - arr.length;
        bitsByDate.set(date, arr.concat(new Array(diff).fill(false)));
      }
    }

    function parseBitsString(raw){
      bitsByDate.clear();
      if(!raw){
        dateSlots.forEach(d => ensureBits(d));
        return;
      }
      const parts = raw.split(';').map(s => s.trim()).filter(Boolean);
      if(parts.length === 0){
        dateSlots.forEach(d => ensureBits(d));
        return;
      }
      const useSlots = dateSlots.length ? dateSlots : parts.map((_,i)=> i.toString());
      parts.forEach((part, idx)=>{
        let key = '';
        let bits = part;
        if(part.includes(':')){
          const [k,v] = part.split(':');
          key = normalizeDateStr(k) || useSlots[idx] || '';
          bits = v || '';
        }else{
          key = useSlots[idx] || '';
        }
        ensureBits(key);
        const arr = bitsByDate.get(key) || [];
        const chars = (bits||'').trim();
        for(let i=0;i<orderedMembers.length;i++){
          arr[i] = chars[i] === '1';
        }
        bitsByDate.set(key, arr);
      });
      dateSlots.forEach(d => ensureBits(d));
    }

    function serializeBits(){
      const rows = [];
      dateSlots.forEach(date => {
        const arr = bitsByDate.get(date) || [];
        const bits = orderedMembers.map((_,i)=> arr[i] ? '1' : '0').join('');
        rows.push(`${date}:${bits}`);
      });
      return rows.join(';');
    }

    function updateBitsInput(){
      if(!bitsInput) return;
      bitsInput.value = serializeBits();
    }

    function toggleBit(date, memberIdx, on){
      ensureBits(date);
      const arr = bitsByDate.get(date) || [];
      arr[memberIdx] = on;
      bitsByDate.set(date, arr);
      updateBitsInput();
      scheduleAutoSave('cell');
    }

    function applyBitsToCells(){
      if(!tableEl) return;
      // 繝｡繝ｳ繝舌・縺斐→縺ｫ繝薙ャ繝医′1縺､縺ｧ繧ゅ≠繧九°繧偵メ繧ｧ繝・け
      const memberHasBit = new Map();
      bitsByDate.forEach((arr) => {
        if(!Array.isArray(arr)) return;
        arr.forEach((on, idx) => {
          if(on) memberHasBit.set(idx, true);
        });
      });
      
      tableEl.querySelectorAll('.vac-cell').forEach(cell => {
        const date = cell.dataset.date;
        const idx = Number(cell.dataset.memberIndex || '-1');
        const arr = bitsByDate.get(date);
        const on = Array.isArray(arr) ? !!arr[idx] : false;
        cell.classList.toggle('on', on);
        cell.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
      
      // 繝｡繝ｳ繝舌・蜷阪・繝上う繝ｩ繧､繝郁｡ｨ遉ｺ
      tableEl.querySelectorAll('th.member-name').forEach(th => {
        const idx = Number(th.dataset.memberIndex || '-1');
        const hasBit = memberHasBit.has(idx);
        th.classList.toggle('member-has-bit', hasBit);
      });
    }

    function createHeaderRow(){
      const thead = document.createElement('thead');
      const monthRow = document.createElement('tr');
      monthRow.className = 'vac-month-row';
      const dayRow = document.createElement('tr');
      dayRow.className = 'vac-day-row';

      const groupHeader = document.createElement('th');
      groupHeader.textContent = '繧ｰ繝ｫ繝ｼ繝・;
      groupHeader.className = 'group-name';
      groupHeader.rowSpan = 2;
      monthRow.appendChild(groupHeader);
      const nameHeader = document.createElement('th');
      nameHeader.textContent = '豌丞錐';
      nameHeader.className = 'member-name';
      nameHeader.rowSpan = 2;
      monthRow.appendChild(nameHeader);

      const monthGroups = [];
      let currentMonth = '';
      let spanStart = 0;
      dateSlots.forEach((date, idx) => {
        const d = new Date(date);
        const monthLabel = `${d.getFullYear()}蟷ｴ${d.getMonth()+1}譛・;
        if(currentMonth === ''){
          currentMonth = monthLabel;
          spanStart = idx;
        }else if(monthLabel !== currentMonth){
          monthGroups.push({ label: currentMonth, start: spanStart, end: idx - 1 });
          currentMonth = monthLabel;
          spanStart = idx;
        }
        const dow = d.getDay();
        const dayTh = document.createElement('th');
        dayTh.dataset.date = date;
        dayTh.className = 'vac-day-header';
        if(dow === 0) dayTh.classList.add('weekend-sun');
        if(dow === 6) dayTh.classList.add('weekend-sat');

        const label = document.createElement('div');
        label.className = 'vac-day-label';

        const dateSpan = document.createElement('span');
        dateSpan.className = 'vac-date';
        dateSpan.textContent = `${d.getDate()}譌･`;

        const daySpan = document.createElement('span');
        daySpan.textContent = ['譌･','譛・,'轣ｫ','豌ｴ','譛ｨ','驥・,'蝨・][dow] || '';
        daySpan.className = 'vac-day';

        label.appendChild(dateSpan);
        label.appendChild(daySpan);
        dayTh.appendChild(label);
        dayRow.appendChild(dayTh);
      });

      if(currentMonth){
        monthGroups.push({ label: currentMonth, start: spanStart, end: dateSlots.length - 1 });
      }

      monthGroups.forEach(group => {
        const th = document.createElement('th');
        th.className = 'vac-month-header';
        th.colSpan = group.end - group.start + 1;
        const span = document.createElement('span');
        span.className = 'vac-month-text';
        span.textContent = group.label;
        th.appendChild(span);
        monthRow.appendChild(th);
      });

      thead.appendChild(monthRow);
      thead.appendChild(dayRow);
      return thead;
    }

    function createBodyRows(){
      const tbody = document.createElement('tbody');
      groupAnchors = [];
      let cursor = 0;
      const grouped = (typeof getRosterOrdering === 'function') ? getRosterOrdering() : [];
      grouped.forEach((group, gi) => {
        const members = group.members || [];
        if(members.length === 0) return;
        const groupTitle = getGroupTitle(group, gi);
        const anchorId = `${(ganttRoot && ganttRoot.id) ? `${ganttRoot.id}-` : ''}group-${gi}`;
        groupAnchors.push({ id: anchorId, title: groupTitle, memberCount: members.length });
        members.forEach((member, mi) => {
          const tr = document.createElement('tr');
          // 繧ｰ繝ｫ繝ｼ繝励・譛蠕後・陦後↓繧ｯ繝ｩ繧ｹ繧定ｿｽ蜉
          if(mi === members.length - 1){
            tr.classList.add('group-last-row');
          }
          if(mi === 0){
            tr.id = anchorId;
            tr.dataset.groupIndex = String(gi);
            const gth = document.createElement('th');
            gth.textContent = groupTitle;
            gth.className = 'group-name';
            gth.rowSpan = members.length;
            tr.appendChild(gth);
          }
          const nameTh = document.createElement('th');
          nameTh.textContent = member.name || '';
          nameTh.className = 'member-name';
          nameTh.dataset.memberIndex = String(cursor);
          tr.appendChild(nameTh);
          dateSlots.forEach(date => {
            const td = document.createElement('td');
            td.className = 'vac-cell';
            td.dataset.date = date;
            td.dataset.memberIndex = String(cursor);
            const d = new Date(date);
            const dow = d.getDay();
            if(dow === 0) td.classList.add('weekend-sun');
            if(dow === 6) td.classList.add('weekend-sat');
            td.setAttribute('role', 'button');
            td.setAttribute('aria-label', `${group.title || ''} ${member.name || ''} ${date}`);
            td.setAttribute('aria-pressed', 'false');
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
          cursor += 1;
        });
      });
      return tbody;
    }

    function applyHolidayColor(holidays){
      latestHolidaySet = holidays instanceof Set ? holidays : new Set();
      if(!tableEl) return;
      if(holidayPaletteIndex >= 0){
        latestHolidaySet.forEach(date => {
          const currentIdx = ensureDateColor(date);
          const defaultIdx = getDefaultColorIndex(date);
          if(currentIdx === defaultIdx){
            dateColorMap.set(date, holidayPaletteIndex);
          }
        });
      }
      applyAllColumnColors();
    }

    async function resolveHolidays(){
      // 謇句虚螳夂ｾｩ縺ｮ逾晄律繝ｪ繧ｹ繝医・縺ｿ繧剃ｽｿ逕ｨ・・SP驕募渚蝗樣∩縺ｮ縺溘ａ螟夜ΚAPI蜻ｼ縺ｳ蜃ｺ縺励ｒ蜑企勁・・
      const set = new Set(MANUAL_HOLIDAYS.map(normalizeDateStr).filter(Boolean));
      return set;
    }

    function renderTable(){
      if(!ganttRoot) return;
      ganttRoot.textContent = '';
      tableEl = document.createElement('table');
      tableEl.appendChild(createHeaderRow());
      tableEl.appendChild(createBodyRows());
      ganttRoot.appendChild(tableEl);
      if(statusEl){
        ganttRoot.appendChild(statusEl);
      }
      applyAllColumnColors();
      applyBitsToCells();
      resolveHolidays().then(set => applyHolidayColor(set));
    }

    function handlePointerDown(e){
      const cell = e.target.closest('.vac-cell');
      if(!cell) return;
      // 蟾ｦ繧ｯ繝ｪ繝・け・・utton === 0・峨・縺ｿ蜿励￠莉倥￠繧・
      if(e.button !== 0) return;
      const idx = Number(cell.dataset.memberIndex || '-1');
      if(idx < 0) return;
      const date = cell.dataset.date;
      const currentOn = cell.classList.contains('on');
      const toValue = !currentOn;
      draggingState = {
        toValue,
        startX: e.clientX,
        startY: e.clientY,
        hasDragged: false,
        startCell: cell
      };
      if(tableEl){
        tableEl.classList.add('dragging');
      }
      toggleBit(date, idx, toValue);
      cell.classList.toggle('on', toValue);
    }

    function handlePointerOver(e){
      if(!draggingState) return;
      const cell = e.target.closest('.vac-cell');
      if(!cell) return;
      const idx = Number(cell.dataset.memberIndex || '-1');
      if(idx < 0) return;
      const date = cell.dataset.date;
      if(draggingState.startCell && draggingState.startCell !== cell){
        draggingState.hasDragged = true;
      }
      toggleBit(date, idx, draggingState.toValue);
      cell.classList.toggle('on', draggingState.toValue);
    }

    function handlePointerMove(e){
      if(!draggingState) return;
      const movedX = typeof draggingState.startX === 'number' ? Math.abs((e.clientX || 0) - draggingState.startX) : 0;
      const movedY = typeof draggingState.startY === 'number' ? Math.abs((e.clientY || 0) - draggingState.startY) : 0;
      if(movedX > 2 || movedY > 2){
        draggingState.hasDragged = true;
      }
      if(draggingState.hasDragged && e.cancelable){
        e.preventDefault();
      }
    }

    function handlePointerUp(){
      draggingState = null;
      if(tableEl){
        tableEl.classList.remove('dragging');
      }
    }

    function clearHoverHighlights(){
      if(!tableEl) return;
      tableEl.querySelectorAll('.hover-highlight').forEach(el => el.classList.remove('hover-highlight'));
    }

    function applyHoverHighlights(cell){
      if(!tableEl || !cell) return;
      clearHoverHighlights();
      const date = cell.dataset.date;
      if(date){
        tableEl.querySelectorAll(`[data-date="${date}"]`).forEach(el => el.classList.add('hover-highlight'));
      }
      const row = cell.closest('tr');
      if(row){
        row.querySelectorAll('th, td').forEach(el => el.classList.add('hover-highlight'));
      }
    }

    function scrollToGroup(anchorId){
      if(!anchorId || !tableEl) return;
      const target = tableEl.querySelector(`#${anchorId}`);
      if(target){
        const container = scrollContainer || ganttRoot;
        if(container && container !== document.body && typeof container.scrollTo === 'function'){
          const targetRect = target.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          const offsetTop = targetRect.top - containerRect.top + container.scrollTop;
          container.scrollTo({ top: offsetTop, behavior: 'smooth' });
        }else{
          target.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
        }
      }
    }

    function renderGroupJumps(){
      if(!jumpContainer) return;
      if(!groupAnchors.length){
        jumpContainer.style.display = 'none';
        return;
      }
      jumpContainer.style.display = 'flex';
      const label = jumpContainer.querySelector('.jump-label') || (() => {
        const el = document.createElement('span');
        el.className = 'jump-label';
        el.textContent = '繧ｰ繝ｫ繝ｼ繝励ず繝｣繝ｳ繝・;
        jumpContainer.appendChild(el);
        return el;
      })();

      const buttonsWrap = jumpContainer.querySelector('.jump-buttons') || (() => {
        const wrap = document.createElement('div');
        wrap.className = 'jump-buttons';
        jumpContainer.appendChild(wrap);
        return wrap;
      })();

      const selectWrap = jumpContainer.querySelector('.jump-select') || (() => {
        const wrap = document.createElement('label');
        wrap.className = 'jump-select';
        const select = document.createElement('select');
        wrap.appendChild(select);
        jumpContainer.appendChild(wrap);
        return wrap;
      })();
      const selectEl = selectWrap.querySelector('select');

      const showButtons = groupJumpMode === 'buttons' || groupJumpMode === 'both';
      const showSelect = groupJumpMode === 'select' || groupJumpMode === 'both';

      label.style.display = '';

      buttonsWrap.textContent = '';
      if(showButtons){
        buttonsWrap.style.display = 'flex';
        groupAnchors.forEach(anchor => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'jump-btn';
          const memberInfo = typeof anchor.memberCount === 'number' ? `・・{anchor.memberCount}蜷搾ｼ荏 : '';
          btn.textContent = `${anchor.title}${memberInfo}`;
          btn.addEventListener('click', () => scrollToGroup(anchor.id));
          buttonsWrap.appendChild(btn);
        });
      }else{
        buttonsWrap.style.display = 'none';
      }

      if(showSelect){
        selectWrap.style.display = 'inline-flex';
        if(selectEl){
          selectEl.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '繧ｰ繝ｫ繝ｼ繝励ｒ驕ｸ謚・;
          selectEl.appendChild(placeholder);
          groupAnchors.forEach(anchor => {
            const opt = document.createElement('option');
            opt.value = anchor.id;
            const memberInfo = typeof anchor.memberCount === 'number' ? `・・{anchor.memberCount}蜷搾ｼ荏 : '';
            opt.textContent = `${anchor.title}${memberInfo}`;
            selectEl.appendChild(opt);
          });
          selectEl.onchange = (e) => {
            const targetId = e.target.value;
            if(targetId){
              scrollToGroup(targetId);
            }
          };
        }
      }else{
        selectWrap.style.display = 'none';
      }
    }

    function bindTableEvents(){
      if(!tableEl) return;
      const isAdmin = typeof isOfficeAdmin === 'function' ? isOfficeAdmin() : false;
      const thead = tableEl.querySelector('thead');
      if(thead){
        thead.removeEventListener('click', handleColorCycle);
        if(isAdmin){
          thead.addEventListener('click', handleColorCycle);
        }
      }
      tableEl.addEventListener('pointerdown', handlePointerDown);
      tableEl.addEventListener('pointerover', handlePointerOver);
      tableEl.addEventListener('pointermove', handlePointerMove, { passive:false });
      tableEl.addEventListener('touchmove', handlePointerMove, { passive:false });
      ['pointerup','pointercancel','pointerleave'].forEach(ev => tableEl.addEventListener(ev, handlePointerUp));
      const tbody = tableEl.querySelector('tbody');
      if(tbody){
        const handleHover = (e) => {
          const cell = e.target.closest('td.vac-cell');
          if(!cell) return;
          applyHoverHighlights(cell);
        };
        const handleOut = (e) => {
          const cell = e.target.closest('td.vac-cell');
          if(!cell) return;
          clearHoverHighlights();
        };
        tbody.addEventListener('mouseover', handleHover);
        tbody.addEventListener('mouseout', handleOut);
        tbody.addEventListener('focusin', handleHover);
        tbody.addEventListener('focusout', handleOut);
      }
      tableEl.addEventListener('mouseleave', clearHoverHighlights);
    }

    function rebuild(){
      if(!ganttRoot) return;
      closePalettePopup();
      orderedMembers = getMembersOrdered();
      dateSlots = buildDateSlots();
      syncDateColorMapWithSlots();
      parseBitsString(bitsInput?.value || '');
      renderTable();
      renderGroupJumps();
      bindTableEvents();
    }

    function init(){
      if(initialized) return;
      initialized = true;
      if(!ganttRoot) return;
      rebuild();
      if(opts.autoBind !== false){
        if(startInput){
          startInput.addEventListener('change', () => {
            rebuild();
            scheduleAutoSave('date-change');
          });
        }
        if(endInput){
          endInput.addEventListener('change', () => {
            rebuild();
            scheduleAutoSave('date-change');
          });
        }
        if(bitsInput){
          bitsInput.addEventListener('input', ()=>{
            parseBitsString(bitsInput.value);
            applyBitsToCells();
            scheduleAutoSave('bits-input');
          });
        }
      }
      lastSavedState = captureCurrentState();
    }

    function reset(){
      bitsByDate.clear();
      if(tableEl){
        tableEl.querySelectorAll('.vac-cell').forEach(td => td.classList.remove('on'));
      }
      rebuild();
    }

    function loadFromString(str){
      parseBitsString(str || '');
      applyBitsToCells();
      updateBitsInput();
    }

    function setRangeAndBits(start, end, bits){
      if(startInput) startInput.value = normalizeDateStr(start) || '';
      if(endInput) endInput.value = normalizeDateStr(end) || '';
      if(bitsInput) bitsInput.value = bits || '';
      rebuild();
    }

    function getBitsString(){
      updateBitsInput();
      return bitsInput?.value || '';
    }

    if(opts.autoInit !== false){
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init, { once:true });
      }else{
        init();
      }
    }

    return {
      rebuild,
      reset,
      loadFromString,
      syncInput: updateBitsInput,
      init,
      setRangeAndBits,
      getBitsString,
      applyBitsToCells,
      applyDateColorMap: applyExternalDateColors,
      setSaveMode: (mode)=>{ saveMode = mode || 'vacation'; }
    };
  }

  const defaultController = createVacationGanttController({
    rootEl: document.getElementById('vacationGantt'),
    startInput: vacationStartInput,
    endInput: vacationEndInput,
    bitsInput: vacationMembersBitsInput
  });

  window.createVacationGantt = createVacationGanttController;
  window.VacationGantt = defaultController || {
    rebuild: ()=>{},
    reset: ()=>{},
    loadFromString: ()=>{},
    syncInput: ()=>{}
  };
})();


/* --- admin.js --- */
/* 邂｡逅・I繧､繝吶Φ繝・*/
const groupOrderList = document.getElementById('groupOrderList');
const groupOrderEmpty = document.getElementById('groupOrderEmpty');
if (adminOfficeSel) {
  adminOfficeSel.addEventListener('change', () => {
    adminSelectedOfficeId = adminOfficeSel.value || '';
    adminMembersLoaded = false; adminMemberList = []; setMemberTableMessage('隱ｭ縺ｿ霎ｼ縺ｿ蠕・■');
    adminToolsLoaded = false; adminToolsOfficeId = '';
    refreshVacationOfficeOptions();
    if (document.getElementById('tabMembers')?.classList.contains('active')) {
      loadAdminMembers(true);
    }
    if (document.getElementById('tabEvents')?.classList.contains('active')) {
      loadVacationsList();
    }
    if (document.getElementById('tabTools')?.classList.contains('active')) {
      loadAdminTools(true);
    }
  });
}
if (vacationOfficeSelect) {
  vacationOfficeSelect.addEventListener('change', async () => {
    const officeId = vacationOfficeSelect.value || adminSelectedOfficeId || CURRENT_OFFICE_ID || '';
    if (typeof fetchNotices === 'function') {
      await fetchNotices(officeId);
    }
    refreshVacationNoticeOptions();
  });
}
btnExport.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  const cfg = await adminGetConfigFor(office);
  const dat = await adminGetFor(office);
  if (!(cfg && cfg.groups) || !(dat && typeof dat.data === 'object')) { toast('繧ｨ繧ｯ繧ｹ繝昴・繝亥､ｱ謨・, false); return; }
  const csv = makeNormalizedCSV(cfg, dat.data);
  const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const bytes = new TextEncoder().encode(csv);
  const blob = new Blob([BOM, bytes], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `presence_${office}.csv`;
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
});
btnImport.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  const file = csvFile.files && csvFile.files[0];
  if (!file) { toast('CSV繧帝∈謚槭＠縺ｦ縺上□縺輔＞', false); return; }

  const text = await file.text();
  const normalizedText = text.replace(/^\uFEFF/, '');
  const rows = parseCSV(normalizedText);
  if (!rows.length) { toast('CSV縺檎ｩｺ縺ｧ縺・, false); return; }
  const titleCell = (rows[0] && rows[0][0] != null) ? String(rows[0][0]) : '';
  if (!((rows[0] || []).length === 1 && titleCell.trim() === '蝨ｨ蟶ｭ邂｡逅・SV')) { toast('CSV繝倥ャ繝縺御ｸ肴ｭ｣縺ｧ縺・, false); return; }
  if (rows.length < 2) { toast('CSV繝倥ャ繝縺御ｸ肴ｭ｣縺ｧ縺・, false); return; }
  const expectedHeader = ['繧ｰ繝ｫ繝ｼ繝礼分蜿ｷ', '繧ｰ繝ｫ繝ｼ繝怜錐', '陦ｨ遉ｺ鬆・, 'id', '豌丞錐', '蜀・ｷ・, '謳ｺ蟶ｯ逡ｪ蜿ｷ', 'Email', '讌ｭ蜍呎凾髢・, '繧ｹ繝・・繧ｿ繧ｹ', '謌ｻ繧頑凾髢・, '蛯呵・];
  const hdr = (rows[1] || []).map(s => s.trim());
  const headerOk = hdr.length === expectedHeader.length && expectedHeader.every((h, i) => hdr[i] === h);
  if (!headerOk) { toast('CSV繝倥ャ繝縺御ｸ肴ｭ｣縺ｧ縺・, false); return; }

  const recs = [];
  for (const r of rows.slice(2)) {
    if (!r.some(x => (x || '').trim() !== '')) continue;
    if (r.length !== expectedHeader.length) { toast('CSV繝・・繧ｿ陦後′荳肴ｭ｣縺ｧ縺・, false); return; }
    const [gi, gt, mi, id, name, ext, mobile, email, workHours, status, time, note] = r;
    recs.push({
      gi: Number(gi) || 0,
      gt: (gt || ''),
      mi: Number(mi) || 0,
      id: (id || ''),
      name: (name || ''),
      ext: (ext || ''),
      mobile: (mobile || ''),
      email: (email || ''),
      workHours: workHours == null ? '' : String(workHours),
      status: (status || (STATUSES[0]?.value || '蝨ｨ蟶ｭ')),
      time: (time || ''),
      note: (note || '')
    });
  }

  const groupsMap = new Map();
  for (const r of recs) {
    if (!r.gi || !r.mi || !r.name) continue;
    if (!groupsMap.has(r.gi)) groupsMap.set(r.gi, { title: r.gt || '', members: [] });
    const g = groupsMap.get(r.gi);
    g.title = r.gt || '';
    const memberId = r.id || '';
    g.members.push({ _mi: r.mi, name: r.name, ext: r.ext || '', mobile: r.mobile || '', email: r.email || '', workHours: r.workHours || '', id: memberId || undefined });
  }
  const groups = Array.from(groupsMap.entries()).sort((a, b) => a[0] - b[0]).map(([gi, g]) => { g.members.sort((a, b) => (a._mi || 0) - (b._mi || 0)); g.members.forEach(m => delete m._mi); return g; });
  const cfgToSet = { version: 2, updated: Date.now(), groups, menus: MENUS || undefined };
  const r1 = await adminSetConfigFor(office, cfgToSet);
  if (!r1 || r1.error) {
    console.error('adminSetConfigFor failed:', r1);
    toast(`蜷咲ｰｿ縺ｮ險ｭ螳壹↓螟ｱ謨・ ${r1?.error || 'unknown'}`, false);
    return;
  }

  const dataObj = {};
  for (const r of recs) {
    const id = r.id || null;
    if (!id) continue;
    const workHours = r.workHours || '';
    dataObj[id] = { ext: r.ext || '', mobile: r.mobile || '', email: r.email || '', workHours, status: STATUSES.some(s => s.value === r.status) ? r.status : (STATUSES[0]?.value || '蝨ｨ蟶ｭ'), time: r.time || '', note: r.note || '' };
  }
  const r2 = await adminSetForChunked(office, dataObj);
  if (!(r2 && r2.ok)) { toast('蝨ｨ蟶ｭ繝・・繧ｿ譖ｴ譁ｰ縺ｫ螟ｱ謨・, false); return; }
  toast('繧､繝ｳ繝昴・繝亥ｮ御ｺ・, true);
});
btnRenameOffice.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  const name = (renameOfficeName.value || '').trim();
  if (!name) { toast('譁ｰ縺励＞諡轤ｹ蜷阪ｒ蜈･蜉・, false); return; }
  const r = await adminRenameOffice(office, name);
  if (r && r.ok) { toast('諡轤ｹ蜷阪ｒ螟画峩縺励∪縺励◆'); }
  else toast('螟画峩縺ｫ螟ｱ謨・, false);
});

btnSetPw.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  const pw = (setPw.value || '').trim();
  const apw = (setAdminPw.value || '').trim();
  if (!pw && !apw) { toast('譖ｴ譁ｰ縺吶ｋ鬆・岼繧貞・蜉・, false); return; }
  const r = await adminSetOfficePassword(office, pw, apw);
  if (r && r.ok) { toast('繝代せ繝ｯ繝ｼ繝峨ｒ譖ｴ譁ｰ縺励∪縺励◆'); setPw.value = ''; setAdminPw.value = ''; }
  else toast('譖ｴ譁ｰ縺ｫ螟ｱ謨・, false);
});

/* 邂｡逅・Δ繝ｼ繝繝ｫ縺ｮ繧ｿ繝門・繧頑崛縺・*/
if (adminModal) {
  const adminTabButtons = adminModal.querySelectorAll('.admin-tabs .tab-btn');
  const adminTabPanels = adminModal.querySelectorAll('.tab-panel');
  const resetPanelScroll = (panel) => {
    if (!panel) return;
    Array.from(panel.children).forEach((child) => {
      if (child.scrollHeight > child.clientHeight) {
        child.scrollTop = 0;
      }
    });
  };

  adminTabButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const targetTab = btn.dataset.tab;

      adminTabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      adminTabPanels.forEach(panel => panel.classList.remove('active'));
      const panelMap = {
        basic: adminModal.querySelector('#tabBasic'),
        members: adminModal.querySelector('#tabMembers'),
        notices: adminModal.querySelector('#tabNotices'),
        events: adminModal.querySelector('#tabEvents'),
        tools: adminModal.querySelector('#tabTools')
      };
      const panel = panelMap[targetTab];
      if (panel) {
        panel.classList.add('active');
        resetPanelScroll(panel);
      }

      if (targetTab === 'notices') {
        if (typeof autoLoadNoticesOnAdminOpen === 'function') {
          await autoLoadNoticesOnAdminOpen();
        }
      } else if (targetTab === 'basic') {
        // no-op for now
      } else if (targetTab === 'members') {
        if (!adminMembersLoaded) { await loadAdminMembers(); }
      } else if (targetTab === 'events') {
        refreshVacationOfficeOptions();
        const officeId = (vacationOfficeSelect?.value) || adminSelectedOfficeId || CURRENT_OFFICE_ID || '';
        if (typeof fetchNotices === 'function') {
          await fetchNotices(officeId);
        }
        refreshVacationNoticeOptions();
        await loadVacationsList();
      } else if (targetTab === 'tools') {
        await loadAdminTools();
      }
    });
  });
}

/* 繝｡繝ｳ繝舌・邂｡逅・*/
let adminMemberList = [], adminMemberData = {}, adminGroupOrder = [], adminMembersLoaded = false;
let adminToolsLoaded = false, adminToolsOfficeId = '';

if (btnMemberSave) { btnMemberSave.addEventListener('click', () => handleMemberSave()); }
if (memberEditForm) {
  memberEditForm.addEventListener('submit', (e) => {
    e.preventDefault();
    submitMemberEdit();
  });
}
if (memberEditReset) { memberEditReset.addEventListener('click', () => openMemberEditor(null)); }
if (memberFilterInput) { memberFilterInput.addEventListener('input', renderMemberTable); }
if (btnMemberFilterClear) {
  btnMemberFilterClear.addEventListener('click', () => {
    memberFilterInput.value = '';
    renderMemberTable();
  });
}

function setMemberTableMessage(msg) {
  if (!memberTableBody) return;
  memberTableBody.textContent = '';
  const tr = document.createElement('tr');
  const td = document.createElement('td');
  td.colSpan = 7; td.style.textAlign = 'center'; td.style.color = '#6b7280';
  td.textContent = msg;
  tr.appendChild(td);
  memberTableBody.appendChild(tr);
}

async function loadAdminMembers(force) {
  const office = selectedOfficeId(); if (!office) return;
  if (force !== true && adminMembersLoaded && adminMemberList.length) { return; }
  try {
    setMemberTableMessage('隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...');
    const [cfg, dataRes] = await Promise.all([
      adminGetConfigFor(office),
      adminGetFor(office)
    ]);
    if (!(cfg && Array.isArray(cfg.groups))) { setMemberTableMessage('險ｭ螳壹・蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆'); return; }
    adminMemberData = (dataRes && dataRes.data && typeof dataRes.data === 'object') ? dataRes.data : {};
    adminGroupOrder = (cfg.groups || []).map(g => String(g.title || ''));
    adminMemberList = [];
    const seenIds = new Set();
    cfg.groups.forEach((g) => {
      (g.members || []).forEach((m, mi) => {
        const idRaw = String(m.id || '').trim();
        const id = idRaw || generateMemberId();
        if (seenIds.has(id)) { return; }
        seenIds.add(id);
        adminMemberList.push({
          id,
          name: String(m.name || ''),
          ext: String(m.ext || ''),
          mobile: String(m.mobile || ''),
          email: String(m.email || ''),
          workHours: (m.workHours == null ? '' : String(m.workHours)),
          group: String(g.title || ''),
          order: mi
        });
      });
    });
    normalizeMemberOrdering();
    renderMemberTable();
    renderGroupOrderList();
    openMemberEditor(null);
    adminMembersLoaded = true;
  } catch (err) {
    console.error('loadAdminMembers error', err);
    setMemberTableMessage('繝｡繝ｳ繝舌・縺ｮ蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆');
  }
}

function normalizeMemberOrdering(options = {}) {
  const { preferCurrentOrder = false } = options;
  const orderBase = [];
  adminGroupOrder.forEach(g => {
    const name = String(g || '');
    if (!name.trim()) return;
    if (!orderBase.includes(name)) orderBase.push(name);
  });
  adminMemberList.forEach(m => {
    const name = String(m.group || '');
    if (name && !orderBase.includes(name)) { orderBase.push(name); }
  });
  adminGroupOrder = orderBase;
  if (preferCurrentOrder) {
    const counters = new Map();
    adminMemberList.forEach(m => {
      const cur = counters.get(m.group) || 0;
      m.order = cur;
      counters.set(m.group, cur + 1);
    });
  }
  adminMemberList.sort((a, b) => {
    const ga = orderBase.indexOf(a.group); const gb = orderBase.indexOf(b.group);
    if (ga !== gb) return ga - gb;
    return (a.order || 0) - (b.order || 0);
  });
  const counters = new Map();
  adminMemberList.forEach(m => {
    const cur = counters.get(m.group) || 0;
    m.order = cur;
    counters.set(m.group, cur + 1);
  });
}

function renderGroupOrderList() {
  if (!groupOrderList) return;
  groupOrderList.textContent = '';
  const order = [...new Set(adminGroupOrder.filter(g => (g || '').trim() !== ''))];
  if (groupOrderEmpty) {
    groupOrderEmpty.style.display = order.length ? 'none' : 'block';
  }
  order.forEach((groupName, idx) => {
    const item = document.createElement('div');
    item.className = 'group-order-item';
    item.dataset.groupName = groupName;
    const label = document.createElement('span');
    label.className = 'group-order-label';
    label.textContent = groupName;
    const actions = document.createElement('div');
    actions.className = 'group-order-actions';
    const upBtn = document.createElement('button');
    upBtn.className = 'btn-move-up';
    upBtn.textContent = '笆ｲ';
    upBtn.title = '荳翫↓遘ｻ蜍・;
    upBtn.disabled = idx === 0;
    upBtn.addEventListener('click', () => moveGroupOrder(groupName, -1));
    const downBtn = document.createElement('button');
    downBtn.className = 'btn-move-down';
    downBtn.textContent = '笆ｼ';
    downBtn.title = '荳九↓遘ｻ蜍・;
    downBtn.disabled = idx === order.length - 1;
    downBtn.addEventListener('click', () => moveGroupOrder(groupName, 1));
    actions.append(upBtn, downBtn);
    item.append(actions, label);
    groupOrderList.appendChild(item);
  });
}

function moveGroupOrder(groupName, dir) {
  const order = [...new Set(adminGroupOrder.filter(g => (g || '').trim() !== ''))];
  const idx = order.indexOf(groupName);
  if (idx < 0) return;
  const targetIdx = idx + dir;
  if (targetIdx < 0 || targetIdx >= order.length) return;
  const nextOrder = [...order];
  const [moving] = nextOrder.splice(idx, 1);
  nextOrder.splice(targetIdx, 0, moving);
  adminGroupOrder = nextOrder;
  normalizeMemberOrdering();
  renderMemberTable();
  renderGroupOrderList();
  refreshMemberGroupOptions();
}

function filteredMemberList() {
  const term = (memberFilterInput?.value || '').trim().toLowerCase();
  if (!term) { return [...adminMemberList]; }
  const words = term.split(/\s+/).filter(Boolean);
  return adminMemberList.filter(m => {
    const name = (m.name || '').toLowerCase();
    return words.every(w => name.includes(w));
  });
}

function renderMemberTable() {
  if (!memberTableBody) { return; }
  memberTableBody.textContent = '';
  if (!adminMemberList.length) {
    setMemberTableMessage('繝｡繝ｳ繝舌・縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ');
    return;
  }
  const rows = filteredMemberList();
  if (!rows.length) {
    setMemberTableMessage('譚｡莉ｶ縺ｫ荳閾ｴ縺吶ｋ繝｡繝ｳ繝舌・縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ');
    return;
  }


  const fragment = document.createDocumentFragment();
  rows.forEach((m, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.memberId = m.id;

    // --- [菫ｮ豁｣] 蟾ｦ遶ｯ: 鬆・分蛻・(謨ｰ蟄・+ 繝懊ち繝ｳ) ---
    const orderTd = document.createElement('td');
    // orderTd.className = 'member-order-cell'; // td縺ｫ逶ｴ謗･flex繧貞ｽ薙※繧九→鄂ｫ邱壹ヨ繝ｩ繝悶Ν縺ｮ蜴溷屏縺ｫ縺ｪ繧九・縺ｧ蟒・ｭ｢

    const orderWrapper = document.createElement('div');
    orderWrapper.className = 'member-order-cell'; // 繝ｩ繝・ヱ繝ｼ縺ｫ繧ｯ繝ｩ繧ｹ繧堤ｧｻ蜍・

    // 3譯√ぞ繝ｭ蝓九ａ謨ｰ蟄・
    const numSpan = document.createElement('span');
    numSpan.className = 'member-order-num';
    numSpan.textContent = String(idx + 1).padStart(3, '0');

    // 遘ｻ蜍輔・繧ｿ繝ｳ鄒､
    const moveActions = document.createElement('div');
    moveActions.className = 'member-move-actions';

    const upBtn = document.createElement('button');
    upBtn.className = 'btn-move-up';
    upBtn.textContent = '笆ｲ';
    upBtn.title = '荳翫↓遘ｻ蜍・;
    // 荳逡ｪ荳翫・陦後・辟｡蜉ｹ蛹・
    upBtn.disabled = (idx === 0);
    upBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveMember(m.id, -1);
    });

    const downBtn = document.createElement('button');
    downBtn.className = 'btn-move-down';
    downBtn.textContent = '笆ｼ';
    downBtn.title = '荳九↓遘ｻ蜍・;
    // 荳逡ｪ荳九・陦後・辟｡蜉ｹ蛹・
    downBtn.disabled = (idx === rows.length - 1);
    downBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      moveMember(m.id, 1);
    });

    moveActions.append(upBtn, downBtn);

    // 繝ｬ繧､繧｢繧ｦ繝・ 謨ｰ蟄・+ 繝懊ち繝ｳ (繧ｳ繝ｭ繝ｳ蜑企勁縲√Λ繝・ヱ繝ｼ縺ｫ霑ｽ蜉)
    orderWrapper.append(numSpan, moveActions);
    orderTd.appendChild(orderWrapper);
    // ------------------------------------------

    const groupTd = document.createElement('td'); groupTd.textContent = m.group || '';
    const nameTd = document.createElement('td'); nameTd.textContent = m.name || '';
    const extTd = document.createElement('td'); extTd.className = 'numeric-cell'; extTd.textContent = m.ext || '';
    const mobileTd = document.createElement('td'); mobileTd.className = 'numeric-cell'; mobileTd.textContent = m.mobile || '';

    const emailTd = document.createElement('td');
    if (m.email) {
      const [localPart, domainPart] = m.email.split('@');
      const emailWrap = document.createElement('div'); emailWrap.className = 'member-email';
      const localSpan = document.createElement('span'); localSpan.textContent = localPart || m.email; emailWrap.appendChild(localSpan);
      if (domainPart !== undefined) {
        const domainSpan = document.createElement('span'); domainSpan.className = 'email-domain'; domainSpan.textContent = '@' + domainPart; emailWrap.appendChild(domainSpan);
      }
      emailTd.appendChild(emailWrap);
    }

    // --- [菫ｮ豁｣] 蜿ｳ遶ｯ: 謫堺ｽ懷・ (讓ｪ荳ｦ縺ｳ繧ｳ繝ｳ繝・リ) ---
    const actionTd = document.createElement('td');

    const actionRow = document.createElement('div');
    actionRow.className = 'member-row-actions'; // 讓ｪ荳ｦ縺ｳ逕ｨ繧ｯ繝ｩ繧ｹ

    const editBtn = document.createElement('button');
    editBtn.textContent = '邱ｨ髮・;
    editBtn.className = 'btn-secondary';
    editBtn.addEventListener('click', () => openMemberEditor(m));

    const delBtn = document.createElement('button');
    delBtn.textContent = '蜑企勁';
    delBtn.className = 'btn-danger';
    delBtn.addEventListener('click', () => deleteMember(m.id));

    actionRow.append(editBtn, delBtn);
    actionTd.appendChild(actionRow);
    // ------------------------------------------

    tr.append(orderTd, groupTd, nameTd, extTd, mobileTd, emailTd, actionTd);
    fragment.appendChild(tr);
  });
  memberTableBody.appendChild(fragment);
}

// function enableMemberDrag() { ... } // 荳崎ｦ√↓縺ｪ縺｣縺溘◆繧∝炎髯､


function openMemberEditor(member) {
  if (memberEditId) memberEditId.value = member?.id || '';
  if (memberEditName) memberEditName.value = member?.name || '';
  if (memberEditExt) memberEditExt.value = member?.ext || '';
  if (memberEditMobile) memberEditMobile.value = member?.mobile || '';
  if (memberEditEmail) memberEditEmail.value = member?.email || '';
  if (memberEditGroup) memberEditGroup.value = member?.group || '';
  if (memberEditModeLabel) {
    memberEditModeLabel.textContent = member ? `邱ｨ髮・ｸｭ・・{member.name || ''}` : '譁ｰ隕剰ｿｽ蜉・冗ｷｨ髮・ヵ繧ｩ繝ｼ繝';
  }
  refreshMemberGroupOptions();
  if (memberEditTop && adminModal?.contains(memberEditTop)) {
    memberEditTop.scrollIntoView({ block: 'start' });
  }
  if (memberEditName) {
    memberEditName.focus({ preventScroll: true });
  }
}

function refreshMemberGroupOptions() {
  if (!memberGroupOptions) return;
  const groups = [...new Set(adminGroupOrder.filter(Boolean))];
  memberGroupOptions.textContent = '';
  groups.forEach(g => {
    const opt = document.createElement('option'); opt.value = g; memberGroupOptions.appendChild(opt);
  });
}

function submitMemberEdit() {
  const name = (memberEditName?.value || '').trim();
  const ext = (memberEditExt?.value || '').trim();
  const mobile = (memberEditMobile?.value || '').trim();
  const email = (memberEditEmail?.value || '').trim();
  const group = (memberEditGroup?.value || '').trim();
  const idRaw = (memberEditId?.value || '').trim();
  if (!name) { toast('豌丞錐縺ｯ蠢・医〒縺・, false); return; }
  if (!group) { toast('謇螻槭げ繝ｫ繝ｼ繝励ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', false); return; }
  if (ext && !/^\d{1,6}$/.test(ext.replace(/[^0-9]/g, ''))) { toast('蜀・ｷ壹・謨ｰ蟄励・縺ｿ縺ｧ蜈･蜉帙＠縺ｦ縺上□縺輔＞・域怙螟ｧ6譯・ｼ・, false); return; }
  const mobileDigits = mobile.replace(/[^0-9]/g, '');
  if (mobile && (mobileDigits.length < 10 || mobileDigits.length > 11)) { toast('謳ｺ蟶ｯ逡ｪ蜿ｷ縺ｯ10縲・1譯√・謨ｰ蟄励〒蜈･蜉帙＠縺ｦ縺上□縺輔＞・医ワ繧､繝輔Φ蜿ｯ・・, false); return; }
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { toast('Email縺ｮ蠖｢蠑上′荳肴ｭ｣縺ｧ縺・, false); return; }
  const id = idRaw || generateUniqueMemberId();
  const existingIdx = adminMemberList.findIndex(m => m.id === id);
  if (existingIdx >= 0) {
    adminMemberList[existingIdx] = { ...adminMemberList[existingIdx], id, name, ext, mobile, email, group };
  } else {
    const order = adminMemberList.filter(m => m.group === group).length;
    adminMemberList.push({ id, name, ext, mobile, email, group, order, workHours: '' });
  }
  normalizeMemberOrdering();
  renderGroupOrderList();
  renderMemberTable();
  openMemberEditor(null);
}

function generateMemberId() { return `member_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`; }
function generateUniqueMemberId() { let id = ''; do { id = generateMemberId(); } while (adminMemberList.some(m => m.id === id)); return id; }

function deleteMember(id) {
  if (!id) return; if (!confirm('縺薙・繝｡繝ｳ繝舌・繧貞炎髯､縺励∪縺吶°・・)) return;
  adminMemberList = adminMemberList.filter(m => m.id !== id);
  normalizeMemberOrdering();
  renderGroupOrderList();
  renderMemberTable();
}

function moveMember(id, dir) {
  const idx = adminMemberList.findIndex(m => m.id === id); if (idx < 0) return;
  const group = adminMemberList[idx].group;
  let targetIdx = idx + dir;
  while (targetIdx >= 0 && targetIdx < adminMemberList.length && adminMemberList[targetIdx].group !== group) {
    targetIdx += dir;
  }
  if (targetIdx < 0 || targetIdx >= adminMemberList.length) return;
  const tmp = adminMemberList[targetIdx];
  adminMemberList[targetIdx] = adminMemberList[idx];
  adminMemberList[idx] = tmp;
  normalizeMemberOrdering({ preferCurrentOrder: true });
  renderMemberTable();
}

function buildMemberSavePayload() {
  const errors = []; const idSet = new Set();
  const defaultStatus = STATUSES[0]?.value || '蝨ｨ蟶ｭ';
  const cleaned = adminMemberList.map(m => ({
    ...m,
    name: (m.name || '').trim(),
    group: (m.group || '').trim(),
    ext: (m.ext || '').trim(),
    mobile: (m.mobile || '').trim(),
    email: (m.email || '').trim()
  }));
  for (const m of cleaned) {
    if (!m.name) { errors.push('missing_name'); break; }
    if (!m.group) { errors.push('missing_group'); break; }
    if (m.ext && !/^\d{1,6}$/.test(m.ext.replace(/[^0-9]/g, ''))) { errors.push('invalid_ext'); break; }
    const mobileDigits = m.mobile.replace(/[^0-9]/g, '');
    if (m.mobile && (mobileDigits.length < 10 || mobileDigits.length > 11)) { errors.push('invalid_mobile'); break; }
    if (m.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m.email)) { errors.push('invalid_email'); break; }
    if (idSet.has(m.id)) { errors.push('duplicate_id'); break; }
    idSet.add(m.id);
  }
  if (errors.length) { return { errors }; }

  const groupOrder = [...adminGroupOrder];
  cleaned.forEach(m => { if (m.group && !groupOrder.includes(m.group)) groupOrder.push(m.group); });
  const grouped = new Map();
  cleaned.forEach(m => {
    const list = grouped.get(m.group) || []; list.push(m); grouped.set(m.group, list);
  });
  const groups = [];
  groupOrder.forEach(gName => {
    const mems = grouped.get(gName) || [];
    if (!mems.length) return;
    mems.sort((a, b) => (a.order || 0) - (b.order || 0));
    groups.push({
      title: gName,
      members: mems.map((m, idx) => ({ id: m.id, name: m.name, ext: m.ext, mobile: m.mobile, email: m.email, workHours: m.workHours || '', _order: idx }))
    });
  });

  const dataObj = {};
  groups.forEach(g => {
    g.members.forEach(m => {
      const existing = adminMemberData[m.id] || {};
      dataObj[m.id] = {
        ext: m.ext || '',
        mobile: m.mobile || '',
        email: m.email || '',
        workHours: existing.workHours == null ? '' : String(existing.workHours || m.workHours || ''),
        status: STATUSES.some(s => s.value === existing.status) ? existing.status : defaultStatus,
        time: existing.time || '',
        note: existing.note || ''
      };
    });
  });

  groups.forEach(g => g.members.forEach(m => delete m._order));
  return { groups, dataObj };
}

async function handleMemberSave() {
  const office = selectedOfficeId(); if (!office) return;
  const { groups, dataObj, errors } = buildMemberSavePayload();
  if (errors) {
    if (errors.includes('missing_name')) { toast('豌丞錐縺ｯ蠢・医〒縺・, false); return; }
    if (errors.includes('missing_group')) { toast('謇螻槭げ繝ｫ繝ｼ繝励ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', false); return; }
    if (errors.includes('invalid_ext')) { toast('蜀・ｷ壹・謨ｰ蟄励・縺ｿ縺ｧ譛螟ｧ6譯√〒縺・, false); return; }
    if (errors.includes('invalid_mobile')) { toast('謳ｺ蟶ｯ逡ｪ蜿ｷ縺ｯ10縲・1譯√・謨ｰ蟄励〒蜈･蜉帙＠縺ｦ縺上□縺輔＞', false); return; }
    if (errors.includes('invalid_email')) { toast('Email縺ｮ蠖｢蠑上′荳肴ｭ｣縺ｧ縺・, false); return; }
    if (errors.includes('duplicate_id')) { toast('ID縺碁㍾隍・＠縺ｦ縺・∪縺吶らｷｨ髮・判髱｢縺ｧ菫ｮ豁｣縺励※縺上□縺輔＞', false); return; }
    toast('蜈･蜉帛・螳ｹ繧堤｢ｺ隱阪＠縺ｦ縺上□縺輔＞', false); return;
  }
  try {
    const cfgToSet = { version: 2, updated: Date.now(), groups, menus: MENUS || undefined };
    const r1 = await adminSetConfigFor(office, cfgToSet);
    if (!(r1 && r1.ok !== false)) { toast('蜷咲ｰｿ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false); return; }
    if (office === CURRENT_OFFICE_ID && typeof normalizeConfigClient === 'function') {
      GROUPS = normalizeConfigClient({ groups });
      CONFIG_UPDATED = cfgToSet.updated;
      if (typeof render === 'function') {
        render();
      }
    }
    const r2 = await adminSetForChunked(office, dataObj);
    if (!(r2 && r2.ok !== false)) toast('蝨ｨ蟶ｭ繝・・繧ｿ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
    else toast('菫晏ｭ倥＠縺ｾ縺励◆');
  } catch (err) {
    console.error('handleMemberSave error', err);
    toast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
  }
}

/* 縺顔衍繧峨○邂｡逅・I */
btnAddNotice.addEventListener('click', () => addNoticeEditorItem());
btnLoadNotices.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  try {
    const params = { action: 'getNotices', token: SESSION_TOKEN, nocache: '1', office };
    const res = await apiPost(params);
    console.log('getNotices response:', res);
    if (res && res.notices) {
      noticesEditor.innerHTML = '';
      if (res.notices.length === 0) {
        addNoticeEditorItem();
      } else {
        res.notices.forEach((n, idx) => {
          const visible = (n && n.visible !== false) ? true : (n && n.display !== false);
          const id = n && (n.id != null ? n.id : (n.noticeId != null ? n.noticeId : idx));
          addNoticeEditorItem(n.title, n.content, visible !== false, id);
        });
      }
      toast('縺顔衍繧峨○繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆');
    } else if (res && res.error) {
      toast('繧ｨ繝ｩ繝ｼ: ' + res.error, false);
    }
  } catch (e) {
    console.error('Load notices error:', e);
    toast('縺顔衍繧峨○縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨・, false);
  }
});
btnSaveNotices.addEventListener('click', async () => {
  const office = selectedOfficeId(); if (!office) return;
  const items = noticesEditor.querySelectorAll('.notice-edit-item');
  const notices = [];
  items.forEach((item, idx) => {
    const title = (item.querySelector('.notice-edit-title').value || '').trim();
    const content = (item.querySelector('.notice-edit-content').value || '').trim();
    const displayToggle = item.querySelector('.notice-display-toggle');
    const visible = displayToggle ? displayToggle.checked : true;
    if (title || content) {
      const id = item.dataset.noticeId || `notice_${Date.now()}_${idx}`;
      notices.push({ id, title, content, visible, display: visible });
    }
  });

  console.log('Saving notices:', notices, 'for office:', office);
  const success = await saveNotices(notices, office);
  if (success) toast('縺顔衍繧峨○繧剃ｿ晏ｭ倥＠縺ｾ縺励◆');
  else toast('縺顔衍繧峨○縺ｮ菫晏ｭ倥↓螟ｱ謨・, false);
});

function addNoticeEditorItem(title = '', content = '', visible = true, id = null) {
  const item = document.createElement('div');
  item.className = 'notice-edit-item' + (visible ? '' : ' hidden-notice');
  item.draggable = true;
  if (id != null) item.dataset.noticeId = String(id);
  item.innerHTML = `
    <span class="notice-edit-handle">站ｮ站ｮ</span>
    <div class="notice-edit-row">
      <input type="text" class="notice-edit-title" placeholder="繧ｿ繧､繝医Ν" value="${escapeHtml(title)}">
      <div class="notice-edit-controls">
        <label class="notice-visibility-toggle"><input type="checkbox" class="notice-display-toggle" ${visible ? 'checked' : ''}> 陦ｨ遉ｺ縺吶ｋ</label>
        <button class="btn-move-up" title="荳翫↓遘ｻ蜍・>笆ｲ</button>
        <button class="btn-move-down" title="荳九↓遘ｻ蜍・>笆ｼ</button>
        <button class="btn-remove-notice">蜑企勁</button>
      </div>
    </div>
    <textarea class="notice-edit-content" placeholder="蜀・ｮｹ・育怐逡･蜿ｯ・・#10;URL繧定ｨ倩ｼ峨☆繧九→閾ｪ蜍慕噪縺ｫ繝ｪ繝ｳ繧ｯ縺ｫ縺ｪ繧翫∪縺・>${escapeHtml(content)}</textarea>
  `;

  // 蜑企勁繝懊ち繝ｳ
  item.querySelector('.btn-remove-notice').addEventListener('click', () => {
    if (confirm('縺薙・縺顔衍繧峨○繧貞炎髯､縺励∪縺吶°・・)) {
      item.remove();
      updateMoveButtons();
    }
  });

  const displayToggle = item.querySelector('.notice-display-toggle');
  if (displayToggle) {
    displayToggle.addEventListener('change', () => {
      if (displayToggle.checked) {
        item.classList.remove('hidden-notice');
      } else {
        item.classList.add('hidden-notice');
      }
    });
  }

  // 荳翫↓遘ｻ蜍輔・繧ｿ繝ｳ
  item.querySelector('.btn-move-up').addEventListener('click', () => {
    const prev = item.previousElementSibling;
    if (prev) {
      noticesEditor.insertBefore(item, prev);
      updateMoveButtons();
    }
  });

  // 荳九↓遘ｻ蜍輔・繧ｿ繝ｳ
  item.querySelector('.btn-move-down').addEventListener('click', () => {
    const next = item.nextElementSibling;
    if (next) {
      noticesEditor.insertBefore(next, item);
      updateMoveButtons();
    }
  });

  // 繝峨Λ繝・げ&繝峨Ο繝・・繧､繝吶Φ繝・
  item.addEventListener('dragstart', (e) => {
    item.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  item.addEventListener('dragend', () => {
    item.classList.remove('dragging');
    document.querySelectorAll('.notice-edit-item').forEach(i => i.classList.remove('drag-over'));
  });

  item.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const dragging = noticesEditor.querySelector('.dragging');
    if (dragging && dragging !== item) {
      const rect = item.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      if (e.clientY < midpoint) {
        noticesEditor.insertBefore(dragging, item);
      } else {
        noticesEditor.insertBefore(dragging, item.nextSibling);
      }
    }
  });

  noticesEditor.appendChild(item);
  updateMoveButtons();
}

// 荳贋ｸ狗ｧｻ蜍輔・繧ｿ繝ｳ縺ｮ譛牙柑/辟｡蜉ｹ繧呈峩譁ｰ
function updateMoveButtons() {
  const items = noticesEditor.querySelectorAll('.notice-edit-item');
  items.forEach((item, index) => {
    const upBtn = item.querySelector('.btn-move-up');
    const downBtn = item.querySelector('.btn-move-down');
    if (upBtn) upBtn.disabled = (index === 0);
    if (downBtn) downBtn.disabled = (index === items.length - 1);
  });
}

/* 繝・・繝ｫ邂｡逅・I */
if (btnAddTool) { btnAddTool.addEventListener('click', () => addToolEditorItem()); }
if (btnLoadTools) { btnLoadTools.addEventListener('click', () => loadAdminTools(true)); }
if (btnSaveTools) {
  btnSaveTools.addEventListener('click', async () => {
    const office = selectedOfficeId(); if (!office) return;
    const items = toolsEditor.querySelectorAll('.tool-edit-item');
    const tools = [];
    items.forEach((item, idx) => {
      const title = (item.querySelector('.tool-edit-title').value || '').trim();
      const url = (item.querySelector('.tool-edit-url').value || '').trim();
      const note = (item.querySelector('.tool-edit-note').value || '').trim();
      const toggle = item.querySelector('.tool-display-toggle');
      const visible = toggle ? toggle.checked : true;
      if (!title && !url && !note) return;
      let childrenRaw = [];
      try {
        const stored = item.dataset.children || '[]';
        childrenRaw = JSON.parse(stored);
      } catch { }
      const normalizedChildren = Array.isArray(childrenRaw) ? normalizeTools(childrenRaw) : [];
      const id = item.dataset.toolId || `tool_${Date.now()}_${idx}`;
      tools.push({ id, title, url, note, visible, display: visible, children: normalizedChildren });
    });

    const success = await saveTools(tools, office);
    if (success) {
      adminToolsLoaded = true; adminToolsOfficeId = office;
      toast('繝・・繝ｫ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆');
    } else {
      toast('繝・・繝ｫ縺ｮ菫晏ｭ倥↓螟ｱ謨・, false);
    }
  });
}

async function loadAdminTools(force = false) {
  const office = selectedOfficeId(); if (!office) return;
  if (!force && adminToolsLoaded && adminToolsOfficeId === office) return;
  try {
    const result = await fetchTools(office);
    const normalized = Array.isArray(result?.list) ? result.list : (Array.isArray(result) ? result : []);
    buildToolsEditor(normalized);
    if (!normalized.length) {
      addToolEditorItem();
    }
    adminToolsLoaded = true; adminToolsOfficeId = office;
    if (force) { toast('繝・・繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆'); }
  } catch (err) {
    console.error('loadAdminTools error', err);
    toast('繝・・繝ｫ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨・, false);
  }
}

function buildToolsEditor(list) {
  if (!toolsEditor) return;
  toolsEditor.innerHTML = '';
  const normalized = normalizeTools(list || []);
  if (!normalized.length) {
    addToolEditorItem();
    return;
  }
  normalized.forEach((tool, idx) => {
    const visible = coerceToolVisibleFlag(tool?.visible ?? tool?.display ?? true);
    addToolEditorItem(tool?.title || '', tool?.url || '', tool?.note || '', visible, tool?.children || [], tool?.id ?? idx);
  });
}

function addToolEditorItem(title = '', url = '', note = '', visible = true, children = null, id = null) {
  const item = document.createElement('div');
  item.className = 'tool-edit-item' + (visible ? '' : ' hidden-tool');
  item.draggable = true;
  if (id != null) item.dataset.toolId = String(id);
  if (children != null) {
    try { item.dataset.children = JSON.stringify(children); } catch { }
  }
  item.innerHTML = `
    <span class="tool-edit-handle">站ｮ站ｮ</span>
    <div class="tool-edit-row">
      <input type="text" class="tool-edit-title" placeholder="繧ｿ繧､繝医Ν" value="${escapeHtml(title)}">
      <input type="url" class="tool-edit-url" placeholder="URL" value="${escapeHtml(url)}">
      <div class="tool-edit-controls">
        <label class="tool-visibility-toggle"><input type="checkbox" class="tool-display-toggle" ${visible ? 'checked' : ''}> 陦ｨ遉ｺ縺吶ｋ</label>
        <button class="btn-move-up" title="荳翫↓遘ｻ蜍・>笆ｲ</button>
        <button class="btn-move-down" title="荳九↓遘ｻ蜍・>笆ｼ</button>
        <button class="btn-remove-tool">蜑企勁</button>
      </div>
    </div>
    <textarea class="tool-edit-note" placeholder="蛯呵・ｼ育怐逡･蜿ｯ・・>${escapeHtml(note)}</textarea>
  `;

  item.querySelector('.btn-remove-tool').addEventListener('click', () => {
    if (confirm('縺薙・繝・・繝ｫ繧貞炎髯､縺励∪縺吶°・・)) {
      item.remove();
      updateToolMoveButtons();
    }
  });

  const displayToggle = item.querySelector('.tool-display-toggle');
  if (displayToggle) {
    displayToggle.addEventListener('change', () => {
      if (displayToggle.checked) {
        item.classList.remove('hidden-tool');
      } else {
        item.classList.add('hidden-tool');
      }
    });
  }

  item.querySelector('.btn-move-up').addEventListener('click', () => {
    const prev = item.previousElementSibling;
    if (prev) {
      toolsEditor.insertBefore(item, prev);
      updateToolMoveButtons();
    }
  });

  item.querySelector('.btn-move-down').addEventListener('click', () => {
    const next = item.nextElementSibling;
    if (next) {
      toolsEditor.insertBefore(next, item);
      updateToolMoveButtons();
    }
  });

  item.addEventListener('dragstart', (e) => {
    item.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  item.addEventListener('dragend', () => {
    item.classList.remove('dragging');
    document.querySelectorAll('.tool-edit-item').forEach(i => i.classList.remove('drag-over'));
  });

  item.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const dragging = toolsEditor.querySelector('.dragging');
    if (dragging && dragging !== item) {
      const rect = item.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      if (e.clientY < midpoint) {
        toolsEditor.insertBefore(dragging, item);
      } else {
        toolsEditor.insertBefore(dragging, item.nextSibling);
      }
    }
  });

  toolsEditor.appendChild(item);
  updateToolMoveButtons();
}

function updateToolMoveButtons() {
  const items = toolsEditor.querySelectorAll('.tool-edit-item');
  items.forEach((item, index) => {
    const upBtn = item.querySelector('.btn-move-up');
    const downBtn = item.querySelector('.btn-move-down');
    if (upBtn) upBtn.disabled = (index === 0);
    if (downBtn) downBtn.disabled = (index === items.length - 1);
  });
}

/* 繧､繝吶Φ繝育ｮ｡逅・I */
if (btnVacationSave) { btnVacationSave.addEventListener('click', handleVacationSave); }
if (btnVacationDelete) { btnVacationDelete.addEventListener('click', handleVacationDelete); }
if (btnVacationReload) { btnVacationReload.addEventListener('click', () => loadVacationsList(true)); }
if (btnVacationClear) { btnVacationClear.addEventListener('click', resetVacationForm); }
if (btnCreateNoticeFromEvent) { btnCreateNoticeFromEvent.addEventListener('click', handleCreateNoticeFromEvent); }

function refreshVacationOfficeOptions() {
  if (!vacationOfficeSelect) return;
  const prev = vacationOfficeSelect.value || '';
  vacationOfficeSelect.textContent = '';

  const adminOptions = (adminOfficeSel && adminOfficeSel.options && adminOfficeSel.options.length) ? Array.from(adminOfficeSel.options) : [];
  const usableOptions = adminOptions.filter(o => o.value);
  if (usableOptions.length) {
    usableOptions.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.textContent || opt.value;
      vacationOfficeSelect.appendChild(o);
    });
  } else if (CURRENT_OFFICE_ID) {
    const o = document.createElement('option');
    o.value = CURRENT_OFFICE_ID; o.textContent = CURRENT_OFFICE_NAME || CURRENT_OFFICE_ID;
    vacationOfficeSelect.appendChild(o);
  } else {
    const o = document.createElement('option');
    o.value = ''; o.textContent = '蟇ｾ雎｡諡轤ｹ繧帝∈謚槭＠縺ｦ縺上□縺輔＞'; o.disabled = true; o.selected = true;
    vacationOfficeSelect.appendChild(o);
  }

  if (prev && vacationOfficeSelect.querySelector(`option[value="${prev}"]`)) {
    vacationOfficeSelect.value = prev;
  } else if (vacationOfficeSelect.options.length) {
    vacationOfficeSelect.selectedIndex = 0;
  }
}

function getVacationTargetOffice() {
  const office = (vacationOfficeSelect && vacationOfficeSelect.value) || selectedOfficeId();
  if (!office) { toast('蟇ｾ雎｡諡轤ｹ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', false); }
  return office;
}

function getNoticesForLookup() {
  return Array.isArray(window.CURRENT_NOTICES) ? window.CURRENT_NOTICES : [];
}

function getNoticesForSelection() {
  return getNoticesForLookup().filter(n => n && n.visible !== false && n.display !== false);
}

function refreshVacationNoticeOptions(selectedId) {
  if (!vacationNoticeSelect) return;
  const notices = getNoticesForSelection();
  const prev = selectedId !== undefined ? String(selectedId || '') : (vacationNoticeSelect.value || '');
  vacationNoticeSelect.textContent = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = '縺顔衍繧峨○繧帝∈謚・;
  vacationNoticeSelect.appendChild(placeholder);

  notices.forEach((notice, idx) => {
    const id = String(notice.id || notice.noticeId || notice.title || idx);
    const title = (notice.title || '(辟｡鬘・').trim();
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = title;
    opt.dataset.title = title;
    vacationNoticeSelect.appendChild(opt);
  });

  const match = Array.from(vacationNoticeSelect.options || []).find(o => o.value === prev);
  vacationNoticeSelect.value = match ? prev : '';
}

function findNoticeSelectionForItem(item) {
  if (!item) return null;
  const notices = getNoticesForLookup();
  const desiredId = item.noticeId || item.noticeKey || '';
  const desiredTitle = item.noticeTitle || '';
  const legacyNote = item.note || item.memo || '';
  const candidates = [
    notices.find(n => String(n?.id || n?.noticeId || '') === String(desiredId)),
    notices.find(n => (n?.title || '') === desiredTitle),
    notices.find(n => (n?.title || '') === legacyNote)
  ].filter(Boolean);
  const picked = candidates[0];
  if (picked) {
    return { id: String(picked.id || picked.noticeId || picked.title || notices.indexOf(picked)), title: picked.title || desiredTitle || legacyNote || '' };
  }
  if (desiredId || desiredTitle) {
    return { id: String(desiredId || desiredTitle), title: desiredTitle || legacyNote || '' };
  }
  return null;
}

function getSelectedNoticeInfo() {
  if (!vacationNoticeSelect) return null;
  const val = vacationNoticeSelect.value || '';
  if (!val) return null;
  const notices = getNoticesForLookup();
  const found = notices.find(n => String(n?.id || n?.noticeId || n?.title || '') === val);
  const title = (found?.title || vacationNoticeSelect.selectedOptions?.[0]?.textContent || '').trim();
  return { id: val, title };
}

function resetVacationForm() {
  if (vacationTitleInput) vacationTitleInput.value = '';
  if (vacationStartInput) vacationStartInput.value = '';
  if (vacationEndInput) vacationEndInput.value = '';
  if (vacationNoticeSelect) { vacationNoticeSelect.value = ''; refreshVacationNoticeOptions(); }
  cachedVacationLegacyNote = '';
  if (vacationMembersBitsInput) vacationMembersBitsInput.value = '';
  if (vacationIdInput) vacationIdInput.value = '';
  if (vacationTypeText) vacationTypeText.value = '莨第嚊蝗ｺ螳夲ｼ井ｸ隕ｧ縺ｧ蛻・崛・・;
  if (vacationColorSelect) vacationColorSelect.value = 'amber';
  if (window.VacationGantt) {
    window.VacationGantt.reset();
  }
}

function fillVacationForm(item) {
  if (!item) return;
  if (vacationTitleInput) vacationTitleInput.value = item.title || '';
  if (vacationStartInput) vacationStartInput.value = item.startDate || item.start || item.from || '';
  if (vacationEndInput) vacationEndInput.value = item.endDate || item.end || item.to || '';
  cachedVacationLegacyNote = item.note || item.memo || '';
  const noticeSel = findNoticeSelectionForItem(item);
  refreshVacationNoticeOptions(noticeSel?.id);
  if (vacationNoticeSelect) {
    vacationNoticeSelect.value = noticeSel?.id || '';
  }
  if (vacationMembersBitsInput) vacationMembersBitsInput.value = item.membersBits || item.bits || '';
  if (vacationIdInput) vacationIdInput.value = item.id || item.vacationId || '';
  if (vacationTypeText) vacationTypeText.value = getVacationTypeLabel(item.isVacation !== false);
  if (vacationColorSelect) vacationColorSelect.value = item.color || 'amber';
  if (vacationOfficeSelect && item.office) {
    refreshVacationOfficeOptions();
    if (vacationOfficeSelect.querySelector(`option[value="${item.office}"]`)) {
      vacationOfficeSelect.value = item.office;
    }
  }
  if (window.VacationGantt) {
    window.VacationGantt.loadFromString(item.membersBits || item.bits || '');
  }
}

function getVacationTypeLabel(isVacation) { return (isVacation === false) ? '莠亥ｮ壹・縺ｿ' : '莨第嚊蝗ｺ螳・; }

let cachedVacationList = [];
let cachedVacationLegacyNote = '';

function normalizeVacationList(list, officeId) {
  if (!Array.isArray(list)) return [];
  const prevList = Array.isArray(cachedVacationList) ? cachedVacationList : [];
  const targetOffice = officeId == null ? '' : String(officeId);
  const normalized = list.map((item, idx) => {
    const idStr = String(item?.id || item?.vacationId || '');
    const itemOffice = String(item?.office || targetOffice || '');
    const prev = prevList.find(v => String(v?.id || v?.vacationId || '') === idStr && String(v?.office || targetOffice || '') === itemOffice);
    const hasIsVacation = item && Object.prototype.hasOwnProperty.call(item, 'isVacation');
    const fallbackHasFlag = prev && Object.prototype.hasOwnProperty.call(prev, 'isVacation');
    const isVacation = hasIsVacation ? item.isVacation : (fallbackHasFlag ? prev.isVacation : false);
    const orderVal = Number(item?.order ?? item?.sortOrder ?? prev?.order ?? (idx + 1));
    return { ...item, office: itemOffice || (item?.office || ''), isVacation, order: Number.isFinite(orderVal) && orderVal > 0 ? orderVal : (idx + 1), _originalIndex: idx };
  });
  normalized.sort((a, b) => {
    const ao = Number(a.order || 0);
    const bo = Number(b.order || 0);
    if (ao !== bo) return ao - bo;
    return (a._originalIndex || 0) - (b._originalIndex || 0);
  });
  normalized.forEach((item, idx) => { if (!item.order) item.order = idx + 1; delete item._originalIndex; });
  return normalized;
}

function renderVacationRows(list, officeId) {
  if (!vacationListBody) return;
  const normalizedList = normalizeVacationList(list, officeId);
  cachedVacationList = normalizedList;
  vacationListBody.textContent = '';
  if (!Array.isArray(normalizedList) || normalizedList.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 9; td.style.textAlign = 'center'; td.textContent = '繧､繝吶Φ繝医・縺ゅｊ縺ｾ縺帙ｓ';
    tr.appendChild(td); vacationListBody.appendChild(tr); return;
  }

  normalizedList.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const idStr = String(item.id || item.vacationId || '');
    tr.dataset.vacationId = idStr;
    tr.dataset.order = String(item.order || idx + 1);
    const dragTd = document.createElement('td');
    dragTd.className = 'vacation-drag-cell';
    const dragBtn = document.createElement('button');
    dragBtn.type = 'button';
    dragBtn.className = 'vacation-drag-handle';
    dragBtn.draggable = true;
    dragBtn.title = '繝峨Λ繝・げ縺励※荳ｦ縺ｳ譖ｿ縺・;
    dragBtn.innerHTML = '<span aria-hidden="true">笘ｰ</span>';
    dragTd.appendChild(dragBtn);
    const titleTd = document.createElement('td'); titleTd.textContent = item.title || '';
    const start = item.startDate || item.start || item.from || '';
    const end = item.endDate || item.end || item.to || '';
    const periodTd = document.createElement('td'); periodTd.textContent = start || end ? `${start || ''}縲・{end || ''}` : '-';
    const officeTd = document.createElement('td'); officeTd.textContent = item.office || '';
    const typeTd = document.createElement('td');
    const typeToggle = document.createElement('input');
    typeToggle.type = 'checkbox';
    typeToggle.checked = item.isVacation === true;
    const typeLabel = document.createElement('span');
    typeLabel.className = 'vacation-type-label';
    typeLabel.textContent = getVacationTypeLabel(typeToggle.checked);
    typeToggle.addEventListener('change', async () => {
      typeToggle.disabled = true;
      const success = await updateVacationFlags(item, { isVacation: typeToggle.checked });
      if (!success) {
        typeToggle.checked = !typeToggle.checked;
      } else {
        typeLabel.textContent = getVacationTypeLabel(typeToggle.checked);
      }
      typeToggle.disabled = false;
    });
    typeTd.append(typeToggle, typeLabel);
    const colorTd = document.createElement('td');
    const colorBadge = document.createElement('span');
    colorBadge.className = `event-color-dot ${getEventColorClass(item.color)}`.trim();
    colorBadge.title = EVENT_COLOR_LABELS[item.color] || '';
    colorTd.appendChild(colorBadge);
    const noteTd = document.createElement('td');
    const noticeSel = findNoticeSelectionForItem(item);
    if (noticeSel && noticeSel.title) {
      const link = document.createElement('a');
      link.href = '#noticesArea';
      link.textContent = noticeSel.title;
      link.addEventListener('click', (e) => {
        e.preventDefault();
        if (typeof toggleNoticesArea === 'function') { toggleNoticesArea(); }
        const noticesArea = document.getElementById('noticesArea');
        if (noticesArea) {
          noticesArea.style.display = 'block';
          noticesArea.classList.remove('collapsed');
          noticesArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
      noteTd.appendChild(link);
    } else if (item.note || item.memo) {
      noteTd.textContent = item.note || item.memo || '';
    } else {
      noteTd.textContent = '-';
    }
    const visibleTd = document.createElement('td');
    const visibleToggle = document.createElement('input');
    visibleToggle.type = 'checkbox';
    visibleToggle.checked = item.visible === true;
    visibleToggle.addEventListener('change', async () => {
      visibleToggle.disabled = true;
      const success = await updateVacationFlags(item, { visible: visibleToggle.checked });
      if (!success) {
        visibleToggle.checked = !visibleToggle.checked;
      }
      visibleToggle.disabled = false;
    });
    visibleTd.appendChild(visibleToggle);
    const actionTd = document.createElement('td');
    const editBtn = document.createElement('button'); editBtn.textContent = '邱ｨ髮・; editBtn.className = 'btn-secondary';
    editBtn.addEventListener('click', () => fillVacationForm(item));
    actionTd.appendChild(editBtn);
    tr.append(dragTd, titleTd, periodTd, officeTd, typeTd, colorTd, noteTd, visibleTd, actionTd);
    vacationListBody.appendChild(tr);
  });
  initVacationSort();
}

function getVacationOrderMapFromDom() {
  const map = new Map();
  if (!vacationListBody) return map;
  let idx = 1;
  vacationListBody.querySelectorAll('tr[data-vacation-id]').forEach(tr => {
    const idStr = tr.dataset.vacationId || '';
    if (!idStr) return;
    map.set(idStr, idx++);
  });
  return map;
}

function hasVacationOrderChanged(orderMap) {
  if (!orderMap || orderMap.size === 0) return false;
  const list = Array.isArray(cachedVacationList) ? cachedVacationList : [];
  return list.some((item, idx) => {
    const idStr = String(item.id || item.vacationId || '');
    if (!idStr) return false;
    const current = orderMap.get(idStr);
    const fallbackOrder = Number(item.order || 0) || (idx + 1);
    return current != null && current !== fallbackOrder;
  });
}

function composeVacationPayloadFromItem(item, overrides = {}) {
  const office = item.office || getVacationTargetOffice();
  if (!office) return null;
  const orderMap = getVacationOrderMapFromDom();
  const idStr = String(item.id || item.vacationId || '');
  const payload = {
    office,
    title: item.title || '',
    start: item.startDate || item.start || item.from || '',
    end: item.endDate || item.end || item.to || '',
    note: item.note || item.memo || item.noticeTitle || '',
    noticeId: item.noticeId || item.noticeKey || '',
    noticeTitle: item.noticeTitle || '',
    membersBits: item.membersBits || item.bits || '',
    visible: overrides.visible !== undefined ? overrides.visible : (item.visible === true),
    isVacation: overrides.isVacation !== undefined ? overrides.isVacation : (item.isVacation !== false),
    color: overrides.color || item.color || 'amber'
  };
  if (idStr) payload.id = idStr;
  const newOrder = (overrides.order !== undefined) ? overrides.order : orderMap.get(idStr);
  if (newOrder != null) {
    payload.order = newOrder;
  } else {
    const maxOrder = Math.max(0, ...Array.from(orderMap.values()));
    payload.order = maxOrder + 1;
  }
  return payload;
}

async function persistVacationOrders(orderMap) {
  const office = getVacationTargetOffice();
  if (!office || !orderMap || orderMap.size === 0) return;
  if (!hasVacationOrderChanged(orderMap)) return;
  const list = Array.isArray(cachedVacationList) ? cachedVacationList : [];
  const payloads = list.map(item => {
    const idStr = String(item.id || item.vacationId || '');
    if (!idStr) return null;
    const orderVal = orderMap.get(idStr);
    if (orderVal == null) return null;
    return composeVacationPayloadFromItem(item, { order: orderVal });
  }).filter(Boolean);
  if (!payloads.length) return;
  try {
    await Promise.all(payloads.map(p => adminSetVacation(office, p)));
    toast('荳ｦ縺ｳ鬆・ｒ菫晏ｭ倥＠縺ｾ縺励◆');
    await loadVacationsList(false, office);
    await loadEvents(office, false);
  } catch (err) {
    console.error('persistVacationOrders error', err);
    toast('荳ｦ縺ｳ鬆・・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
  }
}

let vacationSortInitialized = false;
let vacationDragRow = null;
function initVacationSort() {
  if (!vacationListBody) return;
  if (vacationSortInitialized) return;
  vacationSortInitialized = true;
  vacationListBody.addEventListener('dragstart', e => {
    const handle = e.target.closest('.vacation-drag-handle');
    if (!handle) { e.preventDefault(); return; }
    const row = handle.closest('tr');
    if (!row) return;
    vacationDragRow = row;
    row.classList.add('vacation-dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', row.dataset.vacationId || '');
  });
  vacationListBody.addEventListener('dragover', e => {
    if (!vacationDragRow) return;
    e.preventDefault();
    const targetRow = e.target.closest('tr[data-vacation-id]');
    if (!targetRow || targetRow === vacationDragRow) return;
    const rect = targetRow.getBoundingClientRect();
    const offset = e.clientY - rect.top;
    const shouldInsertBefore = offset < rect.height / 2;
    vacationListBody.insertBefore(vacationDragRow, shouldInsertBefore ? targetRow : targetRow.nextSibling);
  });
  vacationListBody.addEventListener('dragend', () => {
    if (!vacationDragRow) return;
    vacationDragRow.classList.remove('vacation-dragging');
    vacationDragRow = null;
    const orderMap = getVacationOrderMapFromDom();
    persistVacationOrders(orderMap);
  });
}

async function updateVacationFlags(item, overrides = {}) {
  const office = item.office || getVacationTargetOffice(); if (!office) return false;
  const visible = (overrides.visible !== undefined) ? overrides.visible : (item.visible === true);
  const isVacation = (overrides.isVacation !== undefined) ? overrides.isVacation : (item.isVacation === true);
  const payload = composeVacationPayloadFromItem(item, { visible, isVacation });
  if (!payload) return false;
  try {
    const res = await adminSetVacation(office, payload);
    if (res && res.ok !== false) {
      if (res.vacation) {
        item.visible = res.vacation.visible === true;
        item.isVacation = res.vacation.isVacation === true;
        item.color = res.vacation.color || item.color;
      } else {
        item.visible = visible;
        item.isVacation = isVacation;
      }
      toast('繧､繝吶Φ繝郁ｨｭ螳壹ｒ譖ｴ譁ｰ縺励∪縺励◆');
      if (Array.isArray(res.vacations)) {
        renderVacationRows(res.vacations, office);
      } else {
        await loadVacationsList(false, office);
      }
      if (office) { await loadEvents(office, false); }
      return true;
    }
    throw new Error(res && res.error ? String(res.error) : 'update_failed');
  } catch (err) {
    console.error('updateVacationFlags error', err);
    toast('繧､繝吶Φ繝郁ｨｭ螳壹・譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆', false);
    return false;
  }
}

async function loadVacationsList(showToastOnSuccess = false, officeOverride) {
  const office = officeOverride || getVacationTargetOffice(); if (!office) return;
  if (vacationListBody) {
    vacationListBody.textContent = '';
    const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = 9; td.style.textAlign = 'center'; td.textContent = '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...'; tr.appendChild(td); vacationListBody.appendChild(tr);
  }
  try {
    const res = await adminGetVacation(office);
    const list = Array.isArray(res?.vacations) ? res.vacations : (Array.isArray(res?.items) ? res.items : []);
    renderVacationRows(list, office);
    if (showToastOnSuccess) toast('繧､繝吶Φ繝医ｒ隱ｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆');
  } catch (err) {
    console.error('loadVacationsList error', err);
    if (vacationListBody) {
      vacationListBody.textContent = '';
      const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = 9; td.style.textAlign = 'center'; td.textContent = '隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆'; tr.appendChild(td); vacationListBody.appendChild(tr);
    }
    toast('繧､繝吶Φ繝医・蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆', false);
  } finally {
    resetVacationForm();
  }
}

function buildVacationPayload() {
  const office = getVacationTargetOffice(); if (!office) return { error: 'office_missing' };
  const title = (vacationTitleInput?.value || '').trim();
  const start = (vacationStartInput?.value || '').trim();
  const end = (vacationEndInput?.value || '').trim();
  if (window.VacationGantt) {
    window.VacationGantt.syncInput();
  }
  const membersBits = (vacationMembersBitsInput?.value || '').trim();
  const id = (vacationIdInput?.value || '').trim();
  const color = (vacationColorSelect?.value || 'amber');

  const payload = { office, title, start, end, membersBits, color };

  const orderMap = getVacationOrderMapFromDom();
  if (id && orderMap.has(id)) {
    payload.order = orderMap.get(id);
  } else if (orderMap.size > 0) {
    const maxOrder = Math.max(0, ...Array.from(orderMap.values()));
    payload.order = maxOrder + 1;
  } else {
    payload.order = 1;
  }

  const noticeSel = getSelectedNoticeInfo();
  if (noticeSel) {
    payload.noticeId = noticeSel.id;
    payload.noticeTitle = noticeSel.title;
    if (noticeSel.title) payload.note = noticeSel.title;
  } else if (cachedVacationLegacyNote) {
    payload.note = cachedVacationLegacyNote;
  }
  if (id) payload.id = id;

  const errors = [];
  if (!title) errors.push('missing_title');
  if (start && end && start > end) errors.push('invalid_range');

  return { payload, errors };
}

async function persistVacationPayload(payload, { resetFormOnSuccess = true, showToast = true } = {}) {
  if (!payload || !payload.office) return false;
  try {
    const res = await adminSetVacation(payload.office, payload);
    if (res && res.ok !== false) {
      if (res.id && vacationIdInput) { vacationIdInput.value = res.id; }
      if (res.vacation) {
        if (vacationTypeText) vacationTypeText.value = getVacationTypeLabel(res.vacation.isVacation !== false);
        if (vacationColorSelect && res.vacation.color) { vacationColorSelect.value = res.vacation.color; }
      }
      if (showToast) toast('繧､繝吶Φ繝医ｒ菫晏ｭ倥＠縺ｾ縺励◆');
      if (Array.isArray(res.vacations)) {
        renderVacationRows(res.vacations, payload.office);
      } else {
        await loadVacationsList(false, payload.office);
      }
      await loadEvents(payload.office, false);
      if (resetFormOnSuccess) {
        resetVacationForm();
      }
      return true;
    }
    throw new Error(res && res.error ? String(res.error) : 'save_failed');
  } catch (err) {
    console.error('handleVacationSave error', err);
    if (showToast) toast('繧､繝吶Φ繝医・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', false);
    return false;
  }
}

async function handleCreateNoticeFromEvent() {
  const office = getVacationTargetOffice(); if (!office) return;
  const titleInput = prompt('繧､繝吶Φ繝医→邏蝉ｻ倥￠繧九♀遏･繧峨○縺ｮ繧ｿ繧､繝医Ν繧貞・蜉帙＠縺ｦ縺上□縺輔＞・亥ｿ・茨ｼ・, '');
  if (titleInput === null) return;
  const title = (titleInput || '').trim();
  if (!title) { toast('繧ｿ繧､繝医Ν繧貞・蜉帙＠縺ｦ縺上□縺輔＞', false); return; }
  const contentInput = prompt('縺顔衍繧峨○縺ｮ譛ｬ譁・ｼ井ｻｻ諢擾ｼ・, '');
  const newNotice = {
    id: `notice_${Date.now()}`,
    title,
    content: (contentInput || '').trim(),
    visible: true,
    display: true
  };
  const currentList = Array.isArray(window.CURRENT_NOTICES) ? window.CURRENT_NOTICES.slice() : [];
  const nextNotices = [newNotice, ...currentList];
  const success = await saveNotices(nextNotices, office);
  if (success) {
    refreshVacationNoticeOptions(newNotice.id);
    if (vacationNoticeSelect) { vacationNoticeSelect.value = newNotice.id; }
    toast('縺顔衍繧峨○繧定ｿｽ蜉縺励∪縺励◆');
  } else {
    toast('縺顔衍繧峨○縺ｮ霑ｽ蜉縺ｫ螟ｱ謨励＠縺ｾ縺励◆', false);
  }
}

async function handleVacationSave() {
  const { payload, errors } = buildVacationPayload();
  if (!payload || errors?.includes('missing_title')) { toast('繧ｿ繧､繝医Ν繧貞・蜉帙＠縺ｦ縺上□縺輔＞', false); return; }
  if (errors?.includes('invalid_range')) { toast('髢句ｧ区律縺ｨ邨ゆｺ・律縺ｮ謖・ｮ壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞', false); return; }
  await persistVacationPayload(payload, { resetFormOnSuccess: true, showToast: true });
}

async function handleVacationAutoSave() {
  const { payload, errors } = buildVacationPayload();
  if (!payload || (errors && errors.length)) { return false; }
  return await persistVacationPayload(payload, { resetFormOnSuccess: false, showToast: false });
}

async function handleVacationDelete() {
  const office = getVacationTargetOffice(); if (!office) return;
  const id = (vacationIdInput?.value || '').trim();
  if (!id) { toast('蜑企勁縺吶ｋ鬆・岼縺ｮID繧帝∈謚槭＠縺ｦ縺上□縺輔＞', false); return; }
  if (!confirm('驕ｸ謚樔ｸｭ縺ｮ繧､繝吶Φ繝医ｒ蜑企勁縺励∪縺吶°・・)) return;
  try {
    const res = await adminDeleteVacation(office, id);
    if (res && res.ok !== false) {
      toast('蜑企勁縺励∪縺励◆');
      resetVacationForm();
      await loadVacationsList();
    } else {
      throw new Error(res && res.error ? String(res.error) : 'delete_failed');
    }
  } catch (err) {
    console.error('handleVacationDelete error', err);
    toast('繧､繝吶Φ繝医・蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆', false);
  }
}

/* Admin API */
function selectedOfficeId() {
  const office = adminSelectedOfficeId || CURRENT_OFFICE_ID || '';
  if (!office) { toast('謫堺ｽ懷ｯｾ雎｡諡轤ｹ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', false); }
  return office;
}
async function adminGetFor(office) { return await apiPost({ action: 'getFor', token: SESSION_TOKEN, office, nocache: '1' }); }
async function adminGetConfigFor(office) { return await apiPost({ action: 'getConfigFor', token: SESSION_TOKEN, office, nocache: '1' }); }
async function adminSetConfigFor(office, cfgObj) { const q = { action: 'setConfigFor', token: SESSION_TOKEN, office, data: JSON.stringify(cfgObj) }; return await apiPost(q); }
async function adminSetForChunked(office, dataObjFull) {
  const entries = Object.entries(dataObjFull || {});
  if (entries.length === 0) {
    const base = { action: 'setFor', office, token: SESSION_TOKEN, data: JSON.stringify({ updated: Date.now(), data: {}, full: true }) };
    return await apiPost(base);
  }
  const chunkSize = 30; let first = true, ok = true;
  for (let i = 0; i < entries.length; i += chunkSize) {
    const chunk = Object.fromEntries(entries.slice(i, i + chunkSize));
    const obj = { updated: Date.now(), data: chunk, full: first };
    const q = { action: 'setFor', office, token: SESSION_TOKEN, data: JSON.stringify(obj) };
    const r = await apiPost(q);
    if (!(r && r.ok)) ok = false; first = false;
  }
  return ok ? { ok: true } : { error: 'chunk_failed' };
}
async function adminRenameOffice(office, name) { return await apiPost({ action: 'renameOffice', office, name, token: SESSION_TOKEN }); }
async function adminSetOfficePassword(office, pw, apw) { const q = { action: 'setOfficePassword', id: office, token: SESSION_TOKEN }; if (pw) q.password = pw; if (apw) q.adminPassword = apw; return await apiPost(q); }
async function adminGetVacation(office) { return await apiPost({ action: 'getVacation', token: SESSION_TOKEN, office, nocache: '1' }); }
async function adminSetVacation(office, payload) { const q = { action: 'setVacation', token: SESSION_TOKEN, office, data: JSON.stringify(payload) }; return await apiPost(q); }
async function saveVacationBits(office, payload) { const q = { action: 'setVacationBits', token: SESSION_TOKEN, office, data: JSON.stringify(payload) }; return await apiPost(q); }
async function adminDeleteVacation(office, id) { return await apiPost({ action: 'deleteVacation', token: SESSION_TOKEN, office, id }); }

/* CSV繝代・繧ｵ */
function parseCSV(text) {
  const out = []; let i = 0, row = [], field = '', inq = false;
  function pushField() { row.push(field); field = ''; }
  function pushRow() { out.push(row); row = []; }
  while (i < text.length) {
    const c = text[i++];
    if (inq) {
      if (c == '"' && text[i] == '"') { field += '"'; i++; }
      else if (c == '"') { inq = false; }
      else field += c;
    } else {
      if (c === ',') { pushField(); }
      else if (c == '"') { inq = true; }
      else if (c == '\n') { pushField(); pushRow(); }
      else if (c == '\r') { }
      else field += c;
    }
  }
  const endsWithComma = text.length > 0 && text[text.length - 1] === ',';
  if (field !== '' || endsWithComma) pushField();
  if (row.length) pushRow();
  return out;
}

/* CSV・亥・騾夲ｼ・*/
function csvProtectFormula(s) { if (s == null) return ''; const v = String(s); return (/^[=\+\-@\t]/.test(v)) ? "'" + v : v; }
function toCsvRow(arr) { return arr.map(v => { const s = csvProtectFormula(v); return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s; }).join(','); }
function makeNormalizedCSV(cfg, data) {
  const rows = [];
  rows.push(toCsvRow(['蝨ｨ蟶ｭ邂｡逅・SV']));
  rows.push(toCsvRow(['繧ｰ繝ｫ繝ｼ繝礼分蜿ｷ', '繧ｰ繝ｫ繝ｼ繝怜錐', '陦ｨ遉ｺ鬆・, 'id', '豌丞錐', '蜀・ｷ・, '謳ｺ蟶ｯ逡ｪ蜿ｷ', 'Email', '讌ｭ蜍呎凾髢・, '繧ｹ繝・・繧ｿ繧ｹ', '謌ｻ繧頑凾髢・, '蛯呵・]));
  (cfg.groups || []).forEach((g, gi) => {
    (g.members || []).forEach((m, mi) => {
      const id = m.id || ''; const rec = (data && data[id]) || {};
      const workHours = rec.workHours || m.workHours || '';
      rows.push(toCsvRow([gi + 1, g.title || '', mi + 1, id, m.name || '', m.ext || '', m.mobile || rec.mobile || '', m.email || rec.email || '', workHours, rec.status || (STATUSES[0]?.value || '蝨ｨ蟶ｭ'), rec.time || '', rec.note || '']));
    });
  });
  return rows.join('\n');
}

/* 邂｡逅・Δ繝ｼ繝繝ｫ繧帝幕縺・◆縺ｨ縺阪↓縺顔衍繧峨○繧定・蜍戊ｪｭ縺ｿ霎ｼ縺ｿ */
async function autoLoadNoticesOnAdminOpen() {
  const office = adminSelectedOfficeId || CURRENT_OFFICE_ID;
  if (!office) return;
  try {
    const params = { action: 'getNotices', token: SESSION_TOKEN, nocache: '1', office };
    const res = await apiPost(params);
    if (res && res.notices) {
      noticesEditor.innerHTML = '';
      if (res.notices.length === 0) {
        addNoticeEditorItem();
      } else {
        res.notices.forEach((n, idx) => {
          const visible = (n && n.visible !== false) ? true : (n && n.display !== false);
          const id = n && (n.id != null ? n.id : (n.noticeId != null ? n.noticeId : idx));
          addNoticeEditorItem(n.title, n.content, visible !== false, id);
        });
      }
    }
  } catch (e) {
    console.error('Auto-load notices error:', e);
  }
}

/* 繧､繝吶Φ繝医お繧ｯ繧ｹ繝昴・繝域ｩ溯・ */
const btnExportEvent = document.getElementById('btnExportEvent');
if (btnExportEvent) {
  btnExportEvent.addEventListener('click', async () => {
    const office = adminSelectedOfficeId || CURRENT_OFFICE_ID;
    if (!office) { toast('諡轤ｹ縺碁∈謚槭＆繧後※縺・∪縺帙ｓ', false); return; }

    try {
      // 險ｭ螳壹→繧､繝吶Φ繝井ｸ隕ｧ繧貞叙蠕・
      const cfg = await adminGetConfigFor(office);
      const eventsRes = await apiPost({ action: 'getVacation', token: SESSION_TOKEN, office, nocache: '1' });

      if (!cfg || !cfg.groups) { toast('險ｭ螳壹・蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆', false); return; }
      if (!eventsRes || !eventsRes.vacations) { toast('繧､繝吶Φ繝医・蜿門ｾ励↓螟ｱ謨励＠縺ｾ縺励◆', false); return; }

      const events = eventsRes.vacations;
      if (!events.length) { toast('繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧九う繝吶Φ繝医′縺ゅｊ縺ｾ縺帙ｓ'); return; }

      // CSV繝倥ャ繝繝ｼ
      const rows = [];
      rows.push(toCsvRow(['繧､繝吶Φ繝・D', '繧ｿ繧､繝医Ν', '髢句ｧ区律', '邨ゆｺ・律', '繧ｰ繝ｫ繝ｼ繝・, '豌丞錐', '繝薙ャ繝育憾諷・]));

      // 蜷・う繝吶Φ繝医↓縺､縺・※蜃ｦ逅・
      events.forEach(event => {
        const eventId = event.id || event.vacationId || '';
        const title = event.title || '';
        const startDate = event.startDate || event.start || event.from || '';
        const endDate = event.endDate || event.end || event.to || '';
        const membersBits = event.membersBits || event.bits || '';

        // 繝｡繝ｳ繝舌・繝ｪ繧ｹ繝医ｒ讒狗ｯ・
        const members = [];
        (cfg.groups || []).forEach(g => {
          (g.members || []).forEach(m => {
            members.push({ group: g.title || '', name: m.name || '' });
          });
        });

        // 繝薙ャ繝域枚蟄怜・繧定ｧ｣譫・
        const bitChars = membersBits.split('');
        members.forEach((member, idx) => {
          const bitValue = bitChars[idx] === '1' ? '笳・ : '';
          rows.push(toCsvRow([eventId, title, startDate, endDate, member.group, member.name, bitValue]));
        });
      });

      const csv = rows.join('\\n');
      const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const bytes = new TextEncoder().encode(csv);
      const blob = new Blob([BOM, bytes], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      a.href = url;
      a.download = `events_${office}_${timestamp}.csv`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
      toast('繧､繝吶Φ繝医ｒ繧ｨ繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺励◆');
    } catch (e) {
      console.error('Event export error:', e);
      toast('繧ｨ繧ｯ繧ｹ繝昴・繝医↓螟ｱ謨励＠縺ｾ縺励◆', false);
    }
  });
}


/* --- app_network.js --- */
/**
 * App Network & Sync
 * Refactored from sync.js
 */

App.Network = {
    // Config
    remotePullTimer: null,
    configWatchTimer: null,
    fallbackTimer: null,
    tokenRenewTimer: null,
    unsubscribeSnapshot: null,
    useSdkMode: false,
    rowTimers: new Map(),

    // Setup Menus (Logic moved here for cohesion)
    defaultMenus() {
        return {
            timeStepMinutes: 30,
            statuses: [
                { value: "蝨ｨ蟶ｭ", class: "st-here", clearOnSet: true },
                { value: "螟門・", requireTime: true, class: "st-out" },
                { value: "蝨ｨ螳・共蜍・, class: "st-remote", clearOnSet: true },
                { value: "蜃ｺ蠑ｵ", requireTime: true, class: "st-trip" },
                { value: "遐比ｿｮ", requireTime: true, class: "st-training" },
                { value: "蛛･蠎ｷ險ｺ譁ｭ", requireTime: true, class: "st-health" },
                { value: "繧ｳ繧｢繝峨ャ繧ｯ", requireTime: true, class: "st-coadoc" },
                { value: "蟶ｰ螳・, class: "st-home" },
                { value: "莨代∩", class: "st-off", clearOnSet: true }
            ],
            noteOptions: ["逶ｴ蜃ｺ", "逶ｴ蟶ｰ", "逶ｴ蜃ｺ繝ｻ逶ｴ蟶ｰ"],
            businessHours: [
                "07:00-15:30", "07:30-16:00", "08:00-16:30", "08:30-17:00", "09:00-17:30",
                "09:30-18:00", "10:00-18:30", "10:30-19:00", "11:00-19:30", "11:30-20:00", "12:00-20:30"
            ]
        };
    },

    setupMenus(m) {
        const base = this.defaultMenus();
        const MENUS = (m && typeof m === 'object') ? Object.assign({}, base, m) : base;
        App.State.MENUS = MENUS;

        // Normalization
        if (!Array.isArray(MENUS.businessHours)) MENUS.businessHours = base.businessHours;

        // Status setup
        const sts = Array.isArray(MENUS.statuses) ? MENUS.statuses : base.statuses;
        App.State.STATUSES = sts.map(s => ({ value: String(s.value) }));
        App.State.requiresTimeSet = new Set(sts.filter(s => s.requireTime).map(s => String(s.value)));
        App.State.clearOnSet = new Set(sts.filter(s => s.clearOnSet).map(s => String(s.value)));
        App.State.statusClassMap = new Map(sts.map(s => [String(s.value), String(s.class || "")]));

        // Update Datalists
        this.updateDatalists();
    },

    updateDatalists() {
        // Re-implement datalist population
        let dl = document.getElementById('noteOptions');
        if (!dl) { dl = document.createElement('datalist'); dl.id = 'noteOptions'; document.body.appendChild(dl); }
        dl.replaceChildren();
        const optBlank = document.createElement('option'); optBlank.value = ""; optBlank.label = "・育ｩｺ逋ｽ・・;
        dl.appendChild(optBlank);
        (App.State.MENUS.noteOptions || []).forEach(t => {
            const opt = document.createElement('option'); opt.value = String(t); dl.appendChild(opt);
        });

        // WorkHours (legacy support)
        let workDl = document.getElementById('workHourOptions');
        if (!workDl) { workDl = document.createElement('datalist'); workDl.id = 'workHourOptions'; document.body.appendChild(workDl); }
        workDl.replaceChildren();
        const wBlank = document.createElement('option'); wBlank.value = ""; wBlank.label = "・育ｩｺ逋ｽ・・;
        workDl.appendChild(wBlank);
        (App.State.MENUS.businessHours || []).forEach(h => {
            const opt = document.createElement('option'); opt.value = String(h); workDl.appendChild(opt);
        });
    },

    // API Post
    async apiPost(payload) {
        try {
            const res = await fetch(App.Config.REMOTE_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error("API Error:", e);
            return { error: 'network', details: e.message };
        }
    },

    // Plan B: Legacy Polling
    async startLegacyPolling(immediate) {
        console.log("Fallback to Workers Polling (Plan B)");
        this.useSdkMode = false;
        if (this.remotePullTimer) { clearInterval(this.remotePullTimer); this.remotePullTimer = null; }

        // Ensure config watch is running in Plan B
        this.startConfigWatch(true);

        const pollAction = async () => {
            const r = await this.apiPost({ action: 'get', token: App.State.SESSION_TOKEN });
            if (r?.error === 'unauthorized') {
                // App.Auth.logout(); 
                return;
            }
            if (r && r.data) App.Logic.applyState(r.data);
        };

        if (immediate) pollAction().catch(() => { });
        this.remotePullTimer = setInterval(pollAction, App.Config.REMOTE_POLL_MS);
    },

    // Plan A: Remote Sync with Firebase
    startRemoteSync(immediate) {
        if (this.remotePullTimer) { clearInterval(this.remotePullTimer); this.remotePullTimer = null; }
        if (this.unsubscribeSnapshot) { this.unsubscribeSnapshot(); this.unsubscribeSnapshot = null; }
        if (this.fallbackTimer) { clearTimeout(this.fallbackTimer); this.fallbackTimer = null; }

        if (!App.State.CURRENT_OFFICE_ID) {
            console.error("No Office ID");
            return;
        }

        if (!App.initFirebase()) {
            this.startLegacyPolling(immediate);
            return;
        }

        // Fallback Timer
        this.fallbackTimer = setTimeout(() => {
            if (!this.useSdkMode) {
                console.warn("Plan A Timeout. Switching to Plan B.");
                this.startLegacyPolling(immediate);
            }
        }, 5000);

        firebase.auth().signInAnonymously().then(() => {
            const db = firebase.firestore();
            const docRef = db.collection('offices').doc(App.State.CURRENT_OFFICE_ID).collection('members');

            this.unsubscribeSnapshot = docRef.onSnapshot((snapshot) => {
                if (this.fallbackTimer) { clearTimeout(this.fallbackTimer); this.fallbackTimer = null; }

                if (!this.useSdkMode) {
                    console.log("Plan A Connected.");
                    this.useSdkMode = true;
                    // Stop config poll if SDk connected
                    if (this.configWatchTimer) { clearInterval(this.configWatchTimer); this.configWatchTimer = null; }
                }

                let needsConfigRefetch = false;
                const changes = {};
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'removed') needsConfigRefetch = true;
                    changes[change.doc.id] = change.doc.data();
                });

                if (needsConfigRefetch) this.fetchConfigOnce();
                if (Object.keys(changes).length > 0) App.Logic.applyState(changes);

            }, (error) => {
                console.error("Plan A Error:", error);
                if (this.fallbackTimer) { clearTimeout(this.fallbackTimer); this.fallbackTimer = null; }
                if (!this.useSdkMode) this.startLegacyPolling(immediate);
            });
        }).catch(e => {
            console.error("Auth Error:", e);
            this.startLegacyPolling(immediate);
        });
    },

    async fetchConfigOnce() {
        const cfg = await this.apiPost({ action: 'getConfig', token: App.State.SESSION_TOKEN, nocache: '1' });
        if (cfg && !cfg.error) {
            const updated = cfg.updated || 0;
            const groups = cfg.groups || cfg.config?.groups || [];
            const menus = cfg.menus || cfg.config?.menus || null;

            const shouldUpdate = (updated && updated !== App.State.CONFIG_UPDATED) || (!updated && App.State.CONFIG_UPDATED === 0);
            if (shouldUpdate) {
                App.State.GROUPS = this.normalizeConfigClient(groups);
                App.State.CONFIG_UPDATED = updated || Date.now();
                this.setupMenus(menus);
                App.UI.render();
            }
        }
    },

    startConfigWatch(immediate = true) {
        if (this.configWatchTimer) { clearInterval(this.configWatchTimer); this.configWatchTimer = null; }
        if (immediate) this.fetchConfigOnce().catch(console.error);
        this.configWatchTimer = setInterval(() => this.fetchConfigOnce(), App.Config.CONFIG_POLL_MS);
    },

    normalizeConfigClient(groups) {
        return (groups || []).map(g => ({
            title: g.title || "",
            members: (g.members || []).map(m => ({
                id: String(m.id ?? "").trim(),
                name: String(m.name ?? ""),
                ext: m.ext || "",
                mobile: m.mobile || "",
                email: m.email || "",
                workHours: m.workHours || ""
            })).filter(m => m.id || m.name)
        }));
    },

    debounceRowPush(key) {
        if (App.State.PENDING_ROWS.has(key)) {
            // Already pending, just reset timer?
            // Actually board.js logic was: set PENDING, clear old timer, set new timer.
            // We can follow that.
        }
        App.State.PENDING_ROWS.add(key);

        if (this.rowTimers.has(key)) clearTimeout(this.rowTimers.get(key));

        // Add dataset.editing to inputs (visual feedback/locking prevention)
        const tr = document.getElementById(`row-${key}`);
        if (tr) tr.querySelectorAll('input,select').forEach(e => e.dataset.editing = "true");

        const timerId = setTimeout(() => {
            this.rowTimers.delete(key);
            this.pushRowDelta(key);
        }, 1500); // 1.5s debounce

        this.rowTimers.set(key, timerId);
    },

    async pushRowDelta(key) {
        const tr = document.getElementById(`row-${key}`);
        if (!tr) return;
        const st = App.Logic.getRowStateByTr(tr);
        if (!st) return;

        st.workHours = st.workHours == null ? '' : String(st.workHours);
        const baseRev = { [key]: Number(tr.dataset.rev || 0) };
        const payload = { updated: Date.now(), data: { [key]: st } };

        try {
            const r = await this.apiPost({
                action: 'set',
                token: App.State.SESSION_TOKEN,
                data: JSON.stringify(payload),
                baseRev: JSON.stringify(baseRev)
            });

            if (!r) {
                App.UI.showToast('騾壻ｿ｡繧ｨ繝ｩ繝ｼ', true);
                return;
            }

            if (r.error === 'conflict') {
                const c = (r.conflicts && r.conflicts.find(x => x.id === key)) || null;
                if (c && c.server) {
                    App.Logic.applyState({ [key]: c.server });
                    App.UI.showToast('遶ｶ蜷医＠縺ｾ縺励◆・亥・隱ｭ霎ｼ・・, true);
                } else {
                    // Just update revision if conflict but no content change?
                    const rev = Number((r.rev && r.rev[key]) || 0);
                    if (rev) tr.dataset.rev = String(rev);
                }
                return;
            }

            if (!r.error) {
                const rev = Number((r.rev && r.rev[key]) || 0);
                if (rev) tr.dataset.rev = String(rev);
                return;
            }

            App.UI.showToast('菫晏ｭ伜､ｱ謨・, true);
        } finally {
            App.State.PENDING_ROWS.delete(key);
            if (tr) {
                tr.querySelectorAll('[data-editing]').forEach(e => delete e.dataset.editing);
            }
        }
    }
};


/* --- app_auth.js --- */
/**
 * App Auth
 * Refactored from auth.js
 */
App.Auth = {
    async checkLogin() {
        return new Promise((resolve) => {
            if (typeof App.initFirebase === 'function') {
                App.initFirebase();
            }
            if (typeof firebase === 'undefined' || !(firebase.apps && firebase.apps.length)) {
                console.error("Firebase SDK not loaded");
                resolve(false);
                return;
            }

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    const storedOffice = localStorage.getItem('presence_office');
                    const storedRole = localStorage.getItem('presence_role');

                    if (storedOffice && storedRole) {
                        App.State.SESSION_TOKEN = 'firebase_session';
                        App.State.CURRENT_OFFICE_ID = storedOffice;
                        App.State.CURRENT_ROLE = storedRole;
                        this.updateAuthUI();

                        // Start Services
                        if (App.Network.startRemoteSync) App.Network.startRemoteSync(true);
                        if (App.Network.startConfigWatch) App.Network.startConfigWatch();
                        if (App.Notices && App.Notices.startPolling) App.Notices.startPolling();
                        if (App.Tools && App.Tools.startPolling) App.Tools.startPolling(storedOffice);

                        resolve(true);
                    } else {
                        this.logout();
                        resolve(false);
                    }
                } else {
                    App.State.SESSION_TOKEN = '';
                    App.State.CURRENT_OFFICE_ID = '';
                    App.State.CURRENT_ROLE = '';
                    this.updateAuthUI();
                    resolve(false);
                }
            });
        });
    },

    async login(officeInput, passwordInput) {
        try {
            if (typeof App.initFirebase === 'function') {
                App.initFirebase();
            }
            if (typeof firebase === 'undefined' || !(firebase.apps && firebase.apps.length)) {
                throw new Error("Firebase縺ｮ蛻晄悄蛹悶↓螟ｱ謨励＠縺ｾ縺励◆縲・);
            }

            // Worker Auth
            const formData = new URLSearchParams();
            formData.append('action', 'login');
            formData.append('office', officeInput);
            formData.append('password', passwordInput);

            const resp = await fetch(App.Config.REMOTE_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            const result = await resp.json();

            if (!result.ok) {
                throw new Error("隱崎ｨｼ縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲・);
            }

            localStorage.setItem('presence_office', result.office);
            localStorage.setItem('presence_role', result.role);
            localStorage.setItem('presence_office_name', result.officeName || result.office);

            await firebase.auth().signInAnonymously();

            App.State.SESSION_TOKEN = 'firebase_session';
            App.State.CURRENT_OFFICE_ID = result.office;
            App.State.CURRENT_ROLE = result.role;

            App.UI.showToast(`繝ｭ繧ｰ繧､繝ｳ縺励∪縺励◆: ${result.officeName}`);
            this.updateAuthUI();

            return true;

        } catch (error) {
            console.error("Login error:", error);
            App.UI.showToast(error.message, true);
            return false;
        }
    },

    async logout() {
        try {
            if (typeof firebase !== 'undefined') {
                await firebase.auth().signOut();
            }
            localStorage.removeItem('presence_office');
            localStorage.removeItem('presence_role');
            App.UI.showToast("繝ｭ繧ｰ繧ｪ繝輔＠縺ｾ縺励◆");
            setTimeout(() => location.reload(), 500);
        } catch (e) {
            console.error(e);
        }
    },

    updateAuthUI() {
        const loginEl = document.getElementById('login-screen'); // Ensure ID exists in HTML
        const board = App.UI.DOM.board;

        if (App.State.SESSION_TOKEN) {
            if (loginEl) loginEl.style.display = 'none';
            if (board) board.style.display = 'block';
            this.ensureAuthUI();
        } else {
            if (loginEl) loginEl.style.display = 'flex';
            if (board) board.style.display = 'none';
            this.ensureAuthUI();
        }
    },

    ensureAuthUI() {
        const loggedIn = !!App.State.SESSION_TOKEN;
        const isAdmin = loggedIn && (App.State.CURRENT_ROLE === 'admin' || App.State.CURRENT_ROLE === 'superAdmin');

        const setDisp = (id, show) => {
            const el = document.getElementById(id);
            if (el) el.style.display = show ? 'inline-block' : 'none';
        }

        setDisp('noticesBtn', false); // Managed by Notices module
        setDisp('adminBtn', isAdmin);
        setDisp('logoutBtn', loggedIn);
        setDisp('toolsBtn', loggedIn);
        setDisp('manualBtn', loggedIn);

        // Filters
        setDisp('nameFilter', loggedIn);
        setDisp('statusFilter', loggedIn);
    }
};


/* --- app_notices.js --- */
/**
 * App Notices
 * Refactored from notices.js
 */
App.Notices = {
    pollingTimer: null,
    unsubscribe: null,
    collapsedKey: 'noticeAreaCollapsed',
    collapsePreference: false,

    init() {
        this.collapsePreference = this.loadCollapsePreference();
        const noticesHeader = document.querySelector('#noticesArea .notices-header');
        if (noticesHeader) {
            // Remove old listeners by cloning
            const newHeader = noticesHeader.cloneNode(true);
            noticesHeader.parentNode.replaceChild(newHeader, noticesHeader);
            newHeader.addEventListener('click', () => this.toggleNoticesArea());
        }
    },

    loadCollapsePreference() {
        try {
            const officeKey = `${this.collapsedKey}_${App.State.CURRENT_OFFICE_ID || 'default'}`;
            const raw = localStorage.getItem(officeKey);
            return raw === 'true';
        } catch { return false; }
    },

    saveCollapsePreference(collapsed) {
        this.collapsePreference = !!collapsed;
        try {
            const officeKey = `${this.collapsedKey}_${App.State.CURRENT_OFFICE_ID || 'default'}`;
            localStorage.setItem(officeKey, this.collapsePreference ? 'true' : 'false');
        } catch { }
    },

    toggleNoticesArea() {
        const noticesArea = document.getElementById('noticesArea');
        if (!noticesArea) return;
        const isCollapsed = noticesArea.classList.toggle('collapsed');
        this.saveCollapsePreference(isCollapsed);
    },

    startPolling() {
        if (this.unsubscribe) return;

        const db = (typeof firebase !== 'undefined' && firebase.apps.length) ? firebase.firestore() : null;
        if (db && App.State.CURRENT_OFFICE_ID) {
            console.log('Notices: start listener');
            const colRef = db.collection('offices').doc(App.State.CURRENT_OFFICE_ID).collection('notices');
            this.unsubscribe = colRef.onSnapshot((snapshot) => {
                const list = [];
                snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                this.applyNotices(list);
            }, (e) => {
                console.warn('Notices listener failed:', e);
                this.startLegacyPolling();
            });
        } else {
            this.startLegacyPolling();
        }
    },

    startLegacyPolling() {
        if (this.pollingTimer) return;
        this.fetchNotices();
        this.pollingTimer = setInterval(() => {
            if (App.State.SESSION_TOKEN) this.fetchNotices();
            else this.stopPolling();
        }, 30000);
    },

    stopPolling() {
        if (this.pollingTimer) { clearInterval(this.pollingTimer); this.pollingTimer = null; }
        if (this.unsubscribe) { this.unsubscribe(); this.unsubscribe = null; }
    },

    async fetchNotices() {
        if (!App.State.SESSION_TOKEN) return;
        const res = await App.Network.apiPost({
            action: 'getNotices',
            token: App.State.SESSION_TOKEN,
            office: App.State.CURRENT_OFFICE_ID,
            nocache: '1'
        });
        if (res && res.notices) {
            this.applyNotices(res.notices);
        }
    },

    applyNotices(raw) {
        // Normalization logic simplified for brevity but essential parts kept
        // Assume raw is array of objects or strings
        const list = (Array.isArray(raw) ? raw : []).map(n => {
            if (typeof n === 'string') return { title: n, content: '', visible: true };
            return n;
        }).filter(n => {
            const v = n.visible ?? n.display ?? true;
            return v !== false && String(v) !== 'false';
        });

        App.State.CURRENT_NOTICES = list;
        this.renderNotices(list);
    },

    renderNotices(list) {
        const area = document.getElementById('noticesArea');
        const container = document.getElementById('noticesList');
        const btn = document.getElementById('noticesBtn');
        const summary = document.getElementById('noticesSummary');

        if (!area || !container) return;

        if (!list || list.length === 0) {
            container.innerHTML = '';
            area.style.display = 'none';
            if (btn) btn.style.display = 'none';
            return;
        }

        container.innerHTML = '';
        list.forEach(n => {
            const div = el('div', { class: 'notice-item' });
            const title = n.title || '';
            const body = n.content || '';
            // ... rendering logic ...
            div.innerHTML = `<div class="notice-header"><span class="notice-toggle">筐､</span><span class="notice-title">${sanitizeText(title)}</span></div>`;
            if (body) {
                div.innerHTML += `<div class="notice-content">${sanitizeText(body)}</div>`; // Should linkify
                div.querySelector('.notice-header').addEventListener('click', () => div.classList.toggle('expanded'));
            } else {
                div.classList.add('title-only');
            }
            container.appendChild(div);
        });

        if (summary) {
            summary.textContent = list.length > 0 ? `${list[0].title} (莉・{list.length - 1}莉ｶ)` : '';
        }

        area.style.display = 'block';
        if (btn) btn.style.display = 'inline-block';

        if (this.collapsePreference) area.classList.add('collapsed');
        else area.classList.remove('collapsed');
    }
};


/* --- app_tools.js --- */
/**
 * App Tools
 * Refactored from tools.js
 */
App.Tools = {
    pollingTimer: null,
    unsubscribe: null,
    pollOfficeId: '',

    startPolling(officeId) {
        const target = officeId || App.State.CURRENT_OFFICE_ID;
        if (!target) return;
        if (this.unsubscribe) return;

        const db = (typeof firebase !== 'undefined' && firebase.apps.length) ? firebase.firestore() : null;
        if (db) {
            console.log('Tools: start listener');
            const docRef = db.collection('offices').doc(target).collection('tools').doc('config');
            this.unsubscribe = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    this.applyToolsData(data.tools || [], []);
                } else {
                    this.applyToolsData([], []);
                }
            }, (e) => {
                this.startLegacyPolling(target);
            });
        } else {
            this.startLegacyPolling(target);
        }
    },

    startLegacyPolling(officeId) {
        if (this.pollingTimer) return;
        this.pollOfficeId = officeId;
        this.fetchTools();
        this.pollingTimer = setInterval(() => this.fetchTools(), 60000);
    },

    stopPolling() {
        if (this.pollingTimer) { clearInterval(this.pollingTimer); this.pollingTimer = null; }
        if (this.unsubscribe) { this.unsubscribe(); this.unsubscribe = null; }
    },

    async fetchTools() {
        if (!App.State.SESSION_TOKEN) return;
        const res = await App.Network.apiPost({
            action: 'getTools',
            token: App.State.SESSION_TOKEN,
            office: this.pollOfficeId,
            nocache: '1'
        });
        if (res && res.tools) {
            this.applyToolsData(res.tools, res.warnings);
        }
    },

    applyToolsData(raw, warnings) {
        // Simplification for brevity: Assume normalization
        // In real port, we should copy the normalization logic
        const list = App.Tools.normalize(raw); // Placeholder for normalization
        this.renderToolsList(list);
    },

    normalize(raw) {
        // Simple passthrough for now, relying on existing structure or simplified one
        if (Array.isArray(raw)) return raw;
        if (raw && Array.isArray(raw.list)) return raw.list;
        return [];
    },

    renderToolsList(list) {
        const container = document.getElementById('toolsList');
        if (!container) return;
        container.innerHTML = '';
        if (!list || !list.length) {
            container.textContent = '繝・・繝ｫ諠・ｱ縺ｪ縺・;
            return;
        }
        // Recursive render
        const render = (items, parent) => {
            items.forEach(item => {
                const div = el('div', { class: 'tools-item' });
                const link = item.url ? `<a href="${item.url}" target="_blank">${sanitizeText(item.title)}</a>` : sanitizeText(item.title);
                div.innerHTML = `<div class="tools-item-title">${link}</div>`;
                if (item.note) div.innerHTML += `<div class="tools-item-note">${sanitizeText(item.note)}</div>`;
                parent.appendChild(div);
                if (item.children) {
                    const childContainer = el('div', { style: 'padding-left:12px' });
                    render(item.children, childContainer);
                    parent.appendChild(childContainer);
                }
            });
        };
        render(list, container);
    }
};


/* --- app_logic.js --- */
/**
 * App Logic & UI
 * Refactored from board.js, globals.js using App namespace and Event Delegation.
 */

// Shortcuts
const el = (tag, attrs = {}, children = []) => {
    const element = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'text') element.textContent = v;
        else if (k === 'class') element.className = v;
        else element.setAttribute(k, v);
    });
    children.forEach(c => {
        if (typeof c === 'string') element.appendChild(document.createTextNode(c));
        else if (c instanceof Node) element.appendChild(c);
    });
    return element;
};

const sanitizeText = (str) => {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
};

// UI Helpers attached to App.UI
App.UI.DOM = {
    board: null,
    toast: null,
    menuEl: null,
    menuList: null,
    titleBtn: null,
    contactOverlay: null,

    init() {
        this.board = document.getElementById('board');
        this.toast = document.getElementById('toast');
        this.menuEl = document.getElementById('menu');
        this.menuList = document.getElementById('menuList');
        this.titleBtn = document.querySelector('.title-btn');
        if (this.titleBtn) {
            this.titleBtn.addEventListener('click', (e) => { e.stopPropagation(); App.UI.toggleMenu(); });
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                App.UI.closeMenu();
                App.Logic.closeContactPopup();
                App.Logic.hideAllCandidatePanels();
            }
        });
        document.addEventListener('click', (e) => {
            if (this.menuEl && this.menuEl.classList.contains('show')) {
                const within = this.menuEl.contains(e.target) || this.titleBtn.contains(e.target);
                if (!within) App.UI.closeMenu();
            }
        });
    },

    showToast(msg, isError = false) {
        if (!this.toast) return;
        this.toast.innerHTML = '';
        const panel = el('div', { class: 'toast-panel' }, [msg]);
        this.toast.className = `toast ${isError ? 'toast--error' : 'toast--success'} show`;
        this.toast.appendChild(panel);
        setTimeout(() => {
            this.toast.classList.remove('show');
        }, 3000);
    }
};

App.Logic = {
    // Time Options
    buildTimeOptions(stepMin) {
        const startMin = 7 * 60;
        const endMin = 22 * 60;
        const frag = document.createDocumentFragment();
        frag.appendChild(el('option', { value: "", text: "" }));
        const step = Math.max(5, Math.min(60, Number(stepMin || 30)));
        for (let m = startMin; m <= endMin; m += step) {
            const h = Math.floor(m / 60), mm = m % 60;
            const t = `${String(h).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
            frag.appendChild(el('option', { value: t, text: t }));
        }
        return frag;
    },

    // Candidate Panels
    renderCandidatePanel(panel, type) {
        if (!panel) return;
        const options = type === 'workHours'
            ? (App.State.MENUS?.businessHours || [])
            : (App.State.MENUS?.noteOptions || []);

        panel.replaceChildren();
        const ul = el('ul', { class: 'candidate-list' });
        const vals = [''].concat(Array.isArray(options) ? options.map(v => String(v ?? '')) : []);

        vals.forEach(v => {
            const label = v === '' ? '・育ｩｺ逋ｽ・・ : v;
            const btn = el('button', {
                type: 'button',
                class: 'candidate-option',
                'data-value': v,
                text: label
            });
            ul.appendChild(el('li', {}, [btn]));
        });
        panel.appendChild(ul);
    },

    toggleCandidatePanel(wrapper) {
        if (!wrapper) return;
        const panel = wrapper.querySelector('.candidate-panel');
        const btn = wrapper.querySelector('.candidate-btn');
        const type = wrapper.dataset.type;
        if (!panel || !type) return;

        const isOpen = panel.classList.contains('show');
        this.hideAllCandidatePanels();
        if (isOpen) {
            panel.classList.remove('show');
            if (btn) btn.setAttribute('aria-expanded', 'false');
            return;
        }
        this.renderCandidatePanel(panel, type);
        panel.classList.add('show');
        if (btn) btn.setAttribute('aria-expanded', 'true');
    },

    hideAllCandidatePanels() {
        const board = App.UI.DOM.board;
        if (!board) return;
        board.querySelectorAll('.candidate-panel.show').forEach(p => {
            p.classList.remove('show');
            const btn = p.closest('.candidate-input')?.querySelector('.candidate-btn');
            if (btn) btn.setAttribute('aria-expanded', 'false');
        });
    },

    buildCandidateField({ id, name, placeholder, type, value }) {
        const wrapper = el('div', { class: 'candidate-input', 'data-type': type });
        const input = el('input', {
            id, name, type: 'text', placeholder, autocomplete: 'off', inputmode: 'text'
        });
        if (value != null) input.value = value;

        let btn = null;
        if (type !== 'note' && type !== 'workHours') {
            btn = el('button', {
                type: 'button', class: 'candidate-btn', 'aria-haspopup': 'listbox', 'aria-expanded': 'false', 'aria-label': '蛟呵｣懊ｒ陦ｨ遉ｺ'
            });
            btn.innerHTML = '笆ｼ';
        }

        const panel = el('div', { class: 'candidate-panel', role: 'listbox' });
        wrapper.appendChild(input);
        if (btn) wrapper.appendChild(btn);
        wrapper.appendChild(panel);

        // click on input for note/workHours also toggles
        if (type === 'note' || type === 'workHours') {
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!panel.classList.contains('show')) {
                    this.hideAllCandidatePanels();
                    this.renderCandidatePanel(panel, type);
                    panel.classList.add('show');
                }
            });
        }

        return { wrapper, input };
    },

    // Row Logic
    getRowStateByTr(tr) {
        if (!tr) return null;
        const key = tr.dataset.key;
        const workHoursInput = tr.querySelector('input[name="workHours"]');
        return {
            id: key,
            ext: tr.querySelector('td.ext')?.textContent.trim() || "",
            workHours: workHoursInput ? workHoursInput.value : "",
            status: tr.querySelector('select[name="status"]').value,
            time: tr.querySelector('select[name="time"]').value,
            note: tr.querySelector('input[name="note"]').value
        };
    },

    buildRow(member) {
        const name = member.name || "";
        const ext = (member.ext && /^[0-9]{1,6}$/.test(String(member.ext))) ? String(member.ext) : "";
        const key = member.id;
        const tr = el('tr', { id: `row-${key}` });
        tr.dataset.key = key;
        tr.dataset.rev = '0';
        tr.dataset.mobile = member.mobile ? String(member.mobile) : '';
        tr.dataset.email = member.email ? String(member.email) : '';

        const tdName = el('td', { class: 'name', 'data-label': '豌丞錐' });
        tdName.textContent = name;

        // Attach long press
        this.attachContactLongPress(tdName, tr, member);

        const tdExt = el('td', { class: 'ext', 'data-label': '蜀・ｷ・ }, [ext]);

        const workPlaceholder = '09:00-17:30';
        const workInit = member.workHours == null ? '' : String(member.workHours);
        const tdWork = el('td', { class: 'work', 'data-label': '讌ｭ蜍呎凾髢・ });
        const workField = this.buildCandidateField({ id: `work-${key}`, name: 'workHours', placeholder: workPlaceholder, type: 'workHours', value: workInit });
        tdWork.appendChild(el('label', { class: 'sr-only', for: `work-${key}`, text: '讌ｭ蜍呎凾髢・ }));
        tdWork.appendChild(workField.wrapper);

        const tdStatus = el('td', { class: 'status', 'data-label': '繧ｹ繝・・繧ｿ繧ｹ' });
        const selStatus = el('select', { id: `status-${key}`, name: 'status' });
        tdStatus.appendChild(el('label', { class: 'sr-only', for: `status-${key}`, text: '繧ｹ繝・・繧ｿ繧ｹ' }));
        App.State.STATUSES.forEach(s => selStatus.appendChild(el('option', { value: s.value, text: s.value })));
        tdStatus.appendChild(selStatus);

        const tdTime = el('td', { class: 'time', 'data-label': '謌ｻ繧頑凾髢・ });
        const selTime = el('select', { id: `time-${key}`, name: 'time' });
        tdTime.appendChild(el('label', { class: 'sr-only', for: `time-${key}`, text: '謌ｻ繧頑凾髢・ }));
        selTime.appendChild(this.buildTimeOptions(App.State.MENUS?.timeStepMinutes));
        tdTime.appendChild(selTime);

        const tdNote = el('td', { class: 'note', 'data-label': '蛯呵・ });
        const noteField = this.buildCandidateField({ id: `note-${key}`, name: 'note', placeholder: '蛯呵・, type: 'note' });
        tdNote.appendChild(noteField.wrapper);

        tr.append(tdName, tdExt, tdWork, tdStatus, tdTime, tdNote);
        return tr;
    },

    buildPanel(group, idx) {
        const gid = `grp-${idx}`;
        const sec = el('section', { class: 'panel', id: gid });
        sec.dataset.groupIndex = String(idx);

        const title = group.title || `繧ｰ繝ｫ繝ｼ繝・{idx + 1}`;
        sec.appendChild(el('h3', { class: 'title', text: title }));

        const table = el('table', { 'aria-label': `蝨ｨ蟶ｭ陦ｨ・・{title}・荏 });
        table.appendChild(el('colgroup', {}, [
            el('col', { class: 'col-name' }), el('col', { class: 'col-ext' }), el('col', { class: 'col-work' }),
            el('col', { class: 'col-status' }), el('col', { class: 'col-time' }), el('col', { class: 'col-note' })
        ]));

        const thead = el('thead');
        const thr = el('tr');
        ['豌丞錐', '蜀・ｷ・, '讌ｭ蜍呎凾髢・, '繧ｹ繝・・繧ｿ繧ｹ', '謌ｻ繧頑凾髢・, '蛯呵・].forEach(h => thr.appendChild(el('th', { text: h })));
        thead.appendChild(thr);
        table.appendChild(thead);

        const tbody = el('tbody');
        (group.members || []).forEach(m => {
            const r = this.buildRow(m);
            tbody.appendChild(r);
        });
        table.appendChild(tbody);
        sec.appendChild(table);
        return sec;
    },

    ensureRowControls(tr) {
        if (!tr) return;
        const key = tr.dataset.key;
        // Self-healing: status
        let s = tr.querySelector('td.status select');
        if (!s) {
            const td = tr.querySelector('td.status');
            s = el('select', { id: `status-${key}`, name: 'status' });
            App.State.STATUSES.forEach(x => s.appendChild(el('option', { value: x.value, text: x.value })));
            td && td.appendChild(s);
        }
        // Self-healing: time
        let t = tr.querySelector('td.time select');
        if (!t) {
            const td = tr.querySelector('td.time');
            t = el('select', { id: `time-${key}`, name: 'time' });
            t.appendChild(this.buildTimeOptions(App.State.MENUS?.timeStepMinutes));
            td && td.appendChild(t);
        }
        // Self-healing: workHours
        let w = tr.querySelector('input[name="workHours"]');
        if (!w || !w.closest('.candidate-input')) {
            const td = tr.querySelector('td.work');
            const placeholder = '09:00-17:30';
            const field = this.buildCandidateField({ id: `work-${key}`, name: 'workHours', placeholder, type: 'workHours', value: w?.value });
            if (td) {
                if (!td.querySelector('label.sr-only')) {
                    td.insertBefore(el('label', { class: 'sr-only', for: `work-${key}`, text: '讌ｭ蜍呎凾髢・ }), td.firstChild || null);
                }
                td.querySelector('.candidate-input')?.remove();
                td.appendChild(field.wrapper);
                w = field.input;
            }
        }
        // Self-healing: note
        const noteInp = tr.querySelector('input[name="note"]');
        if (!noteInp || !noteInp.closest('.candidate-input')) {
            const td = tr.querySelector('td.note');
            const field = this.buildCandidateField({ id: `note-${key}`, name: 'note', placeholder: '蛯呵・, type: 'note', value: noteInp?.value });
            if (td) {
                td.querySelector('.candidate-input')?.remove();
                td.appendChild(field.wrapper);
            }
        }
    },

    ensureTimePrompt(tr) {
        if (!tr) return;
        const statusEl = tr.querySelector('select[name="status"]');
        const timeTd = tr.querySelector('td.time');
        const timeEl = tr.querySelector('select[name="time"]');
        if (!(statusEl && timeTd && timeEl)) return;
        const needs = App.State.requiresTimeSet.has(statusEl.value);
        const empty = !timeEl.value;
        if (needs && empty) {
            timeTd.classList.add('need-time');
            timeEl.setAttribute('aria-invalid', 'true');
            let hint = timeTd.querySelector('.time-hint');
            if (!hint) { hint = document.createElement('span'); hint.className = 'time-hint'; hint.textContent = '謌ｻ繧頑凾髢薙ｒ驕ｸ謚・; timeTd.appendChild(hint); }
        } else {
            timeTd.classList.remove('need-time');
            timeEl.removeAttribute('aria-invalid');
            const hint = timeTd.querySelector('.time-hint'); if (hint) hint.remove();
        }
    },

    // Event Wiring
    wireEvents() {
        const board = App.UI.DOM.board;
        if (!board) return;

        // Delegation
        document.addEventListener('click', (e) => {
            // Candidate Button
            const candidateBtn = e.target.closest('.candidate-btn');
            if (candidateBtn && board.contains(candidateBtn)) {
                e.preventDefault(); e.stopPropagation();
                this.toggleCandidatePanel(candidateBtn.closest('.candidate-input'));
                return;
            }
            // Candidate Option
            const candidateOpt = e.target.closest('.candidate-option');
            if (candidateOpt) {
                e.preventDefault();
                const wrapper = candidateOpt.closest('.candidate-input');
                const input = wrapper?.querySelector('input');
                if (input) {
                    input.value = candidateOpt.dataset.value ?? '';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.focus();
                }
                this.hideAllCandidatePanels();
                return;
            }

            if (!e.target.closest('.candidate-input')) this.hideAllCandidatePanels();
        });

        // Focus/Blur for editing state
        board.addEventListener('focusin', e => {
            const t = e.target;
            if (t && t.dataset) t.dataset.editing = '1';
        });
        board.addEventListener('focusout', e => {
            const t = e.target;
            if (t && t.dataset) delete t.dataset.editing;
        });

        board.addEventListener('change', (e) => {
            const t = e.target;
            if (!t) return;
            const tr = t.closest('tr');
            if (!tr) return;
            if (t.name === 'status') this.handleStatusChange(tr, t);
            else if (t.name === 'time') this.handleTimeChange(tr, t);
        });

        board.addEventListener('input', (e) => {
            const t = e.target;
            if (!t || !t.closest('tr')) return;
            const key = t.closest('tr').dataset.key;
            if (t.name === 'note' || t.name === 'workHours') {
                App.Network.debounceRowPush(key);
            }
        });
    },

    handleStatusChange(tr, statusEl) {
        const status = statusEl.value;
        const timeSel = tr.querySelector('select[name="time"]');
        const noteInp = tr.querySelector('input[name="note"]');

        // Recolor
        tr.className = '';
        const cls = App.State.statusClassMap.get(status);
        if (cls) tr.classList.add(cls);

        // Toggle Time
        this.toggleTimeEnable(statusEl, timeSel);

        // Clear on set
        if (App.State.clearOnSet.has(status)) {
            if (timeSel) timeSel.value = '';
            if (noteInp && this.isNotePresetValue(noteInp.value)) { noteInp.value = ''; }
        }

        this.ensureTimePrompt(tr);

        App.Network.debounceRowPush(tr.dataset.key);
    },

    isNotePresetValue(val) {
        const v = (val == null ? "" : String(val)).trim();
        if (v === "") return true;
        const set = new Set((App.State.MENUS?.noteOptions || []).map(x => String(x)));
        return set.has(v);
    },

    handleTimeChange(tr, timeEl) {
        this.ensureTimePrompt(tr);
        App.Network.debounceRowPush(tr.dataset.key);
    },

    toggleTimeEnable(statusEl, timeEl) {
        if (!timeEl) return;
        const needsTime = App.State.requiresTimeSet.has(statusEl.value);
        const timeTd = timeEl.closest('td.time');
        if (needsTime) {
            timeEl.setAttribute('aria-disabled', 'false');
            timeEl.tabIndex = 0;
            timeTd?.classList.remove('time-disabled');
        } else {
            timeEl.setAttribute('aria-disabled', 'true');
            timeEl.tabIndex = -1;
            timeTd?.classList.add('time-disabled');
        }
    },

    // Contact Event Logic (Long Press)
    contactHoldTimer: null,
    contactScrollBound: false,

    closeContactPopup() {
        if (App.UI.DOM.contactOverlay) {
            App.UI.DOM.contactOverlay.remove();
            App.UI.DOM.contactOverlay = null;
        }
    },

    resolveContactInfo(tr, fallback) {
        const nameText = tr?.querySelector('td.name')?.textContent || fallback?.name || '';
        const mobileVal = tr ? (tr.dataset.mobile ?? '') : '';
        const emailVal = tr ? (tr.dataset.email ?? '') : '';
        return {
            name: nameText,
            mobile: (mobileVal || fallback?.mobile || '').trim(),
            email: (emailVal || fallback?.email || '').trim()
        };
    },

    showContactPopup(member) {
        this.closeContactPopup();
        const overlay = el('div', { class: 'contact-overlay' });
        const dialogLabel = `${sanitizeText(member.name || '')}縺ｮ騾｣邨｡蜈・;
        const dialog = el('div', { class: 'contact-dialog', role: 'dialog', 'aria-modal': 'true', 'aria-label': dialogLabel });
        const closeBtn = el('button', { type: 'button', class: 'contact-close', 'aria-label': '髢峨§繧・ }, ['ﾃ・]);
        const title = el('h4', { class: 'contact-title', text: dialogLabel });

        const mobile = member.mobile ? String(member.mobile) : '';
        const email = member.email ? String(member.email) : '';

        const mobileRow = el('div', { class: 'contact-row' }, [
            el('span', { class: 'contact-label', text: '謳ｺ蟶ｯ' }),
            mobile
                ? el('a', { class: 'contact-link', href: `tel:${mobile}`, text: mobile })
                : el('span', { class: 'contact-empty', text: '譛ｪ逋ｻ骭ｲ' })
        ]);

        const emailRow = el('div', { class: 'contact-row' }, [
            el('span', { class: 'contact-label', text: '繝｡繝ｼ繝ｫ' }),
            email
                ? el('a', { class: 'contact-link', href: `mailto:${encodeURIComponent(email)}`, text: email })
                : el('span', { class: 'contact-empty', text: '譛ｪ逋ｻ骭ｲ' })
        ]);

        const body = el('div', { class: 'contact-body' }, [mobileRow, emailRow]);
        closeBtn.addEventListener('click', () => this.closeContactPopup());
        overlay.addEventListener('click', (e) => { if (e.target === overlay) this.closeContactPopup(); });

        dialog.append(closeBtn, title, body);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        App.UI.DOM.contactOverlay = overlay;
        closeBtn.focus({ preventScroll: true });
    },

    attachContactLongPress(tdName, tr, fallbackMember) {
        if (!tdName) return;
        const HOLD_DELAY_MS = 900;
        const MOVE_TOLERANCE_PX = 10;
        let startTouchPoint = null;

        const startHold = (touchPoint) => {
            if (this.contactHoldTimer) clearTimeout(this.contactHoldTimer);
            startTouchPoint = touchPoint ? { x: touchPoint.clientX, y: touchPoint.clientY } : null;
            this.contactHoldTimer = setTimeout(() => {
                this.contactHoldTimer = null;
                const payload = this.resolveContactInfo(tr, fallbackMember);
                this.showContactPopup(payload);
            }, HOLD_DELAY_MS);
        };
        const cancelHold = () => {
            startTouchPoint = null;
            if (this.contactHoldTimer) clearTimeout(this.contactHoldTimer);
            this.contactHoldTimer = null;
        };
        const handleTouchStart = (e) => {
            // e.preventDefault(); // Don't prevent default, allow scrolling? 
            // Actually board.js had preventDefault() but it might block scrolling if not careful.
            // board.js: e.preventDefault()
            const touch = e.touches?.[0];
            startHold(touch);
        };
        const handleTouchMove = (e) => {
            if (!startTouchPoint) return;
            const touch = e.touches?.[0];
            if (!touch) return cancelHold();
            const dx = Math.abs(touch.clientX - startTouchPoint.x);
            const dy = Math.abs(touch.clientY - startTouchPoint.y);
            if (dx > MOVE_TOLERANCE_PX || dy > MOVE_TOLERANCE_PX) {
                cancelHold();
            }
        };

        const handleMouseDown = (e) => { if (e.button === 0) startHold(); };

        tdName.addEventListener('touchstart', handleTouchStart, { passive: true }); // Changed to passive:true for scroll logic? 
        // Logic in board.js was: Start timer. If scrolled or moved, cancel.
        tdName.addEventListener('touchend', cancelHold, { passive: true });
        tdName.addEventListener('touchcancel', cancelHold);
        tdName.addEventListener('touchmove', handleTouchMove, { passive: true });
        tdName.addEventListener('mousedown', handleMouseDown);
        tdName.addEventListener('mouseup', cancelHold);
        tdName.addEventListener('mouseleave', cancelHold);

        if (!this.contactScrollBound) {
            window.addEventListener('scroll', () => cancelHold(), { passive: true, capture: true });
            this.contactScrollBound = true;
        }
    },

    // Public Apply State
    applyState(data) {
        if (!data) return;
        Object.entries(data).forEach(([k, v]) => {
            if (App.State.PENDING_ROWS.has(k)) return;
            const tr = document.getElementById(`row-${k}`);
            if (!tr) return; // Should ensureRowControls
            this.ensureRowControls(tr);

            const s = tr.querySelector('select[name="status"]');
            const t = tr.querySelector('select[name="time"]');
            const w = tr.querySelector('input[name="workHours"]');
            const n = tr.querySelector('input[name="note"]');
            const extTd = tr.querySelector('td.ext');

            if (extTd && v && v.ext !== undefined) {
                extTd.textContent = String(v.ext || '').replace(/[^0-9]/g, '');
            }
            if (v && v.mobile !== undefined) { tr.dataset.mobile = String(v.mobile ?? '').trim(); }
            if (v && v.email !== undefined) { tr.dataset.email = String(v.email ?? '').trim(); }

            if (v.status && App.State.STATUSES.some(x => x.value === v.status)) if (s) s.value = v.status;
            if (v.workHours != null && w) w.value = v.workHours;
            if (v.time != null && t) t.value = v.time;
            if (v.note != null && n) n.value = v.note;

            const remoteRev = Number(v.rev || 0);
            const localRev = Number(tr.dataset.rev || 0);
            if (remoteRev > localRev) {
                tr.dataset.rev = String(remoteRev);
            }

            if (s && t) this.toggleTimeEnable(s, t);
            this.ensureTimePrompt(tr);

            // Recolor
            tr.className = '';
            const cls = App.State.statusClassMap.get(s?.value);
            if (cls) tr.classList.add(cls);
        });
    }
};

App.UI.render = function () {
    const board = App.UI.DOM.board;
    if (!board) return;
    board.replaceChildren();

    (App.State.GROUPS || []).forEach((g, i) => {
        board.appendChild(App.Logic.buildPanel(g, i));
    });

    board.style.display = '';

    // Wire events
    App.Logic.wireEvents();

    // Group Menu
    App.UI.buildGroupMenu();
};

App.UI.buildGroupMenu = function () {
    if (!App.UI.DOM.menuList) return;
    App.UI.DOM.menuList.replaceChildren();

    const total = (App.State.GROUPS || []).reduce((s, g) => s + ((g.members && g.members.length) || 0), 0);
    const topBtn = el('button', { class: 'grp-item', 'data-target': 'top', text: `蜈ｨ菴難ｼ亥粋險茨ｼ・{total}蜷搾ｼ荏 });
    topBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); App.UI.closeMenu(); });
    App.UI.DOM.menuList.appendChild(el('li', {}, [topBtn]));

    (App.State.GROUPS || []).forEach((g, i) => {
        const title = g.title || `繧ｰ繝ｫ繝ｼ繝・{i + 1}`;
        const sub = (g.members?.length) ? `・・{g.members.length}蜷搾ｼ荏 : '・・蜷搾ｼ・;
        const span = el('span', { class: 'muted', text: ` ${sub}` });
        const btn = el('button', { class: 'grp-item', 'data-target': `grp-${i}` }, [title, span]);
        btn.addEventListener('click', () => {
            document.getElementById(`grp-${i}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            App.UI.closeMenu();
        });
        App.UI.DOM.menuList.appendChild(el('li', {}, [btn]));
    });
};

App.UI.toggleMenu = function () {
    if (App.UI.DOM.menuEl) {
        App.UI.DOM.menuEl.classList.toggle('show');
        const isShow = App.UI.DOM.menuEl.classList.contains('show');
        if (App.UI.DOM.titleBtn) App.UI.DOM.titleBtn.setAttribute('aria-expanded', String(isShow));
    }
};
App.UI.closeMenu = function () {
    if (App.UI.DOM.menuEl) {
        App.UI.DOM.menuEl.classList.remove('show');
        if (App.UI.DOM.titleBtn) App.UI.DOM.titleBtn.setAttribute('aria-expanded', 'false');
    }
};


/* --- bootstrap.js --- */
/**
 * Bootstrap
 * Initializes the application.
 */
document.addEventListener('DOMContentLoaded', async () => {
    console.log("Bootstrap: DOMContentLoaded");

    // Initialize UI references (if Logic needs them early)
    // App.Logic might need 'board' element which is in globals.js

    // Initialize App
    // This will setup listeners, check auth, etc.
    await App.init();

    console.log("Bootstrap: App initialized");
});


</script>
</body>

</html>
