# GAS 新規デプロイ手順（お知らせ機能対応）

## 🎯 目的
既存のデプロイを更新しても反映されない場合、新規デプロイを作成して完全にリフレッシュします。

---

## 📝 手順1: GASコードの最終確認

### 1-1. Apps Script エディタで確認
1. GASプロジェクトを開く
2. `GAS_コード.gs` を開く
3. 以下を確認：
   - **総行数:** 622行
   - **523-524行目:** `if(action === 'getNotices'){` が存在
   - **548行目:** `if(action === 'setNotices'){` が存在
   - **158-206行目:** `coerceNoticeArray_()`, `normalizeNoticeItem_()`, `normalizeNoticesArray_()` 関数が存在

### 1-2. 保存を確認
- Ctrl+S (Cmd+S) で保存
- 画面上部に「すべての変更を保存しました」と表示されることを確認

---

## 📝 手順2: 新規デプロイの作成

### 2-1. デプロイ画面を開く
1. Apps Script エディタ右上の **「デプロイ」** ボタンをクリック
2. **「新しいデプロイ」** を選択

### 2-2. デプロイタイプの選択
1. 左側の **「種類の選択」** アイコン（⚙️）をクリック
2. **「ウェブアプリ」** を選択

### 2-3. デプロイ設定
以下の設定を入力：

| 項目 | 設定値 |
|------|--------|
| **説明** | `お知らせ機能追加 v2.0` |
| **次のユーザーとして実行** | `自分（あなたのメールアドレス）` |
| **アクセスできるユーザー** | `全員` |

### 2-4. デプロイ実行
1. **「デプロイ」** ボタンをクリック
2. 初回の場合、承認画面が表示されます：
   - **「承認が必要です」** → **「権限を確認」** をクリック
   - Googleアカウントを選択
   - **「詳細」** → **「（プロジェクト名）に移動（安全ではないページ）」** をクリック
   - **「許可」** をクリック

### 2-5. 新しいウェブアプリURLの取得
1. デプロイ完了後、**ウェブアプリURL** が表示されます
2. このURLをコピーします（重要！）

**URLの形式:**
```
https://script.google.com/macros/s/AKfycbz.../exec
```

⚠️ **注意:** この新しいURLは古いURLとは異なります。必ずコピーしてください。

### 2-6. デプロイ画面を閉じる
- **「完了」** をクリック

---

## 📝 手順3: Cloudflare Worker環境変数の更新

### 3-1. Cloudflare Dashboardにアクセス
1. https://dash.cloudflare.com にログイン
2. 左メニューから **「Workers & Pages」** を選択
3. プロジェクト一覧から該当プロジェクト（おそらく `hqweb-proxy` や類似名）をクリック

### 3-2. 環境変数の編集
1. **「Settings」** タブをクリック
2. **「Environment Variables」** セクションまでスクロール
3. **「Edit variables」** または **「Add variables」** をクリック

### 3-3. GAS_ENDPOINTの更新
1. 既存の `GAS_ENDPOINT` 変数を見つける
2. **「Edit」** をクリック
3. 値を **手順2-5でコピーした新しいURL** に置き換える

**変更前（例）:**
```
https://script.google.com/macros/s/AKfycbxOLDURL.../exec
```

**変更後（例）:**
```
https://script.google.com/macros/s/AKfycbzNEWURL.../exec
```

### 3-4. 保存とデプロイ
1. **「Save and deploy」** または **「Save」** ボタンをクリック
2. 確認ダイアログが出たら **「Deploy」** をクリック

⏱️ **デプロイには30秒〜1分程度かかります**

---

## 📝 手順4: キャッシュのクリア

### 4-1. ブラウザキャッシュのクリア
1. ブラウザで Ctrl+Shift+Delete (Cmd+Shift+Delete) を押す
2. **「キャッシュされた画像とファイル」** にチェック
3. 期間を **「全期間」** に設定
4. **「データを削除」** をクリック

### 4-2. 強制リロード
1. HQシステムのページを開く
2. Ctrl+Shift+R (Cmd+Shift+R) で強制リロード
3. もう一度 Ctrl+Shift+R で再度リロード

---

## 📝 手順5: 動作確認

### 5-1. ログインと初期表示
1. HQシステムにログイン（名古屋オフィス管理者アカウント）
2. ログイン後、以下を確認：
   - ヘッダーに **「お知らせ」** ボタンが表示されるか
   - お知らせエリアが表示されるか

### 5-2. お知らせの追加テスト
1. **「管理」** ボタンをクリック
2. 「お知らせ管理」セクションで以下を入力：
   - **タイトル:** `システムメンテナンスのお知らせ`
   - **内容:** `明日23:00〜24:00までメンテナンスを実施します。`
3. **「追加」** ボタンをクリック
4. 成功メッセージが表示されることを確認

### 5-3. 表示確認
1. 管理パネルを閉じる
2. お知らせエリアに追加した内容が表示されることを確認

### 5-4. 折りたたみ機能テスト
1. ヘッダーの **「お知らせ」** ボタンをクリック
2. お知らせが折りたたまれ、以下の形式で表示されることを確認：
   ```
   システムメンテナンスのお知らせ (他0件)
   ```
3. もう一度 **「お知らせ」** ボタンをクリック
4. お知らせが展開されることを確認

### 5-5. コンソールログ確認（デバッグ用）
1. ブラウザで F12 を押して開発者ツールを開く
2. **「Console」** タブを選択
3. お知らせを保存/読み込みした際に、エラーが出ていないか確認

**正常時のログ例:**
```
saveNotices: sending params: {action: 'setNotices', office: 'nagoya', noticesLength: 1}
setNotices response: {ok: true, notices: [...]}
fetchNotices params: {action: 'getNotices', token: '...', nocache: '1', office: 'nagoya'}
fetchNotices response: {updated: ..., notices: [...]}
```

**エラー時のログ例（今回解決すべき問題）:**
```
setNotices response: {error: 'unknown_action'}  ← これが出なければOK
```

---

## 🔧 トラブルシューティング

### ❌ 問題1: 依然として `{error: 'unknown_action'}` が出る

**原因:** Cloudflare Workerのデプロイが完了していない、またはURLが間違っている

**解決策:**
1. Cloudflare Dashboardで環境変数が正しく保存されているか再確認
2. `GAS_ENDPOINT` の値が **手順2-5でコピーしたURL** と完全に一致しているか確認
3. Cloudflare Workerを手動で再デプロイ：
   - Workers & Pages → プロジェクトを選択
   - **「Deployments」** タブ
   - 最新のデプロイの右側の **「...」** メニュー
   - **「Retry deployment」** を選択

### ❌ 問題2: お知らせボタンが表示されない

**原因:** お知らせデータがまだ存在しない

**解決策:**
1. 管理パネルからお知らせを1件追加
2. ページをリロード
3. お知らせがある場合にのみボタンが表示される仕様です

### ❌ 問題3: お知らせは表示されるが保存ができない

**原因:** GAS APIの `setNotices` エンドポイントのみが動作していない

**解決策:**
1. GASエディタで **手順1** を再実行
2. `if(action === 'setNotices'){` のブロック（548-581行目）が存在するか確認
3. 存在する場合、GASプロジェクト全体を選択してコピー
4. 新しいGASプロジェクトを作成して貼り付け
5. その新しいプロジェクトでデプロイを作成（**手順2** を実行）

### ❌ 問題4: 403 Forbidden エラー

**原因:** GASの実行権限設定が間違っている

**解決策:**
1. GASエディタで **「デプロイ」** → **「デプロイを管理」** を開く
2. 最新のデプロイの右側の ✏️（編集）アイコンをクリック
3. **「アクセスできるユーザー」** が **「全員」** になっているか確認
4. なっていない場合は変更して **「デプロイを更新」** をクリック

---

## ✅ 成功の確認

以下がすべて動作すれば成功です：

- ✅ ログイン後、お知らせエリアが展開状態で表示される
- ✅ ヘッダーに「お知らせ」ボタンが表示される
- ✅ 「お知らせ」ボタンをクリックすると折りたたみ/展開が切り替わる
- ✅ 折りたたみ時に「（タイトル） (他●件)」形式で表示される
- ✅ 管理パネルからお知らせの追加・編集・削除ができる
- ✅ コンソールに `{error: 'unknown_action'}` が表示されない

---

## 📞 サポート

問題が解決しない場合は、以下の情報を提供してください：

1. **GASコードの総行数**（エディタ下部に表示）
2. **ブラウザのコンソールログ**（F12 → Console タブ）
3. **Cloudflare Workerの環境変数 `GAS_ENDPOINT` の値**（最初の50文字のみ）
4. **具体的なエラーメッセージ**

---

## 📚 参考情報

### GASデプロイの仕組み
- 各デプロイは独立したURLを持つ
- 既存デプロイの「更新」は、キャッシュの影響で反映されないことがある
- 新規デプロイは完全に新しいインスタンスを作成するため、確実に最新コードが反映される

### Cloudflare Workerのキャッシュ
- 環境変数を変更すると、Worker全体が再デプロイされる
- 再デプロイ後、グローバルに配信されるまで30秒〜1分かかる
- ブラウザキャッシュとは独立しているため、両方クリアする必要がある

---

**作成日:** 2025-11-12  
**バージョン:** 2.0（お知らせ機能対応）
